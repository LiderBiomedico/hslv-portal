// ğŸ”§ SCRIPT DE DIAGNÃ“STICO RÃPIDO PARA SUPABASE
// Copiar y pegar en Console del navegador (F12)

console.log('ğŸ” INICIANDO DIAGNÃ“STICO COMPLETO...\n');

// ===== TEST 1: VERIFICAR CONEXIÃ“N A INTERNET =====
console.log('ğŸ“¡ TEST 1: Verificando conexiÃ³n a internet...');
fetch('https://httpbin.org/json')
  .then(response => response.json())
  .then(data => {
    console.log('âœ… Internet: OK');
  })
  .catch(error => {
    console.error('âŒ Internet: FALLO', error);
  });

// ===== TEST 2: VERIFICAR ARCHIVOS SUPABASE =====
console.log('\nğŸ“ TEST 2: Verificando archivos de configuraciÃ³n...');

// Test carga de config/supabase.js
fetch('./config/supabase.js')
  .then(response => {
    if (response.ok) {
      console.log('âœ… config/supabase.js: Archivo encontrado');
      return response.text();
    } else {
      console.error('âŒ config/supabase.js: Archivo NO encontrado (Error', response.status, ')');
      console.log('ğŸ”§ SOLUCIÃ“N: Verificar que el archivo existe en GitHub en la carpeta config/');
    }
  })
  .then(content => {
    if (content) {
      // Verificar contenido del archivo
      if (content.includes('supabaseUrl') && content.includes('supabaseKey')) {
        console.log('âœ… config/supabase.js: Estructura correcta');
        
        // Verificar si tiene credenciales reales
        if (content.includes('TU-PROYECTO-ID') || content.includes('tu-proyecto')) {
          console.error('âŒ config/supabase.js: Contiene credenciales de EJEMPLO');
          console.log('ğŸ”§ SOLUCIÃ“N: Reemplazar con credenciales reales de Supabase');
        } else {
          console.log('âœ… config/supabase.js: Credenciales parecen reales');
        }
      } else {
        console.error('âŒ config/supabase.js: Estructura incorrecta');
        console.log('ğŸ”§ SOLUCIÃ“N: Verificar contenido del archivo');
      }
    }
  })
  .catch(error => {
    console.error('âŒ config/supabase.js: Error al cargar', error);
  });

// ===== TEST 3: VERIFICAR VARIABLES GLOBALES =====
console.log('\nğŸŒ TEST 3: Verificando variables globales...');

setTimeout(() => {
  if (typeof window.supabase !== 'undefined') {
    console.log('âœ… window.supabase: Definida');
  } else {
    console.error('âŒ window.supabase: NO definida');
    console.log('ğŸ”§ SOLUCIÃ“N: Verificar import de Supabase en HTML');
  }

  if (typeof window.saveRequestToFirebase === 'function') {
    console.log('âœ… Funciones de compatibilidad: OK');
  } else {
    console.error('âŒ Funciones de compatibilidad: NO definidas');
    console.log('ğŸ”§ SOLUCIÃ“N: Verificar configuraciÃ³n de firebaseCompat');
  }
}, 2000);

// ===== TEST 4: VERIFICAR CREDENCIALES SUPABASE =====
console.log('\nğŸ”‘ TEST 4: Probando conexiÃ³n a Supabase...');

// FunciÃ³n para probar Supabase
function testSupabaseConnection() {
  // Intentar obtener credenciales del archivo actual
  const scripts = document.getElementsByTagName('script');
  let supabaseUrl = null;
  let supabaseKey = null;
  
  // Buscar en scripts inline
  for (let script of scripts) {
    if (script.innerHTML.includes('supabaseUrl')) {
      const content = script.innerHTML;
      const urlMatch = content.match(/supabaseUrl\s*=\s*['"](.*?)['"]/);
      const keyMatch = content.match(/supabaseKey\s*=\s*['"](.*?)['"]/);
      
      if (urlMatch) supabaseUrl = urlMatch[1];
      if (keyMatch) supabaseKey = keyMatch[1];
      break;
    }
  }
  
  if (!supabaseUrl || !supabaseKey) {
    console.error('âŒ Credenciales Supabase: NO encontradas en scripts');
    console.log('ğŸ”§ SOLUCIÃ“N: Verificar que las credenciales estÃ©n configuradas');
    return;
  }
  
  if (supabaseUrl.includes('TU-PROYECTO') || supabaseUrl.includes('tu-proyecto')) {
    console.error('âŒ Credenciales Supabase: Son ejemplos, no reales');
    console.log('ğŸ”§ SOLUCIÃ“N: Configurar credenciales reales de Supabase');
    console.log('   - URL encontrada:', supabaseUrl);
    return;
  }
  
  console.log('ğŸ” Probando conexiÃ³n con:', supabaseUrl);
  
  // Test bÃ¡sico de conectividad
  fetch(supabaseUrl + '/rest/v1/', {
    headers: {
      'apikey': supabaseKey,
      'Authorization': 'Bearer ' + supabaseKey
    }
  })
  .then(response => {
    if (response.ok) {
      console.log('âœ… Supabase: ConexiÃ³n exitosa');
      
      // Test de tabla solicitudes
      return fetch(supabaseUrl + '/rest/v1/solicitudes?limit=1', {
        headers: {
          'apikey': supabaseKey,
          'Authorization': 'Bearer ' + supabaseKey
        }
      });
    } else {
      console.error('âŒ Supabase: Error de autenticaciÃ³n (', response.status, ')');
      console.log('ğŸ”§ SOLUCIÃ“N: Verificar API key en Supabase dashboard');
    }
  })
  .then(response => {
    if (response && response.ok) {
      console.log('âœ… Tabla solicitudes: Accesible');
      return response.json();
    } else if (response) {
      console.error('âŒ Tabla solicitudes: Error', response.status);
      console.log('ğŸ”§ SOLUCIÃ“N: Verificar que tabla "solicitudes" existe');
    }
  })
  .then(data => {
    if (data) {
      console.log('âœ… Datos de prueba:', data.length, 'solicitudes encontradas');
    }
  })
  .catch(error => {
    console.error('âŒ Supabase: Error de conexiÃ³n', error);
    console.log('ğŸ”§ SOLUCIÃ“N: Verificar URL y configuraciÃ³n de red');
  });
}

// Ejecutar test despuÃ©s de que se cargue la pÃ¡gina
setTimeout(testSupabaseConnection, 3000);

// ===== TEST 5: VERIFICAR POLÃTICAS RLS =====
console.log('\nğŸ”’ TEST 5: Las polÃ­ticas RLS se verificarÃ¡n con el test de conexiÃ³n...');

// ===== RESUMEN Y RECOMENDACIONES =====
setTimeout(() => {
  console.log('\nğŸ“‹ RESUMEN DEL DIAGNÃ“STICO:');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('1. âœ…/âŒ ConexiÃ³n a internet');
  console.log('2. âœ…/âŒ Archivo config/supabase.js');
  console.log('3. âœ…/âŒ Variables globales de Supabase');
  console.log('4. âœ…/âŒ ConexiÃ³n a Supabase');
  console.log('5. âœ…/âŒ Acceso a tablas');
  console.log('\nğŸ”§ PRÃ“XIMOS PASOS SEGÃšN RESULTADOS:');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('Si hay âŒ, revisar las soluciones especÃ­ficas arriba');
  console.log('Si todo es âœ… pero aÃºn no funciona, ejecutar:');
  console.log('');
  console.log('// Test manual de funciÃ³n:');
  console.log('window.getRequestsFromFirebase()');
  console.log('  .then(data => console.log("Datos obtenidos:", data))');
  console.log('  .catch(err => console.error("Error:", err))');
  console.log('');
  console.log('ğŸ“ Si persisten problemas, contactar soporte con estos resultados');
}, 5000);

// ===== FUNCIÃ“N DE TEST MANUAL =====
window.runManualTest = function() {
  console.log('\nğŸ§ª EJECUTANDO TEST MANUAL...');
  
  if (typeof window.getRequestsFromFirebase === 'function') {
    window.getRequestsFromFirebase()
      .then(data => {
        console.log('âœ… Test manual exitoso:', data.length, 'solicitudes obtenidas');
        console.log('ğŸ‰ Supabase estÃ¡ funcionando correctamente');
      })
      .catch(error => {
        console.error('âŒ Test manual fallÃ³:', error);
        console.log('ğŸ”§ Revisar configuraciÃ³n de Supabase y base de datos');
      });
  } else {
    console.error('âŒ FunciÃ³n getRequestsFromFirebase no estÃ¡ definida');
    console.log('ğŸ”§ Verificar configuraciÃ³n de firebaseCompat en HTML');
  }
};

console.log('\nğŸ’¡ COMANDOS ÃšTILES:');
console.log('runManualTest() - Ejecutar test manual de Supabase');
console.log('window.checkConnection() - Verificar estado de conexiÃ³n');

console.log('\nğŸ” DiagnÃ³stico iniciado. Revisar resultados arriba en 5 segundos...');