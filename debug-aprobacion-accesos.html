<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Aprobaci√≥n de Accesos - Airtable</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            text-align: center;
        }

        .section {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .section h2 {
            color: #1f2937;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0.5rem 0.5rem 0.5rem 0;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .result-area {
            background: #1f2937;
            color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            min-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .table th,
        .table td {
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
            text-align: left;
        }

        .table th {
            background: #f3f4f6;
            font-weight: 600;
            color: #1f2937;
        }

        .table tr:nth-child(even) {
            background: #f9fafb;
        }

        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .request-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .request-card.pending {
            border-left: 4px solid #f59e0b;
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .request-id {
            font-weight: bold;
            color: #1f2937;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîç Debug Aprobaci√≥n de Accesos</h1>
            <p>Diagnosticar y solucionar errores 404 en la aprobaci√≥n</p>
        </div>

        <!-- Verificaci√≥n de Tablas -->
        <div class="section">
            <h2>üìã Verificaci√≥n de Tablas</h2>
            <p>Primero verificamos que las tablas existan y est√©n accesibles:</p>
            
            <button class="btn" onclick="checkTables()">üîç Verificar Tablas</button>
            <button class="btn btn-success" onclick="inspectSolicitudesAcceso()">üìù Inspeccionar SolicitudesAcceso</button>
            <button class="btn btn-warning" onclick="inspectUsuarios()">üë§ Inspeccionar Usuarios</button>
            
            <div id="tables-results"></div>
        </div>

        <!-- Lista de Solicitudes Pendientes -->
        <div class="section">
            <h2>üìã Solicitudes de Acceso Pendientes</h2>
            <p>Ver solicitudes existentes y probar aprobaci√≥n paso a paso:</p>
            
            <button class="btn" onclick="loadPendingRequests()">üìã Cargar Solicitudes Pendientes</button>
            <button class="btn btn-success" onclick="createTestRequest()">‚ûï Crear Solicitud de Prueba</button>
            
            <div id="requests-list"></div>
        </div>

        <!-- Test de Aprobaci√≥n -->
        <div class="section">
            <h2>‚úÖ Test de Aprobaci√≥n Paso a Paso</h2>
            <p>Probar cada paso del proceso de aprobaci√≥n:</p>
            
            <button class="btn btn-warning" onclick="testStepByStep()">üîß Test Paso a Paso</button>
            <button class="btn btn-success" onclick="testUserCreation()">üë§ Test Creaci√≥n Usuario</button>
            <button class="btn btn-danger" onclick="testUpdateMethods()">üîÑ Test M√©todos Update</button>
            
            <div id="approval-results"></div>
        </div>

        <!-- Log de Debug -->
        <div class="section">
            <h2>üìù Log de Debug</h2>
            <div class="result-area" id="debug-log">Iniciando debug de aprobaci√≥n...\n</div>
            <button class="btn" onclick="clearLog()">üßπ Limpiar</button>
            <button class="btn btn-success" onclick="exportLog()">üíæ Exportar</button>
        </div>
    </div>

    <!-- Incluir configuraci√≥n de Airtable -->
    <script src="airtable-config.js"></script>

    <script>
        let debugLog = [];
        let pendingRequests = [];

        // Funciones de logging
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('es-CO');
            const entry = `[${timestamp}] ${message}`;
            
            debugLog.push({ timestamp, message, type });
            
            const logArea = document.getElementById('debug-log');
            logArea.textContent += entry + '\n';
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('debug-log').textContent = 'Log limpiado...\n';
            debugLog = [];
        }

        function exportLog() {
            const logContent = debugLog.map(r => `[${r.timestamp}] ${r.type.toUpperCase()}: ${r.message}`).join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `approval-debug-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
        }

        function showResults(containerId, content, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="${type}">${content}</div>`;
        }

        // üìã Verificar que las tablas existan
        async function checkTables() {
            log('üìã Verificando existencia de tablas...');
            
            const tables = ['Solicitudes', 'SolicitudesAcceso', 'Usuarios', 'Tecnicos'];
            let results = '<h3>üìã Resultado de Verificaci√≥n de Tablas</h3>';
            results += '<table class="table"><thead><tr><th>Tabla</th><th>Estado</th><th>Records</th><th>Acci√≥n</th></tr></thead><tbody>';
            
            for (const table of tables) {
                try {
                    log(`üîç Verificando tabla: ${table}`);
                    
                    const result = await window.airtableAPI.makeRequest(`${table}?maxRecords=3`);
                    const recordCount = result.records ? result.records.length : 0;
                    
                    results += `<tr><td><strong>${table}</strong></td><td>‚úÖ Existe</td><td>${recordCount}</td><td>OK</td></tr>`;
                    log(`‚úÖ ${table}: ${recordCount} records encontrados`);
                    
                } catch (error) {
                    results += `<tr><td><strong>${table}</strong></td><td>‚ùå Error</td><td>-</td><td>${error.message}</td></tr>`;
                    log(`‚ùå ${table}: ${error.message}`);
                }
            }
            
            results += '</tbody></table>';
            showResults('tables-results', results, 'success');
        }

        // üìù Inspeccionar tabla SolicitudesAcceso
        async function inspectSolicitudesAcceso() {
            log('üìù Inspeccionando tabla SolicitudesAcceso...');
            
            try {
                const result = await window.airtableAPI.makeRequest('SolicitudesAcceso?maxRecords=5');
                
                log(`üìä SolicitudesAcceso: ${result.records.length} records`);
                
                if (result.records.length === 0) {
                    showResults('tables-results', 
                        '<h3>‚ö†Ô∏è Tabla SolicitudesAcceso Vac√≠a</h3><p>No hay solicitudes de acceso. Necesitas crear algunas primero.</p>', 
                        'info'
                    );
                    return;
                }

                // Analizar estructura
                const firstRecord = result.records[0];
                const fields = Object.keys(firstRecord.fields);
                
                let html = '<h3>üìù Estructura de SolicitudesAcceso</h3>';
                html += `<p><strong>Records encontrados:</strong> ${result.records.length}</p>`;
                html += `<p><strong>Campos:</strong> ${fields.join(', ')}</p>`;
                html += '<h4>Ejemplo de Record:</h4>';
                html += `<pre>${JSON.stringify(firstRecord, null, 2)}</pre>`;
                
                showResults('tables-results', html, 'success');

            } catch (error) {
                log(`‚ùå Error inspeccionando SolicitudesAcceso: ${error.message}`);
                showResults('tables-results', 
                    `<h3>‚ùå Error en SolicitudesAcceso</h3><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // üë§ Inspeccionar tabla Usuarios
        async function inspectUsuarios() {
            log('üë§ Inspeccionando tabla Usuarios...');
            
            try {
                const result = await window.airtableAPI.makeRequest('Usuarios?maxRecords=5');
                
                log(`üìä Usuarios: ${result.records.length} records`);
                
                let html = '<h3>üë§ Estructura de Usuarios</h3>';
                html += `<p><strong>Records encontrados:</strong> ${result.records.length}</p>`;
                
                if (result.records.length > 0) {
                    const firstRecord = result.records[0];
                    const fields = Object.keys(firstRecord.fields);
                    html += `<p><strong>Campos:</strong> ${fields.join(', ')}</p>`;
                    html += '<h4>Ejemplo de Record:</h4>';
                    html += `<pre>${JSON.stringify(firstRecord, null, 2)}</pre>`;
                } else {
                    html += '<p>‚ö†Ô∏è Tabla vac√≠a - esto es normal si no se han aprobado solicitudes</p>';
                }
                
                showResults('tables-results', html, 'success');

            } catch (error) {
                log(`‚ùå Error inspeccionando Usuarios: ${error.message}`);
                showResults('tables-results', 
                    `<h3>‚ùå Error en Usuarios</h3><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // üìã Cargar solicitudes pendientes
        async function loadPendingRequests() {
            log('üìã Cargando solicitudes de acceso pendientes...');
            
            try {
                const result = await window.airtableAPI.makeRequest('SolicitudesAcceso');
                pendingRequests = result.records.filter(r => 
                    r.fields.estado === 'PENDIENTE' || !r.fields.estado
                );
                
                log(`üìä ${pendingRequests.length} solicitudes pendientes encontradas`);
                
                if (pendingRequests.length === 0) {
                    showResults('requests-list', 
                        '<h3>‚ÑπÔ∏è No hay solicitudes pendientes</h3><p>Crea una solicitud de prueba para poder probar la aprobaci√≥n.</p>', 
                        'info'
                    );
                    return;
                }

                let html = '<h3>üìã Solicitudes Pendientes</h3>';
                
                pendingRequests.forEach((request, index) => {
                    const fields = request.fields;
                    html += `
                        <div class="request-card pending">
                            <div class="request-header">
                                <span class="request-id">ID: ${request.id}</span>
                                <span class="status status-pendiente">PENDIENTE</span>
                            </div>
                            <p><strong>Nombre:</strong> ${fields.nombreCompleto || 'No especificado'}</p>
                            <p><strong>Email:</strong> ${fields.email || 'No especificado'}</p>
                            <p><strong>Servicio:</strong> ${fields.servicioHospitalario || 'No especificado'}</p>
                            <button class="btn btn-success" onclick="testApproveRequest('${request.id}', ${index})">
                                ‚úÖ Probar Aprobaci√≥n
                            </button>
                            <button class="btn btn-warning" onclick="inspectRequest('${request.id}')">
                                üîç Inspeccionar
                            </button>
                        </div>
                    `;
                });
                
                showResults('requests-list', html, 'success');

            } catch (error) {
                log(`‚ùå Error cargando solicitudes: ${error.message}`);
                showResults('requests-list', 
                    `<h3>‚ùå Error Cargando Solicitudes</h3><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // ‚ûï Crear solicitud de prueba
        async function createTestRequest() {
            log('‚ûï Creando solicitud de acceso de prueba...');
            
            try {
                const testData = {
                    fields: {
                        id: `DEBUG${Date.now()}`,
                        nombreCompleto: `Usuario Debug ${Date.now()}`,
                        email: `debug${Date.now()}@hospital.com`,
                        servicioHospitalario: 'INGENIERIA_BIOMEDICA',
                        cargo: 'ADMINISTRATIVO',
                        justificacion: 'Solicitud creada para debug de aprobaci√≥n',
                        fechaSolicitud: new Date().toISOString(),
                        estado: 'PENDIENTE'
                    }
                };

                const result = await window.airtableAPI.makeRequest('SolicitudesAcceso', 'POST', testData);
                
                log(`‚úÖ Solicitud de prueba creada: ${result.id}`);
                showResults('requests-list', 
                    `<h3>‚úÖ Solicitud de Prueba Creada</h3><p>ID: ${result.id}</p><pre>${JSON.stringify(result, null, 2)}</pre>`, 
                    'success'
                );

                // Recargar solicitudes
                setTimeout(loadPendingRequests, 1000);

            } catch (error) {
                log(`‚ùå Error creando solicitud de prueba: ${error.message}`);
                showResults('requests-list', 
                    `<h3>‚ùå Error Creando Solicitud</h3><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // üîç Inspeccionar solicitud espec√≠fica
        async function inspectRequest(requestId) {
            log(`üîç Inspeccionando solicitud: ${requestId}`);
            
            try {
                // M√©todo 1: Obtener por ID directo
                try {
                    const directResult = await window.airtableAPI.makeRequest(`SolicitudesAcceso/${requestId}`);
                    log(`‚úÖ Acceso directo exitoso para: ${requestId}`);
                    showResults('approval-results', 
                        `<h3>‚úÖ Acceso Directo Exitoso</h3><pre>${JSON.stringify(directResult, null, 2)}</pre>`, 
                        'success'
                    );
                } catch (directError) {
                    log(`‚ùå Error en acceso directo: ${directError.message}`);
                    
                    // M√©todo 2: Buscar en lista
                    const listResult = await window.airtableAPI.makeRequest('SolicitudesAcceso');
                    const found = listResult.records.find(r => r.id === requestId);
                    
                    if (found) {
                        log(`‚úÖ Encontrado en lista: ${requestId}`);
                        showResults('approval-results', 
                            `<h3>‚úÖ Encontrado en Lista</h3><p>El record existe pero el acceso directo fall√≥.</p><pre>${JSON.stringify(found, null, 2)}</pre>`, 
                            'info'
                        );
                    } else {
                        log(`‚ùå No encontrado en lista: ${requestId}`);
                        showResults('approval-results', 
                            `<h3>‚ùå Record No Encontrado</h3><p>El ID ${requestId} no existe en la tabla.</p>`, 
                            'error'
                        );
                    }
                }

            } catch (error) {
                log(`‚ùå Error inspeccionando: ${error.message}`);
                showResults('approval-results', 
                    `<h3>‚ùå Error de Inspecci√≥n</h3><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // ‚úÖ Probar aprobaci√≥n de solicitud
        async function testApproveRequest(requestId, index) {
            log(`‚úÖ Probando aprobaci√≥n de solicitud: ${requestId}`);
            
            try {
                // Paso 1: Verificar que la solicitud existe
                log('üìã Paso 1: Verificando solicitud...');
                const request = pendingRequests[index];
                if (!request) {
                    throw new Error('Solicitud no encontrada en lista local');
                }
                
                log(`‚úÖ Solicitud encontrada: ${request.fields.nombreCompleto}`);
                
                // Paso 2: Generar c√≥digo √∫nico
                log('üé≤ Paso 2: Generando c√≥digo de acceso...');
                const accessCode = await window.airtableAPI.generateUniqueAccessCode();
                log(`‚úÖ C√≥digo generado: ${accessCode}`);
                
                // Paso 3: Crear usuario
                log('üë§ Paso 3: Creando usuario...');
                const userData = {
                    nombreCompleto: request.fields.nombreCompleto,
                    email: request.fields.email,
                    servicioHospitalario: request.fields.servicioHospitalario,
                    cargo: request.fields.cargo,
                    codigoAcceso: accessCode,
                    estado: 'ACTIVO',
                    fechaCreacion: new Date().toISOString(),
                    solicitudOrigenId: requestId
                };
                
                const userResult = await window.airtableAPI.createUsuario(userData);
                log(`‚úÖ Usuario creado: ${userResult.id}`);
                
                // Paso 4: Actualizar solicitud (aqu√≠ es donde suele fallar)
                log('üîÑ Paso 4: Actualizando estado de solicitud...');
                try {
                    const updateResult = await window.airtableAPI.updateSolicitudAcceso(requestId, {
                        estado: 'APROBADA',
                        fechaAprobacion: new Date().toISOString(),
                        usuarioCreado: userResult.id
                    });
                    log(`‚úÖ Solicitud actualizada exitosamente`);
                } catch (updateError) {
                    log(`‚ùå ERROR EN PASO 4 (aqu√≠ est√° el problema): ${updateError.message}`);
                    throw updateError;
                }
                
                // Resultado exitoso
                showResults('approval-results', 
                    `<h3>üéâ Aprobaci√≥n Exitosa</h3>
                    <p><strong>Usuario:</strong> ${userData.nombreCompleto}</p>
                    <p><strong>Email:</strong> ${userData.email}</p>
                    <p><strong>C√≥digo:</strong> ${accessCode}</p>
                    <p><strong>ID Usuario:</strong> ${userResult.id}</p>`, 
                    'success'
                );

            } catch (error) {
                log(`‚ùå Error en aprobaci√≥n: ${error.message}`);
                showResults('approval-results', 
                    `<h3>‚ùå Error en Aprobaci√≥n</h3><p>Solicitud: ${requestId}</p><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // üîß Test paso a paso detallado
        async function testStepByStep() {
            log('üîß Iniciando test detallado paso a paso...');
            
            if (pendingRequests.length === 0) {
                showResults('approval-results', 
                    '<h3>‚ö†Ô∏è No hay solicitudes</h3><p>Primero carga las solicitudes pendientes.</p>', 
                    'info'
                );
                return;
            }

            const request = pendingRequests[0];
            const requestId = request.id;
            
            let html = '<h3>üîß Test Paso a Paso</h3>';
            
            try {
                // Test 1: Verificar acceso directo al record
                html += '<h4>üìã Test 1: Acceso Directo</h4>';
                try {
                    const directAccess = await window.airtableAPI.makeRequest(`SolicitudesAcceso/${requestId}`);
                    html += '<p>‚úÖ Acceso directo: OK</p>';
                } catch (e) {
                    html += `<p>‚ùå Acceso directo: ${e.message}</p>`;
                }
                
                // Test 2: Verificar m√©todo updateSolicitudAcceso
                html += '<h4>üîÑ Test 2: M√©todo Update</h4>';
                try {
                    // Solo verificar si el m√©todo existe y est√° bien estructurado
                    if (typeof window.airtableAPI.updateSolicitudAcceso === 'function') {
                        html += '<p>‚úÖ M√©todo updateSolicitudAcceso: Existe</p>';
                        
                        // Test de update con datos m√≠nimos
                        const testUpdate = await window.airtableAPI.updateSolicitudAcceso(requestId, {
                            fechaActualizacion: new Date().toISOString()
                        });
                        html += '<p>‚úÖ Update de prueba: OK</p>';
                    } else {
                        html += '<p>‚ùå M√©todo updateSolicitudAcceso: No existe</p>';
                    }
                } catch (e) {
                    html += `<p>‚ùå Update de prueba: ${e.message}</p>`;
                }
                
                // Test 3: Verificar creaci√≥n de usuario
                html += '<h4>üë§ Test 3: Creaci√≥n de Usuario</h4>';
                try {
                    const testUserData = {
                        nombreCompleto: 'Usuario Test',
                        email: `test${Date.now()}@debug.com`,
                        servicioHospitalario: 'INGENIERIA_BIOMEDICA',
                        estado: 'ACTIVO',
                        codigoAcceso: '9999'
                    };
                    
                    const userResult = await window.airtableAPI.createUsuario(testUserData);
                    html += '<p>‚úÖ Creaci√≥n de usuario: OK</p>';
                    html += `<p>ID Usuario creado: ${userResult.id}</p>`;
                } catch (e) {
                    html += `<p>‚ùå Creaci√≥n de usuario: ${e.message}</p>`;
                }
                
                showResults('approval-results', html, 'success');

            } catch (error) {
                html += `<p>‚ùå Error general: ${error.message}</p>`;
                showResults('approval-results', html, 'error');
            }
        }

        // üë§ Test espec√≠fico de creaci√≥n de usuario
        async function testUserCreation() {
            log('üë§ Probando creaci√≥n de usuario...');
            
            try {
                const testData = {
                    nombreCompleto: `Usuario Test ${Date.now()}`,
                    email: `test${Date.now()}@debug.com`,
                    servicioHospitalario: 'INGENIERIA_BIOMEDICA',
                    cargo: 'ADMINISTRATIVO',
                    codigoAcceso: Math.floor(1000 + Math.random() * 9000).toString(),
                    estado: 'ACTIVO',
                    fechaCreacion: new Date().toISOString()
                };

                const result = await window.airtableAPI.createUsuario(testData);
                
                log(`‚úÖ Usuario test creado: ${result.id}`);
                showResults('approval-results', 
                    `<h3>‚úÖ Usuario Creado</h3><p>ID: ${result.id}</p><pre>${JSON.stringify(result, null, 2)}</pre>`, 
                    'success'
                );

            } catch (error) {
                log(`‚ùå Error creando usuario: ${error.message}`);
                showResults('approval-results', 
                    `<h3>‚ùå Error Creando Usuario</h3><pre>${error.message}</pre>`, 
                    'error'
                );
            }
        }

        // üîÑ Test de m√©todos update
        async function testUpdateMethods() {
            log('üîÑ Probando m√©todos de actualizaci√≥n...');
            
            if (pendingRequests.length === 0) {
                showResults('approval-results', 
                    '<h3>‚ö†Ô∏è No hay solicitudes para probar</h3>', 
                    'info'
                );
                return;
            }

            const requestId = pendingRequests[0].id;
            
            try {
                // Test 1: Update b√°sico
                log(`üîÑ Probando update b√°sico en: ${requestId}`);
                
                const updateData = {
                    fechaActualizacion: new Date().toISOString()
                };
                
                const result = await window.airtableAPI.updateSolicitudAcceso(requestId, updateData);
                
                log(`‚úÖ Update b√°sico exitoso`);
                showResults('approval-results', 
                    `<h3>‚úÖ Update Exitoso</h3><p>Solicitud actualizada: ${requestId}</p><pre>${JSON.stringify(result, null, 2)}</pre>`, 
                    'success'
                );

            } catch (error) {
                log(`‚ùå Error en update: ${error.message}`);
                
                // An√°lisis del error
                let errorAnalysis = '<h3>‚ùå An√°lisis del Error</h3>';
                
                if (error.message.includes('404')) {
                    errorAnalysis += '<p><strong>Error 404:</strong> El record no se encuentra.</p>';
                    errorAnalysis += '<p><strong>Posibles causas:</strong></p>';
                    errorAnalysis += '<ul>';
                    errorAnalysis += '<li>El ID del record no es v√°lido</li>';
                    errorAnalysis += '<li>El proxy no est√° manejando correctamente las URLs con ID</li>';
                    errorAnalysis += '<li>La tabla SolicitudesAcceso no permite updates</li>';
                    errorAnalysis += '<li>Permisos insuficientes en Airtable</li>';
                    errorAnalysis += '</ul>';
                } else if (error.message.includes('422')) {
                    errorAnalysis += '<p><strong>Error 422:</strong> Datos inv√°lidos.</p>';
                } else {
                    errorAnalysis += `<p><strong>Error:</strong> ${error.message}</p>`;
                }
                
                errorAnalysis += `<pre>${error.message}</pre>`;
                
                showResults('approval-results', errorAnalysis, 'error');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ Debug de aprobaci√≥n iniciado');
            
            setTimeout(() => {
                if (window.airtableAPI) {
                    log('‚úÖ airtableAPI disponible');
                    checkTables();
                } else {
                    log('‚ùå airtableAPI no disponible');
                }
            }, 2000);
        });
    </script>
</body>
</html>