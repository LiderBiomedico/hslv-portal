<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Tablas Airtable</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            margin: 0;
            color: #1f2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            text-align: center;
        }

        .header h1 {
            color: #2563eb;
            margin-bottom: 0.5rem;
        }

        .diagnostic-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .btn {
            padding: 0.875rem 2rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            margin: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(37, 99, 235, 0.35);
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .result-container {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #2563eb;
            max-height: 400px;
            overflow-y: auto;
        }

        .table-item {
            background: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 0.5rem 0;
            border-left: 4px solid;
        }

        .table-success {
            border-left-color: #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .table-error {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .field-list {
            background: #f1f5f9;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            max-height: 100px;
            overflow-y: auto;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            border-left: 4px solid;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        .recommendation {
            background: #fffbeb;
            border: 2px solid #f59e0b;
            border-radius: 1rem;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .recommendation h3 {
            color: #d97706;
            margin-bottom: 1rem;
        }

        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Diagn√≥stico de Tablas Airtable</h1>
            <p>Hospital Susana L√≥pez de Valencia - Soluci√≥n Error 404</p>
        </div>

        <div class="diagnostic-card">
            <h2>üß™ Herramientas de Diagn√≥stico</h2>
            <p>Usa estas herramientas para identificar el problema con las tablas de Airtable:</p>
            
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="testBasicConnection()">
                    üîó Test Conexi√≥n B√°sica
                </button>
                <button class="btn btn-secondary" onclick="discoverTables()">
                    üîç Descubrir Tablas Disponibles
                </button>
                <button class="btn btn-success" onclick="inspectSolicitudesAcceso()">
                    üìã Inspeccionar SolicitudesAcceso
                </button>
                <button class="btn btn-warning" onclick="generateTableFix()">
                    üõ†Ô∏è Generar Soluci√≥n
                </button>
            </div>

            <div id="diagnostic-results"></div>
        </div>

        <div class="recommendation">
            <h3>üí° Pasos para Solucionar el Error 404</h3>
            <ol>
                <li><strong>Ejecuta "Test Conexi√≥n B√°sica"</strong> para verificar que Netlify funciona</li>
                <li><strong>Usa "Descubrir Tablas"</strong> para ver qu√© tablas existen realmente</li>
                <li><strong>Inspecciona SolicitudesAcceso</strong> para ver si existe o tiene otro nombre</li>
                <li><strong>Genera la Soluci√≥n</strong> con el mapeo correcto de tablas</li>
            </ol>
        </div>

        <div class="diagnostic-card">
            <h3>üîß Configuraci√≥n Actual Esperada</h3>
            <p>El sistema espera encontrar estas tablas en Airtable:</p>
            <div class="field-list">
                <strong>Tablas Requeridas:</strong><br>
                ‚Ä¢ <code>Solicitudes</code> - Para solicitudes de mantenimiento<br>
                ‚Ä¢ <code>Tecnicos</code> - Para personal t√©cnico<br>
                ‚Ä¢ <code>Usuarios</code> - Para usuarios del portal<br>
                ‚Ä¢ <code>SolicitudesAcceso</code> - Para solicitudes de acceso (¬°LA QUE FALLA!)
            </div>
        </div>
    </div>

    <script>
        let diagnosticResults = [];

        // üîó Test de conexi√≥n b√°sica
        async function testBasicConnection() {
            showLoading('Probando conexi√≥n b√°sica con Netlify...');
            
            try {
                const response = await fetch('/.netlify/functions/hello');
                const data = await response.json();
                
                if (data.success) {
                    showResult('‚úÖ Conexi√≥n B√°sica Exitosa', 'success', {
                        message: 'Netlify Functions funcionando correctamente',
                        environment: data.environment,
                        netlifyInfo: data.netlifyInfo
                    });
                } else {
                    showResult('‚ùå Error en Conexi√≥n B√°sica', 'error', data);
                }
            } catch (error) {
                showResult('üí• Error Cr√≠tico', 'error', {
                    message: error.message,
                    suggestion: 'Verifica que las Netlify Functions est√©n desplegadas correctamente'
                });
            }
        }

        // üîç Descubrir tablas disponibles
        async function discoverTables() {
            showLoading('Descubriendo tablas disponibles en Airtable...');
            
            try {
                const response = await fetch('/.netlify/functions/simple-debug');
                const data = await response.json();
                
                if (data.success) {
                    const workingTables = data.workingTables || [];
                    const failedTables = data.failedTables || [];
                    
                    let resultHtml = `
                        <div class="alert alert-success">
                            <strong>üéâ Descubrimiento Completado</strong><br>
                            Se encontraron ${workingTables.length} tablas funcionando de ${data.tableTests.total} probadas
                        </div>
                    `;
                    
                    if (workingTables.length > 0) {
                        resultHtml += '<h4>‚úÖ Tablas Disponibles:</h4>';
                        workingTables.forEach(table => {
                            resultHtml += `
                                <div class="table-item table-success">
                                    <strong>${table.tableName}</strong> 
                                    <span style="color: #059669;">(${table.recordCount} registros)</span>
                                    ${table.hasData ? '<span style="background: #dcfce7; color: #166534; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">CON DATOS</span>' : ''}
                                    ${table.sampleFields && table.sampleFields.length > 0 ? `
                                        <div class="field-list">
                                            <strong>Campos:</strong> ${table.sampleFields.join(', ')}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    if (failedTables.length > 0) {
                        resultHtml += '<h4 style="margin-top: 1.5rem;">‚ùå Tablas No Encontradas:</h4>';
                        failedTables.forEach(table => {
                            resultHtml += `
                                <div class="table-item table-error">
                                    <strong>${table.tableName}</strong> 
                                    <span style="color: #ef4444;">${table.status}</span>
                                    ${table.errorType ? `<br><small>Tipo: ${table.errorType}</small>` : ''}
                                </div>
                            `;
                        });
                    }
                    
                    if (data.recommendation) {
                        resultHtml += `
                            <div class="alert alert-info">
                                <strong>üí° Recomendaci√≥n:</strong><br>
                                ${data.recommendation}
                            </div>
                        `;
                    }
                    
                    showResult('üîç Tablas Descubiertas', 'success', null, resultHtml);
                    
                    // Guardar resultados para generar soluci√≥n
                    diagnosticResults.discovery = data;
                    
                } else {
                    showResult('‚ùå Error en Descubrimiento', 'error', data);
                }
            } catch (error) {
                showResult('üí• Error en Descubrimiento', 'error', {
                    message: error.message
                });
            }
        }

        // üìã Inspeccionar tabla SolicitudesAcceso espec√≠ficamente
        async function inspectSolicitudesAcceso() {
            showLoading('Inspeccionando tabla SolicitudesAcceso...');
            
            try {
                const response = await fetch('/.netlify/functions/inspect-table?table=SolicitudesAcceso');
                const data = await response.json();
                
                if (data.success) {
                    let resultHtml = `
                        <div class="alert alert-success">
                            <strong>‚úÖ Tabla SolicitudesAcceso Encontrada</strong><br>
                            ${data.analysis.recordCount} registros encontrados
                        </div>
                        
                        <h4>üìã Estructura de la Tabla:</h4>
                        <div class="field-list">
                            <strong>Campos disponibles:</strong><br>
                            ${data.availableFields.map(field => `‚Ä¢ ${field}`).join('<br>')}
                        </div>
                    `;
                    
                    if (data.recommendations && data.recommendations.recommendedMapping) {
                        resultHtml += `
                            <h4>üéØ Mapeo Recomendado:</h4>
                            <div class="field-list">
                        `;
                        
                        Object.entries(data.recommendations.recommendedMapping).forEach(([key, value]) => {
                            const status = value.includes('‚ùå') ? '‚ùå' : '‚úÖ';
                            resultHtml += `${status} <strong>${key}:</strong> ${value}<br>`;
                        });
                        
                        resultHtml += '</div>';
                    }
                    
                    showResult('üìã Inspecci√≥n SolicitudesAcceso', 'success', null, resultHtml);
                    diagnosticResults.solicitudesAcceso = data;
                    
                } else {
                    // Intentar otras variaciones del nombre
                    const variations = [
                        'Solicitudes_Acceso',
                        'solicitudes_acceso', 
                        'solicitudesacceso',
                        'SolicitudAcceso',
                        'AccessRequests',
                        'access_requests'
                    ];
                    
                    let foundAlternative = null;
                    
                    for (const variation of variations) {
                        try {
                            const altResponse = await fetch(`/.netlify/functions/inspect-table?table=${encodeURIComponent(variation)}`);
                            if (altResponse.ok) {
                                const altData = await altResponse.json();
                                if (altData.success) {
                                    foundAlternative = { name: variation, data: altData };
                                    break;
                                }
                            }
                        } catch (e) {
                            // Continuar con la siguiente variaci√≥n
                        }
                    }
                    
                    if (foundAlternative) {
                        showResult('üîç Tabla Alternativa Encontrada', 'success', null, `
                            <div class="alert alert-info">
                                <strong>üí° La tabla "SolicitudesAcceso" no existe, pero se encontr√≥:</strong><br>
                                <code>${foundAlternative.name}</code> con ${foundAlternative.data.analysis.recordCount} registros
                            </div>
                            <div class="field-list">
                                <strong>Campos:</strong><br>
                                ${foundAlternative.data.availableFields.map(field => `‚Ä¢ ${field}`).join('<br>')}
                            </div>
                        `);
                        diagnosticResults.alternative = foundAlternative;
                    } else {
                        showResult('‚ùå Tabla SolicitudesAcceso No Existe', 'error', null, `
                            <div class="alert alert-error">
                                <strong>‚ùå No se encontr√≥ la tabla SolicitudesAcceso</strong><br>
                                Tampoco se encontraron variaciones comunes del nombre.
                            </div>
                            <div class="alert alert-info">
                                <strong>üí° Soluciones:</strong><br>
                                1. Crear la tabla "SolicitudesAcceso" en Airtable<br>
                                2. Usar una tabla existente y actualizar el c√≥digo<br>
                                3. Verificar que el nombre sea exacto (case-sensitive)
                            </div>
                        `);
                    }
                }
            } catch (error) {
                showResult('üí• Error Inspeccionando SolicitudesAcceso', 'error', {
                    message: error.message
                });
            }
        }

        // üõ†Ô∏è Generar soluci√≥n basada en diagn√≥stico
        async function generateTableFix() {
            if (!diagnosticResults.discovery) {
                alert('‚ö†Ô∏è Primero ejecuta "Descubrir Tablas Disponibles" para generar una soluci√≥n');
                return;
            }
            
            const workingTables = diagnosticResults.discovery.workingTables || [];
            const alternative = diagnosticResults.alternative;
            
            let solutionHtml = `
                <div class="alert alert-info">
                    <strong>üõ†Ô∏è Soluci√≥n Generada</strong><br>
                    Basada en el diagn√≥stico de tu base de datos Airtable
                </div>
            `;
            
            // Generar mapeo de tablas corregido
            const tableMapping = {
                solicitudes: 'Solicitudes',
                tecnicos: 'Tecnicos',
                usuarios: 'Usuarios',
                solicitudesAcceso: 'SolicitudesAcceso' // Por defecto
            };
            
            // Ajustar mapeo basado en tablas encontradas
            workingTables.forEach(table => {
                const tableName = table.tableName;
                if (tableName.toLowerCase().includes('solicitud') && tableName.toLowerCase().includes('acces')) {
                    tableMapping.solicitudesAcceso = tableName;
                } else if (tableName.toLowerCase().includes('solicitud')) {
                    tableMapping.solicitudes = tableName;
                } else if (tableName.toLowerCase().includes('tecnic')) {
                    tableMapping.tecnicos = tableName;
                } else if (tableName.toLowerCase().includes('usuario')) {
                    tableMapping.usuarios = tableName;
                }
            });
            
            if (alternative) {
                tableMapping.solicitudesAcceso = alternative.name;
            }
            
            solutionHtml += `
                <h4>üéØ Mapeo de Tablas Corregido:</h4>
                <pre>
// En airtable-config.js, l√≠nea 14-19, reemplaza:
this.tables = {
    solicitudes: '${tableMapping.solicitudes}',
    tecnicos: '${tableMapping.tecnicos}', 
    usuarios: '${tableMapping.usuarios}',
    solicitudesAcceso: '${tableMapping.solicitudesAcceso}'
};
                </pre>
            `;
            
            // Si no se encontr√≥ SolicitudesAcceso, dar instrucciones para crearla
            if (!workingTables.find(t => t.tableName === tableMapping.solicitudesAcceso) && !alternative) {
                solutionHtml += `
                    <div class="alert alert-error">
                        <strong>‚ö†Ô∏è Acci√≥n Requerida en Airtable:</strong><br>
                        La tabla "SolicitudesAcceso" no existe. Debes crearla con estos campos:
                    </div>
                    <div class="field-list">
                        <strong>Campos requeridos para SolicitudesAcceso:</strong><br>
                        ‚Ä¢ <code>nombreCompleto</code> - Single line text<br>
                        ‚Ä¢ <code>email</code> - Email<br>
                        ‚Ä¢ <code>telefono</code> - Phone number<br>
                        ‚Ä¢ <code>servicioHospitalario</code> - Single select<br>
                        ‚Ä¢ <code>cargo</code> - Single select<br>
                        ‚Ä¢ <code>justificacion</code> - Long text<br>
                        ‚Ä¢ <code>estado</code> - Single select (PENDIENTE, APROBADA, RECHAZADA)<br>
                        ‚Ä¢ <code>fechaSolicitud</code> - Date<br>
                        ‚Ä¢ <code>fechaAprobacion</code> - Date<br>
                        ‚Ä¢ <code>usuarioCreado</code> - Link to Usuarios table
                    </div>
                `;
            }
            
            showResult('üõ†Ô∏è Soluci√≥n Generada', 'success', null, solutionHtml);
        }

        // Funci√≥n auxiliar para mostrar loading
        function showLoading(message) {
            const container = document.getElementById('diagnostic-results');
            container.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>${message}</p>
                </div>
            `;
        }

        // Funci√≥n auxiliar para mostrar resultados
        function showResult(title, type, data, customHtml = null) {
            const container = document.getElementById('diagnostic-results');
            
            let html = `
                <div class="result-container">
                    <h3>${title}</h3>
                    ${customHtml || ''}
            `;
            
            if (data && !customHtml) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            html += `</div>`;
            container.innerHTML = html;
        }

        // Auto-ejecutar test b√°sico al cargar
        window.addEventListener('load', function() {
            setTimeout(testBasicConnection, 1000);
        });
    </script>
</body>
</html>