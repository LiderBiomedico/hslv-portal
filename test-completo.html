<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistema Completo - Hospital Susana L√≥pez de Valencia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.125rem;
            opacity: 0.9;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .test-card {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            color: #1f2937;
            transition: all 0.3s ease;
        }

        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .test-card h3 {
            color: #2563eb;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .test-button {
            width: 100%;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .test-button:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
        }

        .test-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .test-result {
            background: #f8fafc;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 4px solid #6b7280;
            font-family: monospace;
            font-size: 0.875rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .test-result.success {
            border-left-color: #059669;
            background: #f0fdf4;
            color: #166534;
        }

        .test-result.error {
            border-left-color: #ef4444;
            background: #fef2f2;
            color: #dc2626;
        }

        .test-result.info {
            border-left-color: #2563eb;
            background: #eff6ff;
            color: #1e40af;
        }

        .status-panel {
            background: rgba(255,255,255,0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .status-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 0.5rem;
        }

        .status-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .log-panel {
            background: rgba(0,0,0,0.8);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 2rem;
            color: #e0e0e0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .log-timestamp {
            color: #60a5fa;
            font-size: 0.75rem;
        }

        .log-level {
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin: 0 0.5rem;
        }

        .log-level.info {
            background: #2563eb;
            color: white;
        }

        .log-level.success {
            background: #059669;
            color: white;
        }

        .log-level.error {
            background: #ef4444;
            color: white;
        }

        .log-level.warning {
            background: #f59e0b;
            color: white;
        }

        .floating-actions {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 1000;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .floating-btn.primary {
            background: linear-gradient(135deg, #2563eb, #1e40af);
        }

        .floating-btn.success {
            background: linear-gradient(135deg, #059669, #047857);
        }

        .floating-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .floating-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üß™ Test Sistema Completo</h1>
            <p>Hospital Susana L√≥pez de Valencia - Verificaci√≥n de Funcionalidades</p>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <h3 style="text-align: center; margin-bottom: 1rem;">üìä Estado del Sistema</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-icon" id="connection-icon">üîÑ</div>
                    <div class="status-label">Conexi√≥n Airtable</div>
                    <div id="connection-status">Verificando...</div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="numbering-icon">üî¢</div>
                    <div class="status-label">Sistema Numeraci√≥n</div>
                    <div id="numbering-status">Verificando...</div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="assignment-icon">üë®‚Äçüîß</div>
                    <div class="status-label">Sistema Asignaci√≥n</div>
                    <div id="assignment-status">Verificando...</div>
                </div>
                <div class="status-item">
                    <div class="status-icon" id="time-icon">‚è±Ô∏è</div>
                    <div class="status-label">Tracking Tiempos</div>
                    <div id="time-status">Verificando...</div>
                </div>
            </div>
        </div>

        <!-- Test Grid -->
        <div class="test-grid">
            <!-- Test de Conexi√≥n -->
            <div class="test-card">
                <h3>üîó Test de Conexi√≥n</h3>
                <button class="test-button" onclick="testConnection()">Probar Conexi√≥n Airtable</button>
                <button class="test-button" onclick="testTables()">Verificar Tablas</button>
                <button class="test-button" onclick="testCredentials()">Test Credenciales</button>
                <div id="connection-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Numeraci√≥n -->
            <div class="test-card">
                <h3>üî¢ Test Numeraci√≥n Autom√°tica</h3>
                <button class="test-button" onclick="testNumberingSystem()">Test Sistema Numeraci√≥n</button>
                <button class="test-button" onclick="testGenerateNumbers()">Generar N√∫meros Muestra</button>
                <button class="test-button" onclick="testNumberValidation()">Test Validaci√≥n</button>
                <div id="numbering-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Solicitudes -->
            <div class="test-card">
                <h3>üìã Test Solicitudes</h3>
                <button class="test-button" onclick="testCreateSolicitud()">Crear Solicitud Test</button>
                <button class="test-button" onclick="testLoadSolicitudes()">Cargar Solicitudes</button>
                <button class="test-button" onclick="testUpdateSolicitud()">Test Actualizaci√≥n</button>
                <div id="solicitudes-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Personal -->
            <div class="test-card">
                <h3>üë• Test Personal de Soporte</h3>
                <button class="test-button" onclick="testLoadTechnicians()">Cargar Personal</button>
                <button class="test-button" onclick="testCreateTechnician()">Crear Personal Test</button>
                <button class="test-button" onclick="testTechniciansByArea()">Test Por √Årea</button>
                <div id="personal-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Asignaci√≥n -->
            <div class="test-card">
                <h3>üéØ Test Sistema Asignaci√≥n</h3>
                <button class="test-button" onclick="testAssignmentSystem()">Test Asignaci√≥n</button>
                <button class="test-button" onclick="testAutoAssignment()">Test Auto-asignaci√≥n</button>
                <button class="test-button" onclick="testLiberation()">Test Liberaci√≥n</button>
                <div id="assignment-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Tiempos -->
            <div class="test-card">
                <h3>‚è±Ô∏è Test Tiempos Respuesta</h3>
                <button class="test-button" onclick="testTimeTracker()">Test Time Tracker</button>
                <button class="test-button" onclick="testTimeCalculations()">Test C√°lculos</button>
                <button class="test-button" onclick="testTimeStatistics()">Test Estad√≠sticas</button>
                <div id="time-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Usuarios -->
            <div class="test-card">
                <h3>üë§ Test Gesti√≥n Usuarios</h3>
                <button class="test-button" onclick="testUserValidation()">Test Validaci√≥n</button>
                <button class="test-button" onclick="testAccessCodes()">Test C√≥digos</button>
                <button class="test-button" onclick="testApprovalProcess()">Test Aprobaci√≥n</button>
                <div id="users-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test Integral -->
            <div class="test-card">
                <h3>üîÑ Test Integral</h3>
                <button class="test-button" onclick="testCompleteWorkflow()">Flujo Completo</button>
                <button class="test-button" onclick="testStressTest()">Test de Carga</button>
                <button class="test-button" onclick="testSystemHealth()">Test Salud Sistema</button>
                <div id="integral-result" class="test-result" style="display: none;"></div>
            </div>

            <!-- Test de Reportes -->
            <div class="test-card">
                <h3>üìä Test Reportes</h3>
                <button class="test-button" onclick="testStatistics()">Test Estad√≠sticas</button>
                <button class="test-button" onclick="testMetrics()">Test M√©tricas</button>
                <button class="test-button" onclick="testExports()">Test Exportaci√≥n</button>
                <div id="reports-result" class="test-result" style="display: none;"></div>
            </div>
        </div>

        <!-- Log Panel -->
        <div class="log-panel">
            <h3 style="margin-bottom: 1rem;">üìù Log de Testing</h3>
            <div id="log-container">
                <div class="log-entry">
                    <span class="log-timestamp">[Sistema iniciado]</span>
                    <span class="log-level info">INFO</span>
                    Sistema de testing cargado correctamente
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Actions -->
    <div class="floating-actions">
        <button class="floating-btn primary" onclick="runAllTests()" title="Ejecutar Todos los Tests">
            üöÄ
        </button>
        <button class="floating-btn success" onclick="clearResults()" title="Limpiar Resultados">
            üßπ
        </button>
        <button class="floating-btn danger" onclick="resetSystem()" title="Reset Sistema">
            üîÑ
        </button>
    </div>

    <!-- Incluir Airtable Config -->
    <script src="airtable-config.js"></script>

    <script>
        // Variables globales para testing
        let testResults = {
            connection: null,
            numbering: null,
            solicitudes: null,
            personal: null,
            assignment: null,
            time: null,
            users: null,
            integral: null,
            reports: null
        };

        // üìù Sistema de logging
        function log(level, message) {
            const timestamp = new Date().toLocaleTimeString('es-CO');
            const logContainer = document.getElementById('log-container');
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level ${level}">${level.toUpperCase()}</span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // üé® Funciones de UI
        function showResult(testName, content, type = 'info') {
            const resultDiv = document.getElementById(`${testName}-result`);
            resultDiv.style.display = 'block';
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = content;
        }

        function updateStatus(component, status, icon) {
            document.getElementById(`${component}-status`).textContent = status;
            document.getElementById(`${component}-icon`).textContent = icon;
        }

        // üîó Test de Conexi√≥n
        async function testConnection() {
            log('info', 'Iniciando test de conexi√≥n...');
            
            try {
                if (!window.airtableAPI) {
                    throw new Error('AirtableAPI no disponible');
                }

                const isConnected = await window.airtableAPI.testConnection();
                
                if (isConnected) {
                    testResults.connection = true;
                    updateStatus('connection', 'Conectado', '‚úÖ');
                    showResult('connection', `‚úÖ Conexi√≥n exitosa\n\nDetalles:\n‚Ä¢ Estado: Conectado\n‚Ä¢ M√©todo: ${window.airtableAPI.useProxy ? 'Proxy Netlify' : 'Directo'}\n‚Ä¢ Base URL: ${window.airtableAPI.baseUrl}\n‚Ä¢ Ambiente: ${window.airtableAPI.isLocalDevelopment ? 'Desarrollo' : 'Producci√≥n'}`, 'success');
                    log('success', 'Conexi√≥n a Airtable exitosa');
                } else {
                    throw new Error('Test de conexi√≥n fall√≥');
                }

            } catch (error) {
                testResults.connection = false;
                updateStatus('connection', 'Error', '‚ùå');
                showResult('connection', `‚ùå Error de conexi√≥n\n\nError: ${error.message}\n\nPosibles causas:\n‚Ä¢ Credenciales incorrectas\n‚Ä¢ Problemas de red\n‚Ä¢ Configuraci√≥n de proxy\n‚Ä¢ Base ID incorrecta`, 'error');
                log('error', `Error de conexi√≥n: ${error.message}`);
            }
        }

        async function testTables() {
            log('info', 'Verificando tablas de Airtable...');
            
            try {
                const tables = ['Solicitudes', 'Tecnicos', 'Usuarios', 'SolicitudesAcceso'];
                const results = [];

                for (const table of tables) {
                    try {
                        const result = await window.airtableAPI.makeRequest(`${table}?maxRecords=1`);
                        results.push(`‚úÖ ${table}: OK (${result.records?.length || 0} records encontrados)`);
                    } catch (error) {
                        results.push(`‚ùå ${table}: Error - ${error.message}`);
                    }
                }

                showResult('connection', `üìã Verificaci√≥n de Tablas\n\n${results.join('\n')}\n\nTablas configuradas:\n${Object.values(window.airtableAPI.tables).join(', ')}`, 'info');
                log('info', 'Verificaci√≥n de tablas completada');

            } catch (error) {
                showResult('connection', `‚ùå Error verificando tablas: ${error.message}`, 'error');
                log('error', `Error verificando tablas: ${error.message}`);
            }
        }

        // üî¢ Test de Numeraci√≥n
        async function testNumberingSystem() {
            log('info', 'Testing sistema de numeraci√≥n...');
            
            try {
                if (!window.airtableAPI || !window.airtableAPI.numerationSystem) {
                    throw new Error('Sistema de numeraci√≥n no disponible');
                }

                const system = window.airtableAPI.numerationSystem;
                
                // Cargar contadores
                await system.loadCounters();
                
                const nextNumbers = {
                    'INGENIERIA_BIOMEDICA': system.getNextNumber('INGENIERIA_BIOMEDICA'),
                    'MECANICA': system.getNextNumber('MECANICA'),
                    'INFRAESTRUCTURA': system.getNextNumber('INFRAESTRUCTURA')
                };

                testResults.numbering = true;
                updateStatus('numbering', 'Funcionando', '‚úÖ');
                showResult('numbering', `‚úÖ Sistema de numeraci√≥n funcionando\n\nPr√≥ximos n√∫meros:\n‚Ä¢ Biom√©dica: ${nextNumbers.INGENIERIA_BIOMEDICA}\n‚Ä¢ Mec√°nica: ${nextNumbers.MECANICA}\n‚Ä¢ Infraestructura: ${nextNumbers.INFRAESTRUCTURA}\n\nContadores actuales:\n${JSON.stringify(system.counters, null, 2)}`, 'success');
                log('success', 'Sistema de numeraci√≥n verificado correctamente');

            } catch (error) {
                testResults.numbering = false;
                updateStatus('numbering', 'Error', '‚ùå');
                showResult('numbering', `‚ùå Error en sistema de numeraci√≥n: ${error.message}`, 'error');
                log('error', `Error en numeraci√≥n: ${error.message}`);
            }
        }

        async function testGenerateNumbers() {
            log('info', 'Generando n√∫meros de muestra...');
            
            try {
                const system = window.airtableAPI.numerationSystem;
                const samples = [];

                ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'].forEach(area => {
                    const numero = system.generateNumber(area);
                    samples.push(`${area}: ${numero}`);
                });

                showResult('numbering', `üî¢ N√∫meros generados:\n\n${samples.join('\n')}\n\nNota: Estos n√∫meros fueron generados como prueba y incrementaron los contadores.`, 'info');
                log('info', 'N√∫meros de muestra generados');

            } catch (error) {
                showResult('numbering', `‚ùå Error generando n√∫meros: ${error.message}`, 'error');
                log('error', `Error generando n√∫meros: ${error.message}`);
            }
        }

        // üìã Test de Solicitudes
        async function testCreateSolicitud() {
            log('info', 'Creando solicitud de prueba...');
            
            try {
                const testData = {
                    servicioIngenieria: 'INGENIERIA_BIOMEDICA',
                    tipoServicio: 'MANTENIMIENTO_CORRECTIVO',
                    prioridad: 'ALTA',
                    equipo: 'Ventilador Test',
                    ubicacion: 'UCI Test',
                    descripcion: 'Solicitud de prueba del sistema',
                    solicitante: 'Test User',
                    emailSolicitante: 'test@test.com'
                };

                const result = await window.airtableAPI.createSolicitud(testData);
                
                testResults.solicitudes = true;
                showResult('solicitudes', `‚úÖ Solicitud test creada exitosamente\n\nID: ${result.id}\nN√∫mero: ${result.fields.numero}\n√Årea: ${testData.servicioIngenieria}\nPrioridad: ${testData.prioridad}\n\nDatos completos:\n${JSON.stringify(result.fields, null, 2)}`, 'success');
                log('success', `Solicitud test creada: ${result.fields.numero}`);

            } catch (error) {
                testResults.solicitudes = false;
                showResult('solicitudes', `‚ùå Error creando solicitud: ${error.message}`, 'error');
                log('error', `Error creando solicitud: ${error.message}`);
            }
        }

        async function testLoadSolicitudes() {
            log('info', 'Cargando solicitudes desde Airtable...');
            
            try {
                const solicitudes = await window.airtableAPI.getSolicitudes();
                
                const porArea = {};
                solicitudes.forEach(s => {
                    const area = s.servicioIngenieria || 'Sin √°rea';
                    porArea[area] = (porArea[area] || 0) + 1;
                });

                showResult('solicitudes', `üìã ${solicitudes.length} solicitudes cargadas\n\nPor √°rea:\n${Object.entries(porArea).map(([area, count]) => `‚Ä¢ ${area}: ${count}`).join('\n')}\n\n√öltimas 3 solicitudes:\n${solicitudes.slice(-3).map(s => `‚Ä¢ ${s.numero} - ${s.estado || 'PENDIENTE'}`).join('\n')}`, 'info');
                log('info', `${solicitudes.length} solicitudes cargadas desde Airtable`);

            } catch (error) {
                showResult('solicitudes', `‚ùå Error cargando solicitudes: ${error.message}`, 'error');
                log('error', `Error cargando solicitudes: ${error.message}`);
            }
        }

        // üë• Test de Personal
        async function testLoadTechnicians() {
            log('info', 'Cargando personal de soporte...');
            
            try {
                const tecnicos = await window.airtableAPI.getTecnicos();
                
                const porArea = {};
                const porEstado = {};
                
                tecnicos.forEach(t => {
                    const area = t.area || 'Sin √°rea';
                    const estado = t.estado || 'Sin estado';
                    porArea[area] = (porArea[area] || 0) + 1;
                    porEstado[estado] = (porEstado[estado] || 0) + 1;
                });

                testResults.personal = true;
                updateStatus('assignment', 'Disponible', '‚úÖ');
                showResult('personal', `üë• ${tecnicos.length} personal de soporte cargado\n\nPor √°rea:\n${Object.entries(porArea).map(([area, count]) => `‚Ä¢ ${area}: ${count}`).join('\n')}\n\nPor estado:\n${Object.entries(porEstado).map(([estado, count]) => `‚Ä¢ ${estado}: ${count}`).join('\n')}`, 'success');
                log('success', `${tecnicos.length} personal de soporte cargado`);

            } catch (error) {
                testResults.personal = false;
                showResult('personal', `‚ùå Error cargando personal: ${error.message}`, 'error');
                log('error', `Error cargando personal: ${error.message}`);
            }
        }

        async function testCreateTechnician() {
            log('info', 'Creando personal de prueba...');
            
            try {
                const testData = {
                    nombre: 'T√©cnico Test',
                    email: `test.tech.${Date.now()}@test.com`,
                    area: 'INGENIERIA_BIOMEDICA',
                    tipo: 'tecnico',
                    especialidad: 'Ventiladores',
                    estado: 'disponible'
                };

                const result = await window.airtableAPI.createTecnico(testData);
                
                showResult('personal', `‚úÖ Personal test creado exitosamente\n\nID: ${result.id}\nNombre: ${testData.nombre}\n√Årea: ${testData.area}\nTipo: ${testData.tipo}\nEstado: ${testData.estado}\n\nDatos mapeados:\n${JSON.stringify(result.fields, null, 2)}`, 'success');
                log('success', `Personal test creado: ${testData.nombre}`);

            } catch (error) {
                showResult('personal', `‚ùå Error creando personal: ${error.message}`, 'error');
                log('error', `Error creando personal: ${error.message}`);
            }
        }

        // üéØ Test de Asignaci√≥n
        async function testAssignmentSystem() {
            log('info', 'Testing sistema de asignaci√≥n...');
            
            try {
                // Obtener solicitudes pendientes y t√©cnicos disponibles
                const solicitudes = await window.airtableAPI.getSolicitudes();
                const tecnicos = await window.airtableAPI.getTecnicos();
                
                const pendientes = solicitudes.filter(s => s.estado === 'PENDIENTE' || !s.tecnicoAsignado);
                const disponibles = tecnicos.filter(t => t.estado === 'disponible');

                testResults.assignment = true;
                updateStatus('assignment', 'Funcionando', '‚úÖ');
                showResult('assignment', `üéØ Sistema de asignaci√≥n listo\n\nSolicitudes pendientes: ${pendientes.length}\nT√©cnicos disponibles: ${disponibles.length}\n\nCompatibilidad por √°rea:\n${['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'].map(area => {
                    const solicitudesArea = pendientes.filter(s => s.servicioIngenieria === area).length;
                    const tecnicosArea = disponibles.filter(t => t.area === area).length;
                    return `‚Ä¢ ${area}: ${solicitudesArea} solicitudes / ${tecnicosArea} t√©cnicos`;
                }).join('\n')}`, 'success');
                log('success', 'Sistema de asignaci√≥n verificado');

            } catch (error) {
                testResults.assignment = false;
                updateStatus('assignment', 'Error', '‚ùå');
                showResult('assignment', `‚ùå Error en sistema de asignaci√≥n: ${error.message}`, 'error');
                log('error', `Error en asignaci√≥n: ${error.message}`);
            }
        }

        // ‚è±Ô∏è Test de Tiempos
        async function testTimeTracker() {
            log('info', 'Testing sistema de tiempos...');
            
            try {
                if (!window.airtableAPI || !window.airtableAPI.timeTracker) {
                    throw new Error('Sistema de tiempo no disponible');
                }

                const tracker = window.airtableAPI.timeTracker;
                
                // Test de c√°lculos
                const fechaCreacion = new Date(Date.now() - 2 * 60 * 60 * 1000); // 2 horas atr√°s
                const fechaAsignacion = new Date();
                
                const tiempo = tracker.calcularTiempoRespuesta(fechaCreacion, fechaAsignacion);
                const tiempoFormateado = tracker.formatearTiempo(tiempo);
                const evaluacion = tracker.evaluarTiempo(tiempo, 'ALTA');

                testResults.time = true;
                updateStatus('time', 'Funcionando', '‚úÖ');
                showResult('time', `‚è±Ô∏è Sistema de tiempo funcionando\n\nPrueba de c√°lculo:\n‚Ä¢ Tiempo transcurrido: ${tiempoFormateado}\n‚Ä¢ Evaluaci√≥n: ${evaluacion.status} - ${evaluacion.mensaje}\n\nL√≠mites configurados:\n${Object.entries(tracker.limitesTiempo).map(([prioridad, limite]) => `‚Ä¢ ${prioridad}: ${tracker.formatearTiempo(limite)}`).join('\n')}`, 'success');
                log('success', 'Sistema de tiempo verificado');

            } catch (error) {
                testResults.time = false;
                updateStatus('time', 'Error', '‚ùå');
                showResult('time', `‚ùå Error en sistema de tiempo: ${error.message}`, 'error');
                log('error', `Error en tiempo: ${error.message}`);
            }
        }

        // üîÑ Test Integral
        async function testCompleteWorkflow() {
            log('info', 'Ejecutando test de flujo completo...');
            
            try {
                let workflow = 'üîÑ FLUJO COMPLETO DE TRABAJO\n\n';
                
                // 1. Crear solicitud
                workflow += '1. ‚úÖ Creando solicitud con numeraci√≥n autom√°tica...\n';
                const solicitudData = {
                    servicioIngenieria: 'INGENIERIA_BIOMEDICA',
                    tipoServicio: 'MANTENIMIENTO_CORRECTIVO',
                    prioridad: 'CRITICA',
                    equipo: 'Equipo Test Integral',
                    ubicacion: 'Test Location',
                    descripcion: 'Test integral del sistema completo',
                    solicitante: 'Test Integral',
                    emailSolicitante: 'integral@test.com'
                };
                
                const solicitud = await window.airtableAPI.createSolicitud(solicitudData);
                workflow += `   Solicitud creada: ${solicitud.fields.numero}\n\n`;
                
                // 2. Obtener t√©cnicos disponibles
                workflow += '2. ‚úÖ Buscando t√©cnicos disponibles...\n';
                const tecnicos = await window.airtableAPI.getTecnicosDisponibles('INGENIERIA_BIOMEDICA');
                workflow += `   T√©cnicos disponibles: ${tecnicos.length}\n\n`;
                
                if (tecnicos.length > 0) {
                    // 3. Asignar t√©cnico
                    workflow += '3. ‚úÖ Asignando t√©cnico...\n';
                    const asignacion = await window.airtableAPI.asignarTecnicoASolicitud(solicitud.id, tecnicos[0].id);
                    
                    if (asignacion.success) {
                        workflow += `   T√©cnico asignado: ${asignacion.tecnico.nombre}\n`;
                        workflow += `   Tiempo de respuesta: ${asignacion.tiempos.tiempoRespuesta}\n\n`;
                        
                        // 4. Actualizar estado
                        workflow += '4. ‚úÖ Actualizando estado a EN_PROCESO...\n';
                        await window.airtableAPI.updateSolicitud(solicitud.id, { estado: 'EN_PROCESO' });
                        workflow += '   Estado actualizado\n\n';
                        
                        // 5. Completar solicitud
                        workflow += '5. ‚úÖ Completando solicitud...\n';
                        await window.airtableAPI.updateSolicitud(solicitud.id, { 
                            estado: 'COMPLETADA',
                            fechaCompletado: new Date().toISOString()
                        });
                        
                        // 6. Liberar t√©cnico
                        await window.airtableAPI.liberarTecnico(tecnicos[0].id, solicitud.id);
                        workflow += '   Solicitud completada y t√©cnico liberado\n\n';
                        
                        workflow += '‚úÖ FLUJO COMPLETO EXITOSO';
                        
                        showResult('integral', workflow, 'success');
                        log('success', 'Flujo completo ejecutado exitosamente');
                    } else {
                        throw new Error('Error en asignaci√≥n: ' + asignacion.error);
                    }
                } else {
                    workflow += '   ‚ö†Ô∏è No hay t√©cnicos disponibles para completar el flujo\n';
                    showResult('integral', workflow, 'info');
                }

            } catch (error) {
                showResult('integral', `‚ùå Error en flujo completo: ${error.message}`, 'error');
                log('error', `Error en flujo completo: ${error.message}`);
            }
        }

        // üöÄ Ejecutar todos los tests
        async function runAllTests() {
            log('info', 'Iniciando ejecuci√≥n de todos los tests...');
            
            const tests = [
                { name: 'Conexi√≥n', func: testConnection },
                { name: 'Numeraci√≥n', func: testNumberingSystem },
                { name: 'Solicitudes', func: testCreateSolicitud },
                { name: 'Personal', func: testLoadTechnicians },
                { name: 'Asignaci√≥n', func: testAssignmentSystem },
                { name: 'Tiempos', func: testTimeTracker },
                { name: 'Flujo Completo', func: testCompleteWorkflow }
            ];

            for (const test of tests) {
                try {
                    log('info', `Ejecutando test: ${test.name}`);
                    await test.func();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa entre tests
                } catch (error) {
                    log('error', `Error en test ${test.name}: ${error.message}`);
                }
            }

            // Resumen final
            const passed = Object.values(testResults).filter(Boolean).length;
            const total = Object.values(testResults).filter(r => r !== null).length;
            
            log('success', `Tests completados: ${passed}/${total} exitosos`);
            
            alert(`üß™ TESTING COMPLETADO\n\n‚úÖ Tests exitosos: ${passed}\n‚ùå Tests fallidos: ${total - passed}\nüìä Total ejecutados: ${total}\n\n${passed === total ? 'üéâ ¬°Todos los tests pasaron!' : '‚ö†Ô∏è Algunos tests fallaron, revisar resultados'}`);
        }

        // üßπ Limpiar resultados
        function clearResults() {
            document.querySelectorAll('.test-result').forEach(result => {
                result.style.display = 'none';
                result.innerHTML = '';
            });
            
            document.getElementById('log-container').innerHTML = `
                <div class="log-entry">
                    <span class="log-timestamp">[${new Date().toLocaleTimeString('es-CO')}]</span>
                    <span class="log-level info">INFO</span>
                    Resultados limpiados
                </div>
            `;
            
            testResults = {
                connection: null,
                numbering: null,
                solicitudes: null,
                personal: null,
                assignment: null,
                time: null,
                users: null,
                integral: null,
                reports: null
            };
        }

        // üîÑ Reset sistema
        function resetSystem() {
            const confirmed = confirm('üîÑ ¬øReiniciar sistema de testing?\n\nEsto limpiar√° todos los resultados y recargar√° la configuraci√≥n.');
            if (confirmed) {
                location.reload();
            }
        }

        // Placeholder functions para tests adicionales
        function testCredentials() {
            log('info', 'Test de credenciales no implementado a√∫n');
        }

        function testNumberValidation() {
            log('info', 'Test de validaci√≥n de n√∫meros no implementado a√∫n');
        }

        function testUpdateSolicitud() {
            log('info', 'Test de actualizaci√≥n de solicitud no implementado a√∫n');
        }

        function testTechniciansByArea() {
            log('info', 'Test de t√©cnicos por √°rea no implementado a√∫n');
        }

        function testAutoAssignment() {
            log('info', 'Test de auto-asignaci√≥n no implementado a√∫n');
        }

        function testLiberation() {
            log('info', 'Test de liberaci√≥n no implementado a√∫n');
        }

        function testTimeCalculations() {
            log('info', 'Test de c√°lculos de tiempo no implementado a√∫n');
        }

        function testTimeStatistics() {
            log('info', 'Test de estad√≠sticas de tiempo no implementado a√∫n');
        }

        function testUserValidation() {
            log('info', 'Test de validaci√≥n de usuarios no implementado a√∫n');
        }

        function testAccessCodes() {
            log('info', 'Test de c√≥digos de acceso no implementado a√∫n');
        }

        function testApprovalProcess() {
            log('info', 'Test de proceso de aprobaci√≥n no implementado a√∫n');
        }

        function testStressTest() {
            log('info', 'Test de carga no implementado a√∫n');
        }

        function testSystemHealth() {
            log('info', 'Test de salud del sistema no implementado a√∫n');
        }

        function testStatistics() {
            log('info', 'Test de estad√≠sticas no implementado a√∫n');
        }

        function testMetrics() {
            log('info', 'Test de m√©tricas no implementado a√∫n');
        }

        function testExports() {
            log('info', 'Test de exportaci√≥n no implementado a√∫n');
        }

        // üöÄ Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'Sistema de testing inicializado');
            
            // Verificar disponibilidad de AirtableAPI
            setTimeout(() => {
                if (window.airtableAPI) {
                    log('success', 'AirtableAPI detectado');
                    updateStatus('connection', 'API Cargado', 'üîÑ');
                    
                    // Auto-verificar conexi√≥n
                    testConnection();
                } else {
                    log('error', 'AirtableAPI no disponible');
                    updateStatus('connection', 'API No Disponible', '‚ùå');
                }
            }, 2000);
        });
    </script>
</body>
</html>