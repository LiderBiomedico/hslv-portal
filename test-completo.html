<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>?? Test Completo - Sistema Hospital</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .status-bar {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 2rem;
            border-left: 4px solid #2563eb;
        }
        .test-grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .test-section {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .test-section:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .test-section h3 {
            margin: 0 0 0.5rem 0;
            color: #1f2937;
            font-size: 1.125rem;
        }
        .test-section p {
            margin: 0 0 1rem 0;
            color: #6b7280;
            font-size: 0.875rem;
        }
        .btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            width: 100%;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }
        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
        }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .result {
            background: #f1f5f9;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            display: none;
        }
        .result.success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }
        .result.error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .result.warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }
        .result.info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #059669);
            width: 0%;
            transition: width 0.3s ease;
        }
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
        }
        .summary-number {
            font-size: 2rem;
            font-weight: bold;
            color: #0c4a6e;
            margin: 0;
        }
        .summary-label {
            font-size: 0.875rem;
            color: #0369a1;
            margin: 0;
        }
        h1 {
            color: #1f2937;
            margin: 0 0 0.5rem 0;
        }
        .subtitle {
            color: #6b7280;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>?? Test Completo del Sistema Hospital</h1>
            <p class="subtitle">Diagn車stico integral de Netlify Functions + Airtable</p>
        </div>

        <div class="status-bar">
            <h3 style="margin: 0 0 0.5rem 0; color: #1f2937;">?? Estado del Sistema</h3>
            <p style="margin: 0;"><strong>Sitio:</strong> <span id="site-url"></span></p>
            <p style="margin: 0;"><strong>Hostname:</strong> <span id="hostname"></span></p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">Progreso de tests: <span id="progress-text">0/0 completados</span></p>
        </div>

        <div class="quick-actions">
            <button class="btn btn-success" onclick="runAllTests()">
                ?? Ejecutar Todos los Tests
            </button>
            <button class="btn btn-warning" onclick="runCriticalTests()">
                ? Solo Tests Cr赤ticos
            </button>
            <button class="btn" onclick="resetAllTests()">
                ?? Resetear Tests
            </button>
        </div>

        <div class="test-grid">
            <!-- Test 1: Hello Function -->
            <div class="test-section">
                <h3>?? Test 1: Funci車n Hello</h3>
                <p>Verifica que las funciones Netlify est谷n desplegadas correctamente.</p>
                <button class="btn" onclick="testHelloFunction()" id="btn-hello">
                    ?? Probar Funci車n Hello
                </button>
                <div id="hello-result" class="result"></div>
            </div>

            <!-- Test 2: Config Function -->
            <div class="test-section">
                <h3>?? Test 2: Variables de Entorno</h3>
                <p>Confirma que las variables de Airtable est谷n configuradas en Netlify.</p>
                <button class="btn" onclick="testConfigFunction()" id="btn-config">
                    ?? Verificar Variables
                </button>
                <div id="config-result" class="result"></div>
            </div>

            <!-- Test 3: Simple Debug -->
            <div class="test-section">
                <h3>?? Test 3: Debug Simple Airtable</h3>
                <p><strong>TEST CR赤TICO:</strong> Encuentra qu谷 tablas existen y funcionan en Airtable.</p>
                <button class="btn btn-success" onclick="testSimpleDebug()" id="btn-simple">
                    ?? Debug Tablas Airtable
                </button>
                <div id="simple-result" class="result"></div>
            </div>

            <!-- Test 4: Airtable Proxy -->
            <div class="test-section">
                <h3>?? Test 4: Proxy Airtable</h3>
                <p>Prueba el proxy corregido con la tabla confirmada que funciona.</p>
                <button class="btn" onclick="testAirtableProxy()" id="btn-proxy">
                    ?? Probar Proxy Airtable
                </button>
                <div id="proxy-result" class="result"></div>
            </div>

            <!-- Test 5: Integration Test -->
            <div class="test-section">
                <h3>?? Test 5: Integraci車n Completa</h3>
                <p>Test final usando airtable-config.js como lo har赤a el sistema real.</p>
                <button class="btn" onclick="testFullIntegration()" id="btn-integration">
                    ?? Test de Integraci車n
                </button>
                <div id="integration-result" class="result"></div>
            </div>
        </div>

        <!-- Resumen de resultados -->
        <div class="quick-actions" id="summary-section" style="display: none;">
            <div class="summary-card">
                <p class="summary-number" id="tests-passed">0</p>
                <p class="summary-label">Tests Exitosos</p>
            </div>
            <div class="summary-card">
                <p class="summary-number" id="tests-failed">0</p>
                <p class="summary-label">Tests Fallidos</p>
            </div>
            <div class="summary-card">
                <p class="summary-number" id="tables-found">0</p>
                <p class="summary-label">Tablas Funcionando</p>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let testResults = {
            hello: null,
            config: null,
            simple: null,
            proxy: null,
            integration: null
        };
        
        let workingTables = [];
        let recommendedTable = null;

        // Inicializar p芍gina
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('site-url').textContent = window.location.href;
            document.getElementById('hostname').textContent = window.location.hostname;
            updateProgress();
        });

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = content;
            element.className = `result ${type}`;
        }

        function updateProgress() {
            const completed = Object.values(testResults).filter(r => r !== null).length;
            const total = Object.keys(testResults).length;
            const percentage = total > 0 ? (completed / total) * 100 : 0;
            
            document.getElementById('progress-bar').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${completed}/${total} completados`;
            
            if (completed > 0) {
                updateSummary();
            }
        }

        function updateSummary() {
            const passed = Object.values(testResults).filter(r => r === true).length;
            const failed = Object.values(testResults).filter(r => r === false).length;
            
            document.getElementById('tests-passed').textContent = passed;
            document.getElementById('tests-failed').textContent = failed;
            document.getElementById('tables-found').textContent = workingTables.length;
            document.getElementById('summary-section').style.display = 'grid';
        }

        // TEST 1: Hello Function
        async function testHelloFunction() {
            const btn = document.getElementById('btn-hello');
            btn.disabled = true;
            btn.textContent = '?? Probando...';
            
            showResult('hello-result', '?? Ejecutando test de funci車n hello...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/hello');
                
                if (response.ok) {
                    const data = await response.json();
                    const output = `? FUNCI車N HELLO EXITOSA

?? STATUS: ${response.status} ${response.statusText}
?? MENSAJE: ${data.message}
? TIMESTAMP: ${data.timestamp}

?? ENVIRONMENT:
? Node Version: ${data.environment?.nodeVersion || 'N/A'}
? Has Airtable Key: ${data.environment?.hasAirtableKey ? '?' : '?'}
? Has Airtable Base: ${data.environment?.hasAirtableBase ? '?' : '?'}

?? NETLIFY INFO:
? Region: ${data.netlifyInfo?.region || 'N/A'}`;

                    showResult('hello-result', output, 'success');
                    testResults.hello = true;
                } else {
                    const errorText = await response.text();
                    showResult('hello-result', `? ERROR ${response.status}: ${errorText}`, 'error');
                    testResults.hello = false;
                }
            } catch (error) {
                showResult('hello-result', `?? ERROR DE CONEXI車N: ${error.message}`, 'error');
                testResults.hello = false;
            }
            
            btn.disabled = false;
            btn.textContent = '?? Probar Funci車n Hello';
            updateProgress();
        }

        // TEST 2: Config Function
        async function testConfigFunction() {
            const btn = document.getElementById('btn-config');
            btn.disabled = true;
            btn.textContent = '?? Verificando...';
            
            showResult('config-result', '?? Verificando variables de entorno...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/test-config');
                
                if (response.ok) {
                    const data = await response.json();
                    const output = `? VARIABLES CONFIGURADAS CORRECTAMENTE

?? API KEY: ${data.environment?.hasApiKey ? '? Configurada' : '? Faltante'}
?? BASE ID: ${data.environment?.hasBaseId ? '? Configurada' : '? Faltante'}

?? DETALLES:
? API Key Preview: ${data.environment?.apiKeyPreview || 'N/A'}
? Base ID: ${data.environment?.baseId || 'N/A'}
? Timestamp: ${data.timestamp}

?? NETLIFY:
? Region: ${data.netlify?.region || 'N/A'}
? Function: ${data.netlify?.functionName?.substring(0, 10) || 'N/A'}...`;

                    showResult('config-result', output, data.environment?.hasApiKey && data.environment?.hasBaseId ? 'success' : 'error');
                    testResults.config = data.environment?.hasApiKey && data.environment?.hasBaseId;
                } else {
                    const errorText = await response.text();
                    showResult('config-result', `? ERROR ${response.status}: ${errorText}`, 'error');
                    testResults.config = false;
                }
            } catch (error) {
                showResult('config-result', `?? ERROR: ${error.message}`, 'error');
                testResults.config = false;
            }
            
            btn.disabled = false;
            btn.textContent = '?? Verificar Variables';
            updateProgress();
        }

        // TEST 3: Simple Debug (EL M芍S IMPORTANTE)
        async function testSimpleDebug() {
            const btn = document.getElementById('btn-simple');
            btn.disabled = true;
            btn.textContent = '?? Analizando tablas...';
            
            showResult('simple-result', '?? Ejecutando an芍lisis completo de tablas en Airtable...', 'info');
            
            try {
                const response = await fetch('/.netlify/functions/simple-debug');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    workingTables = data.workingTables || [];
                    recommendedTable = data.bestTable;
                    
                    let output = `?? AN芍LISIS COMPLETO DE AIRTABLE

?? CONFIGURACI車N:
? API Key: ${data.configuration?.apiKeyConfigured ? '? Configurada' : '? Faltante'}
? Base ID: ${data.configuration?.baseIdConfigured ? '? Configurada' : '? Faltante'}
? Base: ${data.configuration?.baseId || 'N/A'}

?? RESULTADOS:
? Total tablas probadas: ${data.tableTests?.total || 0}
? Tablas funcionando: ${data.tableTests?.successful || 0}
? Tablas fallidas: ${data.tableTests?.failed || 0}
`;

                    if (workingTables.length > 0) {
                        output += `\n? TABLAS QUE FUNCIONAN:\n`;
                        workingTables.forEach(table => {
                            output += `? ${table.tableName} (${table.recordCount} records)${table.hasData ? ' ??' : ' ??'}\n`;
                            if (table.sampleFields && table.sampleFields.length > 0) {
                                output += `  Campos: ${table.sampleFields.slice(0, 3).join(', ')}${table.sampleFields.length > 3 ? '...' : ''}\n`;
                            }
                        });
                        
                        output += `\n?? RECOMENDACI車N: ${data.recommendation}\n`;
                        
                        if (recommendedTable) {
                            output += `\n? MEJOR TABLA PARA USAR: "${recommendedTable.tableName}"\n`;
                            output += `? Records: ${recommendedTable.recordCount}\n`;
                            output += `? Tiene datos: ${recommendedTable.hasData ? '? S赤' : '? No'}\n`;
                        }
                    } else {
                        output += `\n? NO SE ENCONTRARON TABLAS FUNCIONANDO\n`;
                        
                        if (data.failedTables && data.failedTables.length > 0) {
                            output += `\n?? ERRORES ENCONTRADOS:\n`;
                            data.failedTables.slice(0, 3).forEach(table => {
                                output += `? ${table.tableName}: ${table.status}\n`;
                                if (table.errorType) {
                                    output += `  Tipo: ${table.errorType}\n`;
                                }
                            });
                        }
                    }

                    showResult('simple-result', output, workingTables.length > 0 ? 'success' : 'error');
                    testResults.simple = workingTables.length > 0;
                } else {
                    const errorText = await response.text();
                    showResult('simple-result', `? ERROR ${response.status}: ${errorText}`, 'error');
                    testResults.simple = false;
                }
            } catch (error) {
                showResult('simple-result', `?? ERROR: ${error.message}`, 'error');
                testResults.simple = false;
            }
            
            btn.disabled = false;
            btn.textContent = '?? Debug Tablas Airtable';
            updateProgress();
        }

        // TEST 4: Airtable Proxy
        async function testAirtableProxy() {
            const btn = document.getElementById('btn-proxy');
            btn.disabled = true;
            btn.textContent = '?? Probando proxy...';
            
            showResult('proxy-result', '?? Probando proxy de Airtable...', 'info');
            
            // Usar tabla recomendada si est芍 disponible
            const tableToTest = recommendedTable ? recommendedTable.tableName : 'Solicitudes';
            
            try {
                const response = await fetch(`/.netlify/functions/airtable-proxy/${tableToTest}?maxRecords=1`);
                
                if (response.ok) {
                    const data = await response.json();
                    const output = `? PROXY AIRTABLE FUNCIONANDO

?? TABLA PROBADA: "${tableToTest}"
?? STATUS: ${response.status} ${response.statusText}
?? RECORDS OBTENIDOS: ${data.records?.length || 0}

?? DATOS OBTENIDOS:
${JSON.stringify(data, null, 2)}

?? ?EL PROXY EST芍 FUNCIONANDO CORRECTAMENTE!`;

                    showResult('proxy-result', output, 'success');
                    testResults.proxy = true;
                } else {
                    const errorText = await response.text();
                    let parsedError;
                    try {
                        parsedError = JSON.parse(errorText);
                    } catch (e) {
                        parsedError = errorText;
                    }

                    const output = `? ERROR EN PROXY AIRTABLE

?? TABLA PROBADA: "${tableToTest}"
?? STATUS: ${response.status} ${response.statusText}

?? ERROR DETALLADO:
${typeof parsedError === 'object' ? JSON.stringify(parsedError, null, 2) : parsedError}

?? POSIBLES CAUSAS:
? Proxy no actualizado con la correcci車n
? Tabla "${tableToTest}" no existe
? Problema de permisos espec赤fico`;

                    showResult('proxy-result', output, 'error');
                    testResults.proxy = false;
                }
            } catch (error) {
                showResult('proxy-result', `?? ERROR DE CONEXI車N: ${error.message}`, 'error');
                testResults.proxy = false;
            }
            
            btn.disabled = false;
            btn.textContent = '?? Probar Proxy Airtable';
            updateProgress();
        }

        // TEST 5: Integration Test
        async function testFullIntegration() {
            const btn = document.getElementById('btn-integration');
            btn.disabled = true;
            btn.textContent = '?? Integrando...';
            
            showResult('integration-result', '?? Ejecutando test de integraci車n completa...', 'info');
            
            try {
                // Simular el uso de airtable-config.js como lo har赤a el sistema real
                if (typeof window.debugAirtableConnection === 'function') {
                    const status = window.debugAirtableConnection();
                    
                    const output = `?? TEST DE INTEGRACI車N COMPLETA

?? ESTADO DEL SISTEMA:
? Conectado: ${status.isConnected ? '? S赤' : '? No'}
? Entorno: ${status.environment}
? Hostname: ${status.hostname}
? Proxy habilitado: ${status.useProxy ? '? S赤' : '? No'}
? Tabla confirmada: ${status.confirmedTable || 'N/A'}

?? RESULTADO DEL DEBUG:
${JSON.stringify(status, null, 2)}

${status.isConnected ? '?? ?INTEGRACI車N EXITOSA!' : '? Problemas de integraci車n detectados'}`;

                    showResult('integration-result', output, status.isConnected ? 'success' : 'warning');
                    testResults.integration = status.isConnected;
                } else {
                    showResult('integration-result', `?? airtable-config.js no est芍 cargado o no tiene la funci車n debugAirtableConnection()

?? RECOMENDACI車N:
1. Verificar que airtable-config.js est谷 incluido en la p芍gina
2. Actualizar airtable-config.js con la versi車n corregida
3. Recargar la p芍gina

?? ESTADO ACTUAL:
? window.airtableAPI: ${typeof window.airtableAPI}
? debugAirtableConnection: ${typeof window.debugAirtableConnection}`, 'warning');
                    testResults.integration = false;
                }
            } catch (error) {
                showResult('integration-result', `?? ERROR EN INTEGRACI車N: ${error.message}

?? Stack trace:
${error.stack}`, 'error');
                testResults.integration = false;
            }
            
            btn.disabled = false;
            btn.textContent = '?? Test de Integraci車n';
            updateProgress();
        }

        // Funciones auxiliares
        async function runAllTests() {
            await testHelloFunction();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testConfigFunction();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSimpleDebug();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testAirtableProxy();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testFullIntegration();
        }

        async function runCriticalTests() {
            await testConfigFunction();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testSimpleDebug();
            await new Promise(resolve => setTimeout(resolve, 1000));
            await testAirtableProxy();
        }

        function resetAllTests() {
            testResults = {
                hello: null,
                config: null,
                simple: null,
                proxy: null,
                integration: null
            };
            
            workingTables = [];
            recommendedTable = null;
            
            // Ocultar todos los resultados
            document.querySelectorAll('.result').forEach(result => {
                result.style.display = 'none';
            });
            
            // Resetear botones
            document.querySelectorAll('.btn').forEach(btn => {
                btn.disabled = false;
            });
            
            updateProgress();
            document.getElementById('summary-section').style.display = 'none';
        }

        // Auto-ejecutar test cr赤tico al cargar
        window.addEventListener('load', function() {
            console.log('?? Test completo cargado');
            console.log('?? Sitio:', window.location.href);
            
            // Auto-ejecutar simple debug despu谷s de 3 segundos
            setTimeout(() => {
                console.log('?? Auto-ejecutando simple debug...');
                testSimpleDebug();
            }, 3000);
        });
    </script>
</body>
</html>