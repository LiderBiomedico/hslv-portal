<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Solicitudes de Acceso - Hospital</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f5f9;
            line-height: 1.6;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #059669 0%, #2563eb 100%);
            color: white;
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .test-section {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .test-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0.25rem;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .status {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .status-error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-warning {
            background: #fef3c7;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .result-box {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: monospace;
            font-size: 0.875rem;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .loading {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§ª Test de Solicitudes de Acceso</h1>
        <p>Herramienta de diagnÃ³stico para el sistema de solicitudes del Hospital</p>
    </div>

    <!-- Estado de ConexiÃ³n -->
    <div class="test-section">
        <h2 class="test-title">ğŸŒ Estado de ConexiÃ³n</h2>
        <div id="connection-status" class="status status-info">
            Verificando conexiÃ³n...
        </div>
        <div class="grid">
            <button class="btn btn-primary" onclick="testConnection()">
                ğŸ”„ Test ConexiÃ³n Airtable
            </button>
            <button class="btn btn-warning" onclick="testAccessTable()">
                ğŸ“‹ Test Tabla SolicitudesAcceso
            </button>
            <button class="btn btn-info" onclick="debugSystem()">
                ğŸ” Debug Completo
            </button>
        </div>
        <div id="connection-result" class="result-box" style="display: none;"></div>
    </div>

    <!-- Test de Lectura -->
    <div class="test-section">
        <h2 class="test-title">ğŸ“– Test de Lectura de Solicitudes</h2>
        <div class="grid">
            <button class="btn btn-primary" onclick="getSolicitudesAcceso()">
                ğŸ“‹ Obtener Solicitudes Cloud
            </button>
            <button class="btn btn-warning" onclick="getLocalSolicitudes()">
                ğŸ’¾ Obtener Solicitudes Locales
            </button>
            <button class="btn btn-success" onclick="compareData()">
                ğŸ”„ Comparar Cloud vs Local
            </button>
        </div>
        <div id="read-result" class="result-box" style="display: none;"></div>
    </div>

    <!-- Test de CreaciÃ³n -->
    <div class="test-section">
        <h2 class="test-title">âœï¸ Test de CreaciÃ³n de Solicitudes</h2>
        <form id="test-form" onsubmit="createTestSolicitud(event)">
            <div class="grid">
                <div class="form-group">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" id="test-nombre" class="form-input" value="Test Usuario" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="test-email" class="form-input" value="test@hospital.com" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Servicio</label>
                    <select id="test-servicio" class="form-select" required>
                        <option value="URGENCIAS">Urgencias</option>
                        <option value="UCI">UCI</option>
                        <option value="ADMINISTRATIVO">Administrativo</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cargo</label>
                    <select id="test-cargo" class="form-select" required>
                        <option value="MEDICO">MÃ©dico</option>
                        <option value="ENFERMERO">Enfermero/a</option>
                        <option value="ADMINISTRATIVO">Administrativo</option>
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-success">
                â• Crear Solicitud de Prueba
            </button>
        </form>
        <div id="create-result" class="result-box" style="display: none;"></div>
    </div>

    <!-- Herramientas de Limpieza -->
    <div class="test-section">
        <h2 class="test-title">ğŸ§¹ Herramientas de Mantenimiento</h2>
        <div class="grid">
            <button class="btn btn-warning" onclick="clearLocalData()">
                ğŸ—‘ï¸ Limpiar Datos Locales
            </button>
            <button class="btn btn-danger" onclick="resetTableError()">
                ğŸ”§ Reset Error de Tabla
            </button>
            <button class="btn btn-info" onclick="syncLocalToCloud()">
                â˜ï¸ Sincronizar Local â†’ Cloud
            </button>
        </div>
        <div id="maintenance-result" class="result-box" style="display: none;"></div>
    </div>

    <!-- EstadÃ­sticas -->
    <div class="test-section">
        <h2 class="test-title">ğŸ“Š EstadÃ­sticas del Sistema</h2>
        <button class="btn btn-primary" onclick="getStatistics()">
            ğŸ“ˆ Obtener EstadÃ­sticas
        </button>
        <div id="stats-result" class="result-box" style="display: none;"></div>
    </div>

    <!-- Include Airtable Config -->
    <script src="airtable-config.js"></script>

    <script>
        // InicializaciÃ³n
        let api = null;

        window.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Iniciando herramienta de diagnÃ³stico...');
            
            // Esperar a que se cargue airtable-config.js
            setTimeout(async () => {
                if (window.airtableAPI) {
                    api = window.airtableAPI;
                    await updateConnectionStatus();
                } else {
                    showStatus('connection-status', 'error', 'âŒ Error: airtable-config.js no se cargÃ³ correctamente');
                }
            }, 2000);
        });

        // Funciones de utilidad
        function showStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `status status-${type}`;
            element.textContent = message;
        }

        function showResult(elementId, content) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
        }

        async function updateConnectionStatus() {
            if (!api) return;
            
            const status = api.getStatus();
            if (status.isConnected) {
                showStatus('connection-status', 'success', 'âœ… Conectado a Airtable');
            } else {
                showStatus('connection-status', 'warning', 'âš ï¸ Modo Local (sin conexiÃ³n a Airtable)');
            }
        }

        // Tests de conexiÃ³n
        async function testConnection() {
            showResult('connection-result', 'â³ Probando conexiÃ³n...');
            
            try {
                const isConnected = await api.testConnection();
                const status = api.getStatus();
                
                showResult('connection-result', 
                    `Estado de ConexiÃ³n:\n` +
                    `âœ… Conectado: ${isConnected}\n` +
                    `ğŸŒ Entorno: ${status.environment}\n` +
                    `ğŸ›¡ï¸ Usando Proxy: ${status.useProxy}\n` +
                    `ğŸ“¡ URL Base: ${status.baseUrl}\n` +
                    `ğŸ“‹ VersiÃ³n: ${status.version}\n` +
                    `ğŸ• Timestamp: ${new Date().toLocaleString()}`
                );
            } catch (error) {
                showResult('connection-result', `âŒ Error: ${error.message}`);
            }
        }

        async function testAccessTable() {
            showResult('connection-result', 'â³ Verificando tabla SolicitudesAcceso...');
            
            try {
                const result = await api.testAccessRequestsTable();
                
                if (result.success) {
                    showResult('connection-result', 
                        `âœ… Tabla SolicitudesAcceso verificada\n\n` +
                        `ğŸ“‹ Nombre de tabla: ${result.tableName}\n` +
                        `ğŸ“Š Registros encontrados: ${result.records}\n` +
                        `ğŸ”¤ Campos detectados:\n${result.fields.join('\n')}\n\n` +
                        `ğŸ“ Muestra de datos:\n${JSON.stringify(result.sampleData, null, 2)}`
                    );
                } else {
                    showResult('connection-result', 
                        `âŒ Error verificando tabla\n\n` +
                        `ğŸ“‹ Nombre intentado: ${result.tableName}\n` +
                        `âŒ Error: ${result.error}\n` +
                        `ğŸ”¢ HTTP Status: ${result.status || 'N/A'}\n\n` +
                        `ğŸ’¡ Posibles causas:\n` +
                        `1. La tabla no existe en Airtable\n` +
                        `2. El nombre es diferente (verificar mayÃºsculas/minÃºsculas)\n` +
                        `3. Problemas de permisos en el API Token`
                    );
                }
            } catch (error) {
                showResult('connection-result', `âŒ Error: ${error.message}`);
            }
        }

        async function debugSystem() {
            showResult('connection-result', 'â³ Ejecutando diagnÃ³stico completo...');
            
            try {
                const debugInfo = await window.debugAccessRequests();
                showResult('connection-result', 
                    `ğŸ” DIAGNÃ“STICO COMPLETO\n\n` +
                    `${JSON.stringify(debugInfo, null, 2)}`
                );
            } catch (error) {
                showResult('connection-result', `âŒ Error: ${error.message}`);
            }
        }

        // Tests de lectura
        async function getSolicitudesAcceso() {
            showResult('read-result', 'â³ Obteniendo solicitudes desde Airtable...');
            
            try {
                const solicitudes = await api.getSolicitudesAcceso();
                
                showResult('read-result', 
                    `âœ… Solicitudes obtenidas: ${solicitudes.length}\n\n` +
                    `${solicitudes.map((s, i) => 
                        `ğŸ“‹ Solicitud ${i + 1}:\n` +
                        `  ID: ${s.id}\n` +
                        `  Nombre: ${s.nombreCompleto}\n` +
                        `  Email: ${s.email}\n` +
                        `  Estado: ${s.estado}\n` +
                        `  Fecha: ${s.fechaSolicitud}\n`
                    ).join('\n')}`
                );
            } catch (error) {
                showResult('read-result', `âŒ Error: ${error.message}`);
            }
        }

        async function getLocalSolicitudes() {
            showResult('read-result', 'â³ Obteniendo solicitudes locales...');
            
            try {
                const localData = localStorage.getItem('hospital_access_requests');
                const solicitudes = localData ? JSON.parse(localData) : [];
                
                showResult('read-result', 
                    `ğŸ’¾ Solicitudes locales: ${solicitudes.length}\n\n` +
                    `${solicitudes.map((s, i) => 
                        `ğŸ“‹ Solicitud ${i + 1}:\n` +
                        `  ID: ${s.id}\n` +
                        `  Nombre: ${s.nombreCompleto}\n` +
                        `  Email: ${s.email}\n` +
                        `  Estado: ${s.estado}\n` +
                        `  Fecha: ${s.fechaSolicitud || s.fechaCreacion}\n`
                    ).join('\n')}`
                );
            } catch (error) {
                showResult('read-result', `âŒ Error: ${error.message}`);
            }
        }

        async function compareData() {
            showResult('read-result', 'â³ Comparando datos...');
            
            try {
                const cloudSolicitudes = await api.getSolicitudesAcceso();
                const localData = localStorage.getItem('hospital_access_requests');
                const localSolicitudes = localData ? JSON.parse(localData) : [];
                
                const cloudEmails = cloudSolicitudes.map(s => s.email);
                const localEmails = localSolicitudes.map(s => s.email);
                
                const onlyInCloud = cloudEmails.filter(e => !localEmails.includes(e));
                const onlyInLocal = localEmails.filter(e => !cloudEmails.includes(e));
                
                showResult('read-result', 
                    `ğŸ“Š COMPARACIÃ“N CLOUD vs LOCAL\n\n` +
                    `â˜ï¸ En Cloud: ${cloudSolicitudes.length} solicitudes\n` +
                    `ğŸ’¾ En Local: ${localSolicitudes.length} solicitudes\n\n` +
                    `Solo en Cloud (${onlyInCloud.length}):\n${onlyInCloud.join('\n')}\n\n` +
                    `Solo en Local (${onlyInLocal.length}):\n${onlyInLocal.join('\n')}`
                );
            } catch (error) {
                showResult('read-result', `âŒ Error: ${error.message}`);
            }
        }

        // Test de creaciÃ³n
        async function createTestSolicitud(event) {
            event.preventDefault();
            showResult('create-result', 'â³ Creando solicitud de prueba...');
            
            const formData = {
                nombreCompleto: document.getElementById('test-nombre').value,
                email: document.getElementById('test-email').value,
                telefono: '1234567890',
                servicioHospitalario: document.getElementById('test-servicio').value,
                cargo: document.getElementById('test-cargo').value,
                justificacion: 'Solicitud de prueba desde herramienta de diagnÃ³stico',
                fechaSolicitud: new Date().toISOString(),
                estado: 'PENDIENTE',
                esUrgente: false
            };
            
            try {
                const result = await api.createSolicitudAcceso(formData);
                
                showResult('create-result', 
                    `âœ… Solicitud creada exitosamente!\n\n` +
                    `ID: ${result.id}\n` +
                    `Datos enviados:\n${JSON.stringify(formData, null, 2)}\n\n` +
                    `Respuesta completa:\n${JSON.stringify(result, null, 2)}`
                );
                
                // Actualizar el email para la prÃ³xima prueba
                document.getElementById('test-email').value = `test${Date.now()}@hospital.com`;
                
            } catch (error) {
                showResult('create-result', 
                    `âŒ Error creando solicitud:\n${error.message}\n\n` +
                    `Datos intentados:\n${JSON.stringify(formData, null, 2)}`
                );
            }
        }

        // Herramientas de mantenimiento
        function clearLocalData() {
            if (confirm('Â¿EstÃ¡ seguro de limpiar todos los datos locales de solicitudes de acceso?')) {
                localStorage.removeItem('hospital_access_requests');
                localStorage.removeItem('hospital_access_table_error');
                showResult('maintenance-result', 'âœ… Datos locales limpiados exitosamente');
            }
        }

        function resetTableError() {
            localStorage.removeItem('hospital_access_table_error');
            showResult('maintenance-result', 'âœ… Error de tabla reseteado. Intente cargar el portal de gestiÃ³n nuevamente.');
        }

        async function syncLocalToCloud() {
            showResult('maintenance-result', 'â³ Sincronizando datos locales con la nube...');
            
            try {
                const localData = localStorage.getItem('hospital_access_requests');
                const localSolicitudes = localData ? JSON.parse(localData) : [];
                
                if (localSolicitudes.length === 0) {
                    showResult('maintenance-result', 'â„¹ï¸ No hay solicitudes locales para sincronizar');
                    return;
                }
                
                let synced = 0;
                let errors = 0;
                const results = [];
                
                for (const solicitud of localSolicitudes) {
                    if (solicitud.id && solicitud.id.startsWith('LOCAL-')) {
                        try {
                            // Remover campos que podrÃ­an causar problemas
                            const cleanData = { ...solicitud };
                            delete cleanData.id;
                            delete cleanData.fechaCreacion;
                            
                            await api.createSolicitudAcceso(cleanData);
                            synced++;
                            results.push(`âœ… ${solicitud.email}`);
                        } catch (error) {
                            errors++;
                            results.push(`âŒ ${solicitud.email}: ${error.message}`);
                        }
                    }
                }
                
                showResult('maintenance-result', 
                    `ğŸ“Š SincronizaciÃ³n completada\n\n` +
                    `âœ… Sincronizadas: ${synced}\n` +
                    `âŒ Errores: ${errors}\n\n` +
                    `Detalles:\n${results.join('\n')}`
                );
                
                if (synced > 0) {
                    // Limpiar solicitudes locales sincronizadas
                    const remaining = localSolicitudes.filter(s => !s.id.startsWith('LOCAL-'));
                    localStorage.setItem('hospital_access_requests', JSON.stringify(remaining));
                }
                
            } catch (error) {
                showResult('maintenance-result', `âŒ Error: ${error.message}`);
            }
        }

        // EstadÃ­sticas
        async function getStatistics() {
            showResult('stats-result', 'â³ Obteniendo estadÃ­sticas...');
            
            try {
                const stats = await api.getAdvancedStatistics();
                const cloudSolicitudes = await api.getSolicitudesAcceso();
                const localData = localStorage.getItem('hospital_access_requests');
                const localSolicitudes = localData ? JSON.parse(localData) : [];
                
                showResult('stats-result', 
                    `ğŸ“Š ESTADÃSTICAS DEL SISTEMA\n\n` +
                    `ğŸ” SOLICITUDES DE ACCESO:\n` +
                    `  â˜ï¸ En Cloud: ${cloudSolicitudes.length}\n` +
                    `  ğŸ’¾ En Local: ${localSolicitudes.length}\n` +
                    `  ğŸ“Š Pendientes: ${cloudSolicitudes.filter(s => s.estado === 'PENDIENTE').length}\n` +
                    `  âœ… Aprobadas: ${cloudSolicitudes.filter(s => s.estado === 'APROBADA').length}\n` +
                    `  âŒ Rechazadas: ${cloudSolicitudes.filter(s => s.estado === 'RECHAZADA').length}\n\n` +
                    `ğŸ“‹ SOLICITUDES DE MANTENIMIENTO:\n` +
                    `  Total: ${stats.solicitudes.total}\n` +
                    `  Pendientes: ${stats.solicitudes.pendientes}\n` +
                    `  Asignadas: ${stats.solicitudes.asignadas}\n` +
                    `  En Proceso: ${stats.solicitudes.enProceso}\n` +
                    `  Completadas: ${stats.solicitudes.completadas}\n\n` +
                    `ğŸ‘¥ PERSONAL:\n` +
                    `  Total: ${stats.tecnicos.total}\n` +
                    `  Disponibles: ${stats.tecnicos.disponibles}\n` +
                    `  Ocupados: ${stats.tecnicos.ocupados}\n\n` +
                    `ğŸ‘¤ USUARIOS:\n` +
                    `  Total: ${stats.usuarios.total}\n` +
                    `  Activos: ${stats.usuarios.activos}\n\n` +
                    `ğŸ• Generado: ${new Date(stats.timestamp).toLocaleString()}`
                );
            } catch (error) {
                showResult('stats-result', `âŒ Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>