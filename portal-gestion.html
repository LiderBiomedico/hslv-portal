<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Portal de Gestión Cloud - Hospital Susana López de Valencia</title>
<!-- Agregar Chart.js para gráficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Agregar jsPDF para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .developer-credit {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
            margin-top: 0.25rem;
            margin-bottom: 0;
            text-align: center;
            font-style: italic;
        }

        /* Indicador de conexión Airtable */
        .connection-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(34, 197, 94, 0.3);
            color: #dcfce7;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.3);
            color: #fee2e2;
        }

        .connection-status.fallback {
            background: rgba(245, 158, 11, 0.3);
            color: #fef3c7;
        }

        /* Auto-refresh indicator */
        .auto-refresh-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(59, 130, 246, 0.3);
            color: #dbeafe;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-refresh-indicator.active {
            background: rgba(34, 197, 94, 0.3);
            color: #dcfce7;
        }

        .refresh-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            position: absolute;
            top: 4rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: rgba(255,255,255,0.1);
            border: none;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            color: white;
            backdrop-filter: blur(10px);
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .metric-card.total { 
            border-top-color: #2563eb; 
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }
        .metric-card.biomedica { 
            border-top-color: #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #dcfce7 100%);
        }
        .metric-card.mecanica { 
            border-top-color: #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
        }
        .metric-card.infraestructura { 
            border-top-color: #8b5cf6; 
            background: linear-gradient(135deg, #ffffff 0%, #ede9fe 100%);
        }
        .metric-card.pendientes { 
            border-top-color: #ef4444; 
            background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
        }
        .metric-card.asignadas { 
            border-top-color: #0ea5e9; 
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* Botones */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Solicitudes Card - Mejorado */
        .request-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            position: relative;
        }

        .request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .request-card.pending {
            border-left: 6px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .request-card.assigned {
            border-left: 6px solid #0ea5e9;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .request-card.in-progress {
            border-left: 6px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .request-card.completed {
            border-left: 6px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .request-card.overdue {
            border-left: 6px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            animation: pulse-overdue 2s infinite;
        }

        @keyframes pulse-overdue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .request-number {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .request-area-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-biomedica {
            background: #dcfce7;
            color: #166534;
        }

        .badge-mecanica {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-infraestructura {
            background: #ede9fe;
            color: #7c3aed;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .request-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .request-detail-value {
            color: #1f2937;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-asignada {
            background: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-en-proceso {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-completada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-cancelada {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-aprobada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-rechazada {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-critica {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse-critical 1.5s infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .priority-alta {
            background: #fed7aa;
            color: #ea580c;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-media {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-baja {
            background: #d1fae5;
            color: #059669;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .time-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            font-size: 0.75rem;
            text-align: center;
            min-width: 100px;
        }

        .time-indicator.overdue {
            background: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
        }

        .time-indicator.warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #d97706;
        }

        .time-indicator.ok {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        /* Solicitudes de Acceso */
        .access-request-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .access-request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .access-request-card.pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .access-request-card.approved {
            border-left: 4px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .access-request-card.rejected {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .request-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        /* Modal grande para estadísticas */
        .modal-content.modal-lg {
            max-width: 1200px;
            width: 95%;
        }

        /* Formularios en modales */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Filtros */
        .filters-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        /* Estilos para estadísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-card-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .stat-card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-card-description {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }

        .table-responsive {
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .stats-table tr:hover {
            background: #f8fafc;
        }

        /* Pestañas de análisis temporal */
        .analysis-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .analysis-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .analysis-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .analysis-tab:hover:not(.active) {
            color: #374151;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .connection-status {
                position: static;
                margin-bottom: 1rem;
            }
            
            .auto-refresh-indicator {
                position: static;
                margin-top: 1rem;
                justify-content: center;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }

            .request-actions {
                flex-direction: column;
            }

            .request-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .time-indicator {
                position: static;
                margin-top: 1rem;
                width: 100%;
            }
        }

        @media print {
            body {
                background: white;
            }
            
            .header, .nav-tabs, .btn, .modal-close, .filters-section {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #e5e7eb;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
<div class="header-content container">
<!-- Indicador de conexión Airtable -->
<div class="connection-status disconnected" id="connection-status">
<span id="connection-icon">🔄</span>
<span id="connection-text">Conectando...</span>
</div>
<!-- Indicador de auto-refresh -->
<div class="auto-refresh-indicator" id="auto-refresh-indicator">
<span class="refresh-spinner"></span>
<span id="refresh-text">Auto-refresh activo</span>
<span id="refresh-countdown">(5s)</span>
</div>
<div class="logo">
<div class="hospital-info">
<h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
<p class="developer-credit" style="display:none!important">Desarrollado por Ing. Paul Eduardo Muñoz R.</p>
<p>Portal de Gestión Cloud - Sistema con Análisis Mensual, Trimestral y Desempeño por Técnico</p>
</div>
</div>
<nav class="nav-tabs">
<button class="nav-tab active" data-view="dashboard" onclick="showView('dashboard')">
                    📊 Dashboard
                </button>
<button class="nav-tab" data-view="solicitudes" onclick="showView('solicitudes')">
                    📋 Solicitudes (<span id="total-count">-</span>)
                </button>
<button class="nav-tab" data-view="personal" onclick="showView('personal')">
                    👥 Personal de Soporte (<span id="total-technicians-nav">-</span>)
                </button>
<button class="nav-tab" data-view="accesos" onclick="showView('accesos')">
                    🔐 Accesos (<span id="pending-access-count">-</span>)
                </button>
</nav>
<div class="user-info">
<button class="notification-btn" onclick="showNotifications()">
                    🔔
                    <span class="notification-badge" id="notification-count">-</span>
</button>
</div>
</div>
</header>
<!-- Main Content -->
<main class="main-layout container">
<!-- Dashboard View -->
<div class="view" id="dashboard-view">
<!-- Alert de conexión -->
<div class="alert alert-info" id="connection-alert">
<h3 style="font-weight: 600; margin-bottom: 0.5rem;display:none!important">🌐 Sistema Cloud con Análisis Mensual y Trimestral</h3>
<ul style="margin: 0.5rem 0 0 1rem;">
</ul>
<div style="margin-top: 1rem;">
<button class="btn btn-primary btn-sm" onclick="testCloudConnection()">
                        🧪 Probar Conexión
                    </button>
<button class="btn btn-success btn-sm" onclick="autoAssignAllPending()" style="display:none;">
                        🤖 Auto-asignar Todo
                    </button>
<button class="btn btn-warning btn-sm" onclick="showAdvancedStatisticsModal()">
                        📊 Estadísticas Avanzadas
                    </button>
<button class="btn btn-info btn-sm" onclick="showTechnicianPerformanceModal()">
                        🏆 Desempeño por Técnico
                    </button>
<button class="btn btn-secondary btn-sm" onclick="toggleAutoRefresh()" style="display:none;">
<span id="auto-refresh-toggle-text">⏸️ Pausar Auto-Refresh</span>
</button>
</div>
</div>
<!-- Metrics mejorados con asignaciones -->
<div class="metrics-grid">
<div class="metric-card total" onclick="filterByArea('all')">
<div class="metric-icon">📋</div>
<div class="metric-number" id="metric-total">-</div>
<div class="metric-label">Total Solicitudes</div>
</div>
<div class="metric-card pendientes" onclick="filterByStatus('PENDIENTE')">
<div class="metric-icon">⏳</div>
<div class="metric-number" id="metric-pendientes">-</div>
<div class="metric-label">Pendientes</div>
</div>
<div class="metric-card asignadas" onclick="filterByStatus('ASIGNADA')">
<div class="metric-icon">🎯</div>
<div class="metric-number" id="metric-asignadas">-</div>
<div class="metric-label">Asignadas</div>
</div>
<div class="metric-card biomedica" onclick="filterByArea('INGENIERIA_BIOMEDICA')">
<div class="metric-icon">🏥</div>
<div class="metric-number" id="metric-biomedica">-</div>
<div class="metric-label">Ing. Biomédica</div>
</div>
<div class="metric-card mecanica" onclick="filterByArea('MECANICA')">
<div class="metric-icon">⚙️</div>
<div class="metric-number" id="metric-mecanica">-</div>
<div class="metric-label">Mecánica</div>
</div>
<div class="metric-card infraestructura" onclick="filterByArea('INFRAESTRUCTURA')">
<div class="metric-icon">🏗️</div>
<div class="metric-number" id="metric-infraestructura">-</div>
<div class="metric-label">Infraestructura</div>
</div>
</div>
<!-- Resumen de Personal por Área -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
<div class="card">
<div class="card-header">
<h2 class="card-title">🏥 Personal Biomédica</h2>
<span class="status-disponible" id="biomedica-personnel-count">- registrados</span>
</div>
<div class="card-content">
<div id="biomedica-personnel-summary">
<p style="color: #6b7280; text-align: center;">Cargando datos...</p>
</div>
</div>
</div>
<div class="card">
<div class="card-header">
<h2 class="card-title">⚙️ Personal Mecánica</h2>
<span class="status-disponible" id="mecanica-personnel-count">- registrados</span>
</div>
<div class="card-content">
<div id="mecanica-personnel-summary">
<p style="color: #6b7280; text-align: center;">Cargando datos...</p>
</div>
</div>
</div>
<div class="card">
<div class="card-header">
<h2 class="card-title">🏗️ Personal Infraestructura</h2>
<span class="status-disponible" id="infraestructura-personnel-count">- registrados</span>
</div>
<div class="card-content">
<div id="infraestructura-personnel-summary">
<p style="color: #6b7280; text-align: center;">Cargando datos...</p>
</div>
</div>
</div>
</div>
</div>
<!-- Solicitudes View - Mejorado con Asignación -->
<div class="view hidden" id="solicitudes-view">
<div class="card">
<div class="card-header">
<h2 class="card-title">📋 Gestión de Solicitudes con Asignación</h2>
<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
<button class="btn btn-success btn-sm" onclick="refreshFromCloud()">
                            🔄 Actualizar
                        </button>
<button class="btn btn-primary btn-sm" onclick="autoAssignPending()">
                            🤖 Auto-asignar
                        </button>
<button class="btn btn-warning btn-sm" onclick="showRequestsStatistics()">
                            📊 Estadísticas
                        </button>
</div>
</div>
<div class="card-content">
<!-- Filtros de Solicitudes -->
<div class="filters-section">
<h4 style="color: #1f2937; margin-bottom: 1rem;">🔍 Filtros de Solicitudes</h4>
<div class="filters-grid">
<div>
<label class="form-label">Estado:</label>
<select class="form-select" id="filter-estado-solicitud" onchange="filterSolicitudes()">
<option value="">Todos los estados</option>
<option value="PENDIENTE">⏳ Pendiente</option>
<option value="ASIGNADA">🎯 Asignada</option>
<option value="EN_PROCESO">🔄 En Proceso</option>
<option value="COMPLETADA">✅ Completada</option>
<option value="CANCELADA">❌ Cancelada</option>
</select>
</div>
<div>
<label class="form-label">Área:</label>
<select class="form-select" id="filter-area-solicitud" onchange="filterSolicitudes()">
<option value="">Todas las áreas</option>
<option value="INGENIERIA_BIOMEDICA">🏥 Ing. Biomédica</option>
<option value="MECANICA">⚙️ Mecánica</option>
<option value="INFRAESTRUCTURA">🏗️ Infraestructura</option>
</select>
</div>
<div>
<label class="form-label">Prioridad:</label>
<select class="form-select" id="filter-prioridad-solicitud" onchange="filterSolicitudes()">
<option value="">Todas las prioridades</option>
<option value="CRITICA">🚨 Crítica</option>
<option value="ALTA">🔴 Alta</option>
<option value="MEDIA">🟡 Media</option>
<option value="BAJA">🟢 Baja</option>
</select>
</div>
<div>
<button class="btn btn-secondary btn-sm" onclick="clearSolicitudesFilters()" style="width: 100%;">
                                    🗑️ Limpiar Filtros
                                </button>
</div>
</div>
</div>
<div id="solicitudes-list">
<div style="text-align: center; padding: 3rem; color: #6b7280;">
<div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
<h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando solicitudes desde Airtable...</h3>
<p>Conectando con la base de datos en la nube</p>
</div>
</div>
</div>
</div>
</div>
<!-- Personal de Soporte View (mantenido igual) -->
<div class="view hidden" id="personal-view">
<div class="card">
<div class="card-header">
<h2 class="card-title">👥 Gestión de Personal de Soporte (Cloud)</h2>
<div style="display: flex; gap: 0.5rem;">
<button class="btn btn-success btn-sm" onclick="showAddPersonalModal()">
                            ➕ Agregar Personal
                        </button>
<button class="btn btn-primary btn-sm" onclick="syncTechniciansWithCloud()">
                            🔄 Sincronizar con Airtable
                        </button>
<button class="btn btn-warning btn-sm" onclick="showPersonalStatistics()">
                            📊 Estadísticas
                        </button>
<button class="btn btn-info btn-sm" onclick="showTechnicianPerformanceModal()">
                            🏆 Desempeño Detallado
                        </button>
<button class="btn btn-secondary btn-sm" onclick="debugPersonalConnection()">
                            🔧 Debug Conexión
                        </button>
</div>
</div>
<div class="card-content">
<!-- Filtros de Personal -->
<div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border: 1px solid #e5e7eb;">
<h4 style="color: #1f2937; margin-bottom: 1rem;">🔍 Filtros de Personal</h4>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
<div>
<label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Área:</label>
<select id="filter-area" onchange="filterPersonal()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
<option value="">Todas las áreas</option>
<option value="INGENIERIA_BIOMEDICA">Ingeniería Biomédica</option>
<option value="MECANICA">Mecánica</option>
<option value="INFRAESTRUCTURA">Infraestructura</option>
</select>
</div>
<div>
<label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Estado:</label>
<select id="filter-estado" onchange="filterPersonal()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
<option value="">Todos los estados</option>
<option value="disponible">Disponible</option>
<option value="ocupado">Ocupado</option>
<option value="inactivo">Inactivo</option>
</select>
</div>
<div>
<label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Tipo:</label>
<select id="filter-tipo" onchange="filterPersonal()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
<option value="">Todos los tipos</option>
<option value="ingeniero">Ingeniero</option>
<option value="tecnico">Técnico</option>
<option value="auxiliar">Auxiliar</option>
</select>
</div>
<div style="display: flex; align-items: end;">
<button class="btn btn-secondary btn-sm" onclick="clearPersonalFilters()" style="width: 100%;">
                                    🗑️ Limpiar Filtros
                                </button>
</div>
</div>
</div>
<div id="technicians-container">
<div style="text-align: center; padding: 3rem; color: #6b7280;">
<div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
<h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando personal de soporte desde Airtable...</h3>
<p>Conectando con la base de datos en la nube</p>
</div>
</div>
</div>
</div>
</div>
<!-- Vista de Gestión de Accesos (mantenida igual) -->
<div class="view hidden" id="accesos-view">
<div class="card">
<div class="card-header">
<h2 class="card-title">🔐 Gestión de Accesos al Portal</h2>
<div style="display: flex; gap: 0.5rem;">
<button class="btn btn-success btn-sm" onclick="refreshAccessFromCloud()">
                            🔄 Actualizar desde Airtable
                        </button>
<button class="btn btn-warning btn-sm" onclick="approveAllPending()">
                            ✅ Aprobar Todas Pendientes
                        </button>
</div>
</div>
<div class="card-content">
<div class="alert alert-info">
<h4 style="margin-bottom: 0.5rem;">🔐 Gestión de Accesos al Portal</h4>
<p>Desde aquí puedes aprobar solicitudes de acceso al Portal de Solicitudes. Al aprobar una solicitud:</p>
<ul style="margin: 0.5rem 0 0 1rem;">
<li>✅ Se genera automáticamente un <strong>código de 4 dígitos único</strong></li>
<li>👤 Se crea el usuario en la tabla de usuarios</li>
<li>📧 El usuario podrá ingresar con su <strong>email + código</strong> al Portal de Solicitudes</li>
</ul>
</div>
<div id="access-requests-container">
<div style="text-align: center; padding: 3rem; color: #6b7280;">
<div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
<h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando solicitudes de acceso desde Airtable...</h3>
<p>Conectando con la base de datos en la nube</p>
</div>
</div>
</div>
</div>
</div>
</main>
<!-- Modal de Asignación de Personal -->
<div class="modal" id="assignment-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">🎯 Asignar Personal a Solicitud</h3>
<button class="modal-close" onclick="closeAssignmentModal()">×</button>
</div>
<div id="assignment-modal-content">
<!-- Contenido dinámico del modal -->
</div>
</div>
</div>
<!-- Modal de Cambio de Estado -->
<div class="modal" id="status-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">🔄 Cambiar Estado de Solicitud</h3>
<button class="modal-close" onclick="closeStatusModal()">×</button>
</div>
<div id="status-modal-content">
<!-- Contenido dinámico del modal -->
</div>
</div>
</div>
<!-- Modal de Confirmación de Aprobación -->
<div class="modal" id="approval-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">✅ Confirmar Aprobación</h3>
<button class="modal-close" onclick="closeApprovalModal()">×</button>
</div>
<div id="approval-modal-content">
<!-- Contenido dinámico del modal -->
</div>
</div>
</div>
<!-- Modal de Resultado -->
<div class="modal" id="result-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title" id="result-modal-title">Resultado</h3>
<button class="modal-close" onclick="closeResultModal()">×</button>
</div>
<div id="result-modal-content">
<!-- Contenido dinámico del modal -->
</div>
</div>
</div>
<!-- Modal para Agregar Personal -->
<div class="modal" id="add-personal-modal">
<div class="modal-content" style="max-width: 600px;">
<div class="modal-header">
<h3 class="modal-title">➕ Agregar Personal de Soporte</h3>
<button class="modal-close" onclick="closeAddPersonalModal()">×</button>
</div>
<div id="add-personal-content">
<form id="add-personal-form">
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
<div>
<label class="form-label">👤 Nombre Completo *</label>
<input class="form-input" id="personal-nombre" placeholder="Nombres y apellidos" required="" type="text"/>
</div>
<div>
<label class="form-label">📧 Email *</label>
<input class="form-input" id="personal-email" placeholder="correo@hospital.com" required="" type="email"/>
</div>
<div>
<label class="form-label">🏥 Área de Trabajo *</label>
<select class="form-select" id="personal-area" required="">
<option value="">Seleccione área</option>
<option value="INGENIERIA_BIOMEDICA">Ingeniería Biomédica</option>
<option value="MECANICA">Mecánica</option>
<option value="INFRAESTRUCTURA">Infraestructura</option>
</select>
</div>
<div>
<label class="form-label">👨‍💼 Tipo de Personal *</label>
<select class="form-select" id="personal-tipo" required="">
<option value="">Seleccione tipo</option>
<option value="ingeniero">🎓 Ingeniero</option>
<option value="tecnico">🔧 Técnico</option>
<option value="auxiliar">🛠️ Auxiliar</option>
</select>
</div>
<div>
<label class="form-label">⚙️ Especialidad</label>
<input class="form-input" id="personal-especialidad" placeholder="Especialidad o certificaciones" type="text"/>
</div>
<div>
<label class="form-label">📊 Estado Inicial</label>
<select class="form-select" id="personal-estado">
<option value="disponible">🟢 Disponible</option>
<option value="ocupado">🟡 Ocupado</option>
<option value="inactivo">🔴 Inactivo</option>
</select>
</div>
</div>
<div style="background: #f0f9ff; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; border-left: 3px solid #3b82f6;">
<h5 style="color: #1e40af; margin-bottom: 0.5rem;">💡 Información Importante</h5>
<ul style="color: #1e3a8a; margin: 0; padding-left: 1rem; font-size: 0.875rem;">
<li>El personal registrado podrá ser asignado a solicitudes de mantenimiento</li>
<li>Los datos se guardan automáticamente en Airtable</li>
<li>El estado puede cambiarse posteriormente</li>
<li>La especialidad ayuda en la asignación adecuada de tareas</li>
</ul>
</div>
<div style="display: flex; gap: 0.5rem; justify-content: center;">
<button class="btn btn-success" style="min-width: 150px;" type="submit">
                            💾 Guardar Personal
                        </button>
<button class="btn btn-secondary" onclick="closeAddPersonalModal()" style="min-width: 120px;" type="button">
                            ↩️ Cancelar
                        </button>
</div>
</form>
</div>
</div>
</div>
<!-- Modal para Editar Personal -->
<div class="modal" id="edit-personal-modal">
<div class="modal-content" style="max-width: 500px;">
<div class="modal-header">
<h3 class="modal-title">✏️ Editar Personal de Soporte</h3>
<button class="modal-close" onclick="closeEditPersonalModal()">×</button>
</div>
<div id="edit-personal-content">
<!-- Contenido dinámico del modal de edición -->
</div>
</div>
</div>
<!-- Modal de Estadísticas Avanzadas -->
<div class="modal" id="stats-modal">
<div class="modal-content modal-lg">
<div class="modal-header">
<h3 class="modal-title">📊 Estadísticas Avanzadas del Sistema</h3>
<button class="modal-close" onclick="closeStatsModal()">×</button>
</div>
<div id="stats-modal-content">
<!-- Contenido dinámico de estadísticas -->
</div>
</div>
</div>
<!-- NUEVO: Modal de Desempeño por Técnico -->
<div class="modal" id="technician-performance-modal">
<div class="modal-content modal-lg">
<div class="modal-header">
<h3 class="modal-title">🏆 Análisis de Desempeño por Técnico</h3>
<button class="modal-close" onclick="closeTechnicianPerformanceModal()">×</button>
</div>
<div id="technician-performance-content">
<!-- Contenido dinámico del desempeño -->
</div>
</div>
</div>
<!-- Incluir el archivo de configuración de Airtable -->
<script src="airtable-config.js"></script>
<script>
        // Variables globales para datos de la nube
        let cloudSolicitudes = [];
        let cloudTecnicos = [];
        let cloudUsuarios = [];
        let cloudSolicitudesAcceso = [];
        let isConnectedToAirtable = false;
        let filteredSolicitudes = [];

        // Variables para auto-refresh
        let autoRefreshInterval = null;
        let autoRefreshCountdown = null;
        let isAutoRefreshActive = true;
        let refreshCountdownValue = 5;

        // Variables para gráficos
        let chartInstances = {};

        // Variables para análisis temporal
        let currentAnalysisView = 'general';

        // 🔗 Funciones de conexión y estado
        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connection-status');
            const iconSpan = document.getElementById('connection-icon');
            const textSpan = document.getElementById('connection-text');
            
            statusDiv.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    iconSpan.textContent = '🟢';
                    textSpan.textContent = 'Airtable Conectado';
                    isConnectedToAirtable = true;
                    break;
                case 'disconnected':
                    iconSpan.textContent = '🔴';
                    textSpan.textContent = 'Sin conexión';
                    isConnectedToAirtable = false;
                    break;
                case 'fallback':
                    iconSpan.textContent = '🟡';
                    textSpan.textContent = 'Modo Local';
                    isConnectedToAirtable = false;
                    break;
                default:
                    iconSpan.textContent = '🔄';
                    textSpan.textContent = message || 'Conectando...';
            }
        }

        // 🔄 Funciones de auto-refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (autoRefreshCountdown) {
                clearInterval(autoRefreshCountdown);
            }

            console.log('🔄 Iniciando auto-refresh cada 5 segundos...');
            
            // Refresh principal cada 5 segundos
            autoRefreshInterval = setInterval(async () => {
                if (isAutoRefreshActive) {
                    console.log('🔄 Auto-refresh ejecutándose...');
                    await loadAllDataFromCloud();
                    resetRefreshCountdown();
                }
            }, 5000);

            // Countdown visual
            startRefreshCountdown();
        }

        function startRefreshCountdown() {
            refreshCountdownValue = 5;
            updateRefreshIndicator();
            
            autoRefreshCountdown = setInterval(() => {
                refreshCountdownValue--;
                updateRefreshIndicator();
                
                if (refreshCountdownValue <= 0) {
                    refreshCountdownValue = 5;
                }
            }, 1000);
        }

        function resetRefreshCountdown() {
            refreshCountdownValue = 5;
            updateRefreshIndicator();
        }

        function updateRefreshIndicator() {
            const indicator = document.getElementById('auto-refresh-indicator');
            const refreshText = document.getElementById('refresh-text');
            const countdown = document.getElementById('refresh-countdown');
            
            if (isAutoRefreshActive) {
                indicator.classList.add('active');
                refreshText.textContent = 'Auto-refresh activo';
                countdown.textContent = `(${refreshCountdownValue}s)`;
            } else {
                indicator.classList.remove('active');
                refreshText.textContent = 'Auto-refresh pausado';
                countdown.textContent = '';
            }
        }

        function toggleAutoRefresh() {
            isAutoRefreshActive = !isAutoRefreshActive;
            const toggleBtn = document.getElementById('auto-refresh-toggle-text');
            
            if (isAutoRefreshActive) {
                toggleBtn.innerHTML = '⏸️ Pausar Auto-Refresh';
                console.log('✅ Auto-refresh reactivado');
                startRefreshCountdown();
            } else {
                toggleBtn.innerHTML = '▶️ Reanudar Auto-Refresh';
                console.log('⏸️ Auto-refresh pausado');
                if (autoRefreshCountdown) {
                    clearInterval(autoRefreshCountdown);
                }
            }
            
            updateRefreshIndicator();
        }

        async function testCloudConnection() {
            updateConnectionStatus('connecting', 'Probando conexión...');
            
            try {
                const isConnected = await window.airtableAPI.testConnection();
                
                if (isConnected) {
                    updateConnectionStatus('connected');
                    alert('✅ Conexión exitosa con Airtable\n\n🌐 El sistema está funcionando en la nube correctamente.\n🔄 Auto-refresh cada 5 segundos activo\n🛡️ Sistema con análisis mensual, trimestral y por técnico\n🏆 Historial de personal preservado');
                } else {
                    updateConnectionStatus('fallback');
                    alert('⚠️ No se pudo conectar con Airtable\n\nEl sistema está usando modo local como respaldo.');
                }
            } catch (error) {
                updateConnectionStatus('disconnected');
                alert('❌ Error de conexión\n\n' + error.message);
            }
        }

        // 🔄 Funciones de carga de datos desde Airtable
        async function loadAllDataFromCloud() {
            console.log('🌐 Cargando todos los datos desde Airtable...');
            
            try {
                updateConnectionStatus('connecting', 'Sincronizando...');
                
                const [solicitudes, tecnicos, usuarios, solicitudesAcceso] = await Promise.all([
                    window.airtableAPI.getSolicitudes(),
                    window.airtableAPI.getTecnicos(),
                    window.airtableAPI.getUsuarios(),
                    window.airtableAPI.getSolicitudesAcceso()
                ]);
                
                cloudSolicitudes = solicitudes;
                cloudTecnicos = tecnicos;
                cloudUsuarios = usuarios;
                cloudSolicitudesAcceso = solicitudesAcceso;
                filteredSolicitudes = [...solicitudes];
                
                console.log(`✅ Datos cargados: ${solicitudes.length} solicitudes, ${tecnicos.length} personal, ${usuarios.length} usuarios, ${solicitudesAcceso.length} solicitudes de acceso`);
                
                updateAccessRequestsList();
        	updateAllCounters();
        	updateAllDisplays();
        	updateConnectionStatus('connected');
                
            } catch (error) {
                console.error('❌ Error cargando datos desde Airtable:', error);
                updateConnectionStatus('fallback');
                loadDataFromLocalStorage();
            }
        }

        function loadDataFromLocalStorage() {
            console.log('📱 Cargando datos desde localStorage (modo fallback)...');
            
            try {
                const localSolicitudes = JSON.parse(localStorage.getItem('hospital_solicitudes') || '[]');
                const localTechnicians = JSON.parse(localStorage.getItem('hospital_technicians') || '{}');
                const localUsers = JSON.parse(localStorage.getItem('hospital_approved_users') || '[]');
                const localAccessRequests = JSON.parse(localStorage.getItem('hospital_access_requests') || '[]');
                
                cloudTecnicos = [];
                Object.entries(localTechnicians).forEach(([area, tecnicosArea]) => {
                    tecnicosArea.forEach(tecnico => {
                        cloudTecnicos.push({
                            ...tecnico,
                            area: area
                        });
                    });
                });
                
                cloudSolicitudes = localSolicitudes;
                cloudUsuarios = localUsers;
                cloudSolicitudesAcceso = localAccessRequests;
                filteredSolicitudes = [...localSolicitudes];
                
                updateAllCounters();
                updateAllDisplays();
                
                console.log('✅ Datos cargados desde localStorage');
                
            } catch (error) {
                console.error('❌ Error cargando desde localStorage:', error);
            }
        }

        // 📊 Actualizar contadores
        function updateAllCounters() {
            // Contadores con detección mejorada de área biomédica
            const total = cloudSolicitudes.length;
            
            // Función helper para detectar área biomédica
            const isBiomedicalArea = (area) => {
                if (!area) return false;
                const lowerArea = area.toLowerCase();
                return area === 'INGENIERIA_BIOMEDICA' || 
                       area === 'Ingeniería Biomédica' ||
                       lowerArea.includes('biomed') || 
                       lowerArea.includes('bioméd');
            };
            
            const biomedica = cloudSolicitudes.filter(r => isBiomedicalArea(r.servicioIngenieria)).length;
            const mecanica = cloudSolicitudes.filter(r => 
                r.servicioIngenieria === 'MECANICA' || 
                r.servicioIngenieria === 'Mecánica' ||
                (r.servicioIngenieria && r.servicioIngenieria.toLowerCase().includes('mec'))
            ).length;
            const infraestructura = cloudSolicitudes.filter(r => 
                r.servicioIngenieria === 'INFRAESTRUCTURA' || 
                r.servicioIngenieria === 'Infraestructura' ||
                (r.servicioIngenieria && r.servicioIngenieria.toLowerCase().includes('infra'))
            ).length;
            
            // Contador de pendientes mejorado
            const pendientes = cloudSolicitudes.filter(r => {
                const estadoUpper = (r.estado || 'PENDIENTE').toUpperCase();
                
                if (estadoUpper === 'COMPLETADA' || estadoUpper === 'CANCELADA') {
                    return false;
                }
                
                return estadoUpper === 'PENDIENTE' || 
                       estadoUpper === 'ASIGNADA' || 
                       !r.tecnicoAsignado;
            }).length;
            
            // Contador de asignadas
            const asignadas = cloudSolicitudes.filter(r => {
                const estadoUpper = (r.estado || '').toUpperCase();
                return estadoUpper === 'ASIGNADA';
            }).length;

            // Actualizar todos los elementos del DOM
            document.getElementById('metric-total').textContent = total;
            document.getElementById('metric-biomedica').textContent = biomedica;
            document.getElementById('metric-mecanica').textContent = mecanica;
            document.getElementById('metric-infraestructura').textContent = infraestructura;
            document.getElementById('metric-pendientes').textContent = pendientes;
            document.getElementById('metric-asignadas').textContent = asignadas;
            document.getElementById('total-count').textContent = total;

            // Contadores de personal
            const totalTechnicians = cloudTecnicos.length;
            const biomedicaTecnicos = cloudTecnicos.filter(t => isBiomedicalArea(t.area)).length;
            const mecanicaTecnicos = cloudTecnicos.filter(t => 
                t.area === 'MECANICA' || 
                t.area === 'Mecánica' ||
                (t.area && t.area.toLowerCase().includes('mec'))
            ).length;
            const infraestructuraTecnicos = cloudTecnicos.filter(t => 
                t.area === 'INFRAESTRUCTURA' || 
                t.area === 'Infraestructura' ||
                (t.area && t.area.toLowerCase().includes('infra'))
            ).length;

            document.getElementById('total-technicians-nav').textContent = totalTechnicians;
            document.getElementById('biomedica-personnel-count').textContent = `${biomedicaTecnicos} registrados`;
            document.getElementById('mecanica-personnel-count').textContent = `${mecanicaTecnicos} registrados`;
            document.getElementById('infraestructura-personnel-count').textContent = `${infraestructuraTecnicos} registrados`;

            // Contadores de accesos
            const pendingAccess = cloudSolicitudesAcceso.filter(s => s.estado === 'PENDIENTE' || s.estado === 'Pendiente' || !s.estado).length;
            document.getElementById('pending-access-count').textContent = pendingAccess;
            
            document.getElementById('notification-count').textContent = pendingAccess + pendientes;

            console.log(`📊 Contadores actualizados: ${total} solicitudes, ${pendientes} pendientes, ${totalTechnicians} personal`);
        }

        function updateAllDisplays() {
            updatePersonnelSummaries();
            updateSolicitudesList();
            updateTechniciansList();
            updateAccessRequestsList();
        }

        // Actualizar resúmenes de personal
        function updatePersonnelSummaries() {
            const areas = [
                { key: 'INGENIERIA_BIOMEDICA', name: 'biomedica' },
                { key: 'MECANICA', name: 'mecanica' },
                { key: 'INFRAESTRUCTURA', name: 'infraestructura' }
            ];

            areas.forEach(area => {
                let personnel;
                if (area.key === 'INGENIERIA_BIOMEDICA') {
                    personnel = cloudTecnicos.filter(t => {
                        if (!t.area) return false;
                        const lowerArea = t.area.toLowerCase();
                        return t.area === 'INGENIERIA_BIOMEDICA' || 
                               t.area === 'Ingeniería Biomédica' ||
                               lowerArea.includes('biomed') || 
                               lowerArea.includes('bioméd');
                    });
                } else if (area.key === 'MECANICA') {
                    personnel = cloudTecnicos.filter(t => 
                        t.area === 'MECANICA' || 
                        t.area === 'Mecánica' ||
                        (t.area && t.area.toLowerCase().includes('mec'))
                    );
                } else if (area.key === 'INFRAESTRUCTURA') {
                    personnel = cloudTecnicos.filter(t => 
                        t.area === 'INFRAESTRUCTURA' || 
                        t.area === 'Infraestructura' ||
                        (t.area && t.area.toLowerCase().includes('infra'))
                    );
                } else {
                    personnel = cloudTecnicos.filter(t => t.area === area.key);
                }
                
                const summaryContainer = document.getElementById(`${area.name}-personnel-summary`);
                
                if (personnel.length === 0) {
                    summaryContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No hay personal registrado</p>';
                } else {
                    const available = personnel.filter(p => String(p.estado || '').toLowerCase() === 'disponible').length;
                    const busy = personnel.filter(p => String(p.estado || '').toLowerCase() === 'ocupado').length;
                    const inactive = personnel.filter(p => String(p.estado || '').toLowerCase() === 'inactivo').length;
                    
                    summaryContainer.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; text-align: center;">
                            <div>
                                <div style="font-weight: bold; color: #059669;">${available}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Disponibles</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #f59e0b;">${busy}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Ocupados</div>
                            </div>
                            <div>
                                <div style="font-weight: bold; color: #ef4444;">${inactive}</div>
                                <div style="font-size: 0.75rem; color: #6b7280;">Inactivos</div>
                            </div>
                        </div>
                    `;
                }
            });
        }

        // 🔄 Funciones de sincronización específicas
        async function refreshFromCloud() {
            console.log('🔄 Actualizando solicitudes desde Airtable...');
            
            try {
                cloudSolicitudes = await window.airtableAPI.getSolicitudes();
                filteredSolicitudes = [...cloudSolicitudes];
                updateSolicitudesList();
                updateAllCounters();
                
                alert(`✅ Solicitudes actualizadas desde Airtable\n\n📊 Total: ${cloudSolicitudes.length} solicitudes\n🔄 Auto-refresh: ${isAutoRefreshActive ? 'Activo' : 'Pausado'}\n🕐 ${new Date().toLocaleTimeString('es-CO')}`);
                
            } catch (error) {
                console.error('❌ Error actualizando solicitudes:', error);
                alert('❌ Error al actualizar desde Airtable. Verificar conexión.');
            }
        }

        async function syncTechniciansWithCloud() {
            console.log('🔄 Sincronizando personal de soporte con Airtable...');
            
            try {
                cloudTecnicos = await window.airtableAPI.getTecnicos();
                updateTechniciansList();
                updateAllCounters();
                updatePersonnelSummaries();
                
                alert(`✅ Personal de soporte sincronizado con Airtable\n\n📊 Total: ${cloudTecnicos.length} personas\n🔄 Auto-refresh: ${isAutoRefreshActive ? 'Activo' : 'Pausado'}\n🕐 ${new Date().toLocaleTimeString('es-CO')}`);
                
            } catch (error) {
                console.error('❌ Error sincronizando personal:', error);
                alert('❌ Error al sincronizar con Airtable. Verificar conexión.');
            }
        }

        async function refreshAccessFromCloud() {
            console.log('🔄 Actualizando accesos desde Airtable...');
            
            try {
                cloudSolicitudesAcceso = await window.airtableAPI.getSolicitudesAcceso();
                cloudUsuarios = await window.airtableAPI.getUsuarios();
                updateAccessRequestsList();
                updateAllCounters();
                
                alert(`✅ Accesos actualizados desde Airtable\n\n📊 Solicitudes: ${cloudSolicitudesAcceso.length}\n📊 Usuarios: ${cloudUsuarios.length}\n🔄 Auto-refresh: ${isAutoRefreshActive ? 'Activo' : 'Pausado'}\n🕐 ${new Date().toLocaleTimeString('es-CO')}`);
                
            } catch (error) {
                console.error('❌ Error actualizando accesos:', error);
                alert('❌ Error al actualizar desde Airtable. Verificar conexión.');
            }
        }

        // 📋 Funciones de actualización de listas mejoradas con asignación
        function updateSolicitudesList() {
            const container = document.getElementById('solicitudes-list');
            
            if (filteredSolicitudes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">📋</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes registradas</h3>
                        <p>Las solicitudes aparecerán aquí cuando se creen desde el Portal de Solicitudes</p>
                    </div>
                `;
            } else {
                const solicitudesSorted = [...filteredSolicitudes].sort((a, b) => {
                    // Ordenar por prioridad y fecha
                    const prioridadOrder = { 'CRITICA': 4, 'Crítica': 4, 'ALTA': 3, 'Alta': 3, 'MEDIA': 2, 'Media': 2, 'BAJA': 1, 'Baja': 1 };
                    const aPrio = prioridadOrder[a.prioridad] || 1;
                    const bPrio = prioridadOrder[b.prioridad] || 1;
                    
                    if (aPrio !== bPrio) return bPrio - aPrio;
                    
                    return new Date(b.fechaCreacion || 0) - new Date(a.fechaCreacion || 0);
                });

                container.innerHTML = `
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">✅ ${filteredSolicitudes.length} Solicitudes Cargadas desde Airtable</h4>
                        <p style="color: #047857; font-size: 0.875rem;">
                            Sistema con historial de personal preservado - 
                            🔄 Auto-refresh: ${isAutoRefreshActive ? 'Activo' : 'Pausado'} | 
                            Última actualización: ${new Date().toLocaleTimeString('es-CO')}
                        </p>
                    </div>
                    ${solicitudesSorted.map(solicitud => createSolicitudCard(solicitud)).join('')}
                `;
            }
        }

        function createSolicitudCard(solicitud) {
            const getStatusClass = (status) => {
                const normalizedStatus = status ? status.toUpperCase() : 'PENDIENTE';
                const statusMap = {
                    'PENDIENTE': 'pending',
                    'ASIGNADA': 'assigned',
                    'EN_PROCESO': 'in-progress',
                    'EN PROCESO': 'in-progress',
                    'COMPLETADA': 'completed',
                    'CANCELADA': 'cancelled'
                };
                return statusMap[normalizedStatus] || 'pending';
            };

            const getStatusBadge = (status) => {
                const normalizedStatus = status ? status.toUpperCase() : 'PENDIENTE';
                const badges = {
                    'PENDIENTE': 'status-pendiente',
                    'ASIGNADA': 'status-asignada',
                    'EN_PROCESO': 'status-en-proceso',
                    'EN PROCESO': 'status-en-proceso',
                    'COMPLETADA': 'status-completada',
                    'CANCELADA': 'status-cancelada'
                };
                return badges[normalizedStatus] || 'status-pendiente';
            };

            const getPriorityBadge = (priority) => {
                const normalizedPriority = priority ? priority.toUpperCase() : 'MEDIA';
                const badges = {
                    'CRITICA': 'priority-critica',
                    'CRÍTICA': 'priority-critica',
                    'ALTA': 'priority-alta',
                    'MEDIA': 'priority-media',
                    'BAJA': 'priority-baja'
                };
                return badges[normalizedPriority] || 'priority-media';
            };

            const getAreaBadge = (area) => {
                if (!area) return 'badge-biomedica';
                
                const lowerArea = area.toLowerCase();
                if (area === 'INGENIERIA_BIOMEDICA' || 
                    area === 'Ingeniería Biomédica' ||
                    lowerArea.includes('biomed') || 
                    lowerArea.includes('bioméd')) {
                    return 'badge-biomedica';
                } else if (area === 'MECANICA' || area === 'Mecánica' || lowerArea.includes('mec')) {
                    return 'badge-mecanica';
                } else if (area === 'INFRAESTRUCTURA' || area === 'Infraestructura' || lowerArea.includes('infra')) {
                    return 'badge-infraestructura';
                }
                
                return 'badge-biomedica';
            };

            const getAreaName = (area) => {
                if (!area) return 'Sin área';
                
                const lowerArea = area.toLowerCase();
                if (area === 'INGENIERIA_BIOMEDICA' || 
                    area === 'Ingeniería Biomédica' ||
                    lowerArea.includes('biomed') || 
                    lowerArea.includes('bioméd')) {
                    return '🏥 Biomédica';
                } else if (area === 'MECANICA' || area === 'Mecánica' || lowerArea.includes('mec')) {
                    return '⚙️ Mecánica';
                } else if (area === 'INFRAESTRUCTURA' || area === 'Infraestructura' || lowerArea.includes('infra')) {
                    return '🏗️ Infraestructura';
                }
                
                return area;
            };

            // Calcular tiempo transcurrido y estado
            const fechaCreacion = solicitud.fechaCreacion ? new Date(solicitud.fechaCreacion) : new Date();
            const ahora = new Date();
            const tiempoTranscurrido = ahora - fechaCreacion;
            const horasTranscurridas = Math.floor(tiempoTranscurrido / (1000 * 60 * 60));
            const minutosTranscurridos = Math.floor((tiempoTranscurrido % (1000 * 60 * 60)) / (1000 * 60));

            // Determinar estado del tiempo
            let timeIndicatorClass = 'ok';
            let timeText = `${horasTranscurridas}h ${minutosTranscurridos}m`;

            const estadoUpper = solicitud.estado ? solicitud.estado.toUpperCase() : '';
            if (solicitud.tiempoRespuestaMaximo && estadoUpper !== 'COMPLETADA' && estadoUpper !== 'CANCELADA') {
                const fechaMaxima = new Date(solicitud.tiempoRespuestaMaximo);
                if (ahora > fechaMaxima) {
                    timeIndicatorClass = 'overdue';
                    timeText = '⚠️ VENCIDA';
                } else {
                    const tiempoRestante = fechaMaxima - ahora;
                    const horasRestantes = Math.floor(tiempoRestante / (1000 * 60 * 60));
                    if (horasRestantes < 2) {
                        timeIndicatorClass = 'warning';
                        timeText = `⚠️ ${horasRestantes}h restantes`;
                    } else {
                        timeText = `✅ ${horasRestantes}h restantes`;
                    }
                }
            }

            const cardClass = `request-card ${getStatusClass(solicitud.estado)} ${timeIndicatorClass === 'overdue' ? 'overdue' : ''}`;

            // Mostrar si es error de usuario
            const isErrorUsuario = solicitud.tipoServicio === 'ERROR_USUARIO' || solicitud.tipoServicio === 'Error de Usuario';
            const tipoServicioBadge = isErrorUsuario ? 
                '<span style="background: #fee2e2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">👤 ERROR DE USUARIO</span>' : '';

            // IMPORTANTE: Mostrar el personal asignado siempre, incluso en solicitudes completadas
            const personalDisplay = solicitud.tecnicoAsignado ? 
                `<span style="color: #059669; font-weight: 600;">${solicitud.tecnicoAsignado}</span>` : 
                '<span style="color: #f59e0b;">Sin asignar</span>';

            return `
                <div class="${cardClass}">
                    <div class="time-indicator ${timeIndicatorClass}">
                        <div style="font-weight: bold;">${timeText}</div>
                        <div style="font-size: 0.65rem; margin-top: 0.25rem;">
                            ${horasTranscurridas}h ${minutosTranscurridos}m transcurridas
                        </div>
                    </div>

                    <div class="request-header">
                        <div class="request-number">
                            📋 ${solicitud.numero || 'SIN-NÚMERO'}
                            <span class="request-area-badge ${getAreaBadge(solicitud.servicioIngenieria)}">
                                ${getAreaName(solicitud.servicioIngenieria)}
                            </span>
                            ${tipoServicioBadge}
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <span class="${getStatusBadge(solicitud.estado)}">${solicitud.estado || 'PENDIENTE'}</span>
                            <span class="${getPriorityBadge(solicitud.prioridad)}">${solicitud.prioridad || 'MEDIA'}</span>
                        </div>
                    </div>
                    
                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">🔨 Tipo de Servicio</div>
                            <div class="request-detail-value" ${isErrorUsuario ? 'style="color: #dc2626; font-weight: 600;"' : ''}>
                                ${solicitud.tipoServicio?.replace('_', ' ') || 'No especificado'}
                            </div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">🖥️ Equipo</div>
                            <div class="request-detail-value">${solicitud.equipo || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📍 Ubicación</div>
                            <div class="request-detail-value">${solicitud.ubicacion || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">👤 Solicitante</div>
                            <div class="request-detail-value">${solicitud.solicitante || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">📅 Fecha de Solicitud</div>
                            <div class="request-detail-value">${solicitud.fechaCreacion ? new Date(solicitud.fechaCreacion).toLocaleString('es-CO') : 'No disponible'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">👨‍🔧 Personal ${estadoUpper === 'COMPLETADA' ? 'que Realizó' : 'Asignado'}</div>
                            <div class="request-detail-value">${personalDisplay}</div>
                        </div>
                    </div>

                    <div style="margin: 1rem 0; padding: 1rem; background: #f8fafc; border-radius: 0.5rem; border-left: 3px solid #2563eb;">
                        <div class="request-detail-label">📝 Descripción del Problema</div>
                        <div style="margin-top: 0.5rem; color: #1f2937;">${solicitud.descripcion || 'No especificada'}</div>
                        ${solicitud.observaciones ? `<div style="margin-top: 0.5rem; font-style: italic; color: #6b7280;"><strong>Observaciones:</strong> ${solicitud.observaciones}</div>` : ''}
                        ${solicitud.observacionesAsignacion ? `<div style="margin-top: 0.5rem; color: #059669;"><strong>Observaciones de Asignación:</strong> ${solicitud.observacionesAsignacion}</div>` : ''}
                        ${solicitud.tiempoTotalRespuesta && estadoUpper === 'COMPLETADA' ? `<div style="margin-top: 0.5rem; color: #2563eb;"><strong>⏱️ Tiempo Total de Respuesta:</strong> ${solicitud.tiempoTotalRespuesta}</div>` : ''}
                    </div>

                    <div class="request-actions">
                        ${(solicitud.estado === 'PENDIENTE' || solicitud.estado === 'Pendiente' || !solicitud.tecnicoAsignado) ? `
                            <button class="btn btn-success btn-sm" onclick="showAssignPersonalModal('${solicitud.id}')">
                                🎯 Asignar Personal
                            </button>
                        ` : ''}
                        
                        ${(solicitud.estado !== 'COMPLETADA' && solicitud.estado !== 'Completada' && 
                           solicitud.estado !== 'CANCELADA' && solicitud.estado !== 'Cancelada') ? `
                            <button class="btn btn-warning btn-sm" onclick="showChangeStatusModal('${solicitud.id}')">
                                🔄 Cambiar Estado
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-info btn-sm" onclick="viewRequestDetails('${solicitud.id}')">
                            👁️ Ver Detalles
                        </button>
                        
                        ${solicitud.tecnicoAsignado && 
                          solicitud.estado !== 'COMPLETADA' && solicitud.estado !== 'Completada' ? `
                            <button class="btn btn-danger btn-sm" onclick="unassignPersonal('${solicitud.id}')">
                                🔓 Liberar Personal
                            </button>
                        ` : ''}
                    </div>

                    <div style="background: #eff6ff; padding: 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; margin-top: 1rem;">
                        <span style="color: #1e40af; font-weight: 600;">🌐 Estado Cloud:</span>
                        <span style="color: #1e3a8a;">Sincronizado - Historial de personal preservado - Auto-refresh ${isAutoRefreshActive ? 'activo' : 'pausado'}</span>
                    </div>
                </div>
            `;
        }

        // Función helper para obtener nombre de área (utilizada en múltiples lugares)
        function getAreaName(area) {
            if (!area) return 'Sin área';
            
            const lowerArea = area.toLowerCase();
            if (area === 'INGENIERIA_BIOMEDICA' || 
                area === 'Ingeniería Biomédica' ||
                lowerArea.includes('biomed') || 
                lowerArea.includes('bioméd')) {
                return 'Ing. Biomédica';
            } else if (area === 'MECANICA' || area === 'Mecánica' || lowerArea.includes('mec')) {
                return 'Mecánica';
            } else if (area === 'INFRAESTRUCTURA' || area === 'Infraestructura' || lowerArea.includes('infra')) {
                return 'Infraestructura';
            }
            
            return area;
        }

        // 🎯 Función de asignación de personal
        async function showAssignPersonalModal(solicitudId) {
            console.log('🎯 Mostrando modal de asignación para:', solicitudId);
            
            try {
                const solicitud = cloudSolicitudes.find(s => s.id === solicitudId);
                if (!solicitud) {
                    alert('❌ Solicitud no encontrada');
                    return;
                }

                console.log('📋 Solicitud encontrada:', {
                    numero: solicitud.numero,
                    area: solicitud.servicioIngenieria,
                    prioridad: solicitud.prioridad
                });

                const normalizarArea = (area) => {
                    if (!area) return '';
                    
                    const areaStr = String(area).trim();
                    const areaLower = areaStr.toLowerCase();
                    
                    if (areaStr === 'INGENIERIA_BIOMEDICA' || 
                        areaStr === 'Ingeniería Biomédica' ||
                        areaLower === 'ingeniería biomédica' ||
                        areaLower === 'ingenieria biomedica' ||
                        areaLower.includes('biomed') || 
                        areaLower.includes('bioméd')) {
                        return 'BIOMEDICA';
                    }
                    
                    if (areaStr === 'MECANICA' || 
                        areaStr === 'Mecánica' ||
                        areaLower === 'mecánica' ||
                        areaLower === 'mecanica' ||
                        areaLower.includes('mec')) {
                        return 'MECANICA';
                    }
                    
                    if (areaStr === 'INFRAESTRUCTURA' || 
                        areaStr === 'Infraestructura' ||
                        areaLower === 'infraestructura' ||
                        areaLower.includes('infra')) {
                        return 'INFRAESTRUCTURA';
                    }
                    
                    return areaStr.toUpperCase();
                };

                const areaSolicitudNormalizada = normalizarArea(solicitud.servicioIngenieria);
                console.log('🔍 Área de solicitud normalizada:', areaSolicitudNormalizada);

                const personalDisponible = cloudTecnicos.filter(t => {
                    const estadoTecnico = (t.estado || '').toString().toLowerCase();
                    if (estadoTecnico !== 'disponible') {
                        console.log(`❌ ${t.nombre} no disponible (estado: ${t.estado})`);
                        return false;
                    }

                    const areaTecnicoNormalizada = normalizarArea(t.area);
                    const coincide = areaSolicitudNormalizada === areaTecnicoNormalizada;

                    if (!coincide) {
                        console.log(`❌ ${t.nombre} área no coincide: ${t.area} (${areaTecnicoNormalizada}) !== ${solicitud.servicioIngenieria} (${areaSolicitudNormalizada})`);
                    } else {
                        console.log(`✅ ${t.nombre} área coincide: ${t.area} (${areaTecnicoNormalizada})`);
                    }

                    return coincide;
                });

                console.log(`📊 Personal disponible encontrado: ${personalDisponible.length} técnicos`);

                const modal = document.getElementById('assignment-modal');
                const content = document.getElementById('assignment-modal-content');
                
                if (personalDisponible.length === 0) {
                    const personalDelArea = cloudTecnicos.filter(t => {
                        const areaNorm = normalizarArea(t.area);
                        return areaNorm === areaSolicitudNormalizada;
                    });

                    let debugInfo = '';
                    if (personalDelArea.length > 0) {
                        debugInfo = `
                            <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                                <h5 style="color: #d97706; margin-bottom: 0.5rem;">📊 Personal del área ${getAreaName(solicitud.servicioIngenieria)} (${personalDelArea.length} total):</h5>
                                ${personalDelArea.map(p => `
                                    <div style="padding: 0.5rem; margin: 0.25rem 0; background: white; border-radius: 0.25rem;">
                                        <strong>${p.nombre}</strong> - Estado: <span style="color: ${String(p.estado || '').toLowerCase() === 'disponible' ? '#059669' : '#ef4444'};">${p.estado}</span>
                                        ${p.solicitudAsignada ? ` - Asignado a: ${p.solicitudAsignada}` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }

                    content.innerHTML = `
                        <div class="alert alert-warning">
                            <h4 style="margin-bottom: 0.5rem;">⚠️ No hay personal disponible</h4>
                            <p>No se encontró personal disponible en el área de <strong>${getAreaName(solicitud.servicioIngenieria)}</strong>.</p>
                        </div>
                        
                        ${debugInfo}
                        
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="closeAssignmentModal()">
                                ↩️ Cerrar
                            </button>
                            <button class="btn btn-primary" onclick="showAddPersonalModal()">
                                ➕ Agregar Personal
                            </button>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #1f2937; margin-bottom: 1rem;">📋 Información de la Solicitud</h4>
                            <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                                <p><strong>Número:</strong> ${solicitud.numero}</p>
                                <p><strong>Área:</strong> ${getAreaName(solicitud.servicioIngenieria)}</p>
                                <p><strong>Prioridad:</strong> ${solicitud.prioridad}</p>
                                <p><strong>Equipo:</strong> ${solicitud.equipo || 'No especificado'}</p>
                                <p><strong>Ubicación:</strong> ${solicitud.ubicacion || 'No especificado'}</p>
                            </div>
                        </div>

                        <form id="assignment-form" onsubmit="handleAssignPersonal(event, '${solicitudId}')">
                            <div class="form-group">
                                <label class="form-label">👨‍🔧 Seleccionar Personal Disponible</label>
                                <select id="selected-personal" required class="form-select">
                                    <option value="">Seleccione personal...</option>
                                    ${personalDisponible.map(personal => `
                                        <option value="${personal.id}">
                                            ${personal.nombre} - ${personal.tipo} 
                                            ${personal.especialidad ? `(${personal.especialidad})` : ''}
                                        </option>
                                    `).join('')}
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">📝 Observaciones de Asignación</label>
                                <textarea id="assignment-notes" class="form-textarea" 
                                    placeholder="Observaciones sobre la asignación (opcional)"></textarea>
                            </div>

                            <div style="background: #dcfce7; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                                <h5 style="color: #166534; margin-bottom: 0.5rem;">✅ Personal Disponible (${personalDisponible.length})</h5>
                                <div style="max-height: 150px; overflow-y: auto;">
                                    ${personalDisponible.map(personal => `
                                        <div class="personal-card" data-id="${personal.id}" onclick="selectPersonal('${personal.id}', this)" style="padding: 0.5rem; margin: 0.25rem 0; background: white; border-radius: 0.25rem; border: 1px solid #d1fae5; cursor: pointer;">
                                            <strong>${personal.nombre}</strong> - ${personal.tipo}
                                            ${personal.especialidad ? `<br><small style="color: #6b7280;">Especialidad: ${personal.especialidad}</small>` : ''}
                                            <br><small style="color: #059669;">Área: ${personal.area}</small>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button type="submit" class="btn btn-success" style="min-width: 150px;">
                                    🎯 Asignar Personal
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="closeAssignmentModal()" style="min-width: 120px;">
                                    ↩️ Cancelar
                                </button>
                            </div>
                        </form>
                    `;
                }
                
                modal.classList.add('show');

            } catch (error) {
                console.error('❌ Error mostrando modal de asignación:', error);
                alert('❌ Error al cargar modal de asignación: ' + error.message);
            }
        }

        async function handleAssignPersonal(event, solicitudId) {
            event.preventDefault();
            
            const personalId = document.getElementById('selected-personal').value;
            const observaciones = document.getElementById('assignment-notes').value.trim();
            
            if (!personalId) {
                alert('❌ Por favor seleccione personal');
                return;
            }

            try {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '⏳ Asignando...';

                const result = await window.airtableAPI.assignTechnicianToRequest(
                    solicitudId, 
                    personalId, 
                    observaciones
                );

                if (result.success) {
                    await refreshFromCloud();
                    await syncTechniciansWithCloud();
                    
                    closeAssignmentModal();
                    
                    alert(`✅ Personal asignado exitosamente\n\n👤 Personal: ${result.tecnico.nombre}\n📋 Solicitud: ${result.solicitud.numero}\n⏱️ Tiempo estimado: ${result.tiempoEstimadoRespuesta ? new Date(result.tiempoEstimadoRespuesta).toLocaleString('es-CO') : 'No calculado'}\n🕐 ${new Date().toLocaleTimeString('es-CO')}`);
                } else {
                    throw new Error('La asignación no fue exitosa');
                }

            } catch (error) {
                console.error('❌ Error asignando personal:', error);
                alert('❌ Error al asignar personal: ' + error.message);
            } finally {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '🎯 Asignar Personal';
                }
            }
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').classList.remove('show');
        }

        function selectPersonal(personalId, cardElement) {
            const selectElement = document.getElementById('selected-personal');
            if (selectElement) {
                selectElement.value = personalId;
            }
            const cards = document.querySelectorAll('.personal-card');
            cards.forEach(card => {
                card.style.backgroundColor = 'white';
            });
            if (cardElement) {
                cardElement.style.backgroundColor = '#bbf7d0';
            }
        }

        // 🔄 Funciones de cambio de estado MEJORADAS
        async function showChangeStatusModal(solicitudId) {
            console.log('🔄 Mostrando modal de cambio de estado para:', solicitudId);
            
            try {
                const solicitud = cloudSolicitudes.find(s => s.id === solicitudId);
                if (!solicitud) {
                    alert('❌ Solicitud no encontrada');
                    return;
                }

                const modal = document.getElementById('status-modal');
                const content = document.getElementById('status-modal-content');
                
                const estadosDisponibles = [
                    { value: 'PENDIENTE', label: '⏳ Pendiente', description: 'Solicitud creada, esperando asignación' },
                    { value: 'ASIGNADA', label: '🎯 Asignada', description: 'Personal asignado, esperando inicio' },
                    { value: 'EN_PROCESO', label: '🔄 En Proceso', description: 'Trabajo iniciado por el personal' },
                    { value: 'COMPLETADA', label: '✅ Completada', description: 'Trabajo terminado exitosamente' },
                    { value: 'CANCELADA', label: '❌ Cancelada', description: 'Solicitud cancelada por algún motivo' }
                ];

                content.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="color: #1f2937; margin-bottom: 1rem;">📋 Información de la Solicitud</h4>
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <p><strong>Número:</strong> ${solicitud.numero}</p>
                            <p><strong>Estado Actual:</strong> <span class="${getStatusBadge(solicitud.estado)}">${solicitud.estado || 'PENDIENTE'}</span></p>
                            <p><strong>Tipo de Servicio Actual:</strong> ${solicitud.tipoServicio?.replace('_', ' ') || 'No especificado'}</p>
                            <p><strong>Personal Asignado:</strong> ${solicitud.tecnicoAsignado || 'Sin asignar'}</p>
                            <p><strong>Área:</strong> ${getAreaName(solicitud.servicioIngenieria)}</p>
                        </div>
                    </div>

                    <form id="status-form" onsubmit="handleChangeStatus(event, '${solicitudId}')">
                        <div class="form-group">
                            <label class="form-label">🔄 Nuevo Estado</label>
                            <select id="new-status" required class="form-select" onchange="onStatusChange(this.value)">
                                <option value="">Seleccione nuevo estado...</option>
                                ${estadosDisponibles.map(estado => `
                                    <option value="${estado.value}" ${estado.value === solicitud.estado ? 'disabled' : ''}>
                                        ${estado.label}
                                    </option>
                                `).join('')}
                            </select>
                        </div>

                        <div id="status-description" style="margin-bottom: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 0.5rem; border-left: 3px solid #3b82f6; display: none;">
                            <p id="status-description-text"></p>
                        </div>

                        <!-- Opción de cambiar a Error de Usuario -->
                        <div id="error-usuario-section" style="display: none; background: #fee2e2; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid #ef4444;">
                            <h5 style="color: #dc2626; margin-bottom: 0.5rem;">👤 ¿Fue un Error de Usuario?</h5>
                            <p style="color: #991b1b; font-size: 0.875rem; margin-bottom: 0.75rem;">
                                Si el problema fue causado por un error del usuario (mal uso del equipo, configuración incorrecta, etc.), 
                                puede marcarlo para las estadísticas.
                            </p>
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="mark-as-user-error" style="width: 1.25rem; height: 1.25rem;">
                                <span style="color: #dc2626; font-weight: 500;">Marcar como Error de Usuario</span>
                            </label>
                        </div>

                        <div class="form-group">
                            <label class="form-label">📝 Observaciones del Cambio</label>
                            <textarea id="status-notes" class="form-textarea" 
                                placeholder="Observaciones sobre el cambio de estado (opcional)"></textarea>
                        </div>

                        ${solicitud.estado === 'ASIGNADA' || solicitud.estado === 'Asignada' || 
                          solicitud.estado === 'EN_PROCESO' || solicitud.estado === 'En Proceso' ? `
                            <div class="alert alert-warning">
                                <h5 style="margin-bottom: 0.5rem;">⚠️ Información Importante</h5>
                                <p style="margin: 0;">
                                    ${solicitud.estado === 'ASIGNADA' || solicitud.estado === 'Asignada' ? 
                                        'Si marca como "En Proceso", se registrará el inicio del trabajo.' :
                                        'Si marca como "Completada", el personal será liberado pero se mantendrá el historial.'
                                    }
                                </p>
                            </div>
                        ` : ''}

                        <div style="display: flex; gap: 0.5rem; justify-content: center;">
                            <button type="submit" class="btn btn-warning" style="min-width: 150px;">
                                🔄 Cambiar Estado
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="closeStatusModal()" style="min-width: 120px;">
                                ↩️ Cancelar
                            </button>
                        </div>
                    </form>
                `;
                
                window.onStatusChange = function(value) {
                    const descripcionDiv = document.getElementById('status-description');
                    const descripcionText = document.getElementById('status-description-text');
                    const errorUsuarioSection = document.getElementById('error-usuario-section');
                    
                    if (value) {
                        const estado = estadosDisponibles.find(e => e.value === value);
                        if (estado) {
                            descripcionText.textContent = estado.description;
                            descripcionDiv.style.display = 'block';
                        }
                        
                        if (value === 'COMPLETADA') {
                            errorUsuarioSection.style.display = 'block';
                        } else {
                            errorUsuarioSection.style.display = 'none';
                        }
                    } else {
                        descripcionDiv.style.display = 'none';
                        errorUsuarioSection.style.display = 'none';
                    }
                };
                
                modal.classList.add('show');

            } catch (error) {
                console.error('❌ Error mostrando modal de estado:', error);
                alert('❌ Error al cargar modal de estado: ' + error.message);
            }
        }

        function getStatusBadge(status) {
            const normalizedStatus = status ? status.toUpperCase() : 'PENDIENTE';
            const badges = {
                'PENDIENTE': 'status-pendiente',
                'ASIGNADA': 'status-asignada',
                'EN_PROCESO': 'status-en-proceso',
                'EN PROCESO': 'status-en-proceso',
                'COMPLETADA': 'status-completada',
                'CANCELADA': 'status-cancelada'
            };
            return badges[normalizedStatus] || 'status-pendiente';
        }

        // FUNCIÓN MEJORADA: handleChangeStatus
        async function handleChangeStatus(event, solicitudId) {
            event.preventDefault();
            
            const nuevoEstado = document.getElementById('new-status').value;
            const observaciones = document.getElementById('status-notes').value.trim();
            const marcarErrorUsuario = document.getElementById('mark-as-user-error')?.checked || false;
            
            if (!nuevoEstado) {
                alert('❌ Por favor seleccione un nuevo estado');
                return;
            }

            const confirmed = confirm(`¿Está seguro que desea cambiar el estado a "${nuevoEstado}"?${marcarErrorUsuario ? '\n\n⚠️ También se marcará como ERROR DE USUARIO' : ''}\n\n${nuevoEstado === 'COMPLETADA' ? '📌 NOTA: El personal será liberado pero se mantendrá el historial de quien realizó el trabajo.' : 'Esta acción se registrará en el sistema.'}`);
            if (!confirmed) return;

            try {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '⏳ Cambiando estado...';

                console.log('🔄 Cambiando estado:', { solicitudId, nuevoEstado, observaciones, marcarErrorUsuario });

                // IMPORTANTE: Usar el método actualizado que preserva el historial
                const result = await window.airtableAPI.updateRequestStatus(solicitudId, nuevoEstado, observaciones, true); // true = preservar historial
                
                if (result.success) {
                    // Si se marca como error de usuario y el estado es COMPLETADA
                    if (marcarErrorUsuario && nuevoEstado === 'COMPLETADA') {
                        console.log('👤 Marcando como Error de Usuario...');
                        
                        try {
                            await window.airtableAPI.makeRequest(
                                `Solicitudes/${solicitudId}`, 
                                'PATCH',
                                { fields: { tipoServicio: 'ERROR_USUARIO' } }
                            );
                            
                            console.log('✅ Tipo de servicio actualizado a ERROR_USUARIO');
                            
                            const notaErrorUsuario = `\n[${new Date().toLocaleString('es-CO')}] MARCADO COMO ERROR DE USUARIO al completar`;
                            await window.airtableAPI.makeRequest(
                                `Solicitudes/${solicitudId}`, 
                                'PATCH',
                                { 
                                    fields: { 
                                        observaciones: (result.solicitud.observaciones || '') + notaErrorUsuario
                                    } 
                                }
                            );
                            
                        } catch (errorUsuarioError) {
                            console.error('❌ Error marcando como error de usuario:', errorUsuarioError);
                            alert('⚠️ La solicitud se completó pero no se pudo marcar como Error de Usuario');
                        }
                    }
                    
                    // Actualizar datos locales
                    await refreshFromCloud();
                    
                    // Si se completó, actualizar también el personal
                    if (nuevoEstado === 'COMPLETADA') {
                        await syncTechniciansWithCloud();
                    }
                    
                    closeStatusModal();
                    
                    alert(`✅ Estado cambiado exitosamente\n\n🔄 Nuevo estado: ${nuevoEstado}\n${marcarErrorUsuario ? '👤 Marcado como: ERROR DE USUARIO\n' : ''}📝 Observaciones: ${observaciones || 'Ninguna'}\n${nuevoEstado === 'COMPLETADA' ? '📌 Personal liberado pero historial preservado\n' : ''}${result.mensaje || ''}\n🕐 ${new Date().toLocaleTimeString('es-CO')}`);
                } else {
                    throw new Error(result.mensaje || 'Error al cambiar estado');
                }

            } catch (error) {
                console.error('❌ Error cambiando estado:', error);
                alert('❌ Error al cambiar estado: ' + error.message);
            } finally {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '🔄 Cambiar Estado';
                }
            }
        }

        function closeStatusModal() {
            document.getElementById('status-modal').classList.remove('show');
        }

        // 🔓 Liberar personal asignado
        async function unassignPersonal(solicitudId) {
            const confirmed = confirm('¿Está seguro que desea liberar el personal asignado?\n\nEsto marcará la solicitud como pendiente y liberará al técnico.');
            if (!confirmed) return;

            try {
                await window.airtableAPI.liberarTecnicoAsignado(solicitudId, false); // false = no preservar historial
                await window.airtableAPI.updateRequestStatus(solicitudId, 'PENDIENTE', 'Personal liberado manualmente', false);
                
                await refreshFromCloud();
                await syncTechniciansWithCloud();
                
                alert('✅ Personal liberado exitosamente\n\nLa solicitud vuelve a estar pendiente de asignación.');

            } catch (error) {
                console.error('❌ Error liberando personal:', error);
                alert('❌ Error al liberar personal: ' + error.message);
            }
        }

        // 👁️ Ver detalles de solicitud MEJORADO
        function viewRequestDetails(solicitudId) {
            const solicitud = cloudSolicitudes.find(s => s.id === solicitudId);
            if (!solicitud) {
                alert('❌ Solicitud no encontrada');
                return;
            }

            const fechaCreacion = solicitud.fechaCreacion ? new Date(solicitud.fechaCreacion).toLocaleString('es-CO') : 'No disponible';
            const fechaAsignacion = solicitud.fechaAsignacion ? new Date(solicitud.fechaAsignacion).toLocaleString('es-CO') : 'No asignada';
            const fechaInicio = solicitud.fechaInicioTrabajo ? new Date(solicitud.fechaInicioTrabajo).toLocaleString('es-CO') : 'No iniciada';
            const fechaCompletado = solicitud.fechaCompletado ? new Date(solicitud.fechaCompletado).toLocaleString('es-CO') : 'No completada';
            
            // Verificar si es error de usuario
            const esErrorUsuario = solicitud.tipoServicio === 'ERROR_USUARIO' || solicitud.tipoServicio === 'Error de Usuario';

            alert(`📋 DETALLES COMPLETOS DE LA SOLICITUD\n\n` +
                `🔢 Número: ${solicitud.numero}\n` +
                `🏥 Área: ${getAreaName(solicitud.servicioIngenieria)}\n` +
                `🔨 Tipo: ${solicitud.tipoServicio?.replace('_', ' ') || 'No especificado'}${esErrorUsuario ? ' ⚠️' : ''}\n` +
                `⚡ Prioridad: ${solicitud.prioridad || 'MEDIA'}\n` +
                `📊 Estado: ${solicitud.estado || 'PENDIENTE'}\n` +
                `${esErrorUsuario ? '👤 MARCADO COMO ERROR DE USUARIO\n' : ''}` +
                `\n🖥️ Equipo: ${solicitud.equipo || 'No especificado'}\n` +
                `📍 Ubicación: ${solicitud.ubicacion || 'No especificado'}\n` +
                `👤 Solicitante: ${solicitud.solicitante || 'No especificado'}\n` +
                `🏥 Servicio: ${solicitud.servicioHospitalario || 'No especificado'}\n\n` +
                `📝 Descripción:\n${solicitud.descripcion || 'No especificada'}\n\n` +
                `${solicitud.observaciones ? `📋 Observaciones:\n${solicitud.observaciones}\n\n` : ''}` +
                `👨‍🔧 Personal ${solicitud.estado === 'COMPLETADA' || solicitud.estado === 'Completada' ? 'que Realizó' : 'Asignado'}: ${solicitud.tecnicoAsignado || 'Sin asignar'}\n` +
                `${solicitud.observacionesAsignacion ? `📝 Obs. Asignación: ${solicitud.observacionesAsignacion}\n` : ''}` +
                `\n⏰ CRONOLOGÍA:\n` +
                `📅 Creación: ${fechaCreacion}\n` +
                `🎯 Asignación: ${fechaAsignacion}\n` +
                `▶️ Inicio: ${fechaInicio}\n` +
                `✅ Completado: ${fechaCompletado}\n` +
                `${solicitud.tiempoTotalRespuesta ? `⏱️ Tiempo Total: ${solicitud.tiempoTotalRespuesta}\n` : ''}` +
                `\n🆔 ID: ${solicitud.id}`
            );
        }

        // 🤖 Auto-asignación
        async function autoAssignPending() {
            const confirmed = confirm('🤖 ¿Iniciar auto-asignación de solicitudes pendientes?\n\nSe asignará automáticamente personal disponible a solicitudes sin asignar.');
            if (!confirmed) return;

            try {
                const resultado = await window.airtableAPI.autoAssignPendingRequests();
                
                await refreshFromCloud();
                await syncTechniciansWithCloud();
                
                alert(`🤖 AUTO-ASIGNACIÓN COMPLETADA\n\n` +
                    `✅ Asignadas exitosamente: ${resultado.asignadas}\n` +
                    `❌ Fallidas: ${resultado.fallidas}\n` +
                    `⚠️ Sin personal disponible: ${resultado.sinTecnicos}\n\n` +
                    `📋 DETALLES:\n${resultado.detalles.map(d => `• ${d.solicitud} → ${d.tecnico} (${d.area})`).join('\n')}\n\n` +
                    `🕐 ${new Date().toLocaleTimeString('es-CO')}`
                );

            } catch (error) {
                console.error('❌ Error en auto-asignación:', error);
                alert('❌ Error en auto-asignación: ' + error.message);
            }
        }

       async function autoAssignAllPending() {
            await autoAssignPending();
        }

        // 📊 NUEVA FUNCIÓN: Mostrar desempeño por técnico
        async function showTechnicianPerformanceModal() {
            try {
                const modal = document.getElementById('technician-performance-modal');
                const content = document.getElementById('technician-performance-content');
                
                // Mostrar spinner mientras carga
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div class="loading-spinner" style="width: 3rem; height: 3rem; margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: #6b7280;">Calculando desempeño por técnico...</p>
                    </div>
                `;
                
                modal.classList.add('show');
                
                // Calcular estadísticas por técnico
                const technicianStats = calculateTechnicianPerformance();
                
                // Generar HTML
                content.innerHTML = `
                    <div style="padding: 1rem;">
                        <!-- Encabezado -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="color: #1f2937; font-size: 1.5rem; font-weight: 600;">🏆 Análisis de Desempeño Individual</h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-sm" onclick="exportTechnicianPerformanceToPDF()">
                                    📄 Exportar a PDF
                                </button>
                                <button class="btn btn-info btn-sm" onclick="refreshTechnicianPerformance()">
                                    🔄 Actualizar
                                </button>
                            </div>
                        </div>

                        <!-- Resumen general -->
                        <div class="alert alert-info">
                            <h4 style="margin-bottom: 0.5rem;">📊 Resumen General del Personal</h4>
                            <p style="margin: 0;">
                                <strong>Total de técnicos:</strong> ${technicianStats.summary.totalTechnicians}<br>
                                <strong>Técnicos con solicitudes:</strong> ${technicianStats.summary.techniciansWithRequests}<br>
                                <strong>Total de solicitudes gestionadas:</strong> ${technicianStats.summary.totalRequestsHandled}<br>
                                <strong>Promedio por técnico:</strong> ${technicianStats.summary.averageRequestsPerTechnician.toFixed(1)} solicitudes
                            </p>
                        </div>

                        <!-- Top performers -->
                        <div class="card" style="margin-bottom: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">🥇 Top 5 - Mayor Productividad</h3>
                            </div>
                            <div class="card-content">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                    ${technicianStats.topPerformers.slice(0, 5).map((tech, index) => `
                                        <div style="background: ${index === 0 ? '#fef3c7' : '#f8fafc'}; padding: 1rem; border-radius: 0.5rem; border: 2px solid ${index === 0 ? '#f59e0b' : '#e5e7eb'};">
                                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                                <span style="font-size: 1.5rem;">${['🥇', '🥈', '🥉', '4️⃣', '5️⃣'][index]}</span>
                                                <span style="font-size: 1.5rem; font-weight: bold; color: #1f2937;">${tech.totalRequests}</span>
                                            </div>
                                            <h4 style="color: #1f2937; font-weight: 600; margin-bottom: 0.25rem;">${tech.name}</h4>
                                            <p style="font-size: 0.75rem; color: #6b7280; margin: 0;">
                                                ${tech.area}<br>
                                                Completadas: ${tech.completed}
                                            </p>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Tabla detallada por técnico -->
                        <div class="card" style="margin-bottom: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">📋 Desempeño Detallado por Técnico</h3>
                            </div>
                            <div class="card-content">
                                <div class="table-responsive">
                                    <table class="stats-table">
                                        <thead>
                                            <tr>
                                                <th>Técnico</th>
                                                <th>Área</th>
                                                <th>Total</th>
                                                <th>Completadas</th>
                                                <th>En Proceso</th>
                                                <th>Pendientes</th>
                                                <th>Tasa Completado</th>
                                                <th>Tiempo Promedio</th>
                                                <th>Estado</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${technicianStats.byTechnician.map(tech => `
                                                <tr>
                                                    <td style="font-weight: 600;">${tech.name}</td>
                                                    <td>${getAreaName(tech.area)}</td>
                                                    <td style="text-align: center;">${tech.totalRequests}</td>
                                                    <td style="text-align: center; color: #059669;">${tech.completed}</td>
                                                    <td style="text-align: center; color: #8b5cf6;">${tech.inProgress}</td>
                                                    <td style="text-align: center; color: #f59e0b;">${tech.pending}</td>
                                                    <td style="text-align: center;">
                                                        <span style="color: ${tech.completionRate >= 80 ? '#059669' : tech.completionRate >= 50 ? '#f59e0b' : '#ef4444'};">
                                                            ${tech.completionRate}%
                                                        </span>
                                                    </td>
                                                    <td style="text-align: center;">${tech.averageTime || 'N/A'}</td>
                                                    <td style="text-align: center;">
                                                        <span class="status-${tech.currentStatus.toLowerCase()}" style="font-size: 0.75rem;">
                                                            ${tech.currentStatus === 'disponible' ? '🟢' : tech.currentStatus === 'ocupado' ? '🟡' : '🔴'} ${tech.currentStatus}
                                                        </span>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Estadísticas por área -->
                        <div class="card" style="margin-bottom: 2rem;">
                            <div class="card-header">
                                <h3 class="card-title">🏥 Rendimiento por Área</h3>
                            </div>
                            <div class="card-content">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                                    ${Object.entries(technicianStats.byArea).map(([area, stats]) => `
                                        <div style="background: #f8fafc; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                                            <h4 style="color: #1f2937; margin-bottom: 1rem;">${getAreaName(area)}</h4>
                                            <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #6b7280;">Personal total:</span>
                                                    <span style="font-weight: 600;">${stats.totalTechnicians}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #6b7280;">Solicitudes manejadas:</span>
                                                    <span style="font-weight: 600;">${stats.totalRequests}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #6b7280;">Promedio por técnico:</span>
                                                    <span style="font-weight: 600;">${stats.averagePerTechnician.toFixed(1)}</span>
                                                </div>
                                                <div style="display: flex; justify-content: space-between;">
                                                    <span style="color: #6b7280;">Tasa de completado:</span>
                                                    <span style="font-weight: 600; color: ${stats.completionRate >= 80 ? '#059669' : stats.completionRate >= 50 ? '#f59e0b' : '#ef4444'};">
                                                        ${stats.completionRate}%
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Gráfico de solicitudes por técnico -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">📊 Distribución de Solicitudes por Técnico</h3>
                            </div>
                            <div class="card-content">
                                <div class="chart-container" style="height: 400px;">
                                    <canvas id="technicianRequestsChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Información adicional -->
                        <div class="alert alert-info" style="margin-top: 2rem;">
                            <h4 style="margin-bottom: 0.5rem;">ℹ️ Información del Análisis</h4>
                            <p style="margin: 0;">
                                <strong>Fecha de generación:</strong> ${new Date().toLocaleString('es-CO')}<br>
                                <strong>Período analizado:</strong> Todos los registros disponibles<br>
                                <strong>Nota:</strong> El historial de personal se mantiene incluso después de completar las solicitudes
                            </p>
                        </div>
                    </div>
                `;
                
                // Crear gráfico después de que el HTML esté listo
                setTimeout(() => {
                    createTechnicianChart(technicianStats);
                }, 100);
                
            } catch (error) {
                console.error('❌ Error mostrando desempeño por técnico:', error);
                document.getElementById('technician-performance-content').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>❌ Error al cargar desempeño</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        function closeTechnicianPerformanceModal() {
            document.getElementById('technician-performance-modal').classList.remove('show');
        }

        // Calcular estadísticas de desempeño por técnico
        function calculateTechnicianPerformance() {
            const technicianMap = new Map();
            
            // Inicializar todos los técnicos
            cloudTecnicos.forEach(tech => {
                technicianMap.set(tech.nombre, {
                    name: tech.nombre,
                    area: tech.area,
                    type: tech.tipo,
                    currentStatus: tech.estado || 'disponible',
                    totalRequests: 0,
                    completed: 0,
                    inProgress: 0,
                    pending: 0,
                    cancelled: 0,
                    userErrors: 0,
                    totalTime: 0,
                    requestsWithTime: 0
                });
            });
            
            // Procesar todas las solicitudes
            cloudSolicitudes.forEach(solicitud => {
                if (solicitud.tecnicoAsignado) {
                    const tech = technicianMap.get(solicitud.tecnicoAsignado);
                    if (tech) {
                        tech.totalRequests++;
                        
                        const estado = (solicitud.estado || '').toUpperCase();
                        switch(estado) {
                            case 'COMPLETADA':
                                tech.completed++;
                                // Calcular tiempo si está disponible
                                if (solicitud.tiempoTotalRespuesta) {
                                    const match = solicitud.tiempoTotalRespuesta.match(/(\d+)h\s*(\d+)m/);
                                    if (match) {
                                        const totalMinutes = parseInt(match[1]) * 60 + parseInt(match[2]);
                                        tech.totalTime += totalMinutes;
                                        tech.requestsWithTime++;
                                    }
                                }
                                // Contar errores de usuario
                                if (solicitud.tipoServicio === 'ERROR_USUARIO' || solicitud.tipoServicio === 'Error de Usuario') {
                                    tech.userErrors++;
                                }
                                break;
                            case 'EN_PROCESO':
                            case 'EN PROCESO':
                                tech.inProgress++;
                                break;
                            case 'PENDIENTE':
                            case 'ASIGNADA':
                                tech.pending++;
                                break;
                            case 'CANCELADA':
                                tech.cancelled++;
                                break;
                        }
                    } else {
                        // Técnico histórico no en la lista actual
                        technicianMap.set(solicitud.tecnicoAsignado, {
                            name: solicitud.tecnicoAsignado,
                            area: 'Histórico',
                            type: 'N/A',
                            currentStatus: 'inactivo',
                            totalRequests: 1,
                            completed: (solicitud.estado || '').toUpperCase() === 'COMPLETADA' ? 1 : 0,
                            inProgress: ['EN_PROCESO', 'EN PROCESO'].includes((solicitud.estado || '').toUpperCase()) ? 1 : 0,
                            pending: ['PENDIENTE', 'ASIGNADA'].includes((solicitud.estado || '').toUpperCase()) ? 1 : 0,
                            cancelled: (solicitud.estado || '').toUpperCase() === 'CANCELADA' ? 1 : 0,
                            userErrors: (solicitud.tipoServicio === 'ERROR_USUARIO' || solicitud.tipoServicio === 'Error de Usuario') ? 1 : 0,
                            totalTime: 0,
                            requestsWithTime: 0
                        });
                    }
                }
            });
            
            // Convertir a array y calcular métricas adicionales
            const byTechnician = Array.from(technicianMap.values())
                .filter(tech => tech.totalRequests > 0)
                .map(tech => ({
                    ...tech,
                    completionRate: tech.totalRequests > 0 ? Math.round((tech.completed / tech.totalRequests) * 100) : 0,
                    averageTime: tech.requestsWithTime > 0 ? 
                        formatearTiempo(Math.round(tech.totalTime / tech.requestsWithTime)) : null,
                    errorRate: tech.completed > 0 ? Math.round((tech.userErrors / tech.completed) * 100) : 0
                }))
                .sort((a, b) => b.totalRequests - a.totalRequests);
            
            // Estadísticas por área
            const byArea = {};
            ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'].forEach(area => {
                const areaTechs = byTechnician.filter(tech => {
                    const techArea = tech.area || '';
                    const areaLower = techArea.toLowerCase();
                    
                    if (area === 'INGENIERIA_BIOMEDICA') {
                        return techArea === 'INGENIERIA_BIOMEDICA' || 
                               techArea === 'Ingeniería Biomédica' ||
                               areaLower.includes('biomed') || 
                               areaLower.includes('bioméd');
                    } else if (area === 'MECANICA') {
                        return techArea === 'MECANICA' || 
                               techArea === 'Mecánica' ||
                               areaLower.includes('mec');
                    } else if (area === 'INFRAESTRUCTURA') {
                        return techArea === 'INFRAESTRUCTURA' || 
                               techArea === 'Infraestructura' ||
                               areaLower.includes('infra');
                    }
                    return false;
                });
                
                const totalRequests = areaTechs.reduce((sum, tech) => sum + tech.totalRequests, 0);
                const totalCompleted = areaTechs.reduce((sum, tech) => sum + tech.completed, 0);
                
                byArea[area] = {
                    totalTechnicians: areaTechs.length,
                    totalRequests: totalRequests,
                    totalCompleted: totalCompleted,
                    averagePerTechnician: areaTechs.length > 0 ? totalRequests / areaTechs.length : 0,
                    completionRate: totalRequests > 0 ? Math.round((totalCompleted / totalRequests) * 100) : 0
                };
            });
            
            // Resumen general
            const totalRequestsHandled = byTechnician.reduce((sum, tech) => sum + tech.totalRequests, 0);
            const techniciansWithRequests = byTechnician.length;
            
            return {
                byTechnician: byTechnician,
                topPerformers: byTechnician.slice(0, 10),
                byArea: byArea,
                summary: {
                    totalTechnicians: cloudTecnicos.length,
                    techniciansWithRequests: techniciansWithRequests,
                    totalRequestsHandled: totalRequestsHandled,
                    averageRequestsPerTechnician: techniciansWithRequests > 0 ? totalRequestsHandled / techniciansWithRequests : 0
                }
            };
        }

        // Crear gráfico de desempeño por técnico
        function createTechnicianChart(stats) {
            const ctx = document.getElementById('technicianRequestsChart');
            if (!ctx) return;
            
            // Destruir gráfico anterior si existe
            if (chartInstances.technicianChart) {
                chartInstances.technicianChart.destroy();
            }
            
            // Tomar los top 15 técnicos
            const topTechs = stats.topPerformers.slice(0, 15);
            
            chartInstances.technicianChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: topTechs.map(tech => tech.name),
                    datasets: [{
                        label: 'Completadas',
                        data: topTechs.map(tech => tech.completed),
                        backgroundColor: '#059669'
                    }, {
                        label: 'En Proceso',
                        data: topTechs.map(tech => tech.inProgress),
                        backgroundColor: '#8b5cf6'
                    }, {
                        label: 'Pendientes',
                        data: topTechs.map(tech => tech.pending),
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 15 Técnicos por Número de Solicitudes'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const tech = topTechs[context.dataIndex];
                                    return `Total: ${tech.totalRequests} solicitudes`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Actualizar desempeño de técnicos
        async function refreshTechnicianPerformance() {
            await loadAllDataFromCloud();
            await showTechnicianPerformanceModal();
        }

        // Exportar desempeño a PDF
        async function exportTechnicianPerformanceToPDF() {
            try {
                const content = document.getElementById('technician-performance-content');
                
                const pdfContent = document.createElement('div');
                pdfContent.style.width = '210mm';
                pdfContent.style.padding = '20px';
                pdfContent.style.background = 'white';
                pdfContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #1f2937; font-size: 24px;">HOSPITAL SUSANA LÓPEZ DE VALENCIA E.S.E.</h1>
                        <h2 style="color: #4b5563; font-size: 18px;">Análisis de Desempeño por Técnico</h2>
                        <p style="color: #6b7280;">Fecha: ${new Date().toLocaleString('es-CO')}</p>
                    </div>
                    ${content.innerHTML}
                `;
                
                document.body.appendChild(pdfContent);
                
                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                document.body.removeChild(pdfContent);
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`Desempeño_Tecnicos_${new Date().toISOString().split('T')[0]}.pdf`);
                
                alert('✅ PDF generado exitosamente');
                
            } catch (error) {
                console.error('❌ Error generando PDF:', error);
                alert('❌ Error al generar el PDF: ' + error.message);
            }
        }

        // 📊 Mostrar estadísticas avanzadas con análisis mensual y trimestral
        async function showAdvancedStatisticsModal() {
            try {
                const modal = document.getElementById('stats-modal');
                const content = document.getElementById('stats-modal-content');
                
                // Mostrar spinner mientras carga
                content.innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <div class="loading-spinner" style="width: 3rem; height: 3rem; margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: #6b7280;">Calculando estadísticas avanzadas...</p>
                    </div>
                `;
                
                modal.classList.add('show');
                
                // Obtener estadísticas
                const stats = await window.airtableAPI.getAdvancedStatistics();
                
                // Preparar datos adicionales para análisis
                const solicitudesPorServicio = {};
                const solicitudesPorTecnico = {};
                const tiemposRespuestaPorArea = {
                    'INGENIERIA_BIOMEDICA': [],
                    'MECANICA': [],
                    'INFRAESTRUCTURA': []
                };
                
                // Análisis mensual y trimestral
                const analisisMensual = calcularAnalisisMensual();
                const analisisTrimestral = calcularAnalisisTrimestral();
                
                cloudSolicitudes.forEach(sol => {
                    // Contar por servicio hospitalario
                    const servicio = sol.servicioHospitalario || 'No especificado';
                    solicitudesPorServicio[servicio] = (solicitudesPorServicio[servicio] || 0) + 1;
                    
                    // Contar por técnico asignado
                    if (sol.tecnicoAsignado) {
                        solicitudesPorTecnico[sol.tecnicoAsignado] = (solicitudesPorTecnico[sol.tecnicoAsignado] || 0) + 1;
                    }
                    
                    // Calcular tiempos por área
                    if (sol.tiempoTotalRespuesta && sol.servicioIngenieria) {
                        const area = normalizarAreaParaEstadisticas(sol.servicioIngenieria);
                        if (tiemposRespuestaPorArea[area]) {
                            tiemposRespuestaPorArea[area].push(sol.tiempoTotalRespuesta);
                        }
                    }
                });
                
                // Ordenar técnicos por cantidad de solicitudes
                const topTecnicos = Object.entries(solicitudesPorTecnico)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                // Generar HTML con estadísticas completas
                content.innerHTML = `
                    <div style="padding: 1rem;">
                        <!-- Encabezado con botones de acción -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                            <h2 style="color: #1f2937; font-size: 1.5rem; font-weight: 600;">📊 Análisis Completo del Sistema</h2>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-primary btn-sm" onclick="exportStatsToPDF()">
                                    📄 Exportar a PDF
                                </button>
                                <button class="btn btn-info btn-sm" onclick="refreshStatsData()">
                                    🔄 Actualizar
                                </button>
                            </div>
                        </div>

                        <!-- Pestañas de análisis temporal -->
                        <div class="analysis-tabs">
                            <button class="analysis-tab active" onclick="showAnalysisView('general')">
                                📊 General
                            </button>
                            <button class="analysis-tab" onclick="showAnalysisView('mensual')">
                                📅 Análisis Mensual
                            </button>
                            <button class="analysis-tab" onclick="showAnalysisView('trimestral')">
                                📈 Análisis Trimestral
                            </button>
                        </div>

                        <!-- Vista General -->
                        <div id="general-analysis-view" class="analysis-view">
                            <!-- Indicadores principales -->
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-title">✅ Tasa de Completado</span>
                                        <span style="font-size: 1.5rem;">📈</span>
                                    </div>
                                    <div class="stat-card-value" style="color: #059669;">
                                        ${stats.indicadoresGestion.porcentajeCompletadas}%
                                    </div>
                                    <div class="stat-card-description">
                                        ${stats.solicitudes.completadas} de ${stats.solicitudes.total} solicitudes
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-title">🔧 Mantenimientos Correctivos</span>
                                        <span style="font-size: 1.5rem;">⚙️</span>
                                    </div>
                                    <div class="stat-card-value" style="color: #f59e0b;">
                                        ${stats.indicadoresGestion.porcentajeMantenimientosCorrectivos}%
                                    </div>
                                    <div class="stat-card-description">
                                        Del total de solicitudes
                                    </div>
                                </div>
                                
                                <div class="stat-card" style="border: 2px solid #ef4444;">
                                    <div class="stat-card-header">
                                        <span class="stat-card-title">👤 Errores de Usuario</span>
                                        <span style="font-size: 1.5rem;">⚠️</span>
                                    </div>
                                    <div class="stat-card-value" style="color: #ef4444;">
                                        ${stats.indicadoresGestion.porcentajeErroresUsuario}%
                                    </div>
                                    <div class="stat-card-description">
                                        Solicitudes por mal uso del equipo
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-title">⏱️ Tiempo Promedio</span>
                                        <span style="font-size: 1.5rem;">⏰</span>
                                    </div>
                                    <div class="stat-card-value" style="color: #2563eb;">
                                        ${stats.tiemposRespuesta.promedioRespuesta}
                                    </div>
                                    <div class="stat-card-description">
                                        Respuesta promedio
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-title">⚠️ Vencidas</span>
                                        <span style="font-size: 1.5rem;">🚨</span>
                                    </div>
                                    <div class="stat-card-value" style="color: #dc2626;">
                                        ${stats.tiemposRespuesta.solicitudesVencidas}
                                    </div>
                                    <div class="stat-card-description">
                                        Fuera de tiempo límite
                                    </div>
                                </div>
                                
                                <div class="stat-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-title">🏆 Efectividad</span>
                                        <span style="font-size: 1.5rem;">💯</span>
                                    </div>
                                    <div class="stat-card-value" style="color: #059669;">
                                        ${stats.indicadoresGestion.efectividad.porcentajeGestion}%
                                    </div>
                                    <div class="stat-card-description">
                                        Solicitudes gestionadas
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Alerta sobre errores de usuario -->
                            ${stats.indicadoresGestion.porcentajeErroresUsuario > 10 ? `
                                <div class="alert alert-warning" style="margin-top: 2rem;">
                                    <h4 style="margin-bottom: 0.5rem;">⚠️ Alto Porcentaje de Errores de Usuario</h4>
                                    <p>Se detectó un ${stats.indicadoresGestion.porcentajeErroresUsuario}% de solicitudes por errores de usuario.</p>
                                    <p style="margin-top: 0.5rem;"><strong>Recomendaciones:</strong></p>
                                    <ul style="margin: 0.5rem 0 0 1rem;">
                                        <li>Implementar capacitaciones sobre el uso correcto de equipos</li>
                                        <li>Crear guías visuales de uso común</li>
                                        <li>Establecer un programa de formación continua</li>
                                    </ul>
                                </div>
                            ` : ''}
                            
                            <!-- Gráfico de distribución por estado -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">📊 Distribución por Estado</h3>
                                </div>
                                <div class="card-content">
                                    <div class="chart-container">
                                        <canvas id="estadoChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico de solicitudes por área -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">🏥 Distribución por Área</h3>
                                </div>
                                <div class="card-content">
                                    <div class="chart-container">
                                        <canvas id="areaChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tabla de servicios que más solicitan -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">🏥 Servicios Hospitalarios con Más Solicitudes</h3>
                                </div>
                                <div class="card-content">
                                    <div class="table-responsive">
                                        <table class="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Servicio</th>
                                                    <th>Solicitudes</th>
                                                    <th>Porcentaje</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(solicitudesPorServicio)
                                                    .sort((a, b) => b[1] - a[1])
                                                    .slice(0, 10)
                                                    .map(([servicio, cantidad]) => `
                                                        <tr>
                                                            <td>${servicio}</td>
                                                            <td style="text-align: center;">${cantidad}</td>
                                                            <td style="text-align: center;">${((cantidad / stats.solicitudes.total) * 100).toFixed(1)}%</td>
                                                        </tr>
                                                    `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TABLA MEJORADA: Técnicos con más asignaciones (muestra historial) -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">👨‍🔧 Personal con Más Asignaciones (Incluye Historial)</h3>
                                </div>
                                <div class="card-content">
                                    <div class="table-responsive">
                                        <table class="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Técnico</th>
                                                    <th>Total Asignaciones</th>
                                                    <th>Completadas</th>
                                                    <th>En Proceso</th>
                                                    <th>Tiempo Promedio</th>
                                                    <th>Estado Actual</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${topTecnicos.map(([tecnico, cantidad]) => {
                                                    // Buscar información adicional del técnico
                                                    const techInfo = cloudTecnicos.find(t => t.nombre === tecnico);
                                                    const solicitudesTecnico = cloudSolicitudes.filter(s => s.tecnicoAsignado === tecnico);
                                                    const completadas = solicitudesTecnico.filter(s => (s.estado || '').toUpperCase() === 'COMPLETADA').length;
                                                    const enProceso = solicitudesTecnico.filter(s => ['EN_PROCESO', 'EN PROCESO', 'ASIGNADA'].includes((s.estado || '').toUpperCase())).length;
                                                    
                                                    // Calcular tiempo promedio
                                                    let tiempoPromedio = 'N/A';
                                                    const tiempos = solicitudesTecnico
                                                        .filter(s => s.tiempoTotalRespuesta && (s.estado || '').toUpperCase() === 'COMPLETADA')
                                                        .map(s => {
                                                            const match = s.tiempoTotalRespuesta.match(/(\d+)h\s*(\d+)m/);
                                                            return match ? parseInt(match[1]) * 60 + parseInt(match[2]) : 0;
                                                        })
                                                        .filter(t => t > 0);
                                                    
                                                    if (tiempos.length > 0) {
                                                        const avgMinutos = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
                                                        tiempoPromedio = formatearTiempo(Math.round(avgMinutos));
                                                    }
                                                    
                                                    return `
                                                        <tr>
                                                            <td style="font-weight: 600;">${tecnico}</td>
                                                            <td style="text-align: center;">${cantidad}</td>
                                                            <td style="text-align: center; color: #059669;">${completadas}</td>
                                                            <td style="text-align: center; color: #8b5cf6;">${enProceso}</td>
                                                            <td style="text-align: center;">${tiempoPromedio}</td>
                                                            <td style="text-align: center;">
                                                                ${techInfo ? 
                                                                    `<span class="status-${(techInfo.estado || 'inactivo').toLowerCase()}" style="font-size: 0.75rem;">
                                                                        ${techInfo.estado === 'disponible' ? '🟢' : techInfo.estado === 'ocupado' ? '🟡' : '🔴'} ${techInfo.estado || 'Inactivo'}
                                                                    </span>` : 
                                                                    '<span style="color: #6b7280; font-size: 0.75rem;">📋 Histórico</span>'
                                                                }
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div style="margin-top: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 0.5rem; border-left: 3px solid #3b82f6;">
                                        <p style="margin: 0; color: #1e40af; font-size: 0.875rem;">
                                            <strong>📌 Nota:</strong> Esta tabla incluye todo el historial de asignaciones. 
                                            Los técnicos marcados como "Histórico" ya no están activos en el sistema pero su trabajo queda registrado.
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráfico de tipos de servicio -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">🔧 Distribución por Tipo de Servicio</h3>
                                </div>
                                <div class="card-content">
                                    <div class="chart-container">
                                        <canvas id="tipoServicioChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Estadísticas detalladas por tipo -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">📋 Análisis Detallado por Tipo de Servicio</h3>
                                </div>
                                <div class="card-content">
                                    <div class="table-responsive">
                                        <table class="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Tipo de Servicio</th>
                                                    <th>Total</th>
                                                    <th>Completadas</th>
                                                    <th>Tasa de Completado</th>
                                                    <th>% del Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(stats.estadisticasPorTipo)
                                                    .sort((a, b) => b[1].total - a[1].total)
                                                    .map(([tipo, data]) => {
                                                        const isErrorUsuario = tipo === 'ERROR_USUARIO';
                                                        return `
                                                            <tr ${isErrorUsuario ? 'style="background: #fee2e2;"' : ''}>
                                                                <td ${isErrorUsuario ? 'style="color: #dc2626; font-weight: 600;"' : ''}>
                                                                    ${tipo.replace(/_/g, ' ')}
                                                                    ${isErrorUsuario ? '⚠️' : ''}
                                                                </td>
                                                                <td style="text-align: center;">${data.total}</td>
                                                                <td style="text-align: center;">${data.completadas}</td>
                                                                <td style="text-align: center;">
                                                                    ${data.total > 0 ? ((data.completadas / data.total) * 100).toFixed(1) : 0}%
                                                                </td>
                                                                <td style="text-align: center;">${data.porcentaje}%</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resumen de personal -->
                            <div class="card" style="margin-top: 2rem;">
                                <div class="card-header">
                                    <h3 class="card-title">👥 Estado del Personal de Soporte</h3>
                                </div>
                                <div class="card-content">
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                        <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                                            <div style="font-size: 2rem; font-weight: bold; color: #059669;">${stats.tecnicos.disponibles}</div>
                                            <div style="color: #047857; font-weight: 500;">Disponibles</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                                            <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${stats.tecnicos.ocupados}</div>
                                            <div style="color: #d97706; font-weight: 500;">Ocupados</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 0.5rem;">
                                            <div style="font-size: 2rem; font-weight: bold; color: #ef4444;">${stats.tecnicos.inactivos}</div>
                                            <div style="color: #dc2626; font-weight: 500;">Inactivos</div>
                                        </div>
                                        <div style="text-align: center; padding: 1rem; background: #e0f2fe; border-radius: 0.5rem;">
                                            <div style="font-size: 2rem; font-weight: bold; color: #0284c7;">${stats.tecnicos.total}</div>
                                            <div style="color: #0369a1; font-weight: 500;">Total</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vista de Análisis Mensual -->
                        <div id="mensual-analysis-view" class="analysis-view" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">📅 Análisis Mensual de Solicitudes</h3>
                                </div>
                                <div class="card-content">
                                    <!-- Resumen mensual -->
                                    <div class="stats-grid">
                                        ${Object.entries(analisisMensual.porMes).map(([mes, datos]) => `
                                            <div class="stat-card">
                                                <div class="stat-card-header">
                                                    <span class="stat-card-title">${mes}</span>
                                                    <span style="font-size: 1.5rem;">📅</span>
                                                </div>
                                                <div class="stat-card-value">${datos.total}</div>
                                                <div class="stat-card-description">
                                                    ✅ ${datos.completadas} | ⏳ ${datos.pendientes} | 👤 ${datos.erroresUsuario || 0}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <!-- Gráfico de tendencia mensual -->
                                    <div style="margin-top: 2rem;">
                                        <div class="chart-container">
                                            <canvas id="monthlyTrendChart"></canvas>
                                        </div>
                                    </div>

                                    <!-- Tabla detallada mensual -->
                                    <div class="table-responsive" style="margin-top: 2rem;">
                                        <table class="stats-table">
                                            <thead>
                                                <tr>
                                                    <th>Mes</th>
                                                    <th>Total</th>
                                                    <th>Completadas</th>
                                                    <th>Pendientes</th>
                                                    <th>Errores Usuario</th>
                                                    <th>Tasa Completado</th>
                                                    <th>Tiempo Promedio</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${Object.entries(analisisMensual.porMes).map(([mes, datos]) => `
                                                    <tr>
                                                        <td>${mes}</td>
                                                        <td style="text-align: center;">${datos.total}</td>
                                                        <td style="text-align: center; color: #059669;">${datos.completadas}</td>
                                                        <td style="text-align: center; color: #f59e0b;">${datos.pendientes}</td>
                                                        <td style="text-align: center; color: #ef4444;">${datos.erroresUsuario || 0}</td>
                                                        <td style="text-align: center;">
                                                            ${datos.total > 0 ? Math.round((datos.completadas / datos.total) * 100) : 0}%
                                                        </td>
                                                        <td style="text-align: center;">${datos.tiempoPromedio || 'N/A'}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Análisis mensual por área -->
                                    <div class="card" style="margin-top: 2rem;">
                                        <h4 style="margin-bottom: 1rem;">📊 Distribución Mensual por Área</h4>
                                        <div class="chart-container">
                                            <canvas id="monthlyAreaChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vista de Análisis Trimestral -->
                        <div id="trimestral-analysis-view" class="analysis-view" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">📈 Análisis Trimestral de Desempeño</h3>
                                </div>
                                <div class="card-content">
                                    <!-- Resumen trimestral -->
                                    <div class="stats-grid">
                                        ${Object.entries(analisisTrimestral.porTrimestre).map(([trimestre, datos]) => `
                                            <div class="stat-card">
                                                <div class="stat-card-header">
                                                    <span class="stat-card-title">${trimestre}</span>
                                                    <span style="font-size: 1.5rem;">📊</span>
                                                </div>
                                                <div class="stat-card-value">${datos.total}</div>
                                                <div class="stat-card-description">
                                                    Eficiencia: ${datos.eficiencia}% | Errores: ${datos.erroresUsuario || 0}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>

                                    <!-- Gráfico comparativo trimestral -->
                                    <div style="margin-top: 2rem;">
                                        <div class="chart-container">
                                            <canvas id="quarterlyComparisonChart"></canvas>
                                        </div>
                                    </div>

                                    <!-- Métricas de desempeño trimestral -->
                                    <div class="card" style="margin-top: 2rem;">
                                        <h4 style="margin-bottom: 1rem;">🎯 Indicadores Clave de Desempeño (KPIs)</h4>
                                        <div class="table-responsive">
                                            <table class="stats-table">
                                                <thead>
                                                    <tr>
                                                        <th>Trimestre</th>
                                                        <th>Solicitudes</th>
                                                        <th>Completadas</th>
                                                        <th>Errores Usuario</th>
                                                        <th>Eficiencia</th>
                                                        <th>Tiempo Respuesta</th>
                                                        <th>Satisfacción</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${Object.entries(analisisTrimestral.porTrimestre).map(([trimestre, datos]) => `
                                                        <tr>
                                                            <td>${trimestre}</td>
                                                            <td style="text-align: center;">${datos.total}</td>
                                                            <td style="text-align: center;">${datos.completadas}</td>
                                                            <td style="text-align: center; color: #ef4444;">${datos.erroresUsuario || 0}</td>
                                                            <td style="text-align: center;">
                                                                <span style="color: ${datos.eficiencia >= 80 ? '#059669' : datos.eficiencia >= 60 ? '#f59e0b' : '#ef4444'};">
                                                                    ${datos.eficiencia}%
                                                                </span>
                                                            </td>
                                                            <td style="text-align: center;">${datos.tiempoPromedio}</td>
                                                            <td style="text-align: center;">
                                                                ${datos.satisfaccion ? `${datos.satisfaccion}%` : 'N/A'}
                                                            </td>
                                                        </tr>
                                                    `).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Proyecciones y tendencias -->
                                    <div class="card" style="margin-top: 2rem;">
                                        <h4 style="margin-bottom: 1rem;">📈 Proyecciones y Tendencias</h4>
                                        <div class="alert alert-info">
                                            <p><strong>Tendencia General:</strong> ${analisisTrimestral.tendencia}</p>
                                            <p><strong>Proyección próximo trimestre:</strong> ${analisisTrimestral.proyeccion} solicitudes estimadas</p>
                                            <p><strong>Recomendaciones:</strong></p>
                                            <ul style="margin: 0.5rem 0 0 1rem;">
                                                ${analisisTrimestral.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información adicional -->
                        <div class="alert alert-info" style="margin-top: 2rem;">
                            <h4 style="margin-bottom: 0.5rem;">ℹ️ Información del Reporte</h4>
                            <p style="margin: 0;">
                                <strong>Fecha de generación:</strong> ${new Date(stats.timestamp).toLocaleString('es-CO')}<br>
                                <strong>Total de registros analizados:</strong> ${stats.solicitudes.total} solicitudes<br>
                                <strong>Período:</strong> Todos los registros disponibles en el sistema<br>
                                <strong>Análisis temporal:</strong> Incluye análisis mensual y trimestral<br>
                                <strong>⚠️ Errores de Usuario:</strong> ${stats.indicadoresGestion.porcentajeErroresUsuario}% del total<br>
                                <strong>📌 Historial:</strong> Se mantiene el registro del personal que realizó cada trabajo
                            </p>
                        </div>
                    </div>
                `;
                
                // Crear gráficos después de que el HTML esté listo
                setTimeout(() => {
                    createEstadoChart(stats);
                    createAreaChart(stats);
                    createTipoServicioChart(stats);
                    
                    // Crear gráficos de análisis temporal si están en vista
                    if (currentAnalysisView === 'mensual') {
                        createMonthlyCharts(analisisMensual);
                    } else if (currentAnalysisView === 'trimestral') {
                        createQuarterlyCharts(analisisTrimestral);
                    }
                }, 100);
                
            } catch (error) {
                console.error('❌ Error mostrando estadísticas:', error);
                const content = document.getElementById('stats-modal-content');
                content.innerHTML = `
                    <div class="alert alert-danger">
                        <h4>❌ Error al cargar estadísticas</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Función para cambiar entre vistas de análisis
        function showAnalysisView(view) {
            currentAnalysisView = view;
            
            // Actualizar pestañas activas
            document.querySelectorAll('.analysis-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Ocultar todas las vistas
            document.querySelectorAll('.analysis-view').forEach(v => {
                v.style.display = 'none';
            });
            
            // Mostrar vista seleccionada
            document.getElementById(`${view}-analysis-view`).style.display = 'block';
            
            // Crear gráficos según la vista
            if (view === 'mensual') {
                setTimeout(() => {
                    const analisisMensual = calcularAnalisisMensual();
                    createMonthlyCharts(analisisMensual);
                }, 100);
            } else if (view === 'trimestral') {
                setTimeout(() => {
                    const analisisTrimestral = calcularAnalisisTrimestral();
                    createQuarterlyCharts(analisisTrimestral);
                }, 100);
            }
        }

        // Calcular análisis mensual
        function calcularAnalisisMensual() {
            const meses = {};
            const mesNombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            cloudSolicitudes.forEach(sol => {
                if (sol.fechaCreacion) {
                    const fecha = new Date(sol.fechaCreacion);
                    const mesKey = `${mesNombres[fecha.getMonth()]} ${fecha.getFullYear()}`;
                    
                    if (!meses[mesKey]) {
                        meses[mesKey] = {
                            total: 0,
                            completadas: 0,
                            pendientes: 0,
                            erroresUsuario: 0,
                            tiempos: [],
                            porArea: {
                                'INGENIERIA_BIOMEDICA': 0,
                                'MECANICA': 0,
                                'INFRAESTRUCTURA': 0
                            }
                        };
                    }
                    
                    meses[mesKey].total++;
                    
                    if (sol.estado === 'COMPLETADA' || sol.estado === 'Completada') {
                        meses[mesKey].completadas++;
                        if (sol.tiempoTotalRespuesta) {
                            const match = sol.tiempoTotalRespuesta.match(/(\d+)h\s*(\d+)m/);
                            if (match) {
                                const totalMinutes = parseInt(match[1]) * 60 + parseInt(match[2]);
                                meses[mesKey].tiempos.push(totalMinutes);
                            }
                        }
                    } else if (sol.estado === 'PENDIENTE' || sol.estado === 'Pendiente') {
                        meses[mesKey].pendientes++;
                    }
                    
                    // Contar errores de usuario
                    if (sol.tipoServicio === 'ERROR_USUARIO' || sol.tipoServicio === 'Error de Usuario') {
                        meses[mesKey].erroresUsuario++;
                    }
                    
                    const area = normalizarAreaParaEstadisticas(sol.servicioIngenieria);
                    if (meses[mesKey].porArea[area] !== undefined) {
                        meses[mesKey].porArea[area]++;
                    }
                }
            });
            
            // Calcular promedios
            Object.keys(meses).forEach(mes => {
                const tiempos = meses[mes].tiempos;
                if (tiempos.length > 0) {
                    const promedio = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
                    meses[mes].tiempoPromedio = formatearTiempo(promedio);
                }
            });
            
            return { porMes: meses };
        }

        // Calcular análisis trimestral
        function calcularAnalisisTrimestral() {
            const trimestres = {};
            const getQuarter = (date) => {
                const month = date.getMonth();
                const year = date.getFullYear();
                const q = Math.floor(month / 3) + 1;
                return `Q${q} ${year}`;
            };
            
            cloudSolicitudes.forEach(sol => {
                if (sol.fechaCreacion) {
                    const fecha = new Date(sol.fechaCreacion);
                    const trimestre = getQuarter(fecha);
                    
                    if (!trimestres[trimestre]) {
                        trimestres[trimestre] = {
                            total: 0,
                            completadas: 0,
                            erroresUsuario: 0,
                            tiempos: [],
                            eficiencia: 0,
                            satisfaccion: null
                        };
                    }
                    
                    trimestres[trimestre].total++;
                    
                    if (sol.estado === 'COMPLETADA' || sol.estado === 'Completada') {
                        trimestres[trimestre].completadas++;
                        if (sol.tiempoTotalRespuesta) {
                            const match = sol.tiempoTotalRespuesta.match(/(\d+)h\s*(\d+)m/);
                            if (match) {
                                const totalMinutes = parseInt(match[1]) * 60 + parseInt(match[2]);
                                trimestres[trimestre].tiempos.push(totalMinutes);
                            }
                        }
                    }
                    
                    // Contar errores de usuario
                    if (sol.tipoServicio === 'ERROR_USUARIO' || sol.tipoServicio === 'Error de Usuario') {
                        trimestres[trimestre].erroresUsuario++;
                    }
                }
            });
            
            // Calcular métricas
            Object.keys(trimestres).forEach(trim => {
                const data = trimestres[trim];
                data.eficiencia = data.total > 0 ? Math.round((data.completadas / data.total) * 100) : 0;
                
                if (data.tiempos.length > 0) {
                    const promedio = data.tiempos.reduce((a, b) => a + b, 0) / data.tiempos.length;
                    data.tiempoPromedio = formatearTiempo(promedio);
                }
                
                // Simular satisfacción basada en eficiencia y errores de usuario
                const porcentajeErrores = data.total > 0 ? (data.erroresUsuario / data.total) * 100 : 0;
                data.satisfaccion = data.eficiencia >= 80 && porcentajeErrores < 10 ? 95 : 
                                   data.eficiencia >= 60 && porcentajeErrores < 20 ? 85 : 75;
            });
            
            // Calcular tendencia y proyección
            const valores = Object.values(trimestres).map(t => t.total);
            const promedio = valores.reduce((a, b) => a + b, 0) / valores.length;
            const ultimoValor = valores[valores.length - 1] || 0;
            
            const tendencia = ultimoValor > promedio ? 'Creciente ↗️' : ultimoValor < promedio ? 'Decreciente ↘️' : 'Estable →';
            const proyeccion = Math.round(ultimoValor * 1.1); // Proyección simple +10%
            
            const recomendaciones = [
                'Mantener el nivel de personal actual para cumplir con la demanda',
                'Implementar mantenimiento preventivo para reducir solicitudes correctivas',
                'Mejorar los tiempos de respuesta en áreas críticas',
                'Preservar el historial de técnicos para análisis de desempeño a largo plazo'
            ];
            
            // Agregar recomendación si hay muchos errores de usuario
            const ultimoTrimestre = Object.values(trimestres)[Object.values(trimestres).length - 1];
            if (ultimoTrimestre && ultimoTrimestre.erroresUsuario > 0) {
                const porcentajeErrores = (ultimoTrimestre.erroresUsuario / ultimoTrimestre.total) * 100;
                if (porcentajeErrores > 10) {
                    recomendaciones.unshift('🚨 Implementar urgentemente capacitaciones para reducir errores de usuario');
                }
            }
            
            return {
                porTrimestre: trimestres,
                tendencia,
                proyeccion,
                recomendaciones
            };
        }

        // Formatear tiempo
        function formatearTiempo(minutos) {
            if (!minutos || isNaN(minutos)) return 'N/A';
            const horas = Math.floor(minutos / 60);
            const mins = Math.round(minutos % 60);
            return `${horas}h ${mins}m`;
        }

        // Crear gráficos mensuales
        function createMonthlyCharts(analisisMensual) {
            // Gráfico de tendencia mensual
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;
            
            const labels = Object.keys(analisisMensual.porMes);
            const totales = labels.map(mes => analisisMensual.porMes[mes].total);
            const completadas = labels.map(mes => analisisMensual.porMes[mes].completadas);
            const erroresUsuario = labels.map(mes => analisisMensual.porMes[mes].erroresUsuario);
            
            if (chartInstances.monthlyTrendChart) {
                chartInstances.monthlyTrendChart.destroy();
            }
            
            chartInstances.monthlyTrendChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Solicitudes',
                        data: totales,
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Completadas',
                        data: completadas,
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        tension: 0.3
                    }, {
                        label: 'Errores de Usuario',
                        data: erroresUsuario,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Tendencia Mensual de Solicitudes'
                        }
                    }
                }
            });
            
            // Gráfico de distribución por área mensual
            const ctxArea = document.getElementById('monthlyAreaChart');
            if (!ctxArea) return;
            
            if (chartInstances.monthlyAreaChart) {
                chartInstances.monthlyAreaChart.destroy();
            }
            
            const datasets = ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'].map((area, index) => {
                const colors = ['#059669', '#f59e0b', '#8b5cf6'];
                return {
                    label: getAreaName(area),
                    data: labels.map(mes => analisisMensual.porMes[mes].porArea[area]),
                    backgroundColor: colors[index]
                };
            });
            
            chartInstances.monthlyAreaChart = new Chart(ctxArea.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: true },
                        y: { stacked: true }
                    }
                }
            });
        }

        // Crear gráficos trimestrales
        function createQuarterlyCharts(analisisTrimestral) {
            const ctx = document.getElementById('quarterlyComparisonChart');
            if (!ctx) return;
            
            const labels = Object.keys(analisisTrimestral.porTrimestre);
            const eficiencias = labels.map(trim => analisisTrimestral.porTrimestre[trim].eficiencia);
            const totales = labels.map(trim => analisisTrimestral.porTrimestre[trim].total);
            const erroresUsuario = labels.map(trim => analisisTrimestral.porTrimestre[trim].erroresUsuario);
            
            if (chartInstances.quarterlyComparisonChart) {
                chartInstances.quarterlyComparisonChart.destroy();
            }
            
            chartInstances.quarterlyComparisonChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Solicitudes',
                        data: totales,
                        backgroundColor: '#2563eb',
                        yAxisID: 'y'
                    }, {
                        label: 'Errores de Usuario',
                        data: erroresUsuario,
                        backgroundColor: '#ef4444',
                        yAxisID: 'y'
                    }, {
                        label: 'Eficiencia (%)',
                        data: eficiencias,
                        type: 'line',
                        borderColor: '#059669',
                        backgroundColor: 'rgba(5, 150, 105, 0.1)',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left'
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            max: 100,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Función para normalizar áreas en estadísticas
        function normalizarAreaParaEstadisticas(area) {
            if (!area) return 'OTRO';
            
            const areaLower = area.toLowerCase();
            if (area === 'INGENIERIA_BIOMEDICA' || 
                area === 'Ingeniería Biomédica' ||
                areaLower.includes('biomed') || 
                areaLower.includes('bioméd')) {
                return 'INGENIERIA_BIOMEDICA';
            } else if (area === 'MECANICA' || area === 'Mecánica' || areaLower.includes('mec')) {
                return 'MECANICA';
            } else if (area === 'INFRAESTRUCTURA' || area === 'Infraestructura' || areaLower.includes('infra')) {
                return 'INFRAESTRUCTURA';
            }
            
            return 'OTRO';
        }

        // Crear gráfico de estados
        function createEstadoChart(stats) {
            const ctx = document.getElementById('estadoChart').getContext('2d');
            
            if (chartInstances.estadoChart) {
                chartInstances.estadoChart.destroy();
            }
            
            chartInstances.estadoChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendientes', 'Asignadas', 'En Proceso', 'Completadas', 'Canceladas'],
                    datasets: [{
                        data: [
                            stats.solicitudes.pendientes,
                            stats.solicitudes.asignadas,
                            stats.solicitudes.enProceso,
                            stats.solicitudes.completadas,
                            stats.solicitudes.canceladas
                        ],
                        backgroundColor: [
                            '#f59e0b',
                            '#0ea5e9',
                            '#8b5cf6',
                            '#059669',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Crear gráfico de áreas
        function createAreaChart(stats) {
            const ctx = document.getElementById('areaChart').getContext('2d');
            
            if (chartInstances.areaChart) {
                chartInstances.areaChart.destroy();
            }
            
            chartInstances.areaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Ing. Biomédica', 'Mecánica', 'Infraestructura'],
                    datasets: [{
                        label: 'Solicitudes por Área',
                        data: [
                            stats.solicitudes.porArea.INGENIERIA_BIOMEDICA,
                            stats.solicitudes.porArea.MECANICA,
                            stats.solicitudes.porArea.INFRAESTRUCTURA
                        ],
                        backgroundColor: [
                            '#059669',
                            '#f59e0b',
                            '#8b5cf6'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Crear gráfico de tipos de servicio
        function createTipoServicioChart(stats) {
            const ctx = document.getElementById('tipoServicioChart').getContext('2d');
            
            if (chartInstances.tipoServicioChart) {
                chartInstances.tipoServicioChart.destroy();
            }
            
            const labels = Object.keys(stats.estadisticasPorTipo).map(tipo => {
                const label = tipo.replace(/_/g, ' ');
                return tipo === 'ERROR_USUARIO' ? `${label} ⚠️` : label;
            });
            const data = Object.values(stats.estadisticasPorTipo).map(stat => stat.total);
            
            const backgroundColors = Object.keys(stats.estadisticasPorTipo).map(tipo => 
                tipo === 'ERROR_USUARIO' ? '#ef4444' : '#2563eb'
            );
            
            chartInstances.tipoServicioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cantidad de Solicitudes',
                        data: data,
                        backgroundColor: backgroundColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Cerrar modal de estadísticas
        function closeStatsModal() {
            document.getElementById('stats-modal').classList.remove('show');
        }

        // Actualizar datos de estadísticas
        async function refreshStatsData() {
            await loadAllDataFromCloud();
            await showAdvancedStatisticsModal();
        }

        // Exportar estadísticas a PDF
        async function exportStatsToPDF() {
            try {
                const content = document.getElementById('stats-modal-content');
                
                const pdfContent = document.createElement('div');
                pdfContent.style.width = '210mm';
                pdfContent.style.padding = '20px';
                pdfContent.style.background = 'white';
                pdfContent.innerHTML = `
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h1 style="color: #1f2937; font-size: 24px;">HOSPITAL SUSANA LÓPEZ DE VALENCIA E.S.E.</h1>
                        <h2 style="color: #4b5563; font-size: 18px;">Reporte de Estadísticas del Sistema de Gestión</h2>
                        <p style="color: #6b7280;">Fecha: ${new Date().toLocaleString('es-CO')}</p>
                    </div>
                    ${content.innerHTML}
                `;
                
                document.body.appendChild(pdfContent);
                
                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    logging: false,
                    useCORS: true
                });
                
                document.body.removeChild(pdfContent);
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`Estadisticas_Hospital_${new Date().toISOString().split('T')[0]}.pdf`);
                
                alert('✅ PDF generado exitosamente');
                
            } catch (error) {
                console.error('❌ Error generando PDF:', error);
                alert('❌ Error al generar el PDF: ' + error.message);
            }
        }

        // 📊 Estadísticas simples
        function showRequestsStatistics() {
            const total = cloudSolicitudes.length;
            
            const pendientes = cloudSolicitudes.filter(s => {
                const estadoUpper = (s.estado || 'PENDIENTE').toUpperCase();
                if (estadoUpper === 'COMPLETADA' || estadoUpper === 'CANCELADA') {
                    return false;
                }
                return estadoUpper === 'PENDIENTE' || estadoUpper === 'ASIGNADA' || !s.tecnicoAsignado;
            }).length;
            
            const asignadas = cloudSolicitudes.filter(s => {
                const estado = s.estado ? s.estado.toUpperCase() : '';
                return estado === 'ASIGNADA';
            }).length;
            
            const enProceso = cloudSolicitudes.filter(s => {
                const estado = s.estado ? s.estado.toUpperCase() : '';
                return estado === 'EN_PROCESO' || estado === 'EN PROCESO';
            }).length;
            
            const completadas = cloudSolicitudes.filter(s => {
                const estado = s.estado ? s.estado.toUpperCase() : '';
                return estado === 'COMPLETADA';
            }).length;
            
            const canceladas = cloudSolicitudes.filter(s => {
                const estado = s.estado ? s.estado.toUpperCase() : '';
                return estado === 'CANCELADA';
            }).length;
            
            const erroresUsuario = cloudSolicitudes.filter(s => 
                s.tipoServicio === 'ERROR_USUARIO' || s.tipoServicio === 'Error de Usuario'
            ).length;
            
            // Contar técnicos históricos (que han trabajado pero ya no están activos)
            const tecnicosHistoricos = new Set();
            cloudSolicitudes.forEach(s => {
                if (s.tecnicoAsignado && !cloudTecnicos.find(t => t.nombre === s.tecnicoAsignado)) {
                    tecnicosHistoricos.add(s.tecnicoAsignado);
                }
            });
            
            alert(`📊 ESTADÍSTICAS DE SOLICITUDES\n\n` +
                `📋 Total: ${total}\n` +
                `⏳ Pendientes (incluye asignadas): ${pendientes}\n` +
                `🎯 Solo Asignadas: ${asignadas}\n` +
                `🔄 En Proceso: ${enProceso}\n` +
                `✅ Completadas: ${completadas}\n` +
                `❌ Canceladas: ${canceladas}\n` +
                `👤 Errores de Usuario: ${erroresUsuario} (${total > 0 ? ((erroresUsuario / total) * 100).toFixed(1) : 0}%)\n\n` +
                `📌 Personal histórico preservado: ${tecnicosHistoricos.size} técnicos\n` +
                `📌 Las solicitudes completadas mantienen el registro del personal\n` +
                `🕐 ${new Date().toLocaleTimeString('es-CO')}`
            );
        }

        // 🔍 Filtros
        function filterSolicitudes() {
            const estadoFilter = document.getElementById('filter-estado-solicitud').value;
            const areaFilter = document.getElementById('filter-area-solicitud').value;
            const prioridadFilter = document.getElementById('filter-prioridad-solicitud').value;
            
            console.log('🔍 Aplicando filtros:', { estado: estadoFilter, area: areaFilter, prioridad: prioridadFilter });
            
            filteredSolicitudes = cloudSolicitudes.filter(solicitud => {
                let pass = true;
                
                if (estadoFilter) {
                    const solicitudEstado = solicitud.estado ? solicitud.estado.toUpperCase() : 'PENDIENTE';
                    if (solicitudEstado !== estadoFilter) {
                        pass = false;
                    }
                }
                
                if (areaFilter) {
                    const solicitudArea = solicitud.servicioIngenieria || '';
                    const lowerArea = solicitudArea.toLowerCase();
                    
                    if (areaFilter === 'INGENIERIA_BIOMEDICA') {
                        pass = pass && (
                            solicitudArea === 'INGENIERIA_BIOMEDICA' || 
                            solicitudArea === 'Ingeniería Biomédica' ||
                            lowerArea.includes('biomed') || 
                            lowerArea.includes('bioméd')
                        );
                    } else if (areaFilter === 'MECANICA') {
                        pass = pass && (solicitudArea === 'MECANICA' || solicitudArea === 'Mecánica' || lowerArea.includes('mec'));
                    } else if (areaFilter === 'INFRAESTRUCTURA') {
                        pass = pass && (solicitudArea === 'INFRAESTRUCTURA' || solicitudArea === 'Infraestructura' || lowerArea.includes('infra'));
                    }
                }
                
                if (prioridadFilter) {
                    const solicitudPrioridad = solicitud.prioridad ? solicitud.prioridad.toUpperCase() : 'MEDIA';
                    if (solicitudPrioridad !== prioridadFilter) {
                        pass = false;
                    }
                }
                
                return pass;
            });
            
            console.log(`✅ Filtros aplicados: ${filteredSolicitudes.length} de ${cloudSolicitudes.length} solicitudes`);
            updateSolicitudesList();
        }

        function clearSolicitudesFilters() {
            document.getElementById('filter-estado-solicitud').value = '';
            document.getElementById('filter-area-solicitud').value = '';
            document.getElementById('filter-prioridad-solicitud').value = '';
            
            filteredSolicitudes = [...cloudSolicitudes];
            updateSolicitudesList();
        }

        // 👥 Funciones de personal
        function updateTechniciansList() {
            const container = document.getElementById('technicians-container');
            
            if (cloudTecnicos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">👥</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay personal registrado</h3>
                        <p>Agregue personal para poder asignar solicitudes</p>
                        <button class="btn btn-success" onclick="showAddPersonalModal()" style="margin-top: 1rem;">
                            ➕ Agregar Personal
                        </button>
                    </div>
                `;
            } else {
                // Aplicar filtros
                let filteredTecnicos = [...cloudTecnicos];
                
                const areaFilter = document.getElementById('filter-area')?.value;
                const estadoFilter = document.getElementById('filter-estado')?.value;
                const tipoFilter = document.getElementById('filter-tipo')?.value;
                
                if (areaFilter) {
                    filteredTecnicos = filteredTecnicos.filter(t => {
                        const tecnicoArea = t.area || '';
                        const lowerArea = tecnicoArea.toLowerCase();
                        
                        if (areaFilter === 'INGENIERIA_BIOMEDICA') {
                            return tecnicoArea === 'INGENIERIA_BIOMEDICA' || 
                                   tecnicoArea === 'Ingeniería Biomédica' ||
                                   lowerArea.includes('biomed') || 
                                   lowerArea.includes('bioméd');
                        } else if (areaFilter === 'MECANICA') {
                            return tecnicoArea === 'MECANICA' || tecnicoArea === 'Mecánica' || lowerArea.includes('mec');
                        } else if (areaFilter === 'INFRAESTRUCTURA') {
                            return tecnicoArea === 'INFRAESTRUCTURA' || tecnicoArea === 'Infraestructura' || lowerArea.includes('infra');
                        }
                        return false;
                    });
                }
                
                if (estadoFilter) {
                    const estadoFilterLower = estadoFilter.toString().toLowerCase();
                    filteredTecnicos = filteredTecnicos.filter(t => String(t.estado || '').toLowerCase() === estadoFilterLower);
                }
                
                if (tipoFilter) {
                    const tipoFilterLower = tipoFilter.toString().toLowerCase();
                    filteredTecnicos = filteredTecnicos.filter(t => String(t.tipo || '').toLowerCase() === tipoFilterLower);
                }

                // Calcular estadísticas rápidas por técnico
                const techStats = new Map();
                cloudSolicitudes.forEach(sol => {
                    if (sol.tecnicoAsignado) {
                        if (!techStats.has(sol.tecnicoAsignado)) {
                            techStats.set(sol.tecnicoAsignado, {
                                total: 0,
                                completadas: 0,
                                enProceso: 0
                            });
                        }
                        const stats = techStats.get(sol.tecnicoAsignado);
                        stats.total++;
                        if ((sol.estado || '').toUpperCase() === 'COMPLETADA') {
                            stats.completadas++;
                        } else if (['EN_PROCESO', 'EN PROCESO', 'ASIGNADA'].includes((sol.estado || '').toUpperCase())) {
                            stats.enProceso++;
                        }
                    }
                });

                container.innerHTML = `
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">
                            ✅ ${filteredTecnicos.length} Personal de Soporte 
                            ${filteredTecnicos.length < cloudTecnicos.length ? `(de ${cloudTecnicos.length} total)` : ''}
                        </h4>
                        <p style="color: #047857; font-size: 0.875rem;">
                            Personal registrado en Airtable con capacidad de asignación y estadísticas de desempeño
                        </p>
                    </div>
                    ${filteredTecnicos.map(tecnico => createTechnicianCard(tecnico, techStats.get(tecnico.nombre))).join('')}
                `;
            }
        }

        function createTechnicianCard(tecnico, stats) {
            const estadoClasses = {
                'disponible': 'status-disponible',
                'ocupado': 'status-ocupado',
                'inactivo': 'status-inactivo'
            };

            const estadoLabels = {
                'disponible': '🟢 Disponible',
                'ocupado': '🟡 Ocupado',
                'inactivo': '🔴 Inactivo'
            };

            const tipoLabels = {
                'ingeniero': '🎓 Ingeniero',
                'tecnico': '🔧 Técnico',
                'auxiliar': '🛠️ Auxiliar'
            };

            const performanceInfo = stats ? `
                <div style="margin-top: 1rem; padding: 0.75rem; background: #e0f2fe; border-radius: 0.5rem;">
                    <span style="color: #0369a1; font-weight: 600;">📊 Desempeño:</span>
                    <span style="color: #0284c7; margin-left: 0.5rem;">
                        Total: ${stats.total} | Completadas: ${stats.completadas} | En proceso: ${stats.enProceso}
                    </span>
                </div>
            ` : '';

            return `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: #1f2937; font-weight: 600; font-size: 1.125rem;">
                            👤 ${tecnico.nombre}
                        </h4>
                        <span class="${estadoClasses[tecnico.estado] || 'status-disponible'}" style="padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                            ${estadoLabels[tecnico.estado] || tecnico.estado}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; font-size: 0.875rem;">
                        <div>
                            <span style="color: #6b7280; font-weight: 600;">📧 Email:</span>
                            <span style="color: #1f2937; margin-left: 0.5rem;">${tecnico.email || 'No especificado'}</span>
                        </div>
                        <div>
                            <span style="color: #6b7280; font-weight: 600;">🏥 Área:</span>
                            <span style="color: #1f2937; margin-left: 0.5rem;">${getAreaName(tecnico.area)}</span>
                        </div>
                        <div>
                            <span style="color: #6b7280; font-weight: 600;">👨‍💼 Tipo:</span>
                            <span style="color: #1f2937; margin-left: 0.5rem;">${tipoLabels[tecnico.tipo] || tecnico.tipo}</span>
                        </div>
                        <div>
                            <span style="color: #6b7280; font-weight: 600;">⚙️ Especialidad:</span>
                            <span style="color: #1f2937; margin-left: 0.5rem;">${tecnico.especialidad || 'No especificada'}</span>
                        </div>
                    </div>
                    
                    ${tecnico.solicitudAsignada ? `
                        <div style="margin-top: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 0.5rem;">
                            <span style="color: #d97706; font-weight: 600;">📋 Asignado a:</span>
                            <span style="color: #92400e; margin-left: 0.5rem;">${tecnico.solicitudAsignada}</span>
                        </div>
                    ` : ''}
                    
                    ${performanceInfo}
                    
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-primary btn-sm" onclick="editPersonal('${tecnico.id}')">
                            ✏️ Editar
                        </button>
                        ${tecnico.estado === 'inactivo' ? `
                            <button class="btn btn-success btn-sm" onclick="activatePersonal('${tecnico.id}')">
                                ✅ Activar
                            </button>
                        ` : `
                            <button class="btn btn-warning btn-sm" onclick="deactivatePersonal('${tecnico.id}')">
                                ⏸️ Desactivar
                            </button>
                        `}
                        <button class="btn btn-info btn-sm" onclick="viewPersonalHistory('${tecnico.id}')">
                            📊 Historial Completo
                        </button>
                    </div>
                </div>
            `;
        }

        function filterPersonal() {
            updateTechniciansList();
        }

        function clearPersonalFilters() {
            document.getElementById('filter-area').value = '';
            document.getElementById('filter-estado').value = '';
            document.getElementById('filter-tipo').value = '';
            updateTechniciansList();
        }

        function showAddPersonalModal() {
            document.getElementById('add-personal-modal').classList.add('show');
            document.getElementById('add-personal-form').reset();
        }

        function closeAddPersonalModal() {
            document.getElementById('add-personal-modal').classList.remove('show');
        }

        async function handleAddPersonalForm(event) {
            event.preventDefault();
            
            const nombre = document.getElementById('personal-nombre').value.trim();
            const email = document.getElementById('personal-email').value.trim();
            const area = document.getElementById('personal-area').value;
            const tipo = document.getElementById('personal-tipo').value;
            const especialidad = document.getElementById('personal-especialidad').value.trim();
            const estado = document.getElementById('personal-estado').value;
            
            if (!nombre || !email || !area || !tipo) {
                alert('❌ Por favor complete todos los campos obligatorios');
                return;
            }
            
            try {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '⏳ Guardando...';
                
                const personalData = {
                    nombre: nombre,
                    email: email,
                    area: area,
                    tipo: tipo,
                    especialidad: especialidad || '',
                    estado: estado
                };
                
                console.log('➕ Creando personal:', personalData);
                await window.airtableAPI.createTecnico(personalData);
                
                await syncTechniciansWithCloud();
                closeAddPersonalModal();
                
                alert(`✅ Personal agregado exitosamente\n\n👤 ${nombre}\n📧 ${email}\n🏥 ${getAreaName(area)}\n🕐 ${new Date().toLocaleTimeString('es-CO')}`);
                
            } catch (error) {
                console.error('❌ Error agregando personal:', error);
                alert('❌ Error al agregar personal: ' + error.message);
            } finally {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '💾 Guardar Personal';
                }
            }
        }

        async function editPersonal(personalId) {
            const personal = cloudTecnicos.find(t => t.id === personalId);
            if (!personal) {
                alert('❌ Personal no encontrado');
                return;
            }

            const modal = document.getElementById('edit-personal-modal');
            const content = document.getElementById('edit-personal-content');
            
            content.innerHTML = `
                <form id="edit-personal-form" onsubmit="handleEditPersonal(event, '${personalId}')">
                    <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                        <div>
                            <label class="form-label">👤 Nombre Completo</label>
                            <input type="text" id="edit-nombre" value="${personal.nombre}" required class="form-input">
                        </div>
                        <div>
                            <label class="form-label">📧 Email</label>
                            <input type="email" id="edit-email" value="${personal.email}" required class="form-input">
                        </div>
                        <div>
                            <label class="form-label">🏥 Área de Trabajo</label>
                            <select id="edit-area" required class="form-select">
                                <option value="INGENIERIA_BIOMEDICA" ${personal.area === 'INGENIERIA_BIOMEDICA' || personal.area === 'Ingeniería Biomédica' ? 'selected' : ''}>Ingeniería Biomédica</option>
                                <option value="MECANICA" ${personal.area === 'MECANICA' || personal.area === 'Mecánica' ? 'selected' : ''}>Mecánica</option>
                                <option value="INFRAESTRUCTURA" ${personal.area === 'INFRAESTRUCTURA' || personal.area === 'Infraestructura' ? 'selected' : ''}>Infraestructura</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">👨‍💼 Tipo</label>
                            <select id="edit-tipo" required class="form-select">
                                <option value="ingeniero" ${personal.tipo === 'ingeniero' ? 'selected' : ''}>🎓 Ingeniero</option>
                                <option value="tecnico" ${personal.tipo === 'tecnico' ? 'selected' : ''}>🔧 Técnico</option>
                                <option value="auxiliar" ${personal.tipo === 'auxiliar' ? 'selected' : ''}>🛠️ Auxiliar</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label">⚙️ Especialidad</label>
                            <input type="text" id="edit-especialidad" value="${personal.especialidad || ''}" class="form-input">
                        </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem; justify-content: center;">
                        <button type="submit" class="btn btn-success">
                            💾 Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditPersonalModal()">
                            ↩️ Cancelar
                        </button>
                    </div>
                </form>
            `;
            
            modal.classList.add('show');
        }

        async function handleEditPersonal(event, personalId) {
            event.preventDefault();
            
            const nombre = document.getElementById('edit-nombre').value.trim();
            const email = document.getElementById('edit-email').value.trim();
            const area = document.getElementById('edit-area').value;
            const tipo = document.getElementById('edit-tipo').value;
            const especialidad = document.getElementById('edit-especialidad').value.trim();
            
            try {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '⏳ Guardando...';
                
                await window.airtableAPI.updateTecnico(personalId, {
                    nombre: nombre,
                    email: email,
                    area: area,
                    tipo: tipo,
                    especialidad: especialidad || ''
                });
                
                await syncTechniciansWithCloud();
                closeEditPersonalModal();
                
                alert('✅ Personal actualizado exitosamente');
                
            } catch (error) {
                console.error('❌ Error actualizando personal:', error);
                alert('❌ Error al actualizar personal: ' + error.message);
            } finally {
                const submitBtn = event.target.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '💾 Guardar Cambios';
                }
            }
        }

        function closeEditPersonalModal() {
            document.getElementById('edit-personal-modal').classList.remove('show');
        }

        async function activatePersonal(personalId) {
            try {
                await window.airtableAPI.updateTecnico(personalId, { estado: 'disponible' });
                await syncTechniciansWithCloud();
                alert('✅ Personal activado exitosamente');
            } catch (error) {
                alert('❌ Error al activar personal: ' + error.message);
            }
        }

        async function deactivatePersonal(personalId) {
            const personal = cloudTecnicos.find(t => t.id === personalId);
            if (personal && personal.solicitudAsignada) {
                const confirmed = confirm('⚠️ Este personal tiene una solicitud asignada.\n\n¿Está seguro que desea desactivarlo?\n\nLa solicitud quedará sin personal asignado.');
                if (!confirmed) return;
            }
            
            try {
                await window.airtableAPI.updateTecnico(personalId, { estado: 'inactivo' });
                await syncTechniciansWithCloud();
                alert('✅ Personal desactivado exitosamente');
            } catch (error) {
                alert('❌ Error al desactivar personal: ' + error.message);
            }
        }

        // FUNCIÓN MEJORADA: Ver historial completo del personal
        function viewPersonalHistory(personalId) {
            const personal = cloudTecnicos.find(t => t.id === personalId);
            if (!personal) {
                alert('❌ Personal no encontrado');
                return;
            }

            const solicitudesAsignadas = cloudSolicitudes.filter(s => s.tecnicoAsignado === personal.nombre);
            const completadas = solicitudesAsignadas.filter(s => {
                const estado = s.estado ? s.estado.toUpperCase() : '';
                return estado === 'COMPLETADA';
            }).length;
            const enProceso = solicitudesAsignadas.filter(s => {
                const estado = s.estado ? s.estado.toUpperCase() : '';
                return estado === 'EN_PROCESO' || estado === 'EN PROCESO' || estado === 'ASIGNADA';
            }).length;
            const erroresUsuario = solicitudesAsignadas.filter(s => 
                s.tipoServicio === 'ERROR_USUARIO' || s.tipoServicio === 'Error de Usuario'
            ).length;

            // Calcular tiempo promedio de respuesta
            let tiempoPromedio = 'N/A';
            const tiemposCompletadas = solicitudesAsignadas
                .filter(s => s.tiempoTotalRespuesta && (s.estado || '').toUpperCase() === 'COMPLETADA')
                .map(s => {
                    const match = s.tiempoTotalRespuesta.match(/(\d+)h\s*(\d+)m/);
                    return match ? parseInt(match[1]) * 60 + parseInt(match[2]) : 0;
                })
                .filter(t => t > 0);
            
            if (tiemposCompletadas.length > 0) {
                const avgMinutos = tiemposCompletadas.reduce((a, b) => a + b, 0) / tiemposCompletadas.length;
                tiempoPromedio = formatearTiempo(Math.round(avgMinutos));
            }

            // Calcular tasa de completado
            const tasaCompletado = solicitudesAsignadas.length > 0 ? 
                Math.round((completadas / solicitudesAsignadas.length) * 100) : 0;

            // Mostrar últimas 5 solicitudes
            const ultimasSolicitudes = solicitudesAsignadas
                .sort((a, b) => new Date(b.fechaCreacion || 0) - new Date(a.fechaCreacion || 0))
                .slice(0, 5)
                .map(s => `• ${s.numero} - ${s.estado} - ${getAreaName(s.servicioIngenieria)}`)
                .join('\n');

            alert(`📊 HISTORIAL COMPLETO DE ${personal.nombre.toUpperCase()}\n\n` +
                `👤 Información Personal:\n` +
                `• Email: ${personal.email}\n` +
                `• Área: ${getAreaName(personal.area)}\n` +
                `• Tipo: ${personal.tipo}\n` +
                `• Estado: ${personal.estado}\n` +
                `• Especialidad: ${personal.especialidad || 'No especificada'}\n\n` +
                `📋 Estadísticas de Desempeño:\n` +
                `• Total asignaciones: ${solicitudesAsignadas.length}\n` +
                `• Completadas: ${completadas}\n` +
                `• En proceso/asignadas: ${enProceso}\n` +
                `• Errores de usuario resueltos: ${erroresUsuario}\n` +
                `• Tasa de completado: ${tasaCompletado}%\n` +
                `• Tiempo promedio de respuesta: ${tiempoPromedio}\n\n` +
                `📌 Últimas 5 Solicitudes:\n${ultimasSolicitudes || 'Sin solicitudes'}\n\n` +
                `${personal.solicitudAsignada ? `📌 Asignación actual: ${personal.solicitudAsignada}\n` : '📌 Sin asignación actual\n'}` +
                `🕐 ${new Date().toLocaleTimeString('es-CO')}`
            );
        }

        function showPersonalStatistics() {
            const total = cloudTecnicos.length;
            const disponibles = cloudTecnicos.filter(t => String(t.estado || '').toLowerCase() === 'disponible').length;
            const ocupados = cloudTecnicos.filter(t => String(t.estado || '').toLowerCase() === 'ocupado').length;
            const inactivos = cloudTecnicos.filter(t => String(t.estado || '').toLowerCase() === 'inactivo').length;
            
            const ingenieros = cloudTecnicos.filter(t => String(t.tipo || '').toLowerCase() === 'ingeniero').length;
            const tecnicos = cloudTecnicos.filter(t => String(t.tipo || '').toLowerCase() === 'tecnico').length;
            const auxiliares = cloudTecnicos.filter(t => String(t.tipo || '').toLowerCase() === 'auxiliar').length;
            
            // Contar técnicos históricos
            const tecnicosHistoricos = new Set();
            cloudSolicitudes.forEach(s => {
                if (s.tecnicoAsignado && !cloudTecnicos.find(t => t.nombre === s.tecnicoAsignado)) {
                    tecnicosHistoricos.add(s.tecnicoAsignado);
                }
            });
            
            alert(`📊 ESTADÍSTICAS DE PERSONAL\n\n` +
                `👥 Total Activo: ${total} personas\n` +
                `📋 Personal Histórico: ${tecnicosHistoricos.size} técnicos\n\n` +
                `📊 POR ESTADO:\n` +
                `• 🟢 Disponibles: ${disponibles}\n` +
                `• 🟡 Ocupados: ${ocupados}\n` +
                `• 🔴 Inactivos: ${inactivos}\n\n` +
                `📊 POR TIPO:\n` +
                `• 🎓 Ingenieros: ${ingenieros}\n` +
                `• 🔧 Técnicos: ${tecnicos}\n` +
                `• 🛠️ Auxiliares: ${auxiliares}\n\n` +
                `📊 TASA DE OCUPACIÓN: ${total > 0 ? Math.round((ocupados / total) * 100) : 0}%\n` +
                `📌 El historial de trabajo se mantiene incluso si el personal ya no está activo\n` +
                `🕐 ${new Date().toLocaleTimeString('es-CO')}`
            );
        }

        async function debugPersonalConnection() {
            try {
                const testResult = await window.airtableAPI.testTecnicosTable();
                
                alert(`🔧 DEBUG DE CONEXIÓN - TABLA PERSONAL\n\n` +
                    `${testResult.success ? '✅' : '❌'} Estado: ${testResult.success ? 'Conectado' : 'Error'}\n` +
                    `📊 Registros encontrados: ${testResult.records || 0}\n` +
                    `${testResult.sampleData ? `📋 Muestra de datos:\n${JSON.stringify(testResult.sampleData, null, 2)}` : ''}\n` +
                    `${testResult.error ? `❌ Error: ${testResult.error}` : ''}\n` +
                    `${testResult.status ? `🚨 HTTP Status: ${testResult.status}` : ''}\n\n` +
                    `🕐 ${new Date().toLocaleTimeString('es-CO')}`
                );
                
            } catch (error) {
                alert(`❌ Error en debug: ${error.message}`);
            }
        }

        // 🔐 Funciones de gestión de accesos
        function updateAccessRequestsList() {
            const container = document.getElementById('access-requests-container');
            
            if (cloudSolicitudesAcceso.length === 0 && cloudUsuarios.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">🔐</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes de acceso</h3>
                        <p>Las solicitudes aparecerán aquí cuando los usuarios las envíen desde el Portal</p>
                    </div>
                `;
            } else {
                // Separar solicitudes por estado
                const pendientes = cloudSolicitudesAcceso.filter(s => {
                    const estado = s.estado ? s.estado.toUpperCase() : 'PENDIENTE';
                    return estado === 'PENDIENTE';
                });
                const aprobadas = cloudSolicitudesAcceso.filter(s => {
                    const estado = s.estado ? s.estado.toUpperCase() : '';
                    return estado === 'APROBADA';
                });
                const rechazadas = cloudSolicitudesAcceso.filter(s => {
                    const estado = s.estado ? s.estado.toUpperCase() : '';
                    return estado === 'RECHAZADA';
                });
                
                container.innerHTML = `
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: #d97706; margin-bottom: 0.5rem;">⏳ Pendientes de Aprobación (${pendientes.length})</h4>
                        <p style="color: #92400e; font-size: 0.875rem;">Solicitudes esperando revisión</p>
                    </div>
                    ${pendientes.length > 0 ? 
                        pendientes.map(s => createAccessRequestCard(s, 'pending')).join('') :
                        '<p style="text-align: center; color: #6b7280; padding: 2rem;">No hay solicitudes pendientes</p>'
                    }
                    
                    <div style="background: #dcfce7; padding: 1rem; border-