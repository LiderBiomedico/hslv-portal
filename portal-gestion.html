<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Gesti√≥n Cloud - Hospital Susana L√≥pez de Valencia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .developer-credit {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
            margin-top: 0.25rem;
            margin-bottom: 0;
            text-align: center;
            font-style: italic;
        }

        /* Indicador de conexi√≥n Airtable */
        .connection-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(34, 197, 94, 0.3);
            color: #dcfce7;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.3);
            color: #fee2e2;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Botones */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-error {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* Access Request Cards */
        .access-request-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            position: relative;
        }

        .access-request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .access-request-card.pending {
            border-left: 6px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 20%, #ffffff 100%);
        }

        .access-request-card.approved {
            border-left: 6px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 20%, #ffffff 100%);
        }

        .access-request-card.rejected {
            border-left: 6px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 20%, #ffffff 100%);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .request-name {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
        }

        .request-status {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
        }

        .status-aprobada {
            background: #dcfce7;
            color: #166534;
        }

        .status-rechazada {
            background: #fee2e2;
            color: #dc2626;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .request-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-detail-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
        }

        .request-detail-value {
            color: #1f2937;
            font-weight: 500;
        }

        .request-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .access-code-display {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #2563eb;
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
        }

        .access-code {
            font-size: 3rem;
            font-weight: bold;
            color: #2563eb;
            letter-spacing: 0.5rem;
            font-family: 'Courier New', monospace;
            margin: 1rem 0;
        }

        .hidden {
            display: none !important;
        }

        /* Debug panel styles */
        .debug-panel {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.75rem;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .debug-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
            border-bottom: 1px solid #374151;
        }

        .debug-success { color: #34d399; }
        .debug-error { color: #f87171; }
        .debug-warning { color: #fbbf24; }
        .debug-info { color: #60a5fa; }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content container">
            <!-- Indicador de conexi√≥n Airtable -->
            <div id="connection-status" class="connection-status disconnected">
                <span id="connection-icon">üîÑ</span>
                <span id="connection-text">Conectando...</span>
            </div>
            
            <div class="logo">
                <div class="hospital-info">
                    <h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
                    <p class="developer-credit">Desarrollado por Ing. Paul Eduardo Mu√±oz R.</p>
                    <p>Portal de Gesti√≥n Cloud - ERROR 404 SOLUCIONADO</p>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showView('accesos')" data-view="accesos">
                    üîê Gesti√≥n de Accesos
                </button>
                <button class="nav-tab" onclick="showDebugPanel()" data-view="debug">
                    üêõ Panel Debug
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-layout container">
        <!-- Accesos View - SOLUCIONADO -->
        <div id="accesos-view" class="view">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üîê Gesti√≥n de Accesos (ERROR 404 SOLUCIONADO)</h2>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-success btn-sm" onclick="refreshAccessFromCloud()">
                            üîÑ Actualizar desde Airtable
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="testApprovalProcess()">
                            üß™ Test Proceso Completo
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="generateTestRequests()">
                            üìù Generar Solicitudes Test
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Debug Panel -->
                    <div class="alert alert-success">
                        <h4 style="margin-bottom: 0.5rem;">‚úÖ PROBLEMA SOLUCIONADO</h4>
                        <p><strong>Error original:</strong> "Record undefined no encontrado para actualizar"</p>
                        <p><strong>Causa:</strong> requestId llegaba como undefined al m√©todo de actualizaci√≥n</p>
                        <p><strong>Soluci√≥n:</strong> Validaci√≥n robusta de IDs y manejo mejorado de errores</p>
                    </div>

                    <!-- Debug real-time -->
                    <div id="debug-console" class="debug-panel">
                        <div class="debug-entry debug-info">[Inicio] Sistema de depuraci√≥n activado</div>
                    </div>

                    <!-- Lista de solicitudes de acceso -->
                    <div id="access-requests-container">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">üîÑ Cargando solicitudes de acceso...</h3>
                            <p>Conectando con la base de datos</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para mostrar c√≥digo de acceso -->
    <div id="access-code-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">üéâ Usuario Aprobado Exitosamente</div>
                <p style="color: #6b7280;">El c√≥digo de acceso ha sido generado</p>
            </div>
            
            <div id="user-approved-info" style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                <!-- Info del usuario aprobado se llena din√°micamente -->
            </div>

            <div class="access-code-display">
                <h3 style="color: #2563eb; margin-bottom: 0.5rem;">C√≥digo de Acceso</h3>
                <div class="access-code" id="generated-access-code">----</div>
                <p style="color: #6b7280; font-size: 0.875rem;">
                    El usuario puede usar este c√≥digo para iniciar sesi√≥n
                </p>
            </div>

            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="copyAccessCode()">
                    üìã Copiar C√≥digo
                </button>
                <button class="btn btn-success" onclick="closeAccessCodeModal()">
                    ‚úÖ Cerrar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let cloudSolicitudesAcceso = [];
        let cloudUsuarios = [];
        let isConnectedToAirtable = false;
        let debugLog = [];

        // Mapas para los datos
        const serviciosHospitalarios = {
            'URGENCIAS_ADULTO': 'Urgencias Adulto',
            'URGENCIAS_PEDIATRICAS': 'Urgencias Pedi√°tricas',
            'UCI_ADULTO': 'UCI Adulto',
            'UCI_NEONATAL': 'UCI Neonatal',
            'HOSPITALIZACION_ADULTO': 'Hospitalizaci√≥n Adulto',
            'CIRUGIA_ADULTO': 'Cirug√≠a Adulto',
            'CONSULTA_EXTERNA': 'Consulta Externa',
            'LABORATORIO_CLINICO': 'Laboratorio Cl√≠nico',
            'RADIOLOGIA': 'Radiolog√≠a',
            'FARMACIA_CENTRAL': 'Farmacia Central',
            'FISIOTERAPIA': 'Fisioterapia',
            'INGENIERIA_BIOMEDICA': 'Ingenier√≠a Biom√©dica',
            'INFRAESTRUCTURA': 'Infraestructura',
            'MECANICOS': 'Mec√°nicos'
        };

        const cargosHospitalarios = {
            'JEFE_SERVICIO': 'Jefe de Servicio',
            'COORDINADOR': 'Coordinador',
            'ENFERMERA_JEFE': 'Enfermera Jefe',
            'MEDICO_ESPECIALISTA': 'M√©dico Especialista',
            'AUXILIAR_ENFERMERIA': 'Auxiliar de Enfermer√≠a',
            'ADMINISTRATIVO': 'Personal Administrativo'
        };

        // üìù Funci√≥n de logging mejorada
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('es-CO');
            const entry = `[${timestamp}] ${message}`;
            
            console.log(entry);
            
            const debugConsole = document.getElementById('debug-console');
            if (debugConsole) {
                const logEntry = document.createElement('div');
                logEntry.className = `debug-entry debug-${type}`;
                logEntry.textContent = entry;
                
                debugConsole.appendChild(logEntry);
                debugConsole.scrollTop = debugConsole.scrollHeight;
                
                // Mantener solo las √∫ltimas 50 entradas
                while (debugConsole.children.length > 50) {
                    debugConsole.removeChild(debugConsole.firstChild);
                }
            }
        }

        // üîó Funciones de conexi√≥n
        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connection-status');
            const iconSpan = document.getElementById('connection-icon');
            const textSpan = document.getElementById('connection-text');
            
            statusDiv.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    iconSpan.textContent = 'üü¢';
                    textSpan.textContent = 'Airtable Conectado';
                    isConnectedToAirtable = true;
                    debugLog('Conexi√≥n establecida con Airtable', 'success');
                    break;
                case 'disconnected':
                    iconSpan.textContent = 'üî¥';
                    textSpan.textContent = 'Sin conexi√≥n';
                    isConnectedToAirtable = false;
                    debugLog('Sin conexi√≥n a Airtable - modo local', 'warning');
                    break;
                default:
                    iconSpan.textContent = 'üîÑ';
                    textSpan.textContent = message || 'Conectando...';
            }
        }

        // üîÑ Funciones de carga de datos MEJORADAS
        async function loadAccessRequestsFromCloud() {
            debugLog('üîç Cargando solicitudes de acceso desde la nube...', 'info');
            
            try {
                if (window.airtableAPI && isConnectedToAirtable) {
                    cloudSolicitudesAcceso = await window.airtableAPI.getSolicitudesAcceso();
                    cloudUsuarios = await window.airtableAPI.getUsuarios();
                    debugLog(`‚úÖ Cargadas ${cloudSolicitudesAcceso.length} solicitudes y ${cloudUsuarios.length} usuarios`, 'success');
                } else {
                    // Fallback a localStorage
                    cloudSolicitudesAcceso = JSON.parse(localStorage.getItem('hospital_access_requests') || '[]');
                    cloudUsuarios = JSON.parse(localStorage.getItem('hospital_approved_users') || '[]');
                    debugLog(`üì± Cargadas ${cloudSolicitudesAcceso.length} solicitudes desde localStorage`, 'warning');
                }
                
                updateAccessRequestsList();
                
            } catch (error) {
                debugLog(`‚ùå Error cargando datos: ${error.message}`, 'error');
                cloudSolicitudesAcceso = [];
                cloudUsuarios = [];
                updateAccessRequestsList();
            }
        }

        async function refreshAccessFromCloud() {
            debugLog('üîÑ Actualizando accesos desde Airtable...', 'info');
            await loadAccessRequestsFromCloud();
            alert(`‚úÖ Accesos actualizados\n\nüìä Solicitudes: ${cloudSolicitudesAcceso.length}\nüìä Usuarios: ${cloudUsuarios.length}`);
        }

        // üèóÔ∏è Funci√≥n para generar solicitudes de prueba
        async function generateTestRequests() {
            debugLog('üß™ Generando solicitudes de prueba...', 'info');
            
            const testRequests = [
                {
                    id: `TEST1_${Date.now()}`,
                    nombreCompleto: 'Mar√≠a Gonz√°lez Test',
                    email: `maria.test.${Date.now()}@hospital.com`,
                    servicioHospitalario: 'UCI_ADULTO',
                    cargo: 'ENFERMERA_JEFE',
                    telefono: '+57 300 123 4567',
                    justificacion: 'Solicitud de prueba para validar sistema',
                    fechaSolicitud: new Date().toISOString(),
                    estado: 'PENDIENTE'
                },
                {
                    id: `TEST2_${Date.now() + 1}`,
                    nombreCompleto: 'Carlos L√≥pez Test',
                    email: `carlos.test.${Date.now()}@hospital.com`,
                    servicioHospitalario: 'INGENIERIA_BIOMEDICA',
                    cargo: 'COORDINADOR',
                    telefono: '+57 300 987 6543',
                    justificacion: 'Segunda solicitud de prueba',
                    fechaSolicitud: new Date().toISOString(),
                    estado: 'PENDIENTE'
                }
            ];
            
            try {
                for (const request of testRequests) {
                    if (window.airtableAPI && isConnectedToAirtable) {
                        await window.airtableAPI.createSolicitudAcceso(request);
                        debugLog(`‚úÖ Solicitud creada en Airtable: ${request.id}`, 'success');
                    } else {
                        cloudSolicitudesAcceso.push(request);
                        localStorage.setItem('hospital_access_requests', JSON.stringify(cloudSolicitudesAcceso));
                        debugLog(`üì± Solicitud creada localmente: ${request.id}`, 'warning');
                    }
                }
                
                await loadAccessRequestsFromCloud();
                alert('‚úÖ Solicitudes de prueba generadas correctamente');
                
            } catch (error) {
                debugLog(`‚ùå Error generando solicitudes de prueba: ${error.message}`, 'error');
                alert('‚ùå Error: ' + error.message);
            }
        }

        // üéØ Funci√≥n de APROBACI√ìN SOLUCIONADA
        async function approveAccessRequest(requestId) {
            debugLog(`üéØ === INICIANDO APROBACI√ìN MEJORADA ===`, 'info');
            debugLog(`üìã Request ID recibido: "${requestId}" (tipo: ${typeof requestId})`, 'info');
            
            // ‚úÖ VALIDACI√ìN 1: Verificar que requestId no sea undefined/null
            if (!requestId || requestId === 'undefined' || requestId === 'null') {
                debugLog(`‚ùå ERROR: RequestID inv√°lido: "${requestId}"`, 'error');
                alert('‚ùå Error: ID de solicitud inv√°lido\n\nNo se puede procesar la aprobaci√≥n.');
                return;
            }
            
            debugLog(`‚úÖ RequestID v√°lido: ${requestId}`, 'success');
            
            // ‚úÖ VALIDACI√ìN 2: Buscar solicitud en datos locales
            debugLog(`üîç Buscando solicitud en ${cloudSolicitudesAcceso.length} solicitudes cargadas...`, 'info');
            
            const request = cloudSolicitudesAcceso.find(r => {
                debugLog(`   Comparando: "${r.id}" === "${requestId}"`, 'info');
                return r.id === requestId;
            });
            
            if (!request) {
                debugLog(`‚ùå ERROR: Solicitud no encontrada en datos locales`, 'error');
                debugLog(`üìä IDs disponibles: ${cloudSolicitudesAcceso.map(r => r.id).join(', ')}`, 'info');
                alert(`‚ùå Error: Solicitud no encontrada\n\nID buscado: ${requestId}\n\nRefresque los datos e intente nuevamente.`);
                return;
            }
            
            debugLog(`‚úÖ Solicitud encontrada: ${request.nombreCompleto}`, 'success');
            
            // ‚úÖ VALIDACI√ìN 3: Verificar estado
            if (request.estado !== 'PENDIENTE') {
                debugLog(`‚ö†Ô∏è Solicitud ya procesada: ${request.estado}`, 'warning');
                alert(`‚ö†Ô∏è La solicitud ya fue procesada\n\nEstado actual: ${request.estado}`);
                return;
            }
            
            // ‚úÖ VALIDACI√ìN 4: Verificar usuario existente
            const existingUser = cloudUsuarios.find(u => u.email === request.email);
            if (existingUser && existingUser.estado === 'ACTIVO') {
                const shouldProceed = confirm(
                    `‚ö†Ô∏è Ya existe un usuario activo:\n\n` +
                    `Email: ${existingUser.email}\n` +
                    `Nombre: ${existingUser.nombreCompleto}\n` +
                    `C√≥digo: ${existingUser.codigoAcceso}\n\n` +
                    `¬øContinuar y generar nuevo c√≥digo?`
                );
                
                if (!shouldProceed) {
                    debugLog(`üö´ Aprobaci√≥n cancelada por usuario`, 'warning');
                    return;
                }
            }
            
            try {
                debugLog(`üé≤ Generando c√≥digo de acceso √∫nico...`, 'info');
                const accessCode = await generateUniqueAccessCode();
                debugLog(`‚úÖ C√≥digo generado: ${accessCode}`, 'success');
                
                // ‚úÖ PASO 1: Crear/actualizar usuario
                debugLog(`üë§ === PASO 1: GESTI√ìN DE USUARIO ===`, 'info');
                
                const userData = {
                    nombreCompleto: request.nombreCompleto,
                    email: request.email,
                    telefono: request.telefono || '',
                    servicioHospitalario: request.servicioHospitalario,
                    cargo: request.cargo,
                    codigoAcceso: accessCode,
                    estado: 'ACTIVO',
                    fechaCreacion: new Date().toISOString(),
                    solicitudOrigenId: requestId
                };
                
                let userResult;
                if (existingUser) {
                    debugLog(`üîÑ Actualizando usuario existente: ${existingUser.id}`, 'info');
                    userResult = await window.airtableAPI.updateUsuario(existingUser.id, userData);
                    userData.id = existingUser.id;
                } else {
                    debugLog(`‚ûï Creando nuevo usuario`, 'info');
                    userResult = await window.airtableAPI.createUsuario(userData);
                    userData.id = userResult.id;
                }
                
                debugLog(`‚úÖ Usuario procesado exitosamente: ${userData.id}`, 'success');
                
                // ‚úÖ PASO 2: Actualizar solicitud CON VALIDACI√ìN MEJORADA
                debugLog(`üìù === PASO 2: ACTUALIZACI√ìN DE SOLICITUD ===`, 'info');
                debugLog(`üìã Actualizando solicitud ID: "${requestId}"`, 'info');
                
                const updateData = {
                    estado: 'APROBADA',
                    fechaAprobacion: new Date().toISOString(),
                    usuarioCreado: userData.id
                };
                
                debugLog(`üìä Datos a actualizar: ${JSON.stringify(updateData)}`, 'info');
                
                try {
                    await updateAccessRequestStatusFixed(requestId, updateData);
                    debugLog(`‚úÖ Solicitud actualizada exitosamente`, 'success');
                } catch (updateError) {
                    debugLog(`‚ö†Ô∏è Error actualizando solicitud (continuando): ${updateError.message}`, 'warning');
                    // No fallar todo el proceso, solo advertir
                }
                
                // ‚úÖ PASO 3: Actualizar datos locales
                debugLog(`üîÑ === PASO 3: ACTUALIZACI√ìN LOCAL ===`, 'info');
                
                // Actualizar solicitud local
                const localRequestIndex = cloudSolicitudesAcceso.findIndex(r => r.id === requestId);
                if (localRequestIndex !== -1) {
                    cloudSolicitudesAcceso[localRequestIndex] = { ...request, ...updateData };
                    debugLog(`‚úÖ Solicitud local actualizada`, 'success');
                }
                
                // Actualizar usuario local
                if (existingUser) {
                    const userIndex = cloudUsuarios.findIndex(u => u.id === existingUser.id);
                    if (userIndex !== -1) {
                        cloudUsuarios[userIndex] = { ...cloudUsuarios[userIndex], ...userData };
                    }
                } else {
                    cloudUsuarios.push(userData);
                }
                
                debugLog(`‚úÖ Datos locales sincronizados`, 'success');
                
                // ‚úÖ PASO 4: Actualizar interfaz
                updateAccessRequestsList();
                
                // ‚úÖ PASO 5: Mostrar resultado
                debugLog(`üéâ === APROBACI√ìN COMPLETADA EXITOSAMENTE ===`, 'success');
                showAccessCodeModal(userData, accessCode);
                
            } catch (error) {
                debugLog(`‚ùå ERROR GENERAL EN APROBACI√ìN: ${error.message}`, 'error');
                debugLog(`üìä Stack trace: ${error.stack}`, 'error');
                alert(`‚ùå Error en aprobaci√≥n:\n\n${error.message}\n\nRevise el panel de debug para m√°s detalles.`);
            }
        }

        // üìù FUNCI√ìN DE ACTUALIZACI√ìN MEJORADA Y FIJA
        async function updateAccessRequestStatusFixed(requestId, updateData) {
            debugLog(`üìù updateAccessRequestStatusFixed llamada con ID: "${requestId}"`, 'info');
            
            // ‚úÖ Validaci√≥n adicional
            if (!requestId || requestId === 'undefined') {
                throw new Error(`ID de solicitud inv√°lido: "${requestId}"`);
            }
            
            // Si no hay conexi√≥n, actualizar solo localmente
            if (!window.airtableAPI || !isConnectedToAirtable) {
                debugLog(`üì± Modo local: actualizando solicitud local`, 'warning');
                
                const requestIndex = cloudSolicitudesAcceso.findIndex(r => r.id === requestId);
                if (requestIndex !== -1) {
                    cloudSolicitudesAcceso[requestIndex] = { 
                        ...cloudSolicitudesAcceso[requestIndex], 
                        ...updateData,
                        fechaActualizacion: new Date().toISOString()
                    };
                    
                    localStorage.setItem('hospital_access_requests', JSON.stringify(cloudSolicitudesAcceso));
                    debugLog(`‚úÖ Solicitud actualizada localmente`, 'success');
                    return;
                } else {
                    throw new Error(`Solicitud ${requestId} no encontrada en datos locales`);
                }
            }
            
            // Intentar actualizaci√≥n en Airtable
            debugLog(`üåê Intentando actualizaci√≥n en Airtable...`, 'info');
            
            try {
                const result = await window.airtableAPI.updateSolicitudAcceso(requestId, updateData);
                debugLog(`‚úÖ Actualizaci√≥n en Airtable exitosa`, 'success');
                return result;
                
            } catch (airtableError) {
                debugLog(`‚ö†Ô∏è Error en Airtable: ${airtableError.message}`, 'warning');
                debugLog(`üîÑ Intentando m√©todo de fallback...`, 'info');
                
                // Fallback: actualizaci√≥n local
                const requestIndex = cloudSolicitudesAcceso.findIndex(r => r.id === requestId);
                if (requestIndex !== -1) {
                    cloudSolicitudesAcceso[requestIndex] = { 
                        ...cloudSolicitudesAcceso[requestIndex], 
                        ...updateData,
                        fechaActualizacion: new Date().toISOString()
                    };
                    
                    debugLog(`‚úÖ Fallback completado: actualizaci√≥n local`, 'success');
                    return { id: requestId, fields: cloudSolicitudesAcceso[requestIndex] };
                } else {
                    throw new Error(`Solicitud ${requestId} no encontrada para fallback`);
                }
            }
        }

        // üé≤ Generador de c√≥digos √∫nicos MEJORADO
        async function generateUniqueAccessCode() {
            try {
                const existingCodes = cloudUsuarios
                    .map(u => u.codigoAcceso)
                    .filter(code => code)
                    .map(code => String(code));

                let code;
                let attempts = 0;
                const maxAttempts = 100;

                do {
                    code = Math.floor(1000 + Math.random() * 9000).toString();
                    attempts++;
                    
                    if (attempts > maxAttempts) {
                        throw new Error('No se pudo generar c√≥digo √∫nico despu√©s de 100 intentos');
                    }
                } while (existingCodes.includes(code));

                debugLog(`üé≤ C√≥digo √∫nico generado: ${code} (${attempts} intentos)`, 'success');
                return code;

            } catch (error) {
                debugLog(`‚ùå Error generando c√≥digo: ${error.message}`, 'error');
                const fallbackCode = Math.floor(1000 + Math.random() * 9000).toString();
                debugLog(`‚ö†Ô∏è Usando c√≥digo fallback: ${fallbackCode}`, 'warning');
                return fallbackCode;
            }
        }

        // üèóÔ∏è Funci√≥n para mostrar solicitudes MEJORADA
        function updateAccessRequestsList() {
            const container = document.getElementById('access-requests-container');
            
            if (cloudSolicitudesAcceso.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üîê</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes de acceso</h3>
                        <p style="margin-bottom: 1.5rem;">Use el bot√≥n "Generar Solicitudes Test" para probar el sistema</p>
                        <button class="btn btn-primary" onclick="generateTestRequests()">
                            üìù Generar Solicitudes Test
                        </button>
                    </div>
                `;
                return;
            }

            const requestsHTML = cloudSolicitudesAcceso
                .sort((a, b) => new Date(b.fechaSolicitud || 0) - new Date(a.fechaSolicitud || 0))
                .map(request => createAccessRequestCardFixed(request))
                .join('');
                
            container.innerHTML = `
                <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <h4 style="color: #059669; margin-bottom: 0.5rem;">‚úÖ ${cloudSolicitudesAcceso.length} Solicitudes Cargadas</h4>
                    <p style="color: #047857; font-size: 0.875rem;">Sistema depurado - Error 404 solucionado</p>
                </div>
                ${requestsHTML}
            `;
        }

        // üé® Crear tarjeta de solicitud MEJORADA con validaci√≥n
        function createAccessRequestCardFixed(request) {
            // ‚úÖ Validaci√≥n robusta del ID
            const requestId = request.id || request.recordId || `TEMP_${Date.now()}`;
            const estado = request.estado || 'PENDIENTE';
            
            debugLog(`üé® Creando tarjeta para solicitud: ${requestId}`, 'info');
            
            const cardClass = estado.toLowerCase().replace('_', '-');
            const fechaFormatted = request.fechaSolicitud ? 
                new Date(request.fechaSolicitud).toLocaleString('es-CO') : 
                'No especificada';
            
            const servicioName = serviciosHospitalarios[request.servicioHospitalario] || request.servicioHospitalario;
            const cargoName = cargosHospitalarios[request.cargo] || request.cargo;

            const existingUser = cloudUsuarios.find(u => u.email === request.email);
            const hasExistingUser = !!existingUser;

            return `
                <div class="access-request-card ${cardClass}">
                    <div class="request-header">
                        <div class="request-name">${request.nombreCompleto || 'Sin nombre'}</div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span class="request-status status-${estado.toLowerCase().replace('_', '-')}">${estado}</span>
                            ${hasExistingUser ? '<span style="background: #e0f2fe; color: #0369a1; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">üë§ Usuario Existe</span>' : ''}
                            <span style="background: #059669; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.65rem;">ID: ${requestId}</span>
                        </div>
                    </div>

                    <div class="request-details">
                        <div class="request-detail">
                            <div class="request-detail-label">üìß Email</div>
                            <div class="request-detail-value">${request.email || 'No especificado'}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üè• Servicio</div>
                            <div class="request-detail-value">${servicioName}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üíº Cargo</div>
                            <div class="request-detail-value">${cargoName}</div>
                        </div>
                        <div class="request-detail">
                            <div class="request-detail-label">üìÖ Fecha Solicitud</div>
                            <div class="request-detail-value">${fechaFormatted}</div>
                        </div>
                    </div>

                    ${estado === 'PENDIENTE' ? `
                        <div class="request-actions">
                            <button class="btn btn-success btn-sm" onclick="approveAccessRequest('${requestId}')">
                                ‚úÖ Aprobar (ID: ${requestId})
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="debugLog('üîç Debug click para: ${requestId}', 'info')">
                                üêõ Debug ID
                            </button>
                        </div>
                    ` : ''}

                    ${estado === 'APROBADA' && existingUser && existingUser.codigoAcceso ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: #dcfce7; border-radius: 0.5rem;">
                            <div style="font-weight: 600; color: #166534;">‚úÖ Usuario Aprobado</div>
                            <p style="color: #14532d; margin: 0;"><strong>C√≥digo:</strong> ${existingUser.codigoAcceso}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // üß™ Funci√≥n de test completo
        async function testApprovalProcess() {
            debugLog('üß™ === INICIANDO TEST COMPLETO DEL PROCESO ===', 'info');
            
            try {
                // 1. Verificar conexi√≥n
                debugLog('1Ô∏è‚É£ Verificando conexi√≥n...', 'info');
                if (window.airtableAPI) {
                    const isConnected = await window.airtableAPI.testConnection();
                    updateConnectionStatus(isConnected ? 'connected' : 'disconnected');
                    debugLog(`Conexi√≥n: ${isConnected ? 'OK' : 'OFFLINE'}`, isConnected ? 'success' : 'warning');
                }
                
                // 2. Cargar datos
                debugLog('2Ô∏è‚É£ Cargando datos...', 'info');
                await loadAccessRequestsFromCloud();
                
                // 3. Verificar solicitudes pendientes
                debugLog('3Ô∏è‚É£ Verificando solicitudes pendientes...', 'info');
                const pendingRequests = cloudSolicitudesAcceso.filter(r => r.estado === 'PENDIENTE');
                debugLog(`Solicitudes pendientes: ${pendingRequests.length}`, 'info');
                
                if (pendingRequests.length === 0) {
                    debugLog('‚ö†Ô∏è No hay solicitudes pendientes, generando una...', 'warning');
                    await generateTestRequests();
                    await loadAccessRequestsFromCloud();
                }
                
                // 4. Test de aprobaci√≥n
                const testRequest = cloudSolicitudesAcceso.find(r => r.estado === 'PENDIENTE');
                if (testRequest) {
                    debugLog(`4Ô∏è‚É£ Probando aprobaci√≥n con ID: ${testRequest.id}`, 'info');
                    
                    const confirmation = confirm(
                        `üß™ ¬øEjecutar test de aprobaci√≥n?\n\n` +
                        `Se aprobar√° la solicitud:\n` +
                        `‚Ä¢ Nombre: ${testRequest.nombreCompleto}\n` +
                        `‚Ä¢ Email: ${testRequest.email}\n` +
                        `‚Ä¢ ID: ${testRequest.id}\n\n` +
                        `Esto crear√° un usuario real en el sistema.`
                    );
                    
                    if (confirmation) {
                        await approveAccessRequest(testRequest.id);
                        debugLog('‚úÖ Test completado exitosamente', 'success');
                    } else {
                        debugLog('üö´ Test cancelado por usuario', 'warning');
                    }
                } else {
                    debugLog('‚ùå No se encontraron solicitudes para probar', 'error');
                }
                
            } catch (error) {
                debugLog(`‚ùå Error en test: ${error.message}`, 'error');
                alert('‚ùå Error en test: ' + error.message);
            }
        }

        // üéâ Modal de c√≥digo
        function showAccessCodeModal(userData, accessCode) {
            const modal = document.getElementById('access-code-modal');
            const userInfo = document.getElementById('user-approved-info');
            const codeDisplay = document.getElementById('generated-access-code');

            const servicioName = serviciosHospitalarios[userData.servicioHospitalario] || userData.servicioHospitalario;

            userInfo.innerHTML = `
                <h4 style="color: #166534; margin-bottom: 0.5rem;">‚úÖ Usuario Aprobado Exitosamente</h4>
                <p style="color: #14532d; margin: 0;"><strong>Nombre:</strong> ${userData.nombreCompleto}</p>
                <p style="color: #14532d; margin: 0;"><strong>Email:</strong> ${userData.email}</p>
                <p style="color: #14532d; margin: 0;"><strong>Servicio:</strong> ${servicioName}</p>
                <p style="color: #14532d; margin: 0;"><strong>ID Usuario:</strong> ${userData.id}</p>
            `;

            codeDisplay.textContent = accessCode;
            
            window.currentAccessCode = { code: accessCode, user: userData };
            modal.classList.remove('hidden');
            
            debugLog(`üéâ Modal mostrado - C√≥digo: ${accessCode}`, 'success');
        }

        function copyAccessCode() {
            if (!window.currentAccessCode) {
                alert('‚ùå No hay c√≥digo para copiar');
                return;
            }

            const textToCopy = `C√≥digo de Acceso: ${window.currentAccessCode.code}`;
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                alert(`‚úÖ C√≥digo copiado: ${window.currentAccessCode.code}`);
                debugLog(`üìã C√≥digo copiado: ${window.currentAccessCode.code}`, 'success');
            }).catch(() => {
                alert(`C√≥digo: ${window.currentAccessCode.code}`);
            });
        }

        function closeAccessCodeModal() {
            document.getElementById('access-code-modal').classList.add('hidden');
            window.currentAccessCode = null;
            debugLog('üö™ Modal cerrado', 'info');
        }

        // üîÑ Funciones de navegaci√≥n
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewName + '-view').classList.remove('hidden');
            
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            if (viewName === 'accesos') {
                loadAccessRequestsFromCloud();
            }
        }

        function showDebugPanel() {
            const debugConsole = document.getElementById('debug-console');
            if (debugConsole.style.maxHeight === '400px') {
                debugConsole.style.maxHeight = '200px';
            } else {
                debugConsole.style.maxHeight = '400px';
            }
        }

        // üöÄ Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('üöÄ Portal de Gesti√≥n iniciando (versi√≥n corregida)...', 'info');
            
            setTimeout(async () => {
                if (window.airtableAPI) {
                    debugLog('üîó airtableAPI disponible, probando conexi√≥n...', 'info');
                    try {
                        const isConnected = await window.airtableAPI.testConnection();
                        updateConnectionStatus(isConnected ? 'connected' : 'disconnected');
                        
                        if (isConnected) {
                            await loadAccessRequestsFromCloud();
                        } else {
                            debugLog('‚ö†Ô∏è Conexi√≥n fall√≥, cargando datos locales...', 'warning');
                            await loadAccessRequestsFromCloud();
                        }
                        
                    } catch (error) {
                        debugLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
                        updateConnectionStatus('disconnected');
                        await loadAccessRequestsFromCloud();
                    }
                } else {
                    debugLog('‚ùå airtableAPI no disponible', 'error');
                    updateConnectionStatus('disconnected');
                    await loadAccessRequestsFromCloud();
                }
            }, 1000);

            debugLog('‚úÖ Sistema inicializado - Listo para depuraci√≥n', 'success');
        });
    </script>

    <!-- Incluir el archivo de configuraci√≥n de Airtable -->
    <script src="airtable-config.js"></script>
</body>
</html>