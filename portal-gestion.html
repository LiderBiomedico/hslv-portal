<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Portal de Gesti√≥n Cloud - Hospital Susana L√≥pez de Valencia</title>
<!-- Agregar Chart.js para gr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Agregar jsPDF para exportar a PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .developer-credit {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
            margin-top: 0.25rem;
            margin-bottom: 0;
            text-align: center;
            font-style: italic;
        }

        /* Indicador de conexi√≥n Airtable */
        .connection-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(34, 197, 94, 0.3);
            color: #dcfce7;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.3);
            color: #fee2e2;
        }

        .connection-status.fallback {
            background: rgba(245, 158, 11, 0.3);
            color: #fef3c7;
        }

        /* Auto-refresh indicator */
        .auto-refresh-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(59, 130, 246, 0.3);
            color: #dbeafe;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-refresh-indicator.active {
            background: rgba(34, 197, 94, 0.3);
            color: #dcfce7;
        }

        .refresh-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            position: absolute;
            top: 4rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification-btn {
            position: relative;
            background: rgba(255,255,255,0.1);
            border: none;
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background 0.2s;
            color: white;
            backdrop-filter: blur(10px);
        }

        .notification-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .notification-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 1rem;
            height: 1rem;
            font-size: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .metric-card.total { 
            border-top-color: #2563eb; 
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }
        .metric-card.biomedica { 
            border-top-color: #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #dcfce7 100%);
        }
        .metric-card.mecanica { 
            border-top-color: #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
        }
        .metric-card.infraestructura { 
            border-top-color: #8b5cf6; 
            background: linear-gradient(135deg, #ffffff 0%, #ede9fe 100%);
        }
        .metric-card.pendientes { 
            border-top-color: #ef4444; 
            background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
        }
        .metric-card.asignadas { 
            border-top-color: #0ea5e9; 
            background: linear-gradient(135deg, #ffffff 0%, #e0f2fe 100%);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* Botones */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(14, 165, 233, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Solicitudes Card - Mejorado */
        .request-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
            position: relative;
        }

        .request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .request-card.pending {
            border-left: 6px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .request-card.assigned {
            border-left: 6px solid #0ea5e9;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .request-card.in-progress {
            border-left: 6px solid #8b5cf6;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        .request-card.completed {
            border-left: 6px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .request-card.overdue {
            border-left: 6px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            animation: pulse-overdue 2s infinite;
        }

        @keyframes pulse-overdue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .request-number {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .request-area-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .badge-biomedica {
            background: #dcfce7;
            color: #166534;
        }

        .badge-mecanica {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-infraestructura {
            background: #ede9fe;
            color: #7c3aed;
        }

        .request-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .request-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .request-detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .request-detail-value {
            color: #1f2937;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-asignada {
            background: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-en-proceso {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-completada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-cancelada {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-aprobada {
            background: #dcfce7;
            color: #166534;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-rechazada {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-critica {
            background: #fee2e2;
            color: #dc2626;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse-critical 1.5s infinite;
        }

        @keyframes pulse-critical {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .priority-alta {
            background: #fed7aa;
            color: #ea580c;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-media {
            background: #dbeafe;
            color: #1e40af;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-baja {
            background: #d1fae5;
            color: #059669;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .time-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            font-size: 0.75rem;
            text-align: center;
            min-width: 100px;
        }

        .time-indicator.overdue {
            background: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
        }

        .time-indicator.warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #d97706;
        }

        .time-indicator.ok {
            background: #dcfce7;
            border-color: #22c55e;
            color: #166534;
        }

        /* Solicitudes de Acceso */
        .access-request-card {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .access-request-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .access-request-card.pending {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .access-request-card.approved {
            border-left: 4px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .access-request-card.rejected {
            border-left: 4px solid #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .request-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        /* Modal grande para estad√≠sticas */
        .modal-content.modal-lg {
            max-width: 1200px;
            width: 95%;
        }

        /* Formularios en modales */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Filtros */
        .filters-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .hidden {
            display: none !important;
        }

        /* Estilos para estad√≠sticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .stat-card-title {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .stat-card-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-card-description {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 2rem;
        }

        .table-responsive {
            overflow-x: auto;
            margin-bottom: 1.5rem;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .stats-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .stats-table tr:hover {
            background: #f8fafc;
        }

        /* Pesta√±as de an√°lisis temporal */
        .analysis-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .analysis-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .analysis-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .analysis-tab:hover:not(.active) {
            color: #374151;
        }

        /* Estilos para estad√≠sticas de t√©cnicos */
        .technician-stats-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .technician-stats-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #2563eb;
        }

        .technician-ranking {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .ranking-position {
            font-size: 2rem;
            font-weight: bold;
            color: #6b7280;
            min-width: 50px;
        }

        .ranking-position.gold {
            color: #fbbf24;
        }

        .ranking-position.silver {
            color: #9ca3af;
        }

        .ranking-position.bronze {
            color: #fb923c;
        }

        /* Modal para estad√≠sticas mensuales */
        .month-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            align-items: center;
            justify-content: center;
        }

        .month-selector select {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .connection-status {
                position: static;
                margin-bottom: 1rem;
            }
            
            .auto-refresh-indicator {
                position: static;
                margin-top: 1rem;
                justify-content: center;
            }
            
            .user-info {
                position: static;
                justify-content: center;
                margin-top: 1rem;
            }

            .request-actions {
                flex-direction: column;
            }

            .request-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .time-indicator {
                position: static;
                margin-top: 1rem;
                width: 100%;
            }
        }

        @media print {
            body {
                background: white;
            }
            
            .header, .nav-tabs, .btn, .modal-close, .filters-section {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #e5e7eb;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
<!-- Header -->
<header class="header">
<div class="header-content container">
<!-- Indicador de conexi√≥n Airtable -->
<div class="connection-status disconnected" id="connection-status">
<span id="connection-icon">üîÑ</span>
<span id="connection-text">Conectando...</span>
</div>
<!-- Indicador de auto-refresh -->
<div class="auto-refresh-indicator" id="auto-refresh-indicator">
<span class="refresh-spinner"></span>
<span id="refresh-text">Auto-refresh activo</span>
<span id="refresh-countdown">(5s)</span>
</div>
<div class="logo">
<div class="hospital-info">
<h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
<p class="developer-credit" style="display:none!important">Desarrollado por Ing. Paul Eduardo Mu√±oz R.</p>
<p>Portal de Gesti√≥n Cloud - Sistema con Historial de Asignaciones</p>
</div>
</div>
<nav class="nav-tabs">
<button class="nav-tab active" data-view="dashboard" onclick="showView('dashboard')">
                    üìä Dashboard
                </button>
<button class="nav-tab" data-view="solicitudes" onclick="showView('solicitudes')">
                    üìã Solicitudes (<span id="total-count">-</span>)
                </button>
<button class="nav-tab" data-view="personal" onclick="showView('personal')">
                    üë• Personal de Soporte (<span id="total-technicians-nav">-</span>)
                </button>
<button class="nav-tab" data-view="accesos" onclick="showView('accesos')">
                    üîê Accesos (<span id="pending-access-count">-</span>)
                </button>
</nav>
<div class="user-info">
<button class="notification-btn" onclick="showNotifications()">
                    üîî
                    <span class="notification-badge" id="notification-count">-</span>
</button>
</div>
</div>
</header>
<!-- Main Content -->
<main class="main-layout container">
<!-- Dashboard View -->
<div class="view" id="dashboard-view">
<!-- Alert de conexi√≥n -->
<div class="alert alert-info" id="connection-alert">
<h3 style="font-weight: 600; margin-bottom: 0.5rem;display:none!important">üåê Sistema Cloud con Historial de Asignaciones</h3>
<ul style="margin: 0.5rem 0 0 1rem;">
</ul>
<div style="margin-top: 1rem;">
<button class="btn btn-primary btn-sm" onclick="testCloudConnection()">
                        üß™ Probar Conexi√≥n
                    </button>
<button class="btn btn-success btn-sm" onclick="autoAssignAllPending()" style="display:none;">
                        ü§ñ Auto-asignar Todo
                    </button>
<button class="btn btn-warning btn-sm" onclick="showAdvancedStatisticsModal()">
                        üìä Estad√≠sticas Avanzadas
                    </button>
<button class="btn btn-info btn-sm" onclick="showMonthlyStatsModal()">
                        üìÖ Estad√≠sticas Mensuales
                    </button>
<button class="btn btn-secondary btn-sm" onclick="showTechnicianPerformanceModal()">
                        üë®‚Äçüîß Rendimiento de Personal
                    </button>
<button class="btn btn-secondary btn-sm" onclick="toggleAutoRefresh()" style="display:none;">
<span id="auto-refresh-toggle-text">‚è∏Ô∏è Pausar Auto-Refresh</span>
</button>
</div>
</div>
<!-- Metrics mejorados con asignaciones -->
<div class="metrics-grid">
<div class="metric-card total" onclick="filterByArea('all')">
<div class="metric-icon">üìã</div>
<div class="metric-number" id="metric-total">-</div>
<div class="metric-label">Total Solicitudes</div>
</div>
<div class="metric-card pendientes" onclick="filterByStatus('PENDIENTE')">
<div class="metric-icon">‚è≥</div>
<div class="metric-number" id="metric-pendientes">-</div>
<div class="metric-label">Pendientes</div>
</div>
<div class="metric-card asignadas" onclick="filterByStatus('ASIGNADA')">
<div class="metric-icon">üéØ</div>
<div class="metric-number" id="metric-asignadas">-</div>
<div class="metric-label">Asignadas</div>
</div>
<div class="metric-card biomedica" onclick="filterByArea('INGENIERIA_BIOMEDICA')">
<div class="metric-icon">üè•</div>
<div class="metric-number" id="metric-biomedica">-</div>
<div class="metric-label">Ing. Biom√©dica</div>
</div>
<div class="metric-card mecanica" onclick="filterByArea('MECANICA')">
<div class="metric-icon">‚öôÔ∏è</div>
<div class="metric-number" id="metric-mecanica">-</div>
<div class="metric-label">Mec√°nica</div>
</div>
<div class="metric-card infraestructura" onclick="filterByArea('INFRAESTRUCTURA')">
<div class="metric-icon">üèóÔ∏è</div>
<div class="metric-number" id="metric-infraestructura">-</div>
<div class="metric-label">Infraestructura</div>
</div>
</div>
<!-- Resumen de Personal por √Årea -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
<div class="card">
<div class="card-header">
<h2 class="card-title">üè• Personal Biom√©dica</h2>
<span class="status-disponible" id="biomedica-personnel-count">- registrados</span>
</div>
<div class="card-content">
<div id="biomedica-personnel-list">
                            <p style="color: #6b7280;">Cargando personal...</p>
                        </div>
</div>
</div>
<div class="card">
<div class="card-header">
<h2 class="card-title">‚öôÔ∏è Personal Mec√°nica</h2>
<span class="status-disponible" id="mecanica-personnel-count">- registrados</span>
</div>
<div class="card-content">
<div id="mecanica-personnel-list">
                            <p style="color: #6b7280;">Cargando personal...</p>
                        </div>
</div>
</div>
<div class="card">
<div class="card-header">
<h2 class="card-title">üèóÔ∏è Personal Infraestructura</h2>
<span class="status-disponible" id="infraestructura-personnel-count">- registrados</span>
</div>
<div class="card-content">
<div id="infraestructura-personnel-list">
                            <p style="color: #6b7280;">Cargando personal...</p>
                        </div>
</div>
</div>
</div>
</div>
<!-- Solicitudes View -->
<div class="view hidden" id="solicitudes-view">
<div class="card">
<div class="card-header">
<h2 class="card-title">üìã Gesti√≥n de Solicitudes</h2>
<div style="display: flex; gap: 0.5rem;">
<button class="btn btn-primary btn-sm" onclick="showNewRequestModal()">
                            ‚ûï Nueva Solicitud
                        </button>
<button class="btn btn-info btn-sm" onclick="exportToExcel()">
                            üì• Exportar Excel
                        </button>
</div>
</div>
<div class="card-content">
<!-- Filtros -->
<div class="filters-section">
<div class="filters-grid">
<div>
<label class="form-label">üîç Buscar</label>
<input type="text" class="form-input" id="filter-search" placeholder="N√∫mero, solicitante, t√©cnico..." onkeyup="applyFilters()"/>
</div>
<div>
<label class="form-label">üè• √Årea</label>
<select class="form-select" id="filter-area" onchange="applyFilters()">
<option value="">Todas las √°reas</option>
<option value="INGENIERIA_BIOMEDICA">Ingenier√≠a Biom√©dica</option>
<option value="MECANICA">Mec√°nica</option>
<option value="INFRAESTRUCTURA">Infraestructura</option>
</select>
</div>
<div>
<label class="form-label">üìä Estado</label>
<select class="form-select" id="filter-status" onchange="applyFilters()">
<option value="">Todos los estados</option>
<option value="PENDIENTE">Pendiente</option>
<option value="ASIGNADA">Asignada</option>
<option value="EN_PROCESO">En Proceso</option>
<option value="COMPLETADA">Completada</option>
<option value="CANCELADA">Cancelada</option>
</select>
</div>
<div>
<label class="form-label">‚ö° Prioridad</label>
<select class="form-select" id="filter-priority" onchange="applyFilters()">
<option value="">Todas</option>
<option value="CRITICA">Cr√≠tica</option>
<option value="ALTA">Alta</option>
<option value="MEDIA">Media</option>
<option value="BAJA">Baja</option>
</select>
</div>
</div>
</div>
<div id="solicitudes-list">
<p style="text-align: center; color: #6b7280;">Cargando solicitudes...</p>
</div>
</div>
</div>
</div>
<!-- Personal View -->
<div class="view hidden" id="personal-view">
<div class="card">
<div class="card-header">
<h2 class="card-title">üë• Gesti√≥n de Personal de Soporte</h2>
<button class="btn btn-primary btn-sm" onclick="showNewTechnicianModal()">
                        ‚ûï Nuevo Personal
                    </button>
</div>
<div class="card-content">
<div id="technicians-list">
<p style="text-align: center; color: #6b7280;">Cargando personal...</p>
</div>
</div>
</div>
</div>
<!-- Accesos View -->
<div class="view hidden" id="accesos-view">
<div class="card">
<div class="card-header">
<h2 class="card-title">üîê Solicitudes de Acceso</h2>
<div style="display: flex; gap: 0.5rem;">
<button class="btn btn-info btn-sm" onclick="refreshAccessRequests()">
                            üîÑ Actualizar
                        </button>
</div>
</div>
<div class="card-content">
<div id="access-requests-list">
<p style="text-align: center; color: #6b7280;">Cargando solicitudes de acceso...</p>
</div>
</div>
</div>
</div>
</main>
<!-- Modals -->
<!-- Modal de Nuevo Personal -->
<div class="modal" id="new-technician-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">‚ûï Agregar Personal de Soporte</h3>
<button class="modal-close" onclick="closeModal('new-technician-modal')">√ó</button>
</div>
<form onsubmit="handleNewTechnician(event)">
<div class="form-group">
<label class="form-label">üë§ Nombre Completo *</label>
<input type="text" class="form-input" id="tech-name" required/>
</div>
<div class="form-group">
<label class="form-label">üìß Email</label>
<input type="email" class="form-input" id="tech-email"/>
</div>
<div class="form-group">
<label class="form-label">üè• √Årea *</label>
<select class="form-select" id="tech-area" required>
<option value="">Seleccione √°rea</option>
<option value="INGENIERIA_BIOMEDICA">Ingenier√≠a Biom√©dica</option>
<option value="MECANICA">Mec√°nica</option>
<option value="INFRAESTRUCTURA">Infraestructura</option>
</select>
</div>
<div class="form-group">
<label class="form-label">üë∑ Tipo</label>
<select class="form-select" id="tech-type">
<option value="tecnico">T√©cnico</option>
<option value="ingeniero">Ingeniero</option>
<option value="auxiliar">Auxiliar</option>
<option value="contratista">Contratista</option>
</select>
</div>
<div class="form-group">
<label class="form-label">üîß Especialidad</label>
<input type="text" class="form-input" id="tech-specialty" placeholder="Ej: Ventiladores, Aires acondicionados, etc."/>
</div>
<div style="display: flex; gap: 1rem; margin-top: 2rem;">
<button type="submit" class="btn btn-primary">
                        üíæ Guardar Personal
                    </button>
<button type="button" class="btn btn-secondary" onclick="closeModal('new-technician-modal')">
                        ‚ùå Cancelar
                    </button>
</div>
</form>
</div>
</div>
<!-- Modal de Asignaci√≥n de T√©cnico -->
<div class="modal" id="assign-technician-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">üéØ Asignar Personal de Soporte</h3>
<button class="modal-close" onclick="closeModal('assign-technician-modal')">√ó</button>
</div>
<div id="assign-modal-content">
                <!-- Contenido din√°mico -->
            </div>
</div>
</div>
<!-- Modal de Cambio de Estado -->
<div class="modal" id="change-status-modal">
<div class="modal-content">
<div class="modal-header">
<h3 class="modal-title">üîÑ Cambiar Estado de Solicitud</h3>
<button class="modal-close" onclick="closeModal('change-status-modal')">√ó</button>
</div>
<div id="status-modal-content">
                <!-- Contenido din√°mico -->
            </div>
</div>
</div>
<!-- Modal de Estad√≠sticas Avanzadas -->
<div class="modal" id="advanced-stats-modal">
<div class="modal-content modal-lg">
<div class="modal-header">
<h3 class="modal-title">üìä Estad√≠sticas Avanzadas del Sistema</h3>
<button class="modal-close" onclick="closeModal('advanced-stats-modal')">√ó</button>
</div>
<div id="advanced-stats-content" style="max-height: 70vh; overflow-y: auto;">
                <!-- Contenido din√°mico -->
            </div>
</div>
</div>
<!-- Modal de Estad√≠sticas Mensuales -->
<div class="modal" id="monthly-stats-modal">
<div class="modal-content modal-lg">
<div class="modal-header">
<h3 class="modal-title">üìÖ Estad√≠sticas Mensuales</h3>
<button class="modal-close" onclick="closeModal('monthly-stats-modal')">√ó</button>
</div>
<div class="month-selector">
<select id="stats-month" class="form-select">
<option value="1">Enero</option>
<option value="2">Febrero</option>
<option value="3">Marzo</option>
<option value="4">Abril</option>
<option value="5">Mayo</option>
<option value="6">Junio</option>
<option value="7">Julio</option>
<option value="8">Agosto</option>
<option value="9">Septiembre</option>
<option value="10">Octubre</option>
<option value="11">Noviembre</option>
<option value="12">Diciembre</option>
</select>
<select id="stats-year" class="form-select">
<option value="2024">2024</option>
<option value="2025">2025</option>
</select>
<button class="btn btn-primary" onclick="loadMonthlyStats()">
                    üìä Ver Estad√≠sticas
                </button>
</div>
<div id="monthly-stats-content" style="max-height: 60vh; overflow-y: auto;">
                <!-- Contenido din√°mico -->
            </div>
</div>
</div>
<!-- Modal de Rendimiento de Personal -->
<div class="modal" id="technician-performance-modal">
<div class="modal-content modal-lg">
<div class="modal-header">
<h3 class="modal-title">üë®‚Äçüîß Rendimiento de Personal de Soporte</h3>
<button class="modal-close" onclick="closeModal('technician-performance-modal')">√ó</button>
</div>
<div id="performance-content" style="max-height: 70vh; overflow-y: auto;">
                <!-- Contenido din√°mico -->
            </div>
</div>
</div>
<!-- Include Airtable config -->
<script src="airtable-config.js"></script>
<script>
        // Variables globales
        let solicitudes = [];
        let tecnicos = [];
        let usuarios = [];
        let solicitudesAcceso = [];
        let currentView = 'dashboard';
        let cloudConnected = false;
        let autoRefreshInterval = null;
        let autoRefreshCountdown = 5;

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Portal de Gesti√≥n Cloud Iniciado');
            console.log('üìä Versi√≥n con Historial de Asignaciones');
            
            // Verificar carga de airtable-config.js
            if (!window.airtableAPI) {
                console.warn('‚ö†Ô∏è Esperando carga de airtable-config.js...');
                
                // Intentar m√∫ltiples veces
                let attempts = 0;
                const checkInterval = setInterval(() => {
                    attempts++;
                    if (window.airtableAPI) {
                        console.log('‚úÖ airtableAPI detectado despu√©s de ' + attempts + ' intentos');
                        clearInterval(checkInterval);
                        initializePortal();
                    } else if (attempts > 10) {
                        console.error('‚ùå No se pudo cargar airtableAPI despu√©s de 10 intentos');
                        clearInterval(checkInterval);
                        showNotification('Error: No se pudo cargar la API. Recargue la p√°gina.', 'error');
                    }
                }, 500);
            } else {
                console.log('‚úÖ airtableAPI ya cargado');
                initializePortal();
            }
        });

        // Funciones de inicializaci√≥n
        async function initializePortal() {
            console.log('üîß Inicializando portal...');
            
            // Configurar listeners de conexi√≥n
            window.addEventListener('airtableConnectionUpdate', handleConnectionUpdate);
            
            // Verificar API despu√©s de un delay para asegurar que se carg√≥
            setTimeout(async () => {
                // Debug: Verificar m√©todos disponibles
                if (window.airtableAPI) {
                    console.log('‚úÖ AirtableAPI cargado');
                    console.log('üìã M√©todos disponibles:');
                    const methods = Object.getOwnPropertyNames(Object.getPrototypeOf(window.airtableAPI));
                    console.log(methods.filter(m => typeof window.airtableAPI[m] === 'function'));
                    
                    // Verificar m√©todos cr√≠ticos
                    const criticalMethods = [
                        'getAdvancedStatistics',
                        'getMonthlyTechnicianStats',
                        'getTechnicianHistory'
                    ];
                    
                    criticalMethods.forEach(method => {
                        if (typeof window.airtableAPI[method] === 'function') {
                            console.log(`‚úÖ ${method} disponible`);
                        } else {
                            console.error(`‚ùå ${method} NO disponible`);
                        }
                    });
                } else {
                    console.error('‚ùå AirtableAPI no cargado');
                }
                
                await checkCloudConnection();
                await loadAllData();
                startAutoRefresh();
            }, 2000); // Aumentar delay para asegurar carga completa
        }

        function handleConnectionUpdate(event) {
            console.log('üîÑ Actualizaci√≥n de conexi√≥n:', event.detail);
            cloudConnected = event.detail.connected;
            updateConnectionStatus(
                event.detail.connected ? 'connected' : 'disconnected',
                event.detail.connected ? '‚òÅÔ∏è Conectado a Airtable' : 'üì¥ Modo Local'
            );
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            const iconEl = document.getElementById('connection-icon');
            const textEl = document.getElementById('connection-text');
            
            statusEl.className = `connection-status ${status}`;
            
            if (status === 'connected') {
                iconEl.textContent = '‚òÅÔ∏è';
                textEl.textContent = message || 'Conectado a Airtable';
            } else if (status === 'disconnected') {
                iconEl.textContent = 'üì¥';
                textEl.textContent = message || 'Sin conexi√≥n';
            } else if (status === 'fallback') {
                iconEl.textContent = 'üíæ';
                textEl.textContent = message || 'Modo Local';
            }
        }

        async function checkCloudConnection() {
            console.log('üîç Verificando conexi√≥n cloud...');
            
            if (window.airtableAPI) {
                const status = window.airtableAPI.getStatus();
                cloudConnected = status.isConnected;
                updateConnectionStatus(
                    cloudConnected ? 'connected' : 'disconnected',
                    cloudConnected ? '‚òÅÔ∏è Conectado a Airtable' : 'üì¥ Modo Local'
                );
            }
        }

        // Funciones de carga de datos
        async function loadAllData() {
            console.log('üìä Cargando todos los datos...');
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    const [solicitudesData, tecnicosData, usuariosData, solicitudesAccesoData] = await Promise.all([
                        window.airtableAPI.getSolicitudes(),
                        window.airtableAPI.getTecnicos(),
                        window.airtableAPI.getUsuarios(),
                        window.airtableAPI.getSolicitudesAcceso()
                    ]);
                    
                    solicitudes = solicitudesData || [];
                    tecnicos = tecnicosData || [];
                    usuarios = usuariosData || [];
                    solicitudesAcceso = solicitudesAccesoData || [];
                    
                    console.log(`‚úÖ Datos cargados: ${solicitudes.length} solicitudes, ${tecnicos.length} t√©cnicos`);
                } else {
                    loadLocalData();
                }
                
                updateAllViews();
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                showNotification('Error cargando datos: ' + error.message, 'error');
            }
        }

        function loadLocalData() {
            console.log('üíæ Cargando datos locales...');
            solicitudes = JSON.parse(localStorage.getItem('hospital_solicitudes') || '[]');
            tecnicos = JSON.parse(localStorage.getItem('hospital_tecnicos') || '[]');
            usuarios = JSON.parse(localStorage.getItem('hospital_usuarios') || '[]');
            solicitudesAcceso = JSON.parse(localStorage.getItem('hospital_solicitudes_acceso') || '[]');
        }

        // Funciones de actualizaci√≥n de vistas
        function updateAllViews() {
            updateMetrics();
            updatePersonnelSummary();
            updateSolicitudesList();
            updateTechniciansList();
            updateAccessRequestsList();
            updateNavigationCounters();
        }

        function updateMetrics() {
            // M√©tricas totales
            document.getElementById('metric-total').textContent = solicitudes.length;
            
            // Por estado
            const pendientes = solicitudes.filter(s => 
                s.estado === 'PENDIENTE' || s.estado === 'Pendiente'
            ).length;
            const asignadas = solicitudes.filter(s => 
                s.estado === 'ASIGNADA' || s.estado === 'Asignada'
            ).length;
            
            document.getElementById('metric-pendientes').textContent = pendientes;
            document.getElementById('metric-asignadas').textContent = asignadas;
            
            // Por √°rea
            const biomedica = solicitudes.filter(s => {
                const area = s.servicioIngenieria || '';
                return area.toLowerCase().includes('biomed') || area === 'INGENIERIA_BIOMEDICA';
            }).length;
            
            const mecanica = solicitudes.filter(s => {
                const area = s.servicioIngenieria || '';
                return area === 'MECANICA' || area.toLowerCase().includes('mec');
            }).length;
            
            const infraestructura = solicitudes.filter(s => {
                const area = s.servicioIngenieria || '';
                return area === 'INFRAESTRUCTURA' || area.toLowerCase().includes('infra');
            }).length;
            
            document.getElementById('metric-biomedica').textContent = biomedica;
            document.getElementById('metric-mecanica').textContent = mecanica;
            document.getElementById('metric-infraestructura').textContent = infraestructura;
        }

        function updatePersonnelSummary() {
            const areas = ['BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'];
            
            areas.forEach(area => {
                const areaId = area.toLowerCase();
                const areaTecnicos = tecnicos.filter(t => {
                    const techArea = t.area || '';
                    if (area === 'BIOMEDICA') {
                        return techArea.toLowerCase().includes('biomed') || 
                               techArea === 'INGENIERIA_BIOMEDICA';
                    }
                    return techArea === area || techArea.toLowerCase().includes(areaId);
                });
                
                const disponibles = areaTecnicos.filter(t => t.estado === 'disponible').length;
                const total = areaTecnicos.length;
                
                // Actualizar contador
                const countEl = document.getElementById(`${areaId}-personnel-count`);
                if (countEl) {
                    countEl.textContent = `${total} registrados (${disponibles} disponibles)`;
                }
                
                // Actualizar lista
                const listEl = document.getElementById(`${areaId}-personnel-list`);
                if (listEl) {
                    if (areaTecnicos.length === 0) {
                        listEl.innerHTML = '<p style="color: #6b7280;">No hay personal registrado</p>';
                    } else {
                        listEl.innerHTML = areaTecnicos.map(tecnico => {
                            const estado = tecnico.estado || 'disponible';
                            const estadoClass = estado === 'disponible' ? 'status-disponible' : 'status-ocupado';
                            const estadoText = estado === 'disponible' ? '‚úÖ Disponible' : 'üîß Ocupado';
                            
                            // Obtener estad√≠sticas del t√©cnico
                            const solicitudesTecnico = solicitudes.filter(s => 
                                s.tecnicoAsignado === tecnico.nombre
                            );
                            const completadas = solicitudesTecnico.filter(s => 
                                s.estado === 'COMPLETADA' || s.estado === 'Completada'
                            ).length;
                            
                            return `
                                <div style="padding: 0.5rem; border-bottom: 1px solid #e5e7eb;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong>${tecnico.nombre}</strong>
                                            ${tecnico.especialidad ? `<br><small style="color: #6b7280;">${tecnico.especialidad}</small>` : ''}
                                            <br><small style="color: #059669;">üìä ${completadas} completadas de ${solicitudesTecnico.length} asignadas</small>
                                        </div>
                                        <span class="${estadoClass}">${estadoText}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            });
        }

        function updateSolicitudesList() {
            const listEl = document.getElementById('solicitudes-list');
            if (!listEl) return;
            
            const filteredSolicitudes = applyFiltersToData();
            
            if (filteredSolicitudes.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay solicitudes que mostrar</p>';
                return;
            }
            
            listEl.innerHTML = filteredSolicitudes.map(solicitud => {
                const statusClass = getStatusClass(solicitud.estado);
                const priorityClass = getPriorityClass(solicitud.prioridad);
                const cardClass = getRequestCardClass(solicitud.estado);
                
                return `
                    <div class="request-card ${cardClass}">
                        <div class="request-header">
                            <span class="request-number">${solicitud.numero || 'Sin n√∫mero'}</span>
                            <div style="display: flex; gap: 0.5rem;">
                                <span class="${statusClass}">${getStatusLabel(solicitud.estado)}</span>
                                <span class="${priorityClass}">${solicitud.prioridad || 'Media'}</span>
                            </div>
                        </div>
                        <div class="request-details">
                            <div class="request-detail">
                                <span class="request-detail-label">Solicitante:</span>
                                <span class="request-detail-value">${solicitud.solicitante || 'No especificado'}</span>
                            </div>
                            <div class="request-detail">
                                <span class="request-detail-label">√Årea:</span>
                                <span class="request-detail-value">${getAreaLabel(solicitud.servicioIngenieria)}</span>
                            </div>
                            <div class="request-detail">
                                <span class="request-detail-label">Equipo:</span>
                                <span class="request-detail-value">${solicitud.equipo || 'No especificado'}</span>
                            </div>
                            <div class="request-detail">
                                <span class="request-detail-label">T√©cnico Asignado:</span>
                                <span class="request-detail-value">${solicitud.tecnicoAsignado || 'Sin asignar'}</span>
                            </div>
                        </div>
                        <div class="request-actions">
                            ${getRequestActions(solicitud)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getRequestActions(solicitud) {
            const actions = [];
            
            if (solicitud.estado === 'PENDIENTE' || solicitud.estado === 'Pendiente') {
                actions.push(`<button class="btn btn-primary btn-sm" onclick="showAssignTechnicianModal('${solicitud.id}')">üéØ Asignar</button>`);
            }
            
            if (solicitud.estado === 'ASIGNADA' || solicitud.estado === 'Asignada') {
                actions.push(`<button class="btn btn-info btn-sm" onclick="changeRequestStatus('${solicitud.id}', 'EN_PROCESO')">‚ñ∂Ô∏è Iniciar</button>`);
            }
            
            if (solicitud.estado === 'EN_PROCESO' || solicitud.estado === 'En Proceso') {
                actions.push(`<button class="btn btn-success btn-sm" onclick="changeRequestStatus('${solicitud.id}', 'COMPLETADA')">‚úÖ Completar</button>`);
            }
            
            if (solicitud.estado !== 'COMPLETADA' && solicitud.estado !== 'CANCELADA') {
                actions.push(`<button class="btn btn-danger btn-sm" onclick="changeRequestStatus('${solicitud.id}', 'CANCELADA')">‚ùå Cancelar</button>`);
            }
            
            return actions.join(' ');
        }

        // Funciones de cambio de estado
        async function changeRequestStatus(solicitudId, nuevoEstado) {
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            if (!solicitud) return;
            
            const confirmMsg = `¬øCambiar estado de ${solicitud.numero} a ${getStatusLabel(nuevoEstado)}?`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    const result = await window.airtableAPI.updateRequestStatus(
                        solicitudId, 
                        nuevoEstado,
                        `Estado cambiado a ${nuevoEstado} por el usuario`
                    );
                    
                    if (result.success) {
                        showNotification(`Estado actualizado a ${getStatusLabel(nuevoEstado)}`, 'success');
                        await loadAllData();
                    }
                } else {
                    // Actualizaci√≥n local
                    const index = solicitudes.findIndex(s => s.id === solicitudId);
                    if (index !== -1) {
                        solicitudes[index].estado = nuevoEstado;
                        
                        if (nuevoEstado === 'COMPLETADA') {
                            solicitudes[index].fechaCompletado = new Date().toISOString();
                            // Liberar t√©cnico localmente
                            const tecnico = tecnicos.find(t => t.nombre === solicitudes[index].tecnicoAsignado);
                            if (tecnico) {
                                tecnico.estado = 'disponible';
                                tecnico.solicitudAsignada = '';
                            }
                        }
                        
                        localStorage.setItem('hospital_solicitudes', JSON.stringify(solicitudes));
                        localStorage.setItem('hospital_tecnicos', JSON.stringify(tecnicos));
                        showNotification('Estado actualizado localmente', 'success');
                        updateAllViews();
                    }
                }
            } catch (error) {
                console.error('‚ùå Error cambiando estado:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Funciones de asignaci√≥n
        function showAssignTechnicianModal(solicitudId) {
            const solicitud = solicitudes.find(s => s.id === solicitudId);
            if (!solicitud) return;
            
            const area = solicitud.servicioIngenieria;
            const tecnicosDisponibles = tecnicos.filter(t => {
                const isAvailable = t.estado === 'disponible';
                const techArea = t.area || '';
                
                // Normalizar √°reas para comparaci√≥n
                const solicitudAreaNorm = area?.toLowerCase().includes('biomed') ? 'BIOMEDICA' : area;
                const tecnicoAreaNorm = techArea.toLowerCase().includes('biomed') ? 'BIOMEDICA' : techArea;
                
                return isAvailable && (
                    solicitudAreaNorm === tecnicoAreaNorm ||
                    techArea.toLowerCase().includes(solicitudAreaNorm?.toLowerCase() || '')
                );
            });
            
            const modalContent = document.getElementById('assign-modal-content');
            modalContent.innerHTML = `
                <div class="form-group">
                    <p><strong>Solicitud:</strong> ${solicitud.numero}</p>
                    <p><strong>√Årea:</strong> ${getAreaLabel(solicitud.servicioIngenieria)}</p>
                    <p><strong>Equipo:</strong> ${solicitud.equipo || 'No especificado'}</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üë®‚Äçüîß Seleccionar T√©cnico</label>
                    <select class="form-select" id="selected-technician">
                        <option value="">-- Seleccione --</option>
                        ${tecnicosDisponibles.map(t => `
                            <option value="${t.id}">${t.nombre} ${t.especialidad ? `(${t.especialidad})` : ''}</option>
                        `).join('')}
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìù Observaciones</label>
                    <textarea class="form-textarea" id="assign-observations" 
                              placeholder="Observaciones de la asignaci√≥n (opcional)"></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="assignTechnician('${solicitudId}')">
                        üéØ Asignar
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal('assign-technician-modal')">
                        ‚ùå Cancelar
                    </button>
                </div>
            `;
            
            openModal('assign-technician-modal');
        }

        async function assignTechnician(solicitudId) {
            const technicianId = document.getElementById('selected-technician').value;
            const observations = document.getElementById('assign-observations').value;
            
            if (!technicianId) {
                showNotification('Debe seleccionar un t√©cnico', 'error');
                return;
            }
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    const result = await window.airtableAPI.assignTechnicianToRequest(
                        solicitudId,
                        technicianId,
                        observations
                    );
                    
                    if (result.success) {
                        showNotification('T√©cnico asignado exitosamente', 'success');
                        closeModal('assign-technician-modal');
                        await loadAllData();
                    }
                } else {
                    // Asignaci√≥n local
                    const solicitud = solicitudes.find(s => s.id === solicitudId);
                    const tecnico = tecnicos.find(t => t.id === technicianId);
                    
                    if (solicitud && tecnico) {
                        solicitud.tecnicoAsignado = tecnico.nombre;
                        solicitud.estado = 'ASIGNADA';
                        solicitud.fechaAsignacion = new Date().toISOString();
                        
                        tecnico.estado = 'ocupado';
                        tecnico.solicitudAsignada = solicitud.numero;
                        
                        localStorage.setItem('hospital_solicitudes', JSON.stringify(solicitudes));
                        localStorage.setItem('hospital_tecnicos', JSON.stringify(tecnicos));
                        
                        showNotification('T√©cnico asignado localmente', 'success');
                        closeModal('assign-technician-modal');
                        updateAllViews();
                    }
                }
            } catch (error) {
                console.error('‚ùå Error asignando t√©cnico:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Funciones de estad√≠sticas
        async function showAdvancedStatisticsModal() {
            const modalContent = document.getElementById('advanced-stats-content');
            modalContent.innerHTML = '<p style="text-align: center;">‚è≥ Cargando estad√≠sticas...</p>';
            openModal('advanced-stats-modal');
            
            try {
                // Verificar que el API existe y tiene el m√©todo
                if (!window.airtableAPI) {
                    throw new Error('API de Airtable no disponible');
                }
                
                if (!window.airtableAPI.getAdvancedStatistics) {
                    throw new Error('M√©todo getAdvancedStatistics no disponible');
                }
                
                if (cloudConnected) {
                    console.log('üìä Obteniendo estad√≠sticas avanzadas...');
                    const stats = await window.airtableAPI.getAdvancedStatistics();
                    displayAdvancedStats(stats);
                } else {
                    // Generar estad√≠sticas locales como fallback
                    const localStats = generateLocalStatistics();
                    displayAdvancedStats(localStats);
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo estad√≠sticas:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: red; margin-bottom: 1rem;">Error cargando estad√≠sticas</p>
                        <p style="color: #6b7280;">${error.message}</p>
                        <button class="btn btn-secondary btn-sm" onclick="closeModal('advanced-stats-modal')">
                            Cerrar
                        </button>
                    </div>
                `;
            }
        }

        function displayAdvancedStats(stats) {
            const modalContent = document.getElementById('advanced-stats-content');
            
            modalContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">üìä Total Solicitudes</span>
                        </div>
                        <div class="stat-card-value">${stats.solicitudes.total}</div>
                        <div class="stat-card-description">Total hist√≥rico de solicitudes</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">‚úÖ Tasa de Completitud</span>
                        </div>
                        <div class="stat-card-value">${stats.indicadoresGestion.porcentajeCompletadas}%</div>
                        <div class="stat-card-description">Solicitudes completadas exitosamente</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">‚è±Ô∏è Tiempo Promedio</span>
                        </div>
                        <div class="stat-card-value">${stats.tiemposRespuesta.promedioRespuesta}</div>
                        <div class="stat-card-description">Tiempo promedio de resoluci√≥n</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">üîß Mantenimientos Correctivos</span>
                        </div>
                        <div class="stat-card-value">${stats.indicadoresGestion.porcentajeMantenimientosCorrectivos}%</div>
                        <div class="stat-card-description">Del total de solicitudes</div>
                    </div>
                </div>
                
                <h4 style="margin-top: 2rem; margin-bottom: 1rem;">üë®‚Äçüîß Rendimiento por T√©cnico</h4>
                <div class="table-responsive">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>T√©cnico</th>
                                <th>√Årea</th>
                                <th>Asignadas</th>
                                <th>Completadas</th>
                                <th>En Proceso</th>
                                <th>Tiempo Promedio</th>
                                <th>Tasa Completado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(stats.estadisticasPorTecnico)
                                .filter(([_, data]) => data.totalAsignaciones > 0)
                                .sort((a, b) => b[1].totalAsignaciones - a[1].totalAsignaciones)
                                .map(([tecnico, data]) => `
                                    <tr>
                                        <td><strong>${tecnico}</strong></td>
                                        <td>${getAreaLabel(data.area)}</td>
                                        <td>${data.totalAsignaciones}</td>
                                        <td>${data.completadas}</td>
                                        <td>${data.enProceso}</td>
                                        <td>${data.tiempoPromedio}</td>
                                        <td>${data.tasaCompletado}%</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                </div>
                
                <h4 style="margin-top: 2rem; margin-bottom: 1rem;">üìä Por Tipo de Servicio</h4>
                <div class="table-responsive">
                    <table class="stats-table">
                        <thead>
                            <tr>
                                <th>Tipo de Servicio</th>
                                <th>Total</th>
                                <th>Completadas</th>
                                <th>Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.entries(stats.estadisticasPorTipo)
                                .sort((a, b) => b[1].total - a[1].total)
                                .map(([tipo, data]) => `
                                    <tr>
                                        <td>${tipo}</td>
                                        <td>${data.total}</td>
                                        <td>${data.completadas}</td>
                                        <td>${data.porcentaje}%</td>
                                    </tr>
                                `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function showMonthlyStatsModal() {
            const now = new Date();
            document.getElementById('stats-month').value = now.getMonth() + 1;
            document.getElementById('stats-year').value = now.getFullYear();
            
            openModal('monthly-stats-modal');
            await loadMonthlyStats();
        }

        async function loadMonthlyStats() {
            const month = parseInt(document.getElementById('stats-month').value);
            const year = parseInt(document.getElementById('stats-year').value);
            const modalContent = document.getElementById('monthly-stats-content');
            
            modalContent.innerHTML = '<p style="text-align: center;">‚è≥ Cargando estad√≠sticas mensuales...</p>';
            
            try {
                // Verificar que el API existe y tiene el m√©todo
                if (!window.airtableAPI) {
                    throw new Error('API de Airtable no disponible');
                }
                
                // Verificar si el m√©todo existe
                if (typeof window.airtableAPI.getMonthlyTechnicianStats !== 'function') {
                    console.error('‚ùå M√©todo getMonthlyTechnicianStats no est√° definido');
                    console.log('M√©todos disponibles:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.airtableAPI)));
                    
                    // Usar estad√≠sticas locales como fallback
                    const localStats = generateLocalMonthlyStats(month, year);
                    displayMonthlyStats(localStats);
                    return;
                }
                
                if (cloudConnected) {
                    console.log(`üìä Obteniendo estad√≠sticas de ${month}/${year}...`);
                    const stats = await window.airtableAPI.getMonthlyTechnicianStats(month, year);
                    displayMonthlyStats(stats);
                } else {
                    // Generar estad√≠sticas locales
                    const localStats = generateLocalMonthlyStats(month, year);
                    displayMonthlyStats(localStats);
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo estad√≠sticas mensuales:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: red; margin-bottom: 1rem;">Error cargando estad√≠sticas</p>
                        <p style="color: #6b7280;">${error.message}</p>
                        <button class="btn btn-secondary btn-sm" onclick="closeModal('monthly-stats-modal')">
                            Cerrar
                        </button>
                    </div>
                `;
            }
        }

        function displayMonthlyStats(stats) {
            const modalContent = document.getElementById('monthly-stats-content');
            const monthNames = ['', 'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            modalContent.innerHTML = `
                <h4 style="text-align: center; margin-bottom: 1rem;">
                    üìÖ Estad√≠sticas de ${monthNames[stats.mes]} ${stats.a√±o}
                </h4>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">üìã Total Solicitudes</span>
                        </div>
                        <div class="stat-card-value">${stats.totalSolicitudesMes}</div>
                        <div class="stat-card-description">Solicitudes del mes</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <span class="stat-card-title">üë• T√©cnicos Activos</span>
                        </div>
                        <div class="stat-card-value">${stats.tecnicosActivos}</div>
                        <div class="stat-card-description">Con asignaciones en el mes</div>
                    </div>
                </div>
                
                <h4 style="margin-top: 2rem; margin-bottom: 1rem;">üèÜ Ranking del Mes</h4>
                <div>
                    ${stats.ranking.map(([tecnico, data], index) => {
                        let rankingClass = '';
                        let medal = '';
                        if (index === 0) { rankingClass = 'gold'; medal = 'ü•á'; }
                        else if (index === 1) { rankingClass = 'silver'; medal = 'ü•à'; }
                        else if (index === 2) { rankingClass = 'bronze'; medal = 'ü•â'; }
                        else { medal = `${index + 1}.`; }
                        
                        return `
                            <div class="technician-stats-card">
                                <div class="technician-ranking">
                                    <span class="ranking-position ${rankingClass}">${medal}</span>
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0;">${tecnico}</h4>
                                        <p style="margin: 0.5rem 0; color: #6b7280;">
                                            ${getAreaLabel(data.area)}
                                        </p>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-top: 0.5rem;">
                                            <div>
                                                <strong>${data.totalAsignaciones}</strong><br>
                                                <small>Asignaciones</small>
                                            </div>
                                            <div>
                                                <strong>${data.completadas}</strong><br>
                                                <small>Completadas</small>
                                            </div>
                                            <div>
                                                <strong>${data.tasaCompletado}%</strong><br>
                                                <small>Tasa √âxito</small>
                                            </div>
                                        </div>
                                        <p style="margin-top: 0.5rem; color: #059669;">
                                            ‚è±Ô∏è Tiempo promedio: ${data.tiempoPromedio}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function showTechnicianPerformanceModal() {
            const modalContent = document.getElementById('performance-content');
            modalContent.innerHTML = '<p style="text-align: center;">‚è≥ Cargando rendimiento de personal...</p>';
            openModal('technician-performance-modal');
            
            try {
                // Verificar que el API existe
                if (!window.airtableAPI) {
                    throw new Error('API de Airtable no disponible');
                }
                
                // Verificar si el m√©todo existe
                if (typeof window.airtableAPI.getTechnicianHistory !== 'function') {
                    console.error('‚ùå M√©todo getTechnicianHistory no est√° definido');
                    
                    // Usar estad√≠sticas locales como fallback
                    const localStats = generateLocalTechnicianStats();
                    displayTechnicianPerformance(localStats);
                    return;
                }
                
                if (cloudConnected) {
                    console.log('üìä Obteniendo historial de t√©cnicos...');
                    // Obtener estad√≠sticas de todos los t√©cnicos
                    const allTechStats = await Promise.all(
                        tecnicos.map(async (tecnico) => {
                            try {
                                const history = await window.airtableAPI.getTechnicianHistory(tecnico.nombre);
                                return { tecnico, history };
                            } catch (error) {
                                console.error(`Error obteniendo historial de ${tecnico.nombre}:`, error);
                                // Generar estad√≠sticas locales para este t√©cnico
                                return { 
                                    tecnico, 
                                    history: generateLocalTechnicianHistory(tecnico) 
                                };
                            }
                        })
                    );
                    
                    displayTechnicianPerformance(allTechStats);
                } else {
                    // Generar estad√≠sticas locales
                    const localStats = generateLocalTechnicianStats();
                    displayTechnicianPerformance(localStats);
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo rendimiento:', error);
                modalContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: red; margin-bottom: 1rem;">Error cargando rendimiento</p>
                        <p style="color: #6b7280;">${error.message}</p>
                        <button class="btn btn-secondary btn-sm" onclick="closeModal('technician-performance-modal')">
                            Cerrar
                        </button>
                    </div>
                `;
            }
        }

        // Funciones de generaci√≥n de estad√≠sticas locales
        function generateLocalStatistics() {
            console.log('üìä Generando estad√≠sticas locales...');
            
            const totalSolicitudes = solicitudes.length;
            const completadas = solicitudes.filter(s => s.estado === 'COMPLETADA' || s.estado === 'Completada').length;
            const pendientes = solicitudes.filter(s => s.estado === 'PENDIENTE' || s.estado === 'Pendiente').length;
            const asignadas = solicitudes.filter(s => s.estado === 'ASIGNADA' || s.estado === 'Asignada').length;
            const enProceso = solicitudes.filter(s => s.estado === 'EN_PROCESO' || s.estado === 'En Proceso').length;
            const canceladas = solicitudes.filter(s => s.estado === 'CANCELADA' || s.estado === 'Cancelada').length;
            
            // Calcular estad√≠sticas por t√©cnico
            const estadisticasPorTecnico = {};
            tecnicos.forEach(tecnico => {
                const solicitudesTecnico = solicitudes.filter(s => s.tecnicoAsignado === tecnico.nombre);
                const completadasTecnico = solicitudesTecnico.filter(s => 
                    s.estado === 'COMPLETADA' || s.estado === 'Completada'
                ).length;
                
                estadisticasPorTecnico[tecnico.nombre] = {
                    area: tecnico.area,
                    totalAsignaciones: solicitudesTecnico.length,
                    completadas: completadasTecnico,
                    enProceso: solicitudesTecnico.filter(s => 
                        s.estado === 'EN_PROCESO' || s.estado === 'En Proceso' || 
                        s.estado === 'ASIGNADA' || s.estado === 'Asignada'
                    ).length,
                    tiempoPromedio: 'N/A',
                    tasaCompletado: solicitudesTecnico.length > 0 
                        ? ((completadasTecnico / solicitudesTecnico.length) * 100).toFixed(1) 
                        : 0,
                    estado: tecnico.estado
                };
            });
            
            return {
                solicitudes: {
                    total: totalSolicitudes,
                    pendientes: pendientes,
                    asignadas: asignadas,
                    enProceso: enProceso,
                    completadas: completadas,
                    canceladas: canceladas,
                    porArea: {
                        INGENIERIA_BIOMEDICA: solicitudes.filter(s => {
                            const area = s.servicioIngenieria || '';
                            return area.toLowerCase().includes('biomed') || area === 'INGENIERIA_BIOMEDICA';
                        }).length,
                        MECANICA: solicitudes.filter(s => {
                            const area = s.servicioIngenieria || '';
                            return area === 'MECANICA' || area.toLowerCase().includes('mec');
                        }).length,
                        INFRAESTRUCTURA: solicitudes.filter(s => {
                            const area = s.servicioIngenieria || '';
                            return area === 'INFRAESTRUCTURA' || area.toLowerCase().includes('infra');
                        }).length
                    }
                },
                indicadoresGestion: {
                    porcentajeCompletadas: totalSolicitudes > 0 ? ((completadas / totalSolicitudes) * 100).toFixed(2) : 0,
                    porcentajeMantenimientosCorrectivos: 0,
                    porcentajeErroresUsuario: 0
                },
                tiemposRespuesta: {
                    promedioRespuesta: 'N/A',
                    solicitudesVencidas: 0
                },
                estadisticasPorTipo: {},
                estadisticasPorTecnico: estadisticasPorTecnico
            };
        }

        function generateLocalMonthlyStats(month, year) {
            console.log(`üìä Generando estad√≠sticas locales para ${month}/${year}...`);
            
            // Filtrar solicitudes del mes
            const solicitudesMes = solicitudes.filter(s => {
                if (!s.fechaCreacion) return false;
                const fecha = new Date(s.fechaCreacion);
                return fecha.getMonth() === month - 1 && fecha.getFullYear() === year;
            });
            
            const statsPorTecnico = {};
            tecnicos.forEach(tecnico => {
                const solicitudesTecnico = solicitudesMes.filter(s => 
                    s.tecnicoAsignado === tecnico.nombre
                );
                const completadas = solicitudesTecnico.filter(s => 
                    s.estado === 'COMPLETADA' || s.estado === 'Completada'
                ).length;
                
                if (solicitudesTecnico.length > 0) {
                    statsPorTecnico[tecnico.nombre] = {
                        area: tecnico.area,
                        totalAsignaciones: solicitudesTecnico.length,
                        completadas: completadas,
                        tiempoPromedio: 'N/A',
                        tasaCompletado: ((completadas / solicitudesTecnico.length) * 100).toFixed(1)
                    };
                }
            });
            
            const ranking = Object.entries(statsPorTecnico)
                .sort((a, b) => b[1].totalAsignaciones - a[1].totalAsignaciones);
            
            return {
                mes: month,
                a√±o: year,
                totalSolicitudesMes: solicitudesMes.length,
                tecnicosActivos: ranking.length,
                statsPorTecnico: statsPorTecnico,
                ranking: ranking
            };
        }

        function generateLocalTechnicianStats() {
            console.log('üìä Generando estad√≠sticas locales de t√©cnicos...');
            
            return tecnicos.map(tecnico => {
                const history = generateLocalTechnicianHistory(tecnico);
                return { tecnico, history };
            });
        }

        function generateLocalTechnicianHistory(tecnico) {
            const solicitudesTecnico = solicitudes.filter(s => 
                s.tecnicoAsignado === tecnico.nombre
            );
            
            const completadas = solicitudesTecnico.filter(s => 
                s.estado === 'COMPLETADA' || s.estado === 'Completada'
            );
            
            const enProceso = solicitudesTecnico.filter(s => 
                s.estado === 'EN_PROCESO' || s.estado === 'En Proceso' || 
                s.estado === 'ASIGNADA' || s.estado === 'Asignada'
            );
            
            return {
                tecnico: tecnico.nombre,
                totalAsignaciones: solicitudesTecnico.length,
                completadas: completadas.length,
                enProceso: enProceso.length,
                erroresUsuarioResueltos: 0,
                tiempoPromedioRespuesta: 'N/A',
                tasaCompletado: solicitudesTecnico.length > 0 
                    ? ((completadas.length / solicitudesTecnico.length) * 100).toFixed(1) 
                    : '0',
                solicitudes: solicitudesTecnico
            };
        }

        function displayTechnicianPerformance(techStats) {
            const modalContent = document.getElementById('performance-content');
            
            // Ordenar por total de asignaciones
            techStats.sort((a, b) => b.history.totalAsignaciones - a.history.totalAsignaciones);
            
            modalContent.innerHTML = `
                <div class="analysis-tabs">
                    <button class="analysis-tab active" onclick="showPerformanceTab('overview')">
                        üìä Vista General
                    </button>
                    <button class="analysis-tab" onclick="showPerformanceTab('detailed')">
                        üìã Detalle por T√©cnico
                    </button>
                </div>
                
                <div id="performance-overview" class="performance-tab">
                    <h4 style="margin-bottom: 1rem;">üìä Resumen de Rendimiento</h4>
                    <div class="table-responsive">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>Ranking</th>
                                    <th>T√©cnico</th>
                                    <th>√Årea</th>
                                    <th>Total</th>
                                    <th>Completadas</th>
                                    <th>En Proceso</th>
                                    <th>Tiempo Promedio</th>
                                    <th>Tasa √âxito</th>
                                    <th>Errores Usuario</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${techStats.map((item, index) => {
                                    if (item.history.totalAsignaciones === 0) return '';
                                    
                                    let medal = '';
                                    if (index === 0) medal = 'ü•á';
                                    else if (index === 1) medal = 'ü•à';
                                    else if (index === 2) medal = 'ü•â';
                                    else medal = `${index + 1}`;
                                    
                                    return `
                                        <tr>
                                            <td style="font-weight: bold;">${medal}</td>
                                            <td><strong>${item.tecnico.nombre}</strong></td>
                                            <td>${getAreaLabel(item.tecnico.area)}</td>
                                            <td>${item.history.totalAsignaciones}</td>
                                            <td>${item.history.completadas}</td>
                                            <td>${item.history.enProceso}</td>
                                            <td>${item.history.tiempoPromedioRespuesta}</td>
                                            <td>${item.history.tasaCompletado}%</td>
                                            <td>${item.history.erroresUsuarioResueltos}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="performance-detailed" class="performance-tab" style="display: none;">
                    <h4 style="margin-bottom: 1rem;">üìã Detalle Individual</h4>
                    ${techStats.map(item => {
                        if (item.history.totalAsignaciones === 0) return '';
                        
                        return `
                            <div class="technician-stats-card">
                                <h4>${item.tecnico.nombre}</h4>
                                <p style="color: #6b7280;">${getAreaLabel(item.tecnico.area)} - ${item.tecnico.tipo || 'T√©cnico'}</p>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin: 1rem 0;">
                                    <div style="text-align: center; padding: 1rem; background: #f8fafc; border-radius: 0.5rem;">
                                        <div style="font-size: 2rem; font-weight: bold; color: #2563eb;">${item.history.totalAsignaciones}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Total Asignaciones</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: #f0fdf4; border-radius: 0.5rem;">
                                        <div style="font-size: 2rem; font-weight: bold; color: #059669;">${item.history.completadas}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Completadas</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: #fef3c7; border-radius: 0.5rem;">
                                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">${item.history.enProceso}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">En Proceso</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: #eff6ff; border-radius: 0.5rem;">
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;">${item.history.tiempoPromedioRespuesta}</div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Tiempo Promedio</div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                    <span style="color: #059669;">
                                        ‚úÖ Tasa de √©xito: ${item.history.tasaCompletado}%
                                    </span>
                                    <span style="color: #f59e0b;">
                                        ‚ö†Ô∏è Errores de usuario resueltos: ${item.history.erroresUsuarioResueltos}
                                    </span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function showPerformanceTab(tab) {
            document.querySelectorAll('.analysis-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.performance-tab').forEach(t => t.style.display = 'none');
            
            if (tab === 'overview') {
                document.querySelector('[onclick*="overview"]').classList.add('active');
                document.getElementById('performance-overview').style.display = 'block';
            } else {
                document.querySelector('[onclick*="detailed"]').classList.add('active');
                document.getElementById('performance-detailed').style.display = 'block';
            }
        }

        // Funciones auxiliares
        function getStatusClass(estado) {
            const statusMap = {
                'PENDIENTE': 'status-pendiente',
                'Pendiente': 'status-pendiente',
                'ASIGNADA': 'status-asignada',
                'Asignada': 'status-asignada',
                'EN_PROCESO': 'status-en-proceso',
                'En Proceso': 'status-en-proceso',
                'COMPLETADA': 'status-completada',
                'Completada': 'status-completada',
                'CANCELADA': 'status-cancelada',
                'Cancelada': 'status-cancelada'
            };
            return statusMap[estado] || 'status-pendiente';
        }

        function getStatusLabel(estado) {
            const labelMap = {
                'PENDIENTE': 'Pendiente',
                'ASIGNADA': 'Asignada',
                'EN_PROCESO': 'En Proceso',
                'COMPLETADA': 'Completada',
                'CANCELADA': 'Cancelada'
            };
            return labelMap[estado] || estado;
        }

        function getPriorityClass(prioridad) {
            const priorityMap = {
                'CRITICA': 'priority-critica',
                'ALTA': 'priority-alta',
                'MEDIA': 'priority-media',
                'BAJA': 'priority-baja'
            };
            return priorityMap[prioridad] || 'priority-media';
        }

        function getRequestCardClass(estado) {
            const cardMap = {
                'PENDIENTE': 'pending',
                'Pendiente': 'pending',
                'ASIGNADA': 'assigned',
                'Asignada': 'assigned',
                'EN_PROCESO': 'in-progress',
                'En Proceso': 'in-progress',
                'COMPLETADA': 'completed',
                'Completada': 'completed',
                'CANCELADA': 'cancelled',
                'Cancelada': 'cancelled'
            };
            return cardMap[estado] || 'pending';
        }

        function getAreaLabel(area) {
            if (!area) return 'No especificada';
            
            if (area.toLowerCase().includes('biomed') || area === 'INGENIERIA_BIOMEDICA') {
                return 'üè• Ingenier√≠a Biom√©dica';
            } else if (area === 'MECANICA' || area.toLowerCase().includes('mec')) {
                return '‚öôÔ∏è Mec√°nica';
            } else if (area === 'INFRAESTRUCTURA' || area.toLowerCase().includes('infra')) {
                return 'üèóÔ∏è Infraestructura';
            }
            return area;
        }

        // Funciones de navegaci√≥n
        function showView(viewName) {
            currentView = viewName;
            
            // Actualizar pesta√±as activas
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.view === viewName) {
                    tab.classList.add('active');
                }
            });
            
            // Mostrar/ocultar vistas
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            const viewElement = document.getElementById(`${viewName}-view`);
            if (viewElement) {
                viewElement.classList.remove('hidden');
            }
            
            // Actualizar datos si es necesario
            if (viewName === 'personal') {
                updateTechniciansList();
            } else if (viewName === 'accesos') {
                updateAccessRequestsList();
            }
        }

        // Funciones de modal
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        // Funciones de notificaci√≥n
        function showNotification(message, type = 'info') {
            // Implementar sistema de notificaciones toast
            console.log(`[${type.toUpperCase()}] ${message}`);
            alert(message); // Temporal, reemplazar con toast
        }

        // Funciones de filtros
        function applyFilters() {
            updateSolicitudesList();
        }

        function applyFiltersToData() {
            let filtered = [...solicitudes];
            
            // Filtro de b√∫squeda
            const searchTerm = document.getElementById('filter-search')?.value.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(s => 
                    s.numero?.toLowerCase().includes(searchTerm) ||
                    s.solicitante?.toLowerCase().includes(searchTerm) ||
                    s.tecnicoAsignado?.toLowerCase().includes(searchTerm) ||
                    s.equipo?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Filtro de √°rea
            const filterArea = document.getElementById('filter-area')?.value || '';
            if (filterArea) {
                filtered = filtered.filter(s => {
                    const area = s.servicioIngenieria || '';
                    if (filterArea === 'INGENIERIA_BIOMEDICA') {
                        return area.toLowerCase().includes('biomed') || area === 'INGENIERIA_BIOMEDICA';
                    }
                    return area === filterArea;
                });
            }
            
            // Filtro de estado
            const filterStatus = document.getElementById('filter-status')?.value || '';
            if (filterStatus) {
                filtered = filtered.filter(s => s.estado === filterStatus);
            }
            
            // Filtro de prioridad
            const filterPriority = document.getElementById('filter-priority')?.value || '';
            if (filterPriority) {
                filtered = filtered.filter(s => s.prioridad === filterPriority);
            }
            
            return filtered;
        }

        function filterByArea(area) {
            if (area === 'all') {
                document.getElementById('filter-area').value = '';
            } else {
                document.getElementById('filter-area').value = area;
            }
            showView('solicitudes');
            applyFilters();
        }

        function filterByStatus(status) {
            document.getElementById('filter-status').value = status;
            showView('solicitudes');
            applyFilters();
        }

        // Funciones de auto-refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(() => {
                autoRefreshCountdown--;
                document.getElementById('refresh-countdown').textContent = `(${autoRefreshCountdown}s)`;
                
                if (autoRefreshCountdown <= 0) {
                    autoRefreshCountdown = 5;
                    loadAllData();
                }
            }, 1000);
        }

        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                document.getElementById('auto-refresh-indicator').classList.remove('active');
                document.getElementById('auto-refresh-toggle-text').textContent = '‚ñ∂Ô∏è Reanudar Auto-Refresh';
            } else {
                startAutoRefresh();
                document.getElementById('auto-refresh-indicator').classList.add('active');
                document.getElementById('auto-refresh-toggle-text').textContent = '‚è∏Ô∏è Pausar Auto-Refresh';
            }
        }

        // Funciones de personal
        function showNewTechnicianModal() {
            document.getElementById('tech-name').value = '';
            document.getElementById('tech-email').value = '';
            document.getElementById('tech-area').value = '';
            document.getElementById('tech-type').value = 'tecnico';
            document.getElementById('tech-specialty').value = '';
            openModal('new-technician-modal');
        }

        async function handleNewTechnician(event) {
            event.preventDefault();
            
            const techData = {
                nombre: document.getElementById('tech-name').value,
                email: document.getElementById('tech-email').value,
                area: document.getElementById('tech-area').value,
                tipo: document.getElementById('tech-type').value,
                especialidad: document.getElementById('tech-specialty').value,
                estado: 'disponible'
            };
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    await window.airtableAPI.createTecnico(techData);
                    showNotification('Personal agregado exitosamente', 'success');
                } else {
                    // Guardar localmente
                    techData.id = 'LOCAL_' + Date.now();
                    tecnicos.push(techData);
                    localStorage.setItem('hospital_tecnicos', JSON.stringify(tecnicos));
                    showNotification('Personal guardado localmente', 'success');
                }
                
                closeModal('new-technician-modal');
                await loadAllData();
                
            } catch (error) {
                console.error('‚ùå Error creando personal:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function updateTechniciansList() {
            const listEl = document.getElementById('technicians-list');
            if (!listEl) return;
            
            if (tecnicos.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay personal registrado</p>';
                return;
            }
            
            // Agrupar por √°rea
            const tecnicosPorArea = {
                'INGENIERIA_BIOMEDICA': [],
                'MECANICA': [],
                'INFRAESTRUCTURA': [],
                'OTROS': []
            };
            
            tecnicos.forEach(tecnico => {
                const area = tecnico.area || '';
                if (area.toLowerCase().includes('biomed') || area === 'INGENIERIA_BIOMEDICA') {
                    tecnicosPorArea['INGENIERIA_BIOMEDICA'].push(tecnico);
                } else if (area === 'MECANICA') {
                    tecnicosPorArea['MECANICA'].push(tecnico);
                } else if (area === 'INFRAESTRUCTURA') {
                    tecnicosPorArea['INFRAESTRUCTURA'].push(tecnico);
                } else {
                    tecnicosPorArea['OTROS'].push(tecnico);
                }
            });
            
            listEl.innerHTML = Object.entries(tecnicosPorArea).map(([area, tecnicosArea]) => {
                if (tecnicosArea.length === 0) return '';
                
                return `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                            ${getAreaLabel(area)}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            ${tecnicosArea.map(tecnico => {
                                const estado = tecnico.estado || 'disponible';
                                const estadoClass = estado === 'disponible' ? 'status-disponible' : 'status-ocupado';
                                const estadoText = estado === 'disponible' ? '‚úÖ Disponible' : 'üîß Ocupado';
                                
                                // Obtener estad√≠sticas
                                const solicitudesTecnico = solicitudes.filter(s => 
                                    s.tecnicoAsignado === tecnico.nombre
                                );
                                const completadas = solicitudesTecnico.filter(s => 
                                    s.estado === 'COMPLETADA' || s.estado === 'Completada'
                                ).length;
                                
                                return `
                                    <div class="technician-stats-card">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div>
                                                <h4 style="margin: 0;">${tecnico.nombre}</h4>
                                                <p style="margin: 0.25rem 0; color: #6b7280;">
                                                    ${tecnico.tipo || 'T√©cnico'}
                                                    ${tecnico.especialidad ? ` - ${tecnico.especialidad}` : ''}
                                                </p>
                                                ${tecnico.email ? `<p style="margin: 0.25rem 0; font-size: 0.875rem; color: #6b7280;">üìß ${tecnico.email}</p>` : ''}
                                            </div>
                                            <span class="${estadoClass}">${estadoText}</span>
                                        </div>
                                        
                                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
                                                <div>
                                                    <strong>${solicitudesTecnico.length}</strong> asignaciones totales
                                                </div>
                                                <div>
                                                    <strong>${completadas}</strong> completadas
                                                </div>
                                            </div>
                                            ${solicitudesTecnico.length > 0 ? `
                                                <div style="margin-top: 0.5rem; color: #059669; font-size: 0.875rem;">
                                                    Tasa de √©xito: ${((completadas / solicitudesTecnico.length) * 100).toFixed(1)}%
                                                </div>
                                            ` : ''}
                                        </div>
                                        
                                        <div style="margin-top: 1rem;">
                                            <button class="btn btn-info btn-sm" onclick="viewTechnicianHistory('${tecnico.nombre}')">
                                                üìä Ver Historial
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewTechnicianHistory(technicianName) {
            try {
                if (!window.airtableAPI) {
                    throw new Error('API de Airtable no disponible');
                }
                
                if (typeof window.airtableAPI.getTechnicianHistory !== 'function') {
                    // Usar estad√≠sticas locales
                    const tecnico = tecnicos.find(t => t.nombre === technicianName);
                    if (tecnico) {
                        const history = generateLocalTechnicianHistory(tecnico);
                        
                        alert(`
Historial de ${technicianName} (Local):
- Total asignaciones: ${history.totalAsignaciones}
- Completadas: ${history.completadas}
- En proceso: ${history.enProceso}
- Tasa de √©xito: ${history.tasaCompletado}%
                        `);
                    }
                    return;
                }
                
                if (cloudConnected) {
                    const history = await window.airtableAPI.getTechnicianHistory(technicianName);
                    
                    alert(`
Historial de ${technicianName}:
- Total asignaciones: ${history.totalAsignaciones}
- Completadas: ${history.completadas}
- En proceso: ${history.enProceso}
- Tiempo promedio: ${history.tiempoPromedioRespuesta}
- Tasa de √©xito: ${history.tasaCompletado}%
- Errores de usuario resueltos: ${history.erroresUsuarioResueltos}
                    `);
                } else {
                    // Generar estad√≠sticas locales
                    const tecnico = tecnicos.find(t => t.nombre === technicianName);
                    if (tecnico) {
                        const history = generateLocalTechnicianHistory(tecnico);
                        
                        alert(`
Historial de ${technicianName} (Modo Local):
- Total asignaciones: ${history.totalAsignaciones}
- Completadas: ${history.completadas}
- En proceso: ${history.enProceso}
- Tasa de √©xito: ${history.tasaCompletado}%
                        `);
                    }
                }
            } catch (error) {
                console.error('‚ùå Error obteniendo historial:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        // Funciones de solicitudes de acceso
        function updateAccessRequestsList() {
            const listEl = document.getElementById('access-requests-list');
            if (!listEl) return;
            
            const pendingRequests = solicitudesAcceso.filter(s => 
                s.estado === 'PENDIENTE' || s.estado === 'Pendiente'
            );
            
            if (pendingRequests.length === 0) {
                listEl.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay solicitudes pendientes</p>';
                return;
            }
            
            listEl.innerHTML = pendingRequests.map(solicitud => `
                <div class="access-request-card pending">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <h3 class="request-name">${solicitud.nombreCompleto}</h3>
                            <p style="margin: 0.5rem 0; color: #6b7280;">
                                üìß ${solicitud.email} ${solicitud.telefono ? `| üì± ${solicitud.telefono}` : ''}
                            </p>
                            <p style="margin: 0.5rem 0;">
                                <strong>Servicio:</strong> ${solicitud.servicioHospitalario || 'No especificado'}<br>
                                <strong>Cargo:</strong> ${solicitud.cargo || 'No especificado'}
                            </p>
                            ${solicitud.justificacion ? `
                                <p style="margin: 0.5rem 0; font-style: italic; color: #6b7280;">
                                    "${solicitud.justificacion}"
                                </p>
                            ` : ''}
                        </div>
                        <div>
                            <button class="btn btn-success btn-sm" onclick="approveAccessRequest('${solicitud.id}')">
                                ‚úÖ Aprobar
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="rejectAccessRequest('${solicitud.id}')">
                                ‚ùå Rechazar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function approveAccessRequest(requestId) {
            if (!confirm('¬øAprobar esta solicitud de acceso?')) return;
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    const result = await window.airtableAPI.approveAccessRequestAndCreateUser(requestId);
                    
                    if (result.success) {
                        showNotification(
                            `Usuario creado exitosamente. C√≥digo de acceso: ${result.accessCode}`,
                            'success'
                        );
                        await loadAllData();
                    }
                } else {
                    showNotification('Solo se puede aprobar en modo cloud', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error aprobando solicitud:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function rejectAccessRequest(requestId) {
            if (!confirm('¬øRechazar esta solicitud de acceso?')) return;
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    await window.airtableAPI.updateSolicitudAcceso(requestId, {
                        estado: 'Rechazada'
                    });
                    
                    showNotification('Solicitud rechazada', 'success');
                    await loadAllData();
                } else {
                    showNotification('Solo se puede rechazar en modo cloud', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error rechazando solicitud:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function refreshAccessRequests() {
            loadAllData();
        }

        // Funciones de navegaci√≥n adicionales
        function updateNavigationCounters() {
            document.getElementById('total-count').textContent = solicitudes.length;
            document.getElementById('total-technicians-nav').textContent = tecnicos.length;
            
            const pendingAccess = solicitudesAcceso.filter(s => 
                s.estado === 'PENDIENTE' || s.estado === 'Pendiente'
            ).length;
            document.getElementById('pending-access-count').textContent = pendingAccess;
            
            // Actualizar badge de notificaciones
            const totalNotifications = solicitudes.filter(s => 
                s.estado === 'PENDIENTE' || s.estado === 'Pendiente'
            ).length + pendingAccess;
            document.getElementById('notification-count').textContent = totalNotifications;
        }

        // Funciones de testing
        async function testCloudConnection() {
            console.log('üß™ Probando conexi√≥n...');
            showNotification('Probando conexi√≥n...', 'info');
            
            try {
                await checkCloudConnection();
                
                if (cloudConnected) {
                    const status = window.airtableAPI.getStatus();
                    showNotification(
                        `‚úÖ Conectado exitosamente\n` +
                        `Entorno: ${status.environment}\n` +
                        `Versi√≥n: ${status.version}`,
                        'success'
                    );
                } else {
                    showNotification('üì¥ Trabajando en modo local', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error en prueba:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        async function autoAssignAllPending() {
            if (!confirm('¬øAuto-asignar todas las solicitudes pendientes?')) return;
            
            try {
                if (window.airtableAPI && cloudConnected) {
                    const result = await window.airtableAPI.autoAssignPendingRequests();
                    
                    showNotification(
                        `Auto-asignaci√≥n completada:\n` +
                        `‚úÖ Asignadas: ${result.asignadas}\n` +
                        `‚ùå Fallidas: ${result.fallidas}\n` +
                        `‚ö†Ô∏è Sin t√©cnicos: ${result.sinTecnicos}`,
                        'success'
                    );
                    
                    await loadAllData();
                } else {
                    showNotification('Auto-asignaci√≥n solo disponible en modo cloud', 'warning');
                }
            } catch (error) {
                console.error('‚ùå Error en auto-asignaci√≥n:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function showNotifications() {
            alert('Sistema de notificaciones - En desarrollo');
        }

        function showNewRequestModal() {
            alert('Crear nueva solicitud - En desarrollo\n\nUsar el portal de solicitudes para crear nuevas solicitudes');
        }

        function exportToExcel() {
            alert('Exportar a Excel - En desarrollo');
        }
    </script>
</body>
</html>