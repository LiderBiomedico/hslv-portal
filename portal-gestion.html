<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Gesti√≥n Cloud - Hospital Susana L√≥pez de Valencia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f8f5;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb 0%, #059669 100%);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            color: white;
        }

        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: auto;
            min-height: 5rem;
            padding: 1rem;
            position: relative;
            gap: 0.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            flex: 1;
            min-width: 0;
        }

        .hospital-info h1 {
            font-size: 1.2rem;
            font-weight: bold;
            color: white;
            line-height: 1.2;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .hospital-info p {
            font-size: 0.85rem;
            color: #e0f2fe;
            font-weight: 500;
            margin-top: 0.25rem;
            margin-bottom: 0;
            word-wrap: break-word;
            max-width: 100%;
            text-align: center;
        }

        .developer-credit {
            font-size: 0.75rem;
            color: #bfdbfe;
            font-weight: 400;
            margin-top: 0.25rem;
            margin-bottom: 0;
            text-align: center;
            font-style: italic;
        }

        /* Indicador de conexi√≥n Airtable */
        .connection-status {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: rgba(0,0,0,0.2);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            backdrop-filter: blur(10px);
        }

        .connection-status.connected {
            background: rgba(34, 197, 94, 0.3);
            color: #dcfce7;
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.3);
            color: #fee2e2;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 0.75rem 1.25rem;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tab.active {
            background: white;
            color: #059669;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-tab:hover:not(.active) {
            background: rgba(255,255,255,0.2);
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            padding: 1.5rem 1rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-content {
            padding: 1.5rem;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
            border-top: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }

        .metric-card.total { 
            border-top-color: #2563eb; 
            background: linear-gradient(135deg, #ffffff 0%, #dbeafe 100%);
        }
        .metric-card.biomedica { 
            border-top-color: #059669; 
            background: linear-gradient(135deg, #ffffff 0%, #dcfce7 100%);
        }
        .metric-card.mecanica { 
            border-top-color: #f59e0b; 
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
        }
        .metric-card.infraestructura { 
            border-top-color: #8b5cf6; 
            background: linear-gradient(135deg, #ffffff 0%, #ede9fe 100%);
        }
        .metric-card.pendientes { 
            border-top-color: #ef4444; 
            background: linear-gradient(135deg, #ffffff 0%, #fee2e2 100%);
        }

        .metric-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .metric-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Views */
        .view {
            display: block;
        }

        .view.hidden {
            display: none;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid;
            margin-bottom: 1.5rem;
        }

        .alert-info {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-success {
            background: #f0fdf4;
            border-color: #22c55e;
            color: #15803d;
        }

        .alert-warning {
            background: #fffbeb;
            border-color: #f59e0b;
            color: #d97706;
        }

        .alert-danger {
            background: #fef2f2;
            border-color: #ef4444;
            color: #dc2626;
        }

        /* Botones */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Solicitud Card - MEJORADA */
        .solicitud-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            position: relative;
        }

        .solicitud-card:hover {
            border-color: #2563eb;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .solicitud-card.pendiente {
            border-left: 6px solid #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
        }

        .solicitud-card.asignada {
            border-left: 6px solid #2563eb;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .solicitud-card.en-proceso {
            border-left: 6px solid #8b5cf6;
            background: linear-gradient(135deg, #f3f4f6 0%, #ede9fe 100%);
        }

        .solicitud-card.completada {
            border-left: 6px solid #059669;
            background: linear-gradient(135deg, #ecfdf5 0%, #dcfce7 100%);
        }

        .solicitud-card.urgente {
            animation: pulse-urgent 2s infinite;
            border-color: #ef4444 !important;
        }

        @keyframes pulse-urgent {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        .solicitud-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .solicitud-numero {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.25rem;
            background: rgba(255,255,255,0.8);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 2px solid rgba(0,0,0,0.1);
        }

        .solicitud-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-pendiente {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-asignada {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-proceso {
            background: #ede9fe;
            color: #7c3aed;
        }

        .badge-completada {
            background: #dcfce7;
            color: #166534;
        }

        .badge-critica {
            background: #fee2e2;
            color: #dc2626;
            animation: blink 1s infinite;
        }

        .badge-alta {
            background: #fed7aa;
            color: #ea580c;
        }

        .badge-media {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-baja {
            background: #dcfce7;
            color: #166534;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .solicitud-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
        }

        .solicitud-detail {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .solicitud-detail-label {
            font-weight: 600;
            color: #6b7280;
        }

        .solicitud-detail-value {
            color: #1f2937;
            font-weight: 500;
        }

        .tiempo-respuesta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: rgba(255,255,255,0.7);
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .tiempo-respuesta.urgente {
            background: #fee2e2;
            color: #dc2626;
        }

        .tiempo-respuesta.normal {
            background: #dbeafe;
            color: #1e40af;
        }

        .tiempo-respuesta.rapido {
            background: #dcfce7;
            color: #166534;
        }

        .solicitud-descripcion {
            background: rgba(255,255,255,0.8);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            border-left: 3px solid #2563eb;
        }

        .solicitud-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            padding-top: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .asignacion-section {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
        }

        .personal-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .personal-option {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .personal-option:hover {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .personal-option.selected {
            border-color: #059669;
            background: #dcfce7;
            color: #166534;
        }

        .personal-option.no-disponible {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.25rem;
        }

        .modal-close:hover {
            color: #1f2937;
        }

        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Filtros mejorados */
        .filtros-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .filtro-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filtro-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .filtro-select, .filtro-input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
        }

        .filtro-select:focus, .filtro-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .filtros-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* Estad√≠sticas de tiempo */
        .tiempo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .tiempo-stat {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border-left: 3px solid;
        }

        .tiempo-stat.tiempo-promedio {
            border-left-color: #2563eb;
        }

        .tiempo-stat.tiempo-min {
            border-left-color: #059669;
        }

        .tiempo-stat.tiempo-max {
            border-left-color: #ef4444;
        }

        .tiempo-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }

        .tiempo-stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .solicitud-actions {
                flex-direction: column;
            }

            .solicitud-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .personal-selector {
                grid-template-columns: 1fr;
            }

            .filtros-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content container">
            <!-- Indicador de conexi√≥n Airtable -->
            <div id="connection-status" class="connection-status disconnected">
                <span id="connection-icon">üîÑ</span>
                <span id="connection-text">Conectando...</span>
            </div>
            
            <div class="logo">
                <div class="hospital-info">
                    <h1>HOSPITAL SUSANA LOPEZ DE VALENCIA E.S.E.</h1>
                    <p class="developer-credit">Desarrollado por Ing. Paul Eduardo Mu√±oz R.</p>
                    <p>Portal de Gesti√≥n Cloud - Sistema con Airtable</p>
                </div>
            </div>

            <nav class="nav-tabs">
                <button class="nav-tab active" onclick="showView('dashboard')" data-view="dashboard">
                    üìä Dashboard
                </button>
                <button class="nav-tab" onclick="showView('solicitudes')" data-view="solicitudes">
                    üìã Solicitudes (<span id="total-count">-</span>)
                </button>
                <button class="nav-tab" onclick="showView('asignacion')" data-view="asignacion">
                    üë®‚Äçüîß Asignaci√≥n (<span id="pending-assignment-count">-</span>)
                </button>
                <button class="nav-tab" onclick="showView('tiempos')" data-view="tiempos">
                    ‚è±Ô∏è Tiempos de Respuesta
                </button>
                <button class="nav-tab" onclick="showView('personal')" data-view="personal">
                    üë• Personal (<span id="total-technicians-nav">-</span>)
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-layout container">
        <!-- Dashboard View -->
        <div id="dashboard-view" class="view">
            <!-- Alert de conexi√≥n -->
            <div id="connection-alert" class="alert alert-info">
                <h3 style="font-weight: 600; margin-bottom: 0.5rem;">üåê Sistema Cloud Conectado</h3>
                <p>Portal de Gesti√≥n funcionando con <strong>Airtable</strong> como base de datos en la nube.</p>
                <ul style="margin: 0.5rem 0 0 1rem;">
                    <li><strong>‚úÖ Numeraci√≥n Autom√°tica:</strong> SOLBIO, SOLMEC, SOLINFRA</li>
                    <li><strong>üîÑ Asignaci√≥n Inteligente:</strong> Personal por √°rea especializada</li>
                    <li><strong>‚è±Ô∏è Tracking de Tiempos:</strong> M√©tricas de respuesta en tiempo real</li>
                    <li><strong>üåç Acceso Multi-dispositivo:</strong> Sincronizaci√≥n autom√°tica</li>
                </ul>
            </div>

            <!-- Metrics por √Årea de Ingenier√≠a -->
            <div class="metrics-grid">
                <div class="metric-card total" onclick="filterByArea('all')">
                    <div class="metric-icon">üìã</div>
                    <div class="metric-number" id="metric-total">-</div>
                    <div class="metric-label">Total Solicitudes</div>
                </div>
                <div class="metric-card biomedica" onclick="filterByArea('INGENIERIA_BIOMEDICA')">
                    <div class="metric-icon">üè•</div>
                    <div class="metric-number" id="metric-biomedica">-</div>
                    <div class="metric-label">Ingenier√≠a Biom√©dica</div>
                </div>
                <div class="metric-card mecanica" onclick="filterByArea('MECANICA')">
                    <div class="metric-icon">‚öôÔ∏è</div>
                    <div class="metric-number" id="metric-mecanica">-</div>
                    <div class="metric-label">Mec√°nica</div>
                </div>
                <div class="metric-card infraestructura" onclick="filterByArea('INFRAESTRUCTURA')">
                    <div class="metric-icon">üèóÔ∏è</div>
                    <div class="metric-number" id="metric-infraestructura">-</div>
                    <div class="metric-label">Infraestructura</div>
                </div>
                <div class="metric-card pendientes" onclick="filterByStatus('PENDIENTE')">
                    <div class="metric-icon">‚è≥</div>
                    <div class="metric-number" id="metric-pendientes">-</div>
                    <div class="metric-label">Sin Asignar</div>
                </div>
            </div>

            <!-- Estad√≠sticas de Tiempo -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚è±Ô∏è Estad√≠sticas de Tiempo de Respuesta</h2>
                </div>
                <div class="card-content">
                    <div class="tiempo-stats">
                        <div class="tiempo-stat tiempo-promedio">
                            <div class="tiempo-stat-number" id="tiempo-promedio-general">-</div>
                            <div class="tiempo-stat-label">Tiempo Promedio</div>
                        </div>
                        <div class="tiempo-stat tiempo-min">
                            <div class="tiempo-stat-number" id="tiempo-min-general">-</div>
                            <div class="tiempo-stat-label">Tiempo M√≠nimo</div>
                        </div>
                        <div class="tiempo-stat tiempo-max">
                            <div class="tiempo-stat-number" id="tiempo-max-general">-</div>
                            <div class="tiempo-stat-label">Tiempo M√°ximo</div>
                        </div>
                        <div class="tiempo-stat tiempo-promedio">
                            <div class="tiempo-stat-number" id="solicitudes-vencidas">-</div>
                            <div class="tiempo-stat-label">Solicitudes Vencidas</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de Solicitudes -->
        <div id="solicitudes-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìã Gesti√≥n de Solicitudes (Cloud)</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="refreshFromCloud()">
                            üîÑ Actualizar desde Airtable
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="autoAssignPending()">
                            ü§ñ Auto-asignar Pendientes
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <!-- Filtros -->
                    <div class="filtros-section">
                        <h4 style="color: #1f2937; margin-bottom: 1rem;">üîç Filtros de Solicitudes</h4>
                        <div class="filtros-grid">
                            <div class="filtro-group">
                                <label class="filtro-label">√Årea:</label>
                                <select id="filtro-area" class="filtro-select" onchange="aplicarFiltros()">
                                    <option value="">Todas las √°reas</option>
                                    <option value="INGENIERIA_BIOMEDICA">Ingenier√≠a Biom√©dica</option>
                                    <option value="MECANICA">Mec√°nica</option>
                                    <option value="INFRAESTRUCTURA">Infraestructura</option>
                                </select>
                            </div>
                            <div class="filtro-group">
                                <label class="filtro-label">Estado:</label>
                                <select id="filtro-estado" class="filtro-select" onchange="aplicarFiltros()">
                                    <option value="">Todos los estados</option>
                                    <option value="PENDIENTE">Pendiente</option>
                                    <option value="ASIGNADA">Asignada</option>
                                    <option value="EN_PROCESO">En Proceso</option>
                                    <option value="COMPLETADA">Completada</option>
                                </select>
                            </div>
                            <div class="filtro-group">
                                <label class="filtro-label">Prioridad:</label>
                                <select id="filtro-prioridad" class="filtro-select" onchange="aplicarFiltros()">
                                    <option value="">Todas las prioridades</option>
                                    <option value="CRITICA">Cr√≠tica</option>
                                    <option value="ALTA">Alta</option>
                                    <option value="MEDIA">Media</option>
                                    <option value="BAJA">Baja</option>
                                </select>
                            </div>
                            <div class="filtro-group">
                                <label class="filtro-label">B√∫squeda:</label>
                                <input type="text" id="filtro-busqueda" class="filtro-input" placeholder="Buscar por n√∫mero, equipo..." onkeyup="aplicarFiltros()">
                            </div>
                        </div>
                        <div class="filtros-actions">
                            <button class="btn btn-secondary btn-sm" onclick="limpiarFiltros()">
                                üóëÔ∏è Limpiar Filtros
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="mostrarSoloVencidas()">
                                ‚ö†Ô∏è Solo Vencidas
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="mostrarSoloSinAsignar()">
                                üë®‚Äçüîß Solo Sin Asignar
                            </button>
                        </div>
                    </div>

                    <div id="solicitudes-list">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando solicitudes desde Airtable...</h3>
                            <p>Conectando con la base de datos en la nube</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de Asignaci√≥n -->
        <div id="asignacion-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë®‚Äçüîß Centro de Asignaci√≥n</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="refreshAssignmentData()">
                            üîÑ Actualizar Datos
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="autoAssignByArea()">
                            üéØ Auto-asignar por √Årea
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="alert alert-info">
                        <h4 style="margin-bottom: 0.5rem;">üë®‚Äçüîß Centro de Asignaci√≥n Inteligente</h4>
                        <p>Asigna personal de soporte a solicitudes seg√∫n √°rea de especializaci√≥n y disponibilidad.</p>
                        <ul style="margin: 0.5rem 0 0 1rem;">
                            <li>‚úÖ Filtrado autom√°tico por √°rea de especializaci√≥n</li>
                            <li>üéØ Solo personal disponible para asignaci√≥n</li>
                            <li>‚è±Ô∏è Tracking de tiempos de respuesta</li>
                            <li>üîÑ Actualizaci√≥n autom√°tica de estados</li>
                        </ul>
                    </div>

                    <div id="assignment-container">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando solicitudes pendientes...</h3>
                            <p>Preparando centro de asignaci√≥n</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de Tiempos -->
        <div id="tiempos-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">‚è±Ô∏è An√°lisis de Tiempos de Respuesta</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="refreshTiemposData()">
                            üîÑ Actualizar Datos
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportarReporteTiempos()">
                            üìä Exportar Reporte
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="tiempos-analysis-container">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Analizando tiempos de respuesta...</h3>
                            <p>Generando m√©tricas desde Airtable</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista de Personal -->
        <div id="personal-view" class="view hidden">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Gesti√≥n de Personal de Soporte</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-success btn-sm" onclick="showAddPersonalModal()">
                            ‚ûï Agregar Personal
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="syncTechniciansWithCloud()">
                            üîÑ Sincronizar
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div id="technicians-container">
                        <div style="text-align: center; padding: 3rem; color: #6b7280;">
                            <div class="loading-spinner" style="margin: 0 auto 1rem;"></div>
                            <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Cargando personal...</h3>
                            <p>Conectando con Airtable</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Asignaci√≥n -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üë®‚Äçüîß Asignar Personal a Solicitud</h3>
                <button class="modal-close" onclick="closeAssignmentModal()">&times;</button>
            </div>
            <div id="assignment-modal-content">
                <!-- Contenido din√°mico del modal -->
            </div>
        </div>
    </div>

    <!-- Modal de Detalles -->
    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìã Detalles de Solicitud</h3>
                <button class="modal-close" onclick="closeDetailsModal()">&times;</button>
            </div>
            <div id="details-modal-content">
                <!-- Contenido din√°mico del modal -->
            </div>
        </div>
    </div>

    <!-- Incluir el archivo de configuraci√≥n de Airtable -->
    <script src="airtable-config.js"></script>

    <script>
        // Variables globales
        let cloudSolicitudes = [];
        let cloudTecnicos = [];
        let isConnectedToAirtable = false;
        let solicitudesFiltradas = [];

        // üî¢ SISTEMA DE NUMERACI√ìN AUTOM√ÅTICA
        class NumberingSystem {
            constructor() {
                this.counters = {
                    'INGENIERIA_BIOMEDICA': { prefix: 'SOLBIO', current: 0 },
                    'MECANICA': { prefix: 'SOLMEC', current: 0 },
                    'INFRAESTRUCTURA': { prefix: 'SOLINFRA', current: 0 }
                };
            }

            async loadCountersFromAirtable() {
                console.log('üî¢ Cargando contadores desde Airtable...');
                
                try {
                    // Obtener todas las solicitudes para determinar el siguiente n√∫mero
                    const solicitudes = await window.airtableAPI.getSolicitudes();
                    
                    // Analizar n√∫meros existentes por √°rea
                    Object.keys(this.counters).forEach(area => {
                        const prefix = this.counters[area].prefix;
                        const solicitudesArea = solicitudes.filter(s => 
                            s.servicioIngenieria === area && 
                            s.numero && 
                            s.numero.startsWith(prefix)
                        );
                        
                        if (solicitudesArea.length > 0) {
                            // Extraer n√∫meros y encontrar el m√°ximo
                            const numeros = solicitudesArea
                                .map(s => {
                                    const match = s.numero.match(new RegExp(`${prefix}(\\d+)`));
                                    return match ? parseInt(match[1]) : 0;
                                })
                                .filter(n => n > 0);
                            
                            this.counters[area].current = numeros.length > 0 ? Math.max(...numeros) : 0;
                        }
                        
                        console.log(`üìä ${area}: Siguiente n√∫mero ser√° ${this.counters[area].prefix}${String(this.counters[area].current + 1).padStart(5, '0')}`);
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error cargando contadores:', error);
                }
            }

            generateNumber(area) {
                if (!this.counters[area]) {
                    console.error('‚ùå √Årea no v√°lida para numeraci√≥n:', area);
                    return `SOL${Date.now()}`;
                }
                
                this.counters[area].current++;
                const numero = `${this.counters[area].prefix}${String(this.counters[area].current).padStart(5, '0')}`;
                
                console.log(`üî¢ N√∫mero generado para ${area}: ${numero}`);
                return numero;
            }

            getNextNumber(area) {
                if (!this.counters[area]) return 'SOL00001';
                return `${this.counters[area].prefix}${String(this.counters[area].current + 1).padStart(5, '0')}`;
            }
        }

        // ‚è±Ô∏è SISTEMA DE TIEMPO DE RESPUESTA
        class TimeTracker {
            constructor() {
                this.limitesTiempo = {
                    'CRITICA': 2 * 60 * 60 * 1000, // 2 horas
                    'ALTA': 4 * 60 * 60 * 1000,    // 4 horas
                    'MEDIA': 24 * 60 * 60 * 1000,  // 24 horas
                    'BAJA': 72 * 60 * 60 * 1000    // 72 horas
                };
            }

            calcularTiempoRespuesta(fechaCreacion, fechaAsignacion = null) {
                const inicio = new Date(fechaCreacion);
                const fin = fechaAsignacion ? new Date(fechaAsignacion) : new Date();
                return fin - inicio;
            }

            formatearTiempo(milliseconds) {
                const horas = Math.floor(milliseconds / (1000 * 60 * 60));
                const minutos = Math.floor((milliseconds % (1000 * 60 * 60)) / (1000 * 60));
                
                if (horas > 0) {
                    return `${horas}h ${minutos}m`;
                } else {
                    return `${minutos}m`;
                }
            }

            evaluarTiempo(milliseconds, prioridad) {
                const limite = this.limitesTiempo[prioridad] || this.limitesTiempo['MEDIA'];
                
                if (milliseconds > limite) {
                    return { status: 'urgente', mensaje: 'Tiempo excedido' };
                } else if (milliseconds > limite * 0.8) {
                    return { status: 'normal', mensaje: 'Pr√≥ximo a vencer' };
                } else {
                    return { status: 'rapido', mensaje: 'Dentro del tiempo' };
                }
            }

            generarEstadisticas(solicitudes) {
                const tiempos = solicitudes
                    .filter(s => s.fechaCreacion && s.fechaAsignacion)
                    .map(s => this.calcularTiempoRespuesta(s.fechaCreacion, s.fechaAsignacion));

                if (tiempos.length === 0) {
                    return {
                        promedio: 0,
                        minimo: 0,
                        maximo: 0,
                        vencidas: 0
                    };
                }

                const promedio = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
                const minimo = Math.min(...tiempos);
                const maximo = Math.max(...tiempos);
                
                const vencidas = solicitudes.filter(s => {
                    if (!s.fechaCreacion || s.estado === 'COMPLETADA') return false;
                    const tiempo = this.calcularTiempoRespuesta(s.fechaCreacion);
                    const limite = this.limitesTiempo[s.prioridad] || this.limitesTiempo['MEDIA'];
                    return tiempo > limite;
                }).length;

                return {
                    promedio: this.formatearTiempo(promedio),
                    minimo: this.formatearTiempo(minimo),
                    maximo: this.formatearTiempo(maximo),
                    vencidas: vencidas
                };
            }
        }

        // Instancias globales
        const numberingSystem = new NumberingSystem();
        const timeTracker = new TimeTracker();

        // üîó Funciones de conexi√≥n
        function updateConnectionStatus(status, message) {
            const statusDiv = document.getElementById('connection-status');
            const iconSpan = document.getElementById('connection-icon');
            const textSpan = document.getElementById('connection-text');
            
            statusDiv.className = `connection-status ${status}`;
            
            switch(status) {
                case 'connected':
                    iconSpan.textContent = 'üü¢';
                    textSpan.textContent = 'Airtable Conectado';
                    isConnectedToAirtable = true;
                    break;
                case 'disconnected':
                    iconSpan.textContent = 'üî¥';
                    textSpan.textContent = 'Sin conexi√≥n';
                    isConnectedToAirtable = false;
                    break;
                default:
                    iconSpan.textContent = 'üîÑ';
                    textSpan.textContent = message || 'Conectando...';
            }
        }

        // üîÑ Carga de datos desde Airtable
        async function loadAllDataFromCloud() {
            console.log('üåê Cargando datos desde Airtable...');
            
            try {
                updateConnectionStatus('connecting', 'Sincronizando...');
                
                // Cargar contadores de numeraci√≥n
                await numberingSystem.loadCountersFromAirtable();
                
                // Cargar datos en paralelo
                const [solicitudes, tecnicos] = await Promise.all([
                    window.airtableAPI.getSolicitudes(),
                    window.airtableAPI.getTecnicos()
                ]);
                
                cloudSolicitudes = solicitudes;
                cloudTecnicos = tecnicos;
                solicitudesFiltradas = [...cloudSolicitudes];
                
                console.log(`‚úÖ Datos cargados: ${solicitudes.length} solicitudes, ${tecnicos.length} personal`);
                
                // Actualizar interfaz
                updateAllCounters();
                updateAllDisplays();
                updateConnectionStatus('connected');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                updateConnectionStatus('disconnected');
                loadDataFromLocalStorage();
            }
        }

        function loadDataFromLocalStorage() {
            console.log('üì± Cargando datos desde localStorage...');
            
            try {
                const localSolicitudes = JSON.parse(localStorage.getItem('hospital_solicitudes') || '[]');
                const localTechnicians = JSON.parse(localStorage.getItem('hospital_technicians') || '{}');
                
                cloudTecnicos = [];
                Object.entries(localTechnicians).forEach(([area, tecnicosArea]) => {
                    tecnicosArea.forEach(tecnico => {
                        cloudTecnicos.push({ ...tecnico, area: area });
                    });
                });
                
                cloudSolicitudes = localSolicitudes;
                solicitudesFiltradas = [...cloudSolicitudes];
                
                updateAllCounters();
                updateAllDisplays();
                
                console.log('‚úÖ Datos cargados desde localStorage');
                
            } catch (error) {
                console.error('‚ùå Error cargando desde localStorage:', error);
                cloudSolicitudes = [];
                cloudTecnicos = [];
                solicitudesFiltradas = [];
            }
        }

        // üìä Actualizar contadores
        function updateAllCounters() {
            const total = cloudSolicitudes.length;
            const biomedica = cloudSolicitudes.filter(r => r.servicioIngenieria === 'INGENIERIA_BIOMEDICA').length;
            const mecanica = cloudSolicitudes.filter(r => r.servicioIngenieria === 'MECANICA').length;
            const infraestructura = cloudSolicitudes.filter(r => r.servicioIngenieria === 'INFRAESTRUCTURA').length;
            const pendientes = cloudSolicitudes.filter(r => r.estado === 'PENDIENTE' || !r.tecnicoAsignado).length;

            document.getElementById('metric-total').textContent = total;
            document.getElementById('metric-biomedica').textContent = biomedica;
            document.getElementById('metric-mecanica').textContent = mecanica;
            document.getElementById('metric-infraestructura').textContent = infraestructura;
            document.getElementById('metric-pendientes').textContent = pendientes;
            document.getElementById('total-count').textContent = total;
            document.getElementById('pending-assignment-count').textContent = pendientes;

            const totalTechnicians = cloudTecnicos.length;
            document.getElementById('total-technicians-nav').textContent = totalTechnicians;

            // Actualizar estad√≠sticas de tiempo
            const stats = timeTracker.generarEstadisticas(cloudSolicitudes);
            document.getElementById('tiempo-promedio-general').textContent = stats.promedio;
            document.getElementById('tiempo-min-general').textContent = stats.minimo;
            document.getElementById('tiempo-max-general').textContent = stats.maximo;
            document.getElementById('solicitudes-vencidas').textContent = stats.vencidas;

            console.log(`üìä Contadores actualizados: ${total} solicitudes, ${pendientes} pendientes`);
        }

        function updateAllDisplays() {
            updateSolicitudesList();
            updateAssignmentContainer();
            updateTiemposAnalysis();
            updateTechniciansList();
        }

        // üìã Actualizar lista de solicitudes
        function updateSolicitudesList() {
            const container = document.getElementById('solicitudes-list');
            
            if (solicitudesFiltradas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üìã</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay solicitudes que coincidan</h3>
                        <p>Ajusta los filtros o crea nuevas solicitudes desde el Portal de Solicitudes</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">‚úÖ ${solicitudesFiltradas.length} de ${cloudSolicitudes.length} Solicitudes</h4>
                        <p style="color: #047857; font-size: 0.875rem;">Datos sincronizados desde Airtable - ${new Date().toLocaleTimeString('es-CO')}</p>
                    </div>
                    ${solicitudesFiltradas.map(solicitud => createSolicitudCard(solicitud)).join('')}
                `;
            }
        }

        // üé® Crear tarjeta de solicitud
        function createSolicitudCard(solicitud) {
            const estado = solicitud.estado || 'PENDIENTE';
            const prioridad = solicitud.prioridad || 'MEDIA';
            
            // Calcular tiempo de respuesta
            const tiempoRespuesta = timeTracker.calcularTiempoRespuesta(
                solicitud.fechaCreacion, 
                solicitud.fechaAsignacion
            );
            const evaluacionTiempo = timeTracker.evaluarTiempo(tiempoRespuesta, prioridad);
            
            // Determinar clases CSS
            const cardClass = `solicitud-card ${estado.toLowerCase().replace('_', '-')} ${prioridad === 'CRITICA' ? 'urgente' : ''}`;
            const badgeEstado = `badge badge-${estado.toLowerCase().replace('_', '-')}`;
            const badgePrioridad = `badge badge-${prioridad.toLowerCase()}`;

            return `
                <div class="${cardClass}">
                    <div class="solicitud-header">
                        <div class="solicitud-numero">${solicitud.numero || 'SIN N√öMERO'}</div>
                        <div class="solicitud-badges">
                            <span class="${badgeEstado}">${estado}</span>
                            <span class="${badgePrioridad}">${prioridad}</span>
                            ${solicitud.servicioIngenieria ? `<span class="badge" style="background: #e0f2fe; color: #0369a1;">${getAreaName(solicitud.servicioIngenieria)}</span>` : ''}
                        </div>
                    </div>

                    <div class="tiempo-respuesta ${evaluacionTiempo.status}">
                        <span>‚è±Ô∏è</span>
                        <span><strong>Tiempo:</strong> ${timeTracker.formatearTiempo(tiempoRespuesta)}</span>
                        <span>‚Ä¢</span>
                        <span>${evaluacionTiempo.mensaje}</span>
                    </div>

                    <div class="solicitud-details">
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üîß Tipo de Servicio</div>
                            <div class="solicitud-detail-value">${solicitud.tipoServicio?.replace('_', ' ') || 'No especificado'}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üñ•Ô∏è Equipo</div>
                            <div class="solicitud-detail-value">${solicitud.equipo || 'No especificado'}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üìç Ubicaci√≥n</div>
                            <div class="solicitud-detail-value">${solicitud.ubicacion || 'No especificado'}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üë§ Solicitante</div>
                            <div class="solicitud-detail-value">${solicitud.solicitante || 'No especificado'}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üë®‚Äçüîß T√©cnico Asignado</div>
                            <div class="solicitud-detail-value">${solicitud.tecnicoAsignado || '<span style="color: #f59e0b;">Sin asignar</span>'}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üìÖ Fecha Creaci√≥n</div>
                            <div class="solicitud-detail-value">${solicitud.fechaCreacion ? new Date(solicitud.fechaCreacion).toLocaleString('es-CO') : 'No disponible'}</div>
                        </div>
                    </div>

                    ${solicitud.descripcion ? `
                        <div class="solicitud-descripcion">
                            <div class="solicitud-detail-label">üìù Descripci√≥n del Problema</div>
                            <div style="margin-top: 0.5rem; color: #1f2937;">${solicitud.descripcion}</div>
                        </div>
                    ` : ''}

                    <div class="solicitud-actions">
                        <button class="btn btn-primary" onclick="showAssignmentModal('${solicitud.id}')">
                            üë®‚Äçüîß ${solicitud.tecnicoAsignado ? 'Reasignar' : 'Asignar'} Personal
                        </button>
                        <button class="btn btn-secondary" onclick="showDetailsModal('${solicitud.id}')">
                            üëÅÔ∏è Ver Detalles
                        </button>
                        <button class="btn btn-warning" onclick="updateSolicitudStatus('${solicitud.id}', 'EN_PROCESO')">
                            ‚ñ∂Ô∏è Marcar En Proceso
                        </button>
                        <button class="btn btn-success" onclick="updateSolicitudStatus('${solicitud.id}', 'COMPLETADA')">
                            ‚úÖ Marcar Completada
                        </button>
                    </div>
                </div>
            `;
        }

        // üéØ Centro de asignaci√≥n
        function updateAssignmentContainer() {
            const container = document.getElementById('assignment-container');
            const pendientes = cloudSolicitudes.filter(s => s.estado === 'PENDIENTE' || !s.tecnicoAsignado);
            
            if (pendientes.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">‚úÖ</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">Todas las solicitudes est√°n asignadas</h3>
                        <p>No hay solicitudes pendientes de asignaci√≥n en este momento</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="background: #fef3c7; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="color: #d97706; margin-bottom: 0.5rem;">‚è≥ ${pendientes.length} Solicitudes Sin Asignar</h4>
                        <p style="color: #b45309; font-size: 0.875rem;">Asigna personal especializado para optimizar tiempos de respuesta</p>
                    </div>
                    ${pendientes.map(solicitud => createAssignmentCard(solicitud)).join('')}
                `;
            }
        }

        function createAssignmentCard(solicitud) {
            const tiempoRespuesta = timeTracker.calcularTiempoRespuesta(solicitud.fechaCreacion);
            const evaluacionTiempo = timeTracker.evaluarTiempo(tiempoRespuesta, solicitud.prioridad);
            
            // Filtrar personal disponible por √°rea
            const personalDisponible = cloudTecnicos.filter(t => 
                t.area === solicitud.servicioIngenieria && 
                t.estado === 'disponible'
            );

            return `
                <div class="solicitud-card pendiente">
                    <div class="solicitud-header">
                        <div class="solicitud-numero">${solicitud.numero}</div>
                        <div class="solicitud-badges">
                            <span class="badge badge-${solicitud.prioridad?.toLowerCase() || 'media'}">${solicitud.prioridad || 'MEDIA'}</span>
                            <span class="badge" style="background: #e0f2fe; color: #0369a1;">${getAreaName(solicitud.servicioIngenieria)}</span>
                        </div>
                    </div>

                    <div class="tiempo-respuesta ${evaluacionTiempo.status}">
                        <span>‚è±Ô∏è</span>
                        <span><strong>Sin asignar por:</strong> ${timeTracker.formatearTiempo(tiempoRespuesta)}</span>
                        <span>‚Ä¢</span>
                        <span>${evaluacionTiempo.mensaje}</span>
                    </div>

                    <div class="solicitud-details">
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üñ•Ô∏è Equipo</div>
                            <div class="solicitud-detail-value">${solicitud.equipo}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üìç Ubicaci√≥n</div>
                            <div class="solicitud-detail-value">${solicitud.ubicacion}</div>
                        </div>
                        <div class="solicitud-detail">
                            <div class="solicitud-detail-label">üë§ Solicitante</div>
                            <div class="solicitud-detail-value">${solicitud.solicitante}</div>
                        </div>
                    </div>

                    <div class="asignacion-section">
                        <h5 style="color: #1f2937; margin-bottom: 0.75rem;">
                            üë®‚Äçüîß Personal Disponible (${personalDisponible.length})
                        </h5>
                        
                        ${personalDisponible.length === 0 ? `
                            <div style="text-align: center; padding: 1rem; background: #fee2e2; border-radius: 0.5rem; color: #dc2626;">
                                ‚ùå No hay personal disponible en ${getAreaName(solicitud.servicioIngenieria)}
                            </div>
                        ` : `
                            <div class="personal-selector">
                                ${personalDisponible.map(personal => `
                                    <div class="personal-option" onclick="selectPersonal('${solicitud.id}', '${personal.id}', this)">
                                        <div style="font-weight: 600; color: #1f2937;">${personal.nombre}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280;">${personal.tipo} ‚Ä¢ ${personal.especialidad || 'General'}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div style="margin-top: 1rem; text-align: center;">
                                <button class="btn btn-success" onclick="assignSelectedPersonal('${solicitud.id}')" id="assign-btn-${solicitud.id}" disabled>
                                    ‚úÖ Confirmar Asignaci√≥n
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // üìä An√°lisis de tiempos
        function updateTiemposAnalysis() {
            const container = document.getElementById('tiempos-analysis-container');
            
            // Generar estad√≠sticas por √°rea
            const areas = ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'];
            let html = '';

            areas.forEach(area => {
                const solicitudesArea = cloudSolicitudes.filter(s => s.servicioIngenieria === area);
                const stats = timeTracker.generarEstadisticas(solicitudesArea);
                const areaName = getAreaName(area);
                
                html += `
                    <div class="card" style="margin-bottom: 1rem;">
                        <div class="card-header">
                            <h3 class="card-title">${getAreaIcon(area)} ${areaName}</h3>
                            <span style="background: #e0f2fe; color: #0369a1; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600;">
                                ${solicitudesArea.length} solicitudes
                            </span>
                        </div>
                        <div class="card-content">
                            <div class="tiempo-stats">
                                <div class="tiempo-stat tiempo-promedio">
                                    <div class="tiempo-stat-number">${stats.promedio}</div>
                                    <div class="tiempo-stat-label">Tiempo Promedio</div>
                                </div>
                                <div class="tiempo-stat tiempo-min">
                                    <div class="tiempo-stat-number">${stats.minimo}</div>
                                    <div class="tiempo-stat-label">Tiempo M√≠nimo</div>
                                </div>
                                <div class="tiempo-stat tiempo-max">
                                    <div class="tiempo-stat-number">${stats.maximo}</div>
                                    <div class="tiempo-stat-label">Tiempo M√°ximo</div>
                                </div>
                                <div class="tiempo-stat tiempo-max">
                                    <div class="tiempo-stat-number">${stats.vencidas}</div>
                                    <div class="tiempo-stat-label">Vencidas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // üõ†Ô∏è Funciones de utilidad
        function getAreaName(area) {
            const areas = {
                'INGENIERIA_BIOMEDICA': 'Ingenier√≠a Biom√©dica',
                'MECANICA': 'Mec√°nica',
                'INFRAESTRUCTURA': 'Infraestructura'
            };
            return areas[area] || area;
        }

        function getAreaIcon(area) {
            const icons = {
                'INGENIERIA_BIOMEDICA': 'üè•',
                'MECANICA': '‚öôÔ∏è',
                'INFRAESTRUCTURA': 'üèóÔ∏è'
            };
            return icons[area] || 'üîß';
        }

        // üéØ Funciones de asignaci√≥n
        let selectedPersonalId = null;

        function selectPersonal(solicitudId, personalId, element) {
            // Limpiar selecciones previas
            const container = element.closest('.asignacion-section');
            container.querySelectorAll('.personal-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Seleccionar nuevo
            element.classList.add('selected');
            selectedPersonalId = personalId;
            
            // Habilitar bot√≥n
            const assignBtn = document.getElementById(`assign-btn-${solicitudId}`);
            if (assignBtn) {
                assignBtn.disabled = false;
            }
        }

        async function assignSelectedPersonal(solicitudId) {
            if (!selectedPersonalId) {
                alert('‚ùå Seleccione un t√©cnico primero');
                return;
            }

            try {
                const assignBtn = document.getElementById(`assign-btn-${solicitudId}`);
                if (assignBtn) {
                    assignBtn.disabled = true;
                    assignBtn.innerHTML = '‚è≥ Asignando...';
                }

                // Usar m√©todo de asignaci√≥n de airtable-config.js
                const result = await window.airtableAPI.asignarTecnicoASolicitud(solicitudId, selectedPersonalId);
                
                if (result.success) {
                    alert(`‚úÖ Personal asignado exitosamente\n\nüë®‚Äçüîß T√©cnico: ${result.tecnico.nombre}\nüìã Solicitud: ${solicitudId}\n‚è±Ô∏è Asignado: ${new Date().toLocaleTimeString('es-CO')}`);
                    
                    // Recargar datos
                    await loadAllDataFromCloud();
                } else {
                    throw new Error('Error en la asignaci√≥n');
                }

            } catch (error) {
                console.error('‚ùå Error asignando personal:', error);
                alert('‚ùå Error al asignar personal: ' + error.message);
            } finally {
                selectedPersonalId = null;
            }
        }

        // üîÑ Funciones de actualizaci√≥n
        async function refreshFromCloud() {
            try {
                await loadAllDataFromCloud();
                alert('‚úÖ Datos actualizados desde Airtable');
            } catch (error) {
                alert('‚ùå Error actualizando datos');
            }
        }

        async function refreshAssignmentData() {
            await refreshFromCloud();
        }

        async function refreshTiemposData() {
            await refreshFromCloud();
        }

        // üéõÔ∏è Funciones de filtrado
        function aplicarFiltros() {
            const area = document.getElementById('filtro-area')?.value || '';
            const estado = document.getElementById('filtro-estado')?.value || '';
            const prioridad = document.getElementById('filtro-prioridad')?.value || '';
            const busqueda = document.getElementById('filtro-busqueda')?.value.toLowerCase() || '';

            solicitudesFiltradas = cloudSolicitudes.filter(solicitud => {
                const cumpleArea = !area || solicitud.servicioIngenieria === area;
                const cumpleEstado = !estado || solicitud.estado === estado;
                const cumplePrioridad = !prioridad || solicitud.prioridad === prioridad;
                const cumpleBusqueda = !busqueda || 
                    (solicitud.numero && solicitud.numero.toLowerCase().includes(busqueda)) ||
                    (solicitud.equipo && solicitud.equipo.toLowerCase().includes(busqueda)) ||
                    (solicitud.ubicacion && solicitud.ubicacion.toLowerCase().includes(busqueda)) ||
                    (solicitud.solicitante && solicitud.solicitante.toLowerCase().includes(busqueda));

                return cumpleArea && cumpleEstado && cumplePrioridad && cumpleBusqueda;
            });

            updateSolicitudesList();
        }

        function limpiarFiltros() {
            document.getElementById('filtro-area').value = '';
            document.getElementById('filtro-estado').value = '';
            document.getElementById('filtro-prioridad').value = '';
            document.getElementById('filtro-busqueda').value = '';
            aplicarFiltros();
        }

        function mostrarSoloVencidas() {
            solicitudesFiltradas = cloudSolicitudes.filter(solicitud => {
                if (solicitud.estado === 'COMPLETADA') return false;
                const tiempo = timeTracker.calcularTiempoRespuesta(solicitud.fechaCreacion);
                const limite = timeTracker.limitesTiempo[solicitud.prioridad] || timeTracker.limitesTiempo['MEDIA'];
                return tiempo > limite;
            });
            updateSolicitudesList();
        }

        function mostrarSoloSinAsignar() {
            solicitudesFiltradas = cloudSolicitudes.filter(s => s.estado === 'PENDIENTE' || !s.tecnicoAsignado);
            updateSolicitudesList();
        }

        // üéÆ Funciones de navegaci√≥n
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.add('hidden'));
            document.getElementById(viewName + '-view').classList.remove('hidden');
            
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
        }

        // üöÄ Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Portal de Gesti√≥n Mejorado - Hospital Susana L√≥pez de Valencia');
            
            // Esperar a que airtable-config.js se cargue
            setTimeout(async () => {
                if (window.airtableAPI) {
                    console.log('üîó Conectando con Airtable...');
                    await loadAllDataFromCloud();
                } else {
                    console.error('‚ùå No se pudo cargar airtable-config.js');
                    updateConnectionStatus('disconnected');
                    loadDataFromLocalStorage();
                }
            }, 1000);
        });

        // ü§ñ FUNCIONES DE AUTO-ASIGNACI√ìN
        async function autoAssignPending() {
            try {
                const confirmed = confirm('ü§ñ ¬øEjecutar auto-asignaci√≥n inteligente?\n\nEsto asignar√° autom√°ticamente las solicitudes pendientes al personal disponible seg√∫n su √°rea de especializaci√≥n.');
                if (!confirmed) return;

                const result = await window.airtableAPI.autoAsignarSolicitudesPendientes();
                
                if (result.success) {
                    let mensaje = `ü§ñ AUTO-ASIGNACI√ìN COMPLETADA\n\n`;
                    mensaje += `‚úÖ Asignaciones exitosas: ${result.asignacionesExitosas}\n`;
                    mensaje += `‚ùå Asignaciones fallidas: ${result.asignacionesFallidas}\n`;
                    mensaje += `üìã Total procesadas: ${result.totalProcesadas}\n\n`;
                    
                    if (result.resultados.length > 0) {
                        mensaje += `üìä DETALLES:\n`;
                        result.resultados.slice(0, 5).forEach(r => {
                            if (r.status === 'exitosa') {
                                mensaje += `‚Ä¢ ${r.solicitud} ‚Üí ${r.tecnico} ‚úÖ\n`;
                            } else {
                                mensaje += `‚Ä¢ ${r.solicitud} ‚Üí ${r.error} ‚ùå\n`;
                            }
                        });
                        
                        if (result.resultados.length > 5) {
                            mensaje += `... y ${result.resultados.length - 5} m√°s\n`;
                        }
                    }
                    
                    alert(mensaje);
                    
                    // Recargar datos
                    await loadAllDataFromCloud();
                } else {
                    alert(`‚ùå Error en auto-asignaci√≥n: ${result.error}`);
                }
                
            } catch (error) {
                console.error('‚ùå Error en auto-asignaci√≥n:', error);
                alert('‚ùå Error ejecutando auto-asignaci√≥n: ' + error.message);
            }
        }

        async function autoAssignByArea() {
            try {
                const area = prompt('üéØ Seleccione el √°rea para auto-asignaci√≥n:\n\n1. INGENIERIA_BIOMEDICA\n2. MECANICA\n3. INFRAESTRUCTURA\n\nIngrese el nombre del √°rea:');
                
                if (!area) return;
                
                const areasValidas = ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'];
                if (!areasValidas.includes(area)) {
                    alert('‚ùå √Årea no v√°lida. Use: INGENIERIA_BIOMEDICA, MECANICA, o INFRAESTRUCTURA');
                    return;
                }
                
                // Filtrar solicitudes por √°rea
                const solicitudesPendientes = cloudSolicitudes.filter(s => 
                    (s.estado === 'PENDIENTE' || !s.tecnicoAsignado) && 
                    s.servicioIngenieria === area
                );
                
                if (solicitudesPendientes.length === 0) {
                    alert(`‚ÑπÔ∏è No hay solicitudes pendientes en ${getAreaName(area)}`);
                    return;
                }
                
                const tecnicosDisponibles = await window.airtableAPI.getTecnicosDisponibles(area);
                
                if (tecnicosDisponibles.length === 0) {
                    alert(`‚ùå No hay t√©cnicos disponibles en ${getAreaName(area)}`);
                    return;
                }
                
                const confirmed = confirm(`üéØ Auto-asignar ${solicitudesPendientes.length} solicitudes de ${getAreaName(area)} a ${tecnicosDisponibles.length} t√©cnicos disponibles?`);
                if (!confirmed) return;
                
                let asignacionesExitosas = 0;
                let asignacionesFallidas = 0;
                
                for (let i = 0; i < solicitudesPendientes.length && i < tecnicosDisponibles.length; i++) {
                    try {
                        const resultado = await window.airtableAPI.asignarTecnicoASolicitud(
                            solicitudesPendientes[i].id, 
                            tecnicosDisponibles[i].id
                        );
                        
                        if (resultado.success) {
                            asignacionesExitosas++;
                        } else {
                            asignacionesFallidas++;
                        }
                    } catch (error) {
                        asignacionesFallidas++;
                    }
                }
                
                alert(`üéØ Auto-asignaci√≥n por √°rea completada\n\n‚úÖ Exitosas: ${asignacionesExitosas}\n‚ùå Fallidas: ${asignacionesFallidas}\nüè• √Årea: ${getAreaName(area)}`);
                
                await loadAllDataFromCloud();
                
            } catch (error) {
                console.error('‚ùå Error en auto-asignaci√≥n por √°rea:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        // üë• GESTI√ìN DE PERSONAL DE SOPORTE
        function updateTechniciansList() {
            const container = document.getElementById('technicians-container');
            
            if (cloudTecnicos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #6b7280;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üë•</div>
                        <h3 style="color: #1f2937; margin-bottom: 0.5rem;">No hay personal de soporte registrado</h3>
                        <p>El personal de soporte aparecer√° aqu√≠ cuando se agregue</p>
                        <button class="btn btn-success" onclick="showAddPersonalModal()" style="margin-top: 1rem;">
                            ‚ûï Agregar Primer Personal
                        </button>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div style="background: #f0fdf4; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="color: #059669; margin-bottom: 0.5rem;">‚úÖ ${cloudTecnicos.length} Personal de Soporte Total</h4>
                        <p style="color: #047857; font-size: 0.875rem;">Personal de soporte sincronizado desde la nube</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1rem;">
                        ${cloudTecnicos.map(personal => createPersonalCard(personal)).join('')}
                    </div>
                `;
            }
        }

        function createPersonalCard(personal) {
            const getStatusColor = (estado) => {
                const colors = {
                    'disponible': { bg: '#dcfce7', color: '#166534', icon: 'üü¢' },
                    'ocupado': { bg: '#fef3c7', color: '#d97706', icon: 'üü°' },
                    'inactivo': { bg: '#fee2e2', color: '#dc2626', icon: 'üî¥' }
                };
                return colors[estado] || colors['disponible'];
            };

            const getAreaInfo = (area) => {
                const areas = {
                    'INGENIERIA_BIOMEDICA': { name: 'Ing. Biom√©dica', icon: 'üè•', color: '#059669' },
                    'MECANICA': { name: 'Mec√°nica', icon: '‚öôÔ∏è', color: '#f59e0b' },
                    'INFRAESTRUCTURA': { name: 'Infraestructura', icon: 'üèóÔ∏è', color: '#8b5cf6' }
                };
                return areas[area] || { name: area, icon: 'üîß', color: '#6b7280' };
            };

            const statusColor = getStatusColor(personal.estado);
            const areaInfo = getAreaInfo(personal.area);

            return `
                <div style="background: white; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s; position: relative; border-left: 4px solid ${areaInfo.color};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <h4 style="color: #1f2937; margin-bottom: 0.5rem; font-size: 1.125rem; font-weight: 600;">
                                ${personal.nombre}
                            </h4>
                            <p style="color: #6b7280; font-size: 0.875rem; margin: 0;">
                                ${areaInfo.icon} ${areaInfo.name}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <span style="background: ${statusColor.bg}; color: ${statusColor.color}; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">
                                ${statusColor.icon} ${personal.estado}
                            </span>
                        </div>
                    </div>

                    <div style="display: grid; gap: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #6b7280; font-weight: 600;">üìß Email:</span>
                            <span style="color: #1f2937;">${personal.email}</span>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="color: #6b7280; font-weight: 600;">üë®‚Äçüíº Tipo:</span>
                            <span style="color: #1f2937;">${personal.tipo}</span>
                        </div>
                        
                        ${personal.especialidad ? `
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="color: #6b7280; font-weight: 600;">‚öôÔ∏è Especialidad:</span>
                                <span style="color: #1f2937;">${personal.especialidad}</span>
                            </div>
                        ` : ''}
                    </div>

                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-sm" onclick="editPersonal('${personal.id}')">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="btn btn-${personal.estado === 'disponible' ? 'warning' : 'success'} btn-sm" onclick="togglePersonalStatus('${personal.id}')">
                            ${personal.estado === 'disponible' ? '‚è∏Ô∏è Ocupar' : '‚ñ∂Ô∏è Liberar'}
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="viewPersonalWorkload('${personal.id}')">
                            üìä Carga
                        </button>
                    </div>
                </div>
            `;
        }

        async function viewPersonalWorkload(personalId) {
            try {
                const personal = cloudTecnicos.find(p => p.id === personalId);
                if (!personal) {
                    alert('‚ùå Personal no encontrado');
                    return;
                }

                // Obtener solicitudes asignadas al personal
                const solicitudesAsignadas = cloudSolicitudes.filter(s => 
                    s.tecnicoAsignadoId === personalId || 
                    s.tecnicoAsignado === personal.nombre
                );

                const activas = solicitudesAsignadas.filter(s => s.estado !== 'COMPLETADA');
                const completadas = solicitudesAsignadas.filter(s => s.estado === 'COMPLETADA');

                let mensaje = `üìä CARGA DE TRABAJO\n\n`;
                mensaje += `üë§ Personal: ${personal.nombre}\n`;
                mensaje += `üè• √Årea: ${getAreaName(personal.area)}\n`;
                mensaje += `üìä Estado: ${personal.estado}\n\n`;
                mensaje += `üìã SOLICITUDES:\n`;
                mensaje += `‚Ä¢ Total asignadas: ${solicitudesAsignadas.length}\n`;
                mensaje += `‚Ä¢ Activas: ${activas.length}\n`;
                mensaje += `‚Ä¢ Completadas: ${completadas.length}\n\n`;

                if (activas.length > 0) {
                    mensaje += `üîÑ SOLICITUDES ACTIVAS:\n`;
                    activas.slice(0, 5).forEach(s => {
                        mensaje += `‚Ä¢ ${s.numero} - ${s.estado} - ${s.prioridad || 'MEDIA'}\n`;
                    });
                    if (activas.length > 5) {
                        mensaje += `... y ${activas.length - 5} m√°s\n`;
                    }
                }

                alert(mensaje);

            } catch (error) {
                console.error('‚ùå Error obteniendo carga de trabajo:', error);
                alert('‚ùå Error obteniendo carga de trabajo: ' + error.message);
            }
        }

        async function editPersonal(personalId) {
            // Implementaci√≥n b√°sica - puede expandirse
            const personal = cloudTecnicos.find(p => p.id === personalId);
            if (!personal) {
                alert('‚ùå Personal no encontrado');
                return;
            }

            const nuevoEstado = prompt(`üîÑ Cambiar estado de ${personal.nombre}:\n\n1. disponible\n2. ocupado\n3. inactivo\n\nEstado actual: ${personal.estado}\nIngrese nuevo estado:`);
            
            if (!nuevoEstado) return;

            const estadosValidos = ['disponible', 'ocupado', 'inactivo'];
            if (!estadosValidos.includes(nuevoEstado)) {
                alert('‚ùå Estado no v√°lido. Use: disponible, ocupado, o inactivo');
                return;
            }

            try {
                await window.airtableAPI.updateTecnico(personalId, { estado: nuevoEstado });
                alert(`‚úÖ Estado actualizado a: ${nuevoEstado}`);
                await loadAllDataFromCloud();
            } catch (error) {
                alert('‚ùå Error actualizando estado: ' + error.message);
            }
        }

        async function togglePersonalStatus(personalId) {
            const personal = cloudTecnicos.find(p => p.id === personalId);
            if (!personal) return;

            const newStatus = personal.estado === 'disponible' ? 'ocupado' : 'disponible';
            
            try {
                await window.airtableAPI.updateTecnico(personalId, { estado: newStatus });
                await loadAllDataFromCloud();
            } catch (error) {
                alert('‚ùå Error cambiando estado: ' + error.message);
            }
        }

        // üìã MODALES DE GESTI√ìN
        function showAssignmentModal(solicitudId) {
            const modal = document.getElementById('assignment-modal');
            const content = document.getElementById('assignment-modal-content');
            
            const solicitud = cloudSolicitudes.find(s => s.id === solicitudId);
            if (!solicitud) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }

            // Filtrar personal disponible por √°rea
            const personalDisponible = cloudTecnicos.filter(t => 
                t.area === solicitud.servicioIngenieria && 
                t.estado === 'disponible'
            );

            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h4 style="color: #1f2937; margin-bottom: 0.5rem;">Asignar Personal a Solicitud</h4>
                    <p style="color: #6b7280;">Solicitud: ${solicitud.numero}</p>
                </div>
                
                <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                    <h5 style="color: #1f2937; margin-bottom: 0.75rem;">üìã Detalles de la Solicitud</h5>
                    <p><strong>√Årea:</strong> ${getAreaName(solicitud.servicioIngenieria)}</p>
                    <p><strong>Prioridad:</strong> ${solicitud.prioridad || 'MEDIA'}</p>
                    <p><strong>Equipo:</strong> ${solicitud.equipo}</p>
                    <p><strong>Ubicaci√≥n:</strong> ${solicitud.ubicacion}</p>
                </div>

                ${personalDisponible.length === 0 ? `
                    <div style="text-align: center; padding: 2rem; background: #fee2e2; border-radius: 0.5rem; color: #dc2626;">
                        ‚ùå No hay personal disponible en ${getAreaName(solicitud.servicioIngenieria)}
                    </div>
                ` : `
                    <h5 style="color: #1f2937; margin-bottom: 1rem;">üë®‚Äçüîß Personal Disponible (${personalDisponible.length})</h5>
                    
                    <div style="display: grid; gap: 0.5rem; margin-bottom: 1.5rem; max-height: 300px; overflow-y: auto;">
                        ${personalDisponible.map(personal => `
                            <div class="personal-option" onclick="selectPersonalForModal('${personal.id}', this)" style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; cursor: pointer; transition: all 0.2s;">
                                <div style="font-weight: 600; color: #1f2937;">${personal.nombre}</div>
                                <div style="font-size: 0.875rem; color: #6b7280;">${personal.tipo} ‚Ä¢ ${personal.especialidad || 'General'}</div>
                                <div style="font-size: 0.75rem; color: #059669;">üìß ${personal.email}</div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="confirmModalAssignment('${solicitudId}')" id="modal-assign-btn" disabled style="min-width: 200px;">
                            ‚úÖ Confirmar Asignaci√≥n
                        </button>
                    </div>
                `}
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="closeAssignmentModal()">
                        ‚Ü©Ô∏è Cancelar
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        let selectedModalPersonalId = null;

        function selectPersonalForModal(personalId, element) {
            // Limpiar selecciones previas
            const container = element.parentElement;
            container.querySelectorAll('.personal-option').forEach(opt => {
                opt.style.borderColor = '#e5e7eb';
                opt.style.background = 'white';
            });
            
            // Seleccionar nuevo
            element.style.borderColor = '#059669';
            element.style.background = '#dcfce7';
            selectedModalPersonalId = personalId;
            
            // Habilitar bot√≥n
            const assignBtn = document.getElementById('modal-assign-btn');
            if (assignBtn) {
                assignBtn.disabled = false;
            }
        }

        async function confirmModalAssignment(solicitudId) {
            if (!selectedModalPersonalId) {
                alert('‚ùå Seleccione un t√©cnico primero');
                return;
            }

            try {
                const assignBtn = document.getElementById('modal-assign-btn');
                if (assignBtn) {
                    assignBtn.disabled = true;
                    assignBtn.innerHTML = '‚è≥ Asignando...';
                }

                const result = await window.airtableAPI.asignarTecnicoASolicitud(solicitudId, selectedModalPersonalId);
                
                if (result.success) {
                    alert(`‚úÖ Personal asignado exitosamente\n\nüë®‚Äçüîß T√©cnico: ${result.tecnico.nombre}\nüìã Solicitud: ${result.solicitud.numero}\n‚è±Ô∏è Tiempo de respuesta: ${result.tiempos.tiempoRespuesta}`);
                    
                    closeAssignmentModal();
                    await loadAllDataFromCloud();
                } else {
                    throw new Error('Error en la asignaci√≥n');
                }

            } catch (error) {
                console.error('‚ùå Error asignando personal:', error);
                alert('‚ùå Error al asignar personal: ' + error.message);
            } finally {
                selectedModalPersonalId = null;
            }
        }

        function closeAssignmentModal() {
            document.getElementById('assignment-modal').classList.remove('show');
            selectedModalPersonalId = null;
        }

        function showDetailsModal(solicitudId) {
            const modal = document.getElementById('details-modal');
            const content = document.getElementById('details-modal-content');
            
            const solicitud = cloudSolicitudes.find(s => s.id === solicitudId);
            if (!solicitud) {
                alert('‚ùå Solicitud no encontrada');
                return;
            }

            // Calcular tiempo de respuesta
            const tiempoRespuesta = timeTracker.calcularTiempoRespuesta(
                solicitud.fechaCreacion, 
                solicitud.fechaAsignacion
            );
            const evaluacionTiempo = timeTracker.evaluarTiempo(tiempoRespuesta, solicitud.prioridad);

            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <h4 style="color: #1f2937; margin-bottom: 0.5rem;">${solicitud.numero}</h4>
                    <div style="display: flex; justify-content: center; gap: 0.5rem; flex-wrap: wrap;">
                        <span class="badge badge-${solicitud.estado?.toLowerCase().replace('_', '-') || 'pendiente'}">${solicitud.estado || 'PENDIENTE'}</span>
                        <span class="badge badge-${solicitud.prioridad?.toLowerCase() || 'media'}">${solicitud.prioridad || 'MEDIA'}</span>
                        <span class="badge" style="background: #e0f2fe; color: #0369a1;">${getAreaName(solicitud.servicioIngenieria)}</span>
                    </div>
                </div>

                <div class="tiempo-respuesta ${evaluacionTiempo.status}" style="margin-bottom: 1.5rem;">
                    <span>‚è±Ô∏è</span>
                    <span><strong>Tiempo:</strong> ${timeTracker.formatearTiempo(tiempoRespuesta)}</span>
                    <span>‚Ä¢</span>
                    <span>${evaluacionTiempo.mensaje}</span>
                </div>

                <div style="display: grid; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                        <h5 style="color: #1f2937; margin-bottom: 0.75rem;">üìã Informaci√≥n General</h5>
                        <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
                            <div><strong>Tipo de Servicio:</strong> ${solicitud.tipoServicio?.replace('_', ' ') || 'No especificado'}</div>
                            <div><strong>Equipo:</strong> ${solicitud.equipo || 'No especificado'}</div>
                            <div><strong>Ubicaci√≥n:</strong> ${solicitud.ubicacion || 'No especificado'}</div>
                            <div><strong>Solicitante:</strong> ${solicitud.solicitante || 'No especificado'}</div>
                            <div><strong>Email:</strong> ${solicitud.emailSolicitante || 'No especificado'}</div>
                        </div>
                    </div>

                    <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                        <h5 style="color: #1f2937; margin-bottom: 0.75rem;">üë®‚Äçüîß Asignaci√≥n</h5>
                        <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
                            <div><strong>T√©cnico Asignado:</strong> ${solicitud.tecnicoAsignado || '<span style="color: #f59e0b;">Sin asignar</span>'}</div>
                            <div><strong>Fecha Asignaci√≥n:</strong> ${solicitud.fechaAsignacion ? new Date(solicitud.fechaAsignacion).toLocaleString('es-CO') : 'No asignado'}</div>
                            <div><strong>Fecha Creaci√≥n:</strong> ${solicitud.fechaCreacion ? new Date(solicitud.fechaCreacion).toLocaleString('es-CO') : 'No disponible'}</div>
                        </div>
                    </div>

                    ${solicitud.descripcion ? `
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <h5 style="color: #1f2937; margin-bottom: 0.75rem;">üìù Descripci√≥n del Problema</h5>
                            <div style="font-size: 0.875rem; color: #1f2937;">${solicitud.descripcion}</div>
                        </div>
                    ` : ''}

                    ${solicitud.observaciones ? `
                        <div style="background: #f8fafc; padding: 1rem; border-radius: 0.5rem;">
                            <h5 style="color: #1f2937; margin-bottom: 0.75rem;">üìã Observaciones</h5>
                            <div style="font-size: 0.875rem; color: #1f2937;">${solicitud.observaciones}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                    ${!solicitud.tecnicoAsignado ? `
                        <button class="btn btn-primary" onclick="closeDetailsModal(); showAssignmentModal('${solicitud.id}')">
                            üë®‚Äçüîß Asignar Personal
                        </button>
                    ` : ''}
                    
                    <button class="btn btn-warning" onclick="updateSolicitudStatus('${solicitud.id}', 'EN_PROCESO')">
                        ‚ñ∂Ô∏è En Proceso
                    </button>
                    
                    <button class="btn btn-success" onclick="updateSolicitudStatus('${solicitud.id}', 'COMPLETADA')">
                        ‚úÖ Completar
                    </button>
                    
                    <button class="btn btn-secondary" onclick="closeDetailsModal()">
                        ‚Ü©Ô∏è Cerrar
                    </button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeDetailsModal() {
            document.getElementById('details-modal').classList.remove('show');
        }

        async function updateSolicitudStatus(solicitudId, newStatus) {
            try {
                const solicitud = cloudSolicitudes.find(s => s.id === solicitudId);
                if (!solicitud) {
                    alert('‚ùå Solicitud no encontrada');
                    return;
                }

                const confirmed = confirm(`üîÑ ¬øCambiar estado de ${solicitud.numero} a ${newStatus}?`);
                if (!confirmed) return;

                const updateData = { estado: newStatus };
                
                // Agregar timestamps seg√∫n el estado
                if (newStatus === 'EN_PROCESO') {
                    updateData.fechaInicio = new Date().toISOString();
                } else if (newStatus === 'COMPLETADA') {
                    updateData.fechaCompletado = new Date().toISOString();
                    
                    // Liberar t√©cnico si estaba asignado
                    if (solicitud.tecnicoAsignadoId) {
                        await window.airtableAPI.liberarTecnico(solicitud.tecnicoAsignadoId, solicitudId);
                    }
                }

                await window.airtableAPI.updateSolicitud(solicitudId, updateData);
                
                alert(`‚úÖ Estado actualizado a: ${newStatus}`);
                
                // Cerrar modal si est√° abierto
                closeDetailsModal();
                
                // Recargar datos
                await loadAllDataFromCloud();

            } catch (error) {
                console.error('‚ùå Error actualizando estado:', error);
                alert('‚ùå Error actualizando estado: ' + error.message);
            }
        }

        // üìä FUNCIONES DE EXPORTACI√ìN Y REPORTES
        async function exportarReporteTiempos() {
            try {
                // Generar estad√≠sticas detalladas
                const stats = timeTracker.generarEstadisticas(cloudSolicitudes);
                
                // Estad√≠sticas por √°rea
                const areas = ['INGENIERIA_BIOMEDICA', 'MECANICA', 'INFRAESTRUCTURA'];
                let reporte = `üìä REPORTE DE TIEMPOS DE RESPUESTA\n`;
                reporte += `üè• Hospital Susana L√≥pez de Valencia\n`;
                reporte += `üìÖ Generado: ${new Date().toLocaleString('es-CO')}\n\n`;
                
                reporte += `üìà ESTAD√çSTICAS GENERALES\n`;
                reporte += `‚Ä¢ Tiempo Promedio: ${stats.promedio}\n`;
                reporte += `‚Ä¢ Tiempo M√≠nimo: ${stats.minimo}\n`;
                reporte += `‚Ä¢ Tiempo M√°ximo: ${stats.maximo}\n`;
                reporte += `‚Ä¢ Solicitudes Vencidas: ${stats.vencidas}\n\n`;
                
                areas.forEach(area => {
                    const solicitudesArea = cloudSolicitudes.filter(s => s.servicioIngenieria === area);
                    if (solicitudesArea.length > 0) {
                        const statsArea = timeTracker.generarEstadisticas(solicitudesArea);
                        reporte += `${getAreaIcon(area)} ${getAreaName(area).toUpperCase()}\n`;
                        reporte += `  ‚Ä¢ Total solicitudes: ${solicitudesArea.length}\n`;
                        reporte += `  ‚Ä¢ Tiempo promedio: ${statsArea.promedio}\n`;
                        reporte += `  ‚Ä¢ Vencidas: ${statsArea.vencidas}\n\n`;
                    }
                });
                
                // Copiar al portapapeles (si es posible)
                if (navigator.clipboard) {
                    await navigator.clipboard.writeText(reporte);
                    alert('üìä Reporte copiado al portapapeles\n\nPuede pegarlo en Excel, Word o cualquier editor de texto.');
                } else {
                    // Mostrar en modal si no se puede copiar
                    prompt('üìä Reporte de Tiempos de Respuesta\n\nCopie el texto con Ctrl+C:', reporte);
                }
                
            } catch (error) {
                console.error('‚ùå Error exportando reporte:', error);
                alert('‚ùå Error generando reporte: ' + error.message);
            }
        }

        // üîß FUNCIONES AUXILIARES ADICIONALES
        function showAddPersonalModal() {
            alert('‚ûï Funci√≥n de agregar personal disponible en desarrollo.\n\nPor ahora puede gestionar el personal existente desde las tarjetas mostradas.');
        }

        async function syncTechniciansWithCloud() {
            try {
                await loadAllDataFromCloud();
                alert('‚úÖ Personal sincronizado con Airtable');
            } catch (error) {
                alert('‚ùå Error sincronizando: ' + error.message);
            }
        }

        // üì± FUNCIONES DE FILTRADO AVANZADO
        function filterByArea(area) {
            document.getElementById('filtro-area').value = area === 'all' ? '' : area;
            aplicarFiltros();
            showView('solicitudes');
        }

        function filterByStatus(status) {
            document.getElementById('filtro-estado').value = status === 'all' ? '' : status;
            aplicarFiltros();
            showView('solicitudes');
        }
    </script>
</body>
</html>