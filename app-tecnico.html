<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#059669">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HSLV Soporte">
    
    <title>App Soporte - Hospital Susana LÃ³pez de Valencia</title>
    
    <!-- Manifest para PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Iconos para iOS -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
            padding-bottom: env(safe-area-inset-bottom);
            overflow-x: hidden;
        }

        /* Header fijo */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: env(safe-area-inset-top) 1rem 1rem 1rem;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .notification-badge {
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 1.5rem;
            text-align: center;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            color: #6b7280;
            text-decoration: none;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: #059669;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .nav-label {
            font-size: 0.625rem;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            padding-top: 5rem;
            padding-bottom: 5rem;
            min-height: 100vh;
            background: #f3f4f6;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2.5rem;
            color: white;
        }

        /* Request Cards */
        .request-card {
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            margin: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border-left: 4px solid;
        }

        .request-card.critical {
            border-left-color: #ef4444;
            animation: pulse 2s infinite;
        }

        .request-card.high {
            border-left-color: #f59e0b;
        }

        .request-card.medium {
            border-left-color: #3b82f6;
        }

        .request-card.low {
            border-left-color: #10b981;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .request-number {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
        }

        .priority-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .priority-critical {
            background: #fee2e2;
            color: #dc2626;
        }

        .priority-high {
            background: #fed7aa;
            color: #ea580c;
        }

        .priority-medium {
            background: #dbeafe;
            color: #1e40af;
        }

        .priority-low {
            background: #d1fae5;
            color: #059669;
        }

        .request-info {
            margin-bottom: 1rem;
        }

        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .info-icon {
            margin-right: 0.5rem;
            color: #6b7280;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn:active {
            transform: scale(0.95);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
        }

        /* Photo Upload */
        .photo-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            margin: 1rem 0;
            background: #f9fafb;
            position: relative;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .photo-item {
            position: relative;
            border-radius: 0.5rem;
            overflow: hidden;
            aspect-ratio: 1;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Form inputs */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Status indicators */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #d97706;
        }

        .status-assigned {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-in-progress {
            background: #e9d5ff;
            color: #7c3aed;
        }

        .status-completed {
            background: #d1fae5;
            color: #059669;
        }

        /* Loading spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #059669;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .empty-description {
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Notification permission banner */
        .notification-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-size: 0.875rem;
        }

        /* Camera button */
        .camera-btn {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
            transition: all 0.2s;
        }

        .camera-btn:active {
            transform: scale(0.9);
        }

        /* Install button */
        .install-prompt {
            position: fixed;
            bottom: 5rem;
            left: 1rem;
            right: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 99;
        }

        .install-prompt.show {
            display: block;
            animation: slideUp 0.3s ease-out;
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
            .modal-content {
                margin: 1rem;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-card">
            <div class="login-logo">ð¥</div>
            <h2 style="text-align: center; margin-bottom: 0.5rem;">App Soporte TÃ©cnico</h2>
            <p style="text-align: center; color: #6b7280; font-size: 0.875rem; margin-bottom: 1.5rem;">
                Hospital Susana LÃ³pez de Valencia
            </p>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">ð§ Email</label>
                    <input type="email" id="email" class="form-input" required placeholder="correo@hospital.com">
                </div>
                
                <div class="form-group">
                    <label class="form-label">ð PIN de Acceso</label>
                    <input type="password" id="pin" class="form-input" required placeholder="PIN de 4 dÃ­gitos" 
                           maxlength="4" pattern="[0-9]{4}" inputmode="numeric">
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    ð Iniciar SesiÃ³n
                </button>
            </form>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                <p style="font-size: 0.75rem; color: #6b7280; text-align: center;">
                    ð¡ Use sus credenciales de tÃ©cnico asignadas por el administrador
                </p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden initially) -->
    <div id="main-app" style="display: none;">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div>
                    <div class="header-title">Hola, <span id="user-name">TÃ©cnico</span></div>
                    <div style="font-size: 0.75rem; opacity: 0.9;">
                        <span id="user-area">Ãrea</span> â¢ <span id="current-time">--:--</span>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="notification-badge" id="pending-count">0</div>
                    <button onclick="logout()" style="background: none; border: none; color: white; font-size: 1.25rem;">
                        ðª
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Notification Permission Banner -->
            <div id="notification-banner" class="notification-banner" style="display: none;">
                ð Habilita las notificaciones para recibir alertas de nuevas solicitudes
                <button onclick="requestNotificationPermission()" class="btn btn-secondary" 
                        style="margin-left: 1rem; padding: 0.25rem 0.75rem;">
                    Habilitar
                </button>
            </div>

            <!-- Tab Contents -->
            <div id="pending-tab" class="tab-content active">
                <div style="padding: 1rem;">
                    <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                        ð Solicitudes Asignadas
                    </h2>
                </div>
                <div id="pending-requests">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>

            <div id="in-progress-tab" class="tab-content">
                <div style="padding: 1rem;">
                    <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                        ð§ En Proceso
                    </h2>
                </div>
                <div id="in-progress-requests">
                    <div class="empty-state">
                        <div class="empty-icon">ð­</div>
                        <div class="empty-title">No hay solicitudes en proceso</div>
                        <div class="empty-description">Las solicitudes que estÃ©s trabajando aparecerÃ¡n aquÃ­</div>
                    </div>
                </div>
            </div>

            <div id="completed-tab" class="tab-content">
                <div style="padding: 1rem;">
                    <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                        â Completadas Hoy
                    </h2>
                </div>
                <div id="completed-requests">
                    <div class="empty-state">
                        <div class="empty-icon">ð­</div>
                        <div class="empty-title">No hay solicitudes completadas hoy</div>
                        <div class="empty-description">Las solicitudes que completes aparecerÃ¡n aquÃ­</div>
                    </div>
                </div>
            </div>

            <div id="profile-tab" class="tab-content">
                <div style="padding: 1rem;">
                    <h2 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">
                        ð¤ Mi Perfil
                    </h2>
                    
                    <div style="background: white; border-radius: 1rem; padding: 1.5rem; margin-bottom: 1rem;">
                        <div class="info-row">
                            <span class="info-icon">ð¤</span>
                            <span id="profile-name">Nombre</span>
                        </div>
                        <div class="info-row">
                            <span class="info-icon">ð§</span>
                            <span id="profile-email">Email</span>
                        </div>
                        <div class="info-row">
                            <span class="info-icon">ð¥</span>
                            <span id="profile-area">Ãrea</span>
                        </div>
                        <div class="info-row">
                            <span class="info-icon">ð</span>
                            <span id="profile-stats">0 solicitudes completadas hoy</span>
                        </div>
                    </div>
                    
                    <button onclick="checkForUpdates()" class="btn btn-secondary" style="width: 100%; margin-bottom: 0.5rem;">
                        ð Buscar Actualizaciones
                    </button>
                    
                    <button onclick="installApp()" id="install-btn" class="btn btn-primary" style="width: 100%; display: none;">
                        ð± Instalar App
                    </button>
                </div>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <a href="#" class="nav-item active" onclick="showTab('pending', this)">
                <span class="nav-icon">ð</span>
                <span class="nav-label">Asignadas</span>
            </a>
            <a href="#" class="nav-item" onclick="showTab('in-progress', this)">
                <span class="nav-icon">ð§</span>
                <span class="nav-label">En Proceso</span>
            </a>
            <a href="#" class="nav-item" onclick="showTab('completed', this)">
                <span class="nav-icon">â</span>
                <span class="nav-label">Completadas</span>
            </a>
            <a href="#" class="nav-item" onclick="showTab('profile', this)">
                <span class="nav-icon">ð¤</span>
                <span class="nav-label">Perfil</span>
            </a>
        </nav>
    </div>

    <!-- Modal for Request Actions -->
    <div id="action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Completar Solicitud</h3>
                <button class="modal-close" onclick="closeModal()">Ã</button>
            </div>
            
            <form id="complete-form" onsubmit="handleCompleteRequest(event)">
                <input type="hidden" id="request-id">
                
                <div class="form-group">
                    <label class="form-label">ð Trabajo Realizado</label>
                    <textarea id="work-description" class="form-textarea" required 
                              placeholder="Describa el trabajo realizado..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ð· Evidencia FotogrÃ¡fica</label>
                    <div class="photo-upload-area">
                        <input type="file" id="photo-input" accept="image/*" multiple style="display: none;" 
                               onchange="handlePhotoSelect(event)">
                        
                        <button type="button" class="camera-btn" onclick="document.getElementById('photo-input').click()">
                            ð·
                        </button>
                        
                        <p style="margin-top: 1rem; color: #6b7280; font-size: 0.875rem;">
                            Toque para tomar fotos o seleccionar de galerÃ­a
                        </p>
                        
                        <div id="photo-preview" class="photo-preview"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="mark-error" onchange="toggleErrorSection()">
                        â Marcar como Error de Usuario
                    </label>
                </div>
                
                <div id="error-section" style="display: none;" class="form-group">
                    <label class="form-label">ExplicaciÃ³n del Error</label>
                    <textarea id="error-description" class="form-textarea" 
                              placeholder="Explique por quÃ© fue un error de usuario..."></textarea>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">
                        â Completar Solicitud
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Install Prompt -->
    <div id="install-prompt" class="install-prompt">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div style="font-size: 2rem;">ð±</div>
            <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 0.25rem;">Instalar App</div>
                <div style="font-size: 0.75rem; color: #6b7280;">
                    Instala la app para acceso rÃ¡pido y notificaciones
                </div>
            </div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button onclick="installApp()" class="btn btn-primary" style="flex: 1;">
                Instalar
            </button>
            <button onclick="dismissInstallPrompt()" class="btn btn-secondary" style="flex: 1;">
                Ahora no
            </button>
        </div>
    </div>

    <!-- Include Airtable config -->
    <script src="airtable-config.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Variables globales
        let currentUser = null;
        let assignedRequests = [];
        let inProgressRequests = [];
        let completedRequests = [];
        let selectedPhotos = [];
        let deferredPrompt;

        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('â Service Worker registrado');
                    
                    // Check for updates every hour
                    setInterval(() => {
                        registration.update();
                    }, 3600000);
                })
                .catch(error => {
                    console.error('â Error registrando Service Worker:', error);
                });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            updateTime();
            setInterval(updateTime, 60000);
            
            // Check notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                document.getElementById('notification-banner').style.display = 'block';
            }
            
            // Install prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('install-btn').style.display = 'block';
                
                // Show install prompt after 30 seconds
                setTimeout(() => {
                    if (deferredPrompt) {
                        document.getElementById('install-prompt').classList.add('show');
                    }
                }, 30000);
            });
        });

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
        }

        // Check authentication
        function checkAuth() {
            const savedUser = localStorage.getItem('tecnico_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const pin = document.getElementById('pin').value;
            
            try {
                // Validate against Airtable technicians
                if (window.airtableAPI) {
                    const tecnicos = await window.airtableAPI.getTecnicos();
                    const tecnico = tecnicos.find(t => 
                        t.email === email && 
                        (t.pin === pin || t.codigoAcceso === pin) // Support both field names
                    );
                    
                    if (tecnico) {
                        currentUser = tecnico;
                        localStorage.setItem('tecnico_user', JSON.stringify(tecnico));
                        showMainApp();
                    } else {
                        alert('â Credenciales invÃ¡lidas');
                    }
                } else {
                    // Fallback login for testing
                    if (email && pin === '1234') {
                        currentUser = {
                            nombre: 'TÃ©cnico Demo',
                            email: email,
                            area: 'BIOMEDICA',
                            id: 'demo-' + Date.now()
                        };
                        localStorage.setItem('tecnico_user', JSON.stringify(currentUser));
                        showMainApp();
                    } else {
                        alert('â Credenciales invÃ¡lidas');
                    }
                }
            } catch (error) {
                console.error('Error en login:', error);
                alert('â Error al iniciar sesiÃ³n');
            }
        }

        // Show main app
        function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            // Update user info
            document.getElementById('user-name').textContent = currentUser.nombre || 'TÃ©cnico';
            document.getElementById('user-area').textContent = getAreaName(currentUser.area);
            document.getElementById('profile-name').textContent = currentUser.nombre;
            document.getElementById('profile-email').textContent = currentUser.email;
            document.getElementById('profile-area').textContent = getAreaName(currentUser.area);
            
            // Load requests
            loadRequests();
            
            // Auto-refresh every 30 seconds
            setInterval(loadRequests, 30000);
        }

        // Get area display name
        function getAreaName(area) {
            const areaNames = {
                'INGENIERIA_BIOMEDICA': 'Ing. BiomÃ©dica',
                'BIOMEDICA': 'Ing. BiomÃ©dica',
                'MECANICA': 'MecÃ¡nica',
                'INFRAESTRUCTURA': 'Infraestructura'
            };
            return areaNames[area] || area;
        }

        // Load requests from Airtable
        async function loadRequests() {
            if (!window.airtableAPI) {
                console.error('Airtable API not available');
                return;
            }
            
            try {
                const solicitudes = await window.airtableAPI.getSolicitudes();
                
                // Filter requests assigned to current technician
                assignedRequests = solicitudes.filter(s => 
                    s.tecnicoAsignado === currentUser.nombre && 
                    (s.estado === 'ASIGNADA' || s.estado === 'Asignada')
                );
                
                inProgressRequests = solicitudes.filter(s => 
                    s.tecnicoAsignado === currentUser.nombre && 
                    (s.estado === 'EN_PROCESO' || s.estado === 'En Proceso')
                );
                
                // Get today's completed requests
                const today = new Date().toDateString();
                completedRequests = solicitudes.filter(s => 
                    s.tecnicoAsignado === currentUser.nombre && 
                    (s.estado === 'COMPLETADA' || s.estado === 'Completada') &&
                    s.fechaCompletado && new Date(s.fechaCompletado).toDateString() === today
                );
                
                // Update UI
                updateRequestsUI();
                
                // Check for new assignments
                checkNewAssignments(assignedRequests);
                
            } catch (error) {
                console.error('Error loading requests:', error);
            }
        }

        // Update requests UI
        function updateRequestsUI() {
            // Update counts
            document.getElementById('pending-count').textContent = assignedRequests.length;
            document.getElementById('profile-stats').textContent = 
                `${completedRequests.length} solicitudes completadas hoy`;
            
            // Update pending requests
            const pendingContainer = document.getElementById('pending-requests');
            if (assignedRequests.length === 0) {
                pendingContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ð­</div>
                        <div class="empty-title">No hay solicitudes asignadas</div>
                        <div class="empty-description">Las nuevas solicitudes aparecerÃ¡n aquÃ­</div>
                    </div>
                `;
            } else {
                pendingContainer.innerHTML = assignedRequests.map(request => 
                    createRequestCard(request, 'assigned')
                ).join('');
            }
            
            // Update in-progress requests
            const inProgressContainer = document.getElementById('in-progress-requests');
            if (inProgressRequests.length === 0) {
                inProgressContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ð­</div>
                        <div class="empty-title">No hay solicitudes en proceso</div>
                        <div class="empty-description">Las solicitudes que estÃ©s trabajando aparecerÃ¡n aquÃ­</div>
                    </div>
                `;
            } else {
                inProgressContainer.innerHTML = inProgressRequests.map(request => 
                    createRequestCard(request, 'in-progress')
                ).join('');
            }
            
            // Update completed requests
            const completedContainer = document.getElementById('completed-requests');
            if (completedRequests.length === 0) {
                completedContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ð­</div>
                        <div class="empty-title">No hay solicitudes completadas hoy</div>
                        <div class="empty-description">Las solicitudes que completes aparecerÃ¡n aquÃ­</div>
                    </div>
                `;
            } else {
                completedContainer.innerHTML = completedRequests.map(request => 
                    createRequestCard(request, 'completed')
                ).join('');
            }
        }

        // Create request card
        function createRequestCard(request, status) {
            const priorityClass = getPriorityClass(request.prioridad);
            const priorityBadgeClass = getPriorityBadgeClass(request.prioridad);
            
            const actions = status === 'assigned' ? `
                <button class="btn btn-primary" onclick="startRequest('${request.id}')">
                    â¶ï¸ Iniciar
                </button>
                <button class="btn btn-secondary" onclick="viewDetails('${request.id}')">
                    ðï¸ Ver
                </button>
            ` : status === 'in-progress' ? `
                <button class="btn btn-primary" onclick="openCompleteModal('${request.id}')">
                    â Completar
                </button>
                <button class="btn btn-secondary" onclick="viewDetails('${request.id}')">
                    ðï¸ Ver
                </button>
            ` : `
                <button class="btn btn-secondary" onclick="viewDetails('${request.id}')">
                    ðï¸ Ver Detalles
                </button>
            `;
            
            return `
                <div class="request-card ${priorityClass}">
                    <div class="request-header">
                        <div class="request-number">${request.numero || 'SIN-NÃMERO'}</div>
                        <span class="priority-badge ${priorityBadgeClass}">
                            ${request.prioridad || 'MEDIA'}
                        </span>
                    </div>
                    
                    <div class="request-info">
                        <div class="info-row">
                            <span class="info-icon">ð¥ï¸</span>
                            <span>${request.equipo || 'No especificado'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-icon">ð</span>
                            <span>${request.ubicacion || 'No especificada'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-icon">ð§</span>
                            <span>${request.tipoServicio || 'No especificado'}</span>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        ${actions}
                    </div>
                </div>
            `;
        }

        // Get priority class
        function getPriorityClass(priority) {
            const classes = {
                'CRITICA': 'critical',
                'ALTA': 'high',
                'MEDIA': 'medium',
                'BAJA': 'low'
            };
            return classes[priority] || 'medium';
        }

        // Get priority badge class
        function getPriorityBadgeClass(priority) {
            const classes = {
                'CRITICA': 'priority-critical',
                'ALTA': 'priority-high',
                'MEDIA': 'priority-medium',
                'BAJA': 'priority-low'
            };
            return classes[priority] || 'priority-medium';
        }

        // Start request
        async function startRequest(requestId) {
            if (confirm('Â¿Iniciar trabajo en esta solicitud?')) {
                try {
                    await window.airtableAPI.updateRequestStatus(requestId, 'EN_PROCESO', 
                        'Trabajo iniciado desde app mÃ³vil');
                    
                    // Show notification
                    showNotification('Solicitud Iniciada', 'Has comenzado a trabajar en la solicitud');
                    
                    // Reload requests
                    await loadRequests();
                    
                    // Switch to in-progress tab
                    showTab('in-progress', document.querySelector('.nav-item[onclick*="in-progress"]'));
                    
                } catch (error) {
                    console.error('Error starting request:', error);
                    alert('â Error al iniciar solicitud');
                }
            }
        }

        // Open complete modal
        function openCompleteModal(requestId) {
            const request = inProgressRequests.find(r => r.id === requestId);
            if (!request) return;
            
            document.getElementById('request-id').value = requestId;
            document.getElementById('modal-title').textContent = 
                `Completar ${request.numero || 'Solicitud'}`;
            
            // Reset form
            document.getElementById('complete-form').reset();
            document.getElementById('photo-preview').innerHTML = '';
            selectedPhotos = [];
            
            // Show modal
            document.getElementById('action-modal').classList.add('show');
        }

        // Handle photo selection
        function handlePhotoSelect(event) {
            const files = event.target.files;
            const preview = document.getElementById('photo-preview');
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const photoId = 'photo-' + Date.now() + '-' + Math.random();
                        selectedPhotos.push({
                            id: photoId,
                            data: e.target.result,
                            name: file.name
                        });
                        
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        photoItem.innerHTML = `
                            <img src="${e.target.result}" alt="${file.name}">
                            <button class="photo-remove" onclick="removePhoto('${photoId}')">Ã</button>
                        `;
                        
                        preview.appendChild(photoItem);
                    };
                    
                    reader.readAsDataURL(file);
                }
            }
        }

        // Remove photo
        function removePhoto(photoId) {
            selectedPhotos = selectedPhotos.filter(p => p.id !== photoId);
            
            // Update preview
            const preview = document.getElementById('photo-preview');
            preview.innerHTML = selectedPhotos.map(photo => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="${photo.name}">
                    <button class="photo-remove" onclick="removePhoto('${photo.id}')">Ã</button>
                </div>
            `).join('');
        }

        // Toggle error section
        function toggleErrorSection() {
            const isChecked = document.getElementById('mark-error').checked;
            document.getElementById('error-section').style.display = isChecked ? 'block' : 'none';
        }

        // Handle complete request
        async function handleCompleteRequest(event) {
            event.preventDefault();
            
            const requestId = document.getElementById('request-id').value;
            const workDescription = document.getElementById('work-description').value;
            const isError = document.getElementById('mark-error').checked;
            const errorDescription = document.getElementById('error-description').value;
            
            try {
                // Prepare observations
                let observations = `[${new Date().toLocaleString('es-CO')}] Trabajo completado: ${workDescription}`;
                
                if (isError) {
                    observations += `\n\nâ ï¸ ERROR DE USUARIO: ${errorDescription}`;
                }
                
                if (selectedPhotos.length > 0) {
                    observations += `\n\nð· Se adjuntaron ${selectedPhotos.length} foto(s) como evidencia`;
                    
                    // In a real implementation, you would upload photos to a cloud storage
                    // and include the URLs in the observations
                    // For now, we'll just note that photos were taken
                }
                
                // Update request status
                if (isError) {
                    // Update both status and type if it's a user error
                    await window.airtableAPI.updateRequestStatus(requestId, 'COMPLETADA', observations);
                    
                    // Also update the service type to ERROR_USUARIO if possible
                    // This would require an additional API method
                } else {
                    await window.airtableAPI.updateRequestStatus(requestId, 'COMPLETADA', observations);
                }
                
                // Show success notification
                showNotification('â Solicitud Completada', 
                    `La solicitud ha sido marcada como completada${isError ? ' (Error de Usuario)' : ''}`);
                
                // Close modal
                closeModal();
                
                // Reload requests
                await loadRequests();
                
                // Switch to completed tab
                showTab('completed', document.querySelector('.nav-item[onclick*="completed"]'));
                
            } catch (error) {
                console.error('Error completing request:', error);
                alert('â Error al completar solicitud: ' + error.message);
            }
        }

        // View request details
        function viewDetails(requestId) {
            const request = [...assignedRequests, ...inProgressRequests, ...completedRequests]
                .find(r => r.id === requestId);
            
            if (!request) return;
            
            alert(`ð DETALLES DE SOLICITUD\n\n` +
                `NÃºmero: ${request.numero}\n` +
                `Equipo: ${request.equipo}\n` +
                `UbicaciÃ³n: ${request.ubicacion}\n` +
                `Tipo: ${request.tipoServicio}\n` +
                `Prioridad: ${request.prioridad}\n` +
                `Estado: ${request.estado}\n\n` +
                `DescripciÃ³n:\n${request.descripcion}`
            );
        }

        // Show tab
        function showTab(tabName, element) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('action-modal').classList.remove('show');
        }

        // Request notification permission
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    document.getElementById('notification-banner').style.display = 'none';
                    showNotification('ð Notificaciones Habilitadas', 
                        'RecibirÃ¡s alertas de nuevas solicitudes');
                }
            }
        }

        // Show notification
        function showNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                const notification = new Notification(title, {
                    body: body,
                    icon: 'icons/icon-192.png',
                    badge: 'icons/icon-72.png',
                    vibrate: [200, 100, 200]
                });
                
                notification.onclick = function() {
                    window.focus();
                    notification.close();
                };
            }
        }

        // Check for new assignments
        function checkNewAssignments(currentAssignments) {
            const lastCount = parseInt(localStorage.getItem('last_assignment_count') || '0');
            const currentCount = currentAssignments.length;
            
            if (currentCount > lastCount) {
                const newCount = currentCount - lastCount;
                showNotification('ð Nueva Solicitud Asignada', 
                    `Tienes ${newCount} nueva(s) solicitud(es) asignada(s)`);
                
                // Vibrate if supported
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
            }
            
            localStorage.setItem('last_assignment_count', currentCount.toString());
        }

        // Install app
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                
                deferredPrompt = null;
                document.getElementById('install-btn').style.display = 'none';
                document.getElementById('install-prompt').classList.remove('show');
            }
        }

        // Dismiss install prompt
        function dismissInstallPrompt() {
            document.getElementById('install-prompt').classList.remove('show');
        }

        // Check for updates
        async function checkForUpdates() {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    registration.update();
                    alert('â Buscando actualizaciones...\n\nSi hay una nueva versiÃ³n, se instalarÃ¡ automÃ¡ticamente.');
                }
            }
        }

        // Logout
        function logout() {
            if (confirm('Â¿Cerrar sesiÃ³n?')) {
                localStorage.removeItem('tecnico_user');
                location.reload();
            }
        }
    </script>
</body>
</html>